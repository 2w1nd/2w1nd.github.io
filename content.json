{"pages":[{"title":"","text":"About Meâ€‹ ä¸€ä¸ªèœç‹—","link":"/about/index.html"},{"title":"","text":"å¶å°”è®°å½•ä¸‹å§ğŸ‰ 2022/2/28ï¼Œä»Šå¤©çœ‹åˆ°äº†ä¸€ç¯‡10å¹´çš„åšæ–‡ï¼Œæœ‰å…³å¤§æ•°æ®ä¸‹topké—®é¢˜çš„ï¼Œå†™çš„éå¸¸ç²¾å½©ï¼Œä¸å¾—ä¸ä½©æœè€ä¸€è¾ˆäº’è”äººçš„æŠ€æœ¯å®åŠ›å’Œå¥‰çŒ®ç²¾ç¥","link":"/log/index.html"}],"posts":[{"title":"Javaç±»çš„åŠ è½½æœºåˆ¶","text":"1 æ¦‚è¿°â€‹ é¦–å…ˆï¼Œå…ˆçœ‹å¦‚ä¸‹çš„Javaä»£ç æ‰§è¡Œæµç¨‹å›¾ â€‹ ç±»çš„åŠ è½½æ˜¯æŒ‡å›¾ä¸­ï¼šå­—èŠ‚ç è¿›å…¥Javaè™šæ‹Ÿæœºåçš„ä¸€ç³»åˆ—è¿‡ç¨‹ã€‚å…·ä½“æ˜¯ï¼šè™šæ‹ŸæœºæŠŠæè¿°ç±»çš„æ•°æ®ä»Classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œè½¬æ¢è§£æå’Œåˆå§‹åŒ–ï¼Œæœ€ç»ˆå½¢æˆå¯ä»¥è¢«è™šæ‹Ÿæœºç›´æ¥ä½¿ç”¨çš„Javaç±»å‹ã€‚ â€‹ ç®€å•æ¥è¯´ï¼Œç±»çš„åŠ è½½è¿‡ç¨‹ï¼ˆä»åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜åˆ°å¸å‡ºï¼‰ï¼šåŒ…æ‹¬äº†åŠ è½½ï¼ŒéªŒè¯ï¼Œå‡†å¤‡ï¼Œè§£æï¼Œåˆå§‹åŒ–ï¼Œä½¿ç”¨ï¼Œå¸è½½ã€‚ â€‹ å…¶ä»–çš„è¿‡ç¨‹é¡ºåºéƒ½æ˜¯ç¡®å®šçš„ï¼Œé™¤äº†è§£æï¼Œå®ƒåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µåå¼€å§‹ã€‚æ³¨æ„ï¼šè¿™é‡Œçš„é¡ºåºæŒ‡çš„æ˜¯æŒ‰é¡ºåºå¼€å§‹ï¼Œä½†ä¹‹åæ‰§è¡Œä¸å®Œæˆå¯èƒ½ä¸æ˜¯é¡ºåºçš„ï¼Œè¿™äº›é˜¶æ®µé€šå¸¸æ˜¯äº¤å‰æ‰§è¡Œçš„ã€‚ 2 ç±»çš„åŠ è½½è¿‡ç¨‹2.1 åŠ è½½â€‹ åœ¨è¿™ä¸€é˜¶æ®µï¼Œè™šæ‹Ÿæœºé€šå¸¸éœ€è¦å®Œæˆä¸‰ä»¶äº‹æƒ…ï¼š 1ï¼‰é€šè¿‡ç±»çš„å…¨é™å®šåï¼ˆåŒ…å+ç±»åï¼‰ï¼Œè·å–åˆ°è¯¥ç±»çš„.classæ–‡ä»¶çš„äºŒè¿›åˆ¶å­—èŠ‚æµ 2ï¼‰å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ 3ï¼‰åœ¨Javaå †ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™äº›æ•°æ®çš„è®¿é—®å…¥å£ ç®€å•æ¥è¯´ï¼Œå°±å¦‚ä¸‹å›¾ â€‹ ä¸‹é¢å¯¹å†ç¨å¾®ç»†è¯´ä¸‹è¿™ä¸‰é˜¶æ®µ åŠ è½½äºŒè¿›åˆ¶æ•°æ®åˆ°å†…å­˜ â€‹ è¿™ä¸€é˜¶æ®µå¹¶æ²¡æœ‰è¯´æ˜ä»å“ªé‡Œè·å–ä»¥åŠæ€ä¹ˆè·å–ï¼Œè¿™æ˜¯äº¤ç»™å¼€å‘äººå‘˜è‡ªå®šä¹‰çš„ï¼Œä¸€èˆ¬çš„è¯»å–æ–¹å¼æœ‰ä»¥ä¸‹ ä»ZIPåŒ…ä¸­è·å–ï¼Œæˆ–è€…JARåŒ…ï¼ˆå¾ˆå¸¸è§ç°åœ¨ï¼‰ï¼ŒWARåŒ…ç­‰ ä»ç½‘ç»œè·å–ï¼Œä¾‹å¦‚Applet è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯ â€¦â€¦ æ˜ å°„jvmèƒ½å¤Ÿè¯†åˆ«çš„ç»“æ„ â€‹ å°†æ˜ å°„åå¯ä»¥è¢«è™šæ‹Ÿæœºè¯†åˆ«çš„æ ¼å¼å­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­ï¼Œè¿™ç§æ•°æ®å­˜å‚¨æ ¼å¼æ˜¯ç”±è™šæ‹Ÿæœºè‡ªè¡Œå®šä¹‰ åœ¨å†…å­˜ä¸­ç”Ÿæˆclassæ–‡ä»¶ â€‹ åœ¨Javaå †ä¸­å®ä¾‹åŒ–ä¸€ä¸ªjava.lang.Classç±»çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°†ä½œä¸ºç¨‹åºè®¿é—®æ–¹æ³•åŒºä¸­çš„è¿™äº›ç±»å‹æ•°æ®çš„å¤–éƒ¨æ¥å£ 2.2 éªŒè¯â€‹ è¯¥é˜¶æ®µæ˜¯è¿æ¥é˜¶æ®µçš„ç¬¬ä¸€æ­¥ï¼Œè¿™æ˜¯è¦ç¡®ä¿å‰é¢åŠ è½½è¿›æ¥çš„å­—èŠ‚æµåŒ…å«çš„æ•°æ®ç¬¦åˆè¦æ±‚ï¼Œä¸ä¼šå±å®³åˆ°è™šæ‹Ÿæœºçš„å®‰å…¨ â€‹ ä¸€èˆ¬æœ‰ä»¥ä¸‹å››ä¸ªé˜¶æ®µçš„æ£€éªŒè¿‡ç¨‹ æ–‡ä»¶æ ¼å¼æ£€éªŒ â€‹ å­—èŠ‚æµæ˜¯å¦ç¬¦åˆClassæ–‡ä»¶æ ¼å¼çš„è§„èŒƒï¼Œå¹¶ä¸”èƒ½è¢«å½“å‰ç‰ˆæœ¬çš„è™šæ‹Ÿæœºå¤„ç†ã€‚ä¾‹å¦‚é­”æ•°å¼€å¤´æ˜¯å¦æ­£ç¡®ï¼Œç‰ˆæœ¬å·æ˜¯å¦åœ¨èŒƒå›´å†…ï¼Œå¸¸é‡æ± æ˜¯å¦æœ‰ä¸æ”¯æŒçš„å¸¸é‡ç­‰ å…ƒæ•°æ®éªŒè¯ â€‹ å¯¹æè¿°ä¿¡æ¯è¿›è¡Œè¯­ä¹‰åˆ†æï¼Œç¡®ä¿æè¿°çš„ä¿¡æ¯ç¬¦åˆJavaè¯­è¨€è§„èŒƒçš„è¦æ±‚ã€‚ä¾‹å¦‚è¯¥ç±»æ˜¯å¦æœ‰çˆ¶ç±»ï¼Œæ˜¯å¦ç»§æ‰¿äº†ä¸å…è®¸è¢«ç»§æ‰¿çš„ç±»ï¼Œå¦‚æœä¸æ˜¯æŠ½è±¡ç±»ï¼Œæ˜¯å¦å®ç°äº†è¯¥çˆ¶ç±»æˆ–æ¥å£è¦æ±‚å®ç°çš„æ‰€æœ‰æ–¹æ³•ã€‚ å­—èŠ‚ç éªŒè¯ â€‹ è¿›è¡Œæ•°æ®æµå’Œæ§åˆ¶æµåˆ†æï¼ˆå¯¹ç±»çš„æ–¹æ³•ä½“è¿›è¡Œæ ¡éªŒåˆ†æï¼‰ã€‚ä¾‹å¦‚ä¿è¯æ“ä½œæ•°æ ˆçš„æ•°æ®ç±»å‹å’ŒæŒ‡ä»¤ä»£ç åºåˆ—èƒ½å¤Ÿé…åˆå·¥ä½œï¼Œè·³è½¬æŒ‡ä»¤ä¸ä¼šè·³è½¬åˆ°æ–¹æ³•ä½“ä»¥å¤–çš„å­—èŠ‚ç æŒ‡ä»¤ä¸Šï¼Œä¿è¯æ–¹æ³•ä½“ç±»å‹è½¬åŒ–æœ‰æ•ˆã€‚ ç¬¦å·å¼•ç”¨éªŒè¯ â€‹ è¿™ä¼šå‘ç”Ÿåœ¨è™šæ‹Ÿæœºç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨çš„æ—¶å€™ï¼Œè¿™ä¸ªè½¬åŒ–åŠ¨ä½œå°†åœ¨è¿æ¥çš„ç¬¬ä¸‰é˜¶æ®µâ€”â€”è§£æé˜¶æ®µå‘ç”Ÿã€‚ â€‹ è¿™é‡Œç¬¦å·å¼•ç”¨æ˜¯æŒ‡ä»»ä½•å½¢å¼çš„å­—é¢é‡ï¼Œè¿™ä¸å†…å­˜å¸ƒå±€æ— å…³ï¼Œå¼•ç”¨çš„ç›®æ ‡ä¸ä¸€å®šåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¾‹å¦‚ï¼Œå¼•ç”¨äº†org.simple.peopleï¼Œé‚£ä¹ˆåˆ™ä½¿ç”¨org.simple.peopleæ¥è¡¨ç¤ºè¯¥ç±»çš„åœ°å€ã€‚è€Œç›´æ¥å¼•ç”¨æ˜¯åˆ™å¯ä»¥æ˜¯æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆï¼Œç›¸å¯¹åç§»é‡ï¼Œå¥æŸ„ç­‰ï¼Œè¯¥å¼•ç”¨çš„ç›®æ ‡å¿…å®šå­˜åœ¨äºè™šæ‹Ÿæœºå†…å­˜ä¸­ â€‹ é€šå¸¸è¿™é‡Œè¦æ£€æŸ¥ä»¥ä¸‹å†…å®¹ ç¬¦å·å¼•ç”¨ä¸­é€šè¿‡å­—ç¬¦ä¸²æè¿°çš„å…¨é™å®šåæ˜¯å¦èƒ½æ‰¾åˆ°å¯¹åº”çš„ç±» åœ¨æŒ‡å®šç±»ä¸­æ˜¯å¦å­˜åœ¨ç¬¦åˆæ–¹æ³•çš„å­—æ®µæè¿°ç¬¦åŠç®€å•åç§°æ‰€æè¿°çš„æ–¹æ³•å’Œå­—æ®µ â€¦. 2.3 å‡†å¤‡â€‹ è¿™ä¸€é˜¶æ®µå°†ä¼šä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼ï¼Œè¿™äº›å†…å­˜éƒ½ä¼šåœ¨æ–¹æ³•åŒºä¸­åˆ†é…ï¼ˆJDK1.6ï¼‰ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ç±»å˜é‡æ˜¯æŒ‡è¢«staticä¿®é¥°çš„å˜é‡ï¼Œå®ä¾‹å˜é‡å°†ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–éšç€å¯¹è±¡åˆ†é…åˆ°Javaå †ä¸­ã€‚å¹¶ä¸”ï¼Œåˆå§‹å€¼æ˜¯æŒ‡æ•°æ®ç±»å‹çš„é›¶å€¼ 1public static int value = 123; â€‹ è¿™é‡Œï¼Œå‡†å¤‡é˜¶æ®µåï¼Œåˆå§‹å€¼ä¸º0ï¼Œä¸æ˜¯123ï¼Œå°†valueèµ‹å€¼ä¸º123çš„æ“ä½œåœ¨åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šæ‰§è¡Œ â€‹ ä½†ä¼šå­˜åœ¨ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æœæŸä¸ªå˜é‡æ˜¯ä¸å¯å˜çš„ï¼Œä¾‹å¦‚ä¸Šè¿°å˜é‡å®šä¹‰ä¸ºï¼š 1public static final int value = 123; â€‹ è¿™æ ·ï¼Œå‡†å¤‡é˜¶æ®µè™šæ‹Ÿæœºå°±ä¼šæ ¹æ®ConstantValueçš„è®¾ç½®å°†valueèµ‹å€¼ä¸º123 2.4 è§£æâ€‹ è¿™ä¸€é˜¶æ®µå°†ä¼šå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚ç¬¦å·å¼•ç”¨çš„è§£æå¯ä»¥å‡ºç°å¤šæ¬¡ï¼Œè™šæ‹Ÿæœºå®ç°å¯èƒ½ä¼šå¯¹ç¬¬ä¸€æ¬¡è§£æçš„ç»“æœè¿›è¡Œç¼“å­˜ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨ã€‚ â€‹ è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ä»¥ä¸‹å››ç±»è¿›è¡Œ ç±»æˆ–æ¥å£çš„è§£æ å­—æ®µè§£æ ç±»æ–¹æ³•è§£æ æ¥å£æ–¹æ³•è§£æ â€‹ ç”±äºè¿™äº›ç¯‡å¹…è¿‡é•¿ï¼Œå°±ä¸ç»†è¯´ï¼Œå…·ä½“æŸ¥çœ‹ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ 2.5 åˆå§‹åŒ–â€‹ è¿™ä¸€é˜¶æ®µæ˜¯é€šè¿‡ç¨‹åºåˆ¶å®šçš„ä¸»è§‚è®¡åˆ’å»åˆå§‹åŒ–ç±»å˜é‡å’Œå…¶ä»–èµ„æºï¼Œä»å¦ä¸€æ–¹é¢è¯´ï¼Œæ˜¯æ‰§è¡Œç±»æ„é€ å™¨&lt;clinit&gt;()æ–¹æ³•çš„è¿‡ç¨‹ã€‚è¿™ä¸€æ–¹æ³•è¿è¡Œçš„è¡Œä¸ºå’Œç»†èŠ‚å¦‚ä¸‹ï¼š &lt;clinit&gt;()æ–¹æ³•æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼æ“ä½œå’Œstatic{}å—åˆå¹¶äº§ç”Ÿã€‚ &lt;clinit&gt;()æ–¹æ³•ä¸ç±»çš„æ„é€ å‡½æ•°ä¸åŒï¼Œä¸éœ€è¦æ˜¾å¼è°ƒç”¨çˆ¶ç±»æ„é€ å™¨ï¼Œçˆ¶ç±»çš„&lt;clinit&gt;()æ–¹æ³•å·²ç»æ‰§è¡Œå®Œæ¯• é€šè¿‡ä»¥ä¸Šä¸¤ç‚¹å¯çŸ¥ï¼Œçˆ¶ç±»å®šä¹‰çš„é™æ€è¯­å¥å—è¦ä¼˜äºå­ç±»çš„å˜é‡èµ‹å€¼æ“ä½œ &lt;clinit&gt;()æ–¹æ³•å¯¹äºç±»æˆ–æ¥å£æ¥è¯´å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœä¸€ä¸ªç±»ä¸­æ²¡æœ‰é™æ€è¯­å¥å—ï¼Œä¹Ÿæ²¡æœ‰å¯¹å˜é‡çš„èµ‹å€¼æ“ä½œï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å¯ä»¥ä¸ä¸ºè¿™ä¸ªç±»ç”Ÿæˆ&lt;clinit&gt;()æ–¹æ³•ã€‚ æ¥å£ä¸­ä¸èƒ½ä½¿ç”¨é™æ€è¯­å¥å—ï¼Œä½†ä»ç„¶æœ‰å˜é‡åˆå§‹åŒ–çš„èµ‹å€¼æ“ä½œï¼Œå› æ­¤æ¥å£ä¸ç±»ä¸€æ ·éƒ½ä¼šç”Ÿæˆ&lt;clinit&gt;()æ–¹æ³•ã€‚ä½†æ¥å£ä¸ç±»ä¸åŒçš„æ˜¯ï¼Œæ‰§è¡Œæ¥å£çš„&lt;clinit&gt;()æ–¹æ³•ä¸éœ€è¦å…ˆæ‰§è¡Œçˆ¶æ¥å£çš„&lt;clinit&gt;()æ–¹æ³•ã€‚åªæœ‰å½“çˆ¶æ¥å£ä¸­å®šä¹‰çš„å˜é‡è¢«ä½¿ç”¨æ—¶ï¼Œçˆ¶æ¥å£æ‰ä¼šè¢«åˆå§‹åŒ–ã€‚å¦å¤–ï¼Œæ¥å£çš„å®ç°ç±»åœ¨åˆå§‹åŒ–æ—¶ä¹Ÿä¸€æ ·ä¸ä¼šæ‰§è¡Œæ¥å£çš„&lt;clinit&gt;()æ–¹æ³•ã€‚ è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„&lt;clinit&gt;()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«æ­£ç¡®åœ°åŠ é”å’ŒåŒæ­¥ 3 ç±»åŠ è½½å™¨â€‹ é€šè¿‡å¯¹å‰é¢ç±»åŠ è½½è¿‡ç¨‹çš„é˜è¿°ï¼Œå¯ä»¥å‘ç°é™¤äº†åœ¨åŠ è½½é˜¶æ®µç”¨æˆ·åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨å‚ä¸ä¹‹å¤–ï¼Œå…¶ä½™åŠ¨ä½œå®Œå…¨ç”±è™šæ‹Ÿæœºä¸»å¯¼å’Œæ§åˆ¶ã€‚ç±»åŠ è½½å™¨æé«˜äº†JVMçš„å¯æ‰©å±•æ€§ï¼Œæ˜¯Javaè¯­è¨€æµè¡Œä¸€å¤§åŸå› ã€‚ 3.1 åŒäº²å§”æ´¾æ¨¡å‹â€‹ ç»å¤§éƒ¨åˆ†Javaç¨‹åºéƒ½ä¼šä½¿ç”¨åˆ°ä»¥ä¸‹ä¸‰ç§ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨ï¼š å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰ â€‹ åº”ç”¨ç¨‹åºéƒ½æ˜¯ç”±è¿™ä¸‰ç±»ç±»åŠ è½½å™¨äº’ç›¸é…åˆè¿›è¡ŒåŠ è½½çš„ï¼Œå¦‚æœæœ‰å¿…è¦ï¼Œå¯ä»¥åŠ å…¥è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ â€‹ åŒäº²å§”æ´¾æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚ â€‹ åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œæµç¨‹ï¼š ä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°ç±»åŠ è½½çš„è¯·æ±‚ï¼Œä¸ä¼šé¦–å…ˆè‡ªå·±å°è¯•åŠ è½½è¯¥ç±» å°†è¯¥è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œå¯¹äºæ¯ä¸ªå±‚æ¬¡çš„ç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ æ‰€æœ‰çš„åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ åªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªè¯·æ±‚æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ â€‹ ä½¿ç”¨è¯¥æ¨¡å‹çš„å¥½å¤„æœ‰å¦‚ä¸‹ï¼š Javaç±»å’Œå®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³» â€‹ ä¾‹å¦‚ç±»java.lang.Objectï¼Œå®ƒå­˜æ”¾åœ¨rt.jarä¹‹ä¸­ï¼Œæ— è®ºå“ªä¸€ä¸ªç±»åŠ è½½å™¨è¦åŠ è½½è¿™ä¸ªç±»ï¼Œæœ€ç»ˆéƒ½æ˜¯å§”æ´¾ç»™å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå› æ­¤Objectç±»åœ¨ç¨‹åºçš„å„ç§ç±»åŠ è½½å™¨ç¯å¢ƒä¸­éƒ½æ˜¯åŒä¸€ä¸ªç±»ã€‚ç›¸åï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹ï¼Œç”±å„ä¸ªç±»åŠ è½½å™¨è‡ªè¡Œå»åŠ è½½çš„è¯ï¼Œå¦‚æœç”¨æˆ·è‡ªå·±å†™äº†ä¸€ä¸ªåä¸ºjava.lang.Objectçš„ç±»ï¼Œå¹¶æ”¾åœ¨ç¨‹åºçš„ClassPathä¸­ï¼Œé‚£ç³»ç»Ÿä¸­å°†ä¼šå‡ºç°å¤šä¸ªä¸åŒçš„Objectç±»ï¼ŒJavaç±»å‹ä½“ç³»ä¸­æœ€åŸºç¡€çš„è¡Œä¸ºä¹Ÿå°±æ— ä»ä¿è¯ï¼Œåº”ç”¨ç¨‹åºä¹Ÿå°†ä¼šå˜å¾—ä¸€ç‰‡æ··ä¹±ã€‚å¦‚æœæ‚¨æœ‰ ä¸Šé¢çš„å¥½å¤„ä¹Ÿä»ä¸€å®šç¨‹åº¦ä¸Šé˜²æ­¢äº†å±é™©ä»£ç çš„æ¤å…¥ å‚è€ƒã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-ç¬¬3ç‰ˆã€‹ jvmç±»åŠ è½½å™¨ï¼Œç±»åŠ è½½æœºåˆ¶è¯¦è§£ï¼Œçœ‹è¿™ä¸€ç¯‡å°±å¤Ÿäº† - SegmentFault æ€å¦ Javaç±»åŠ è½½æœºåˆ¶ï¼ˆå…¨å¥—ï¼‰ - æ˜é‡‘ (juejin.cn) Javaè™šæ‹Ÿæœº - ç¬¦å·å¼•ç”¨å’Œç›´æ¥å¼•ç”¨ç†è§£ - qlky - åšå®¢å›­ (cnblogs.com) (99æ¡æ¶ˆæ¯) ç¬¦å·å¼•ç”¨å’Œç›´æ¥å¼•ç”¨æœ‰ä»€ä¹ˆåŒºåˆ«_ç»…å£«jiejieçš„åšå®¢-CSDNåšå®¢_ç¬¦å·å¼•ç”¨å’Œç›´æ¥å¼•ç”¨çš„åŒºåˆ«","link":"/2022/02/07/Java/Java%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/"},{"title":"ç¬¬279åœºå‘¨èµ›","text":"6000. å¯¹å¥‡å¶ä¸‹æ ‡åˆ†åˆ«æ’åº123456789101112131415161718class Solution {public: vector&lt;int&gt; sortEvenOdd(vector&lt;int&gt;&amp; nums) { vector&lt;int&gt; vec1, vec2; for (int i = 0; i &lt; nums.size(); i ++) { if (i % 2 == 0) vec1.push_back(nums[i]); // å¶æ•° else vec2.push_back(nums[i]); // å¥‡æ•° } sort(vec1.begin(), vec1.end()); sort(vec2.begin(), vec2.end(), greater&lt;int&gt;()); vector&lt;int&gt; res; for (int i = 0, j = 0, k = 0; i &lt; nums.size(); i ++) { if (i % 2 == 0) res.push_back(vec1[j ++]); else res.push_back(vec2[k ++]); } return res; }}; 6001. é‡æ’æ•°å­—çš„æœ€å°å€¼1234567891011121314151617181920212223242526272829303132333435363738394041424344454647class Solution {public: vector&lt;int&gt; getNum(long long num) { vector&lt;int&gt; a; while(num) { a.push_back(num % 10); num /= 10; } return a; } long long smallestNumber(long long num) { long long res = 0; if (num &gt; 0) { auto a = getNum(num); sort(a.begin(), a.end()); int i = 0, n =a.size(), k = 0; bool flag = true; vector&lt;int&gt; vec; for (int i = 0; i &lt; n; i ++) { if (a[i] != 0 &amp;&amp; flag){ k = i, flag = !flag; continue; } vec.push_back(a[i]); } res += a[k] * pow(10, n - 1); int cnt = vec.size() - 1; for (int i = 0; i &lt; vec.size(); i ++) { res += vec[i] * pow(10, cnt); cnt --; } } else { long long n1 = -num; auto a = getNum(n1); sort(a.begin(), a.end(), greater&lt;int&gt;()); int cnt = a.size() - 1; for (int i = 0; i &lt; a.size(); i ++) { res += a[i] * pow(10, cnt); cnt --; } res = -res; } return res; }}; 6002. è®¾è®¡ä½é›†123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172class Bitset {public: string bst, fbst; int cnt; bool flipped; // åˆ¤æ–­æ˜¯å¦ç¿»è½¬ Bitset(int size) { bst = string(size, '0'); fbst = string(size, '1'); cnt = 0; flipped = false; } void fix(int idx) { if (!flipped) { if (bst[idx] == '0') cnt ++; bst[idx] = '1'; fbst[idx] = '0'; } else { if (bst[idx] == '1') cnt ++; // å¦‚æœç¿»è½¬äº†ï¼Œåˆ™æ˜¯fbitï¼Œé‚£ä¹ˆç¿»è½¬å‰æ˜¯1ï¼Œç¿»è½¬åæ˜¯0ï¼Œfixè®¾ç½®fbitï¼Œåˆ™åŠ 1 bst[idx] = '0'; fbst[idx] = '1'; } } void unfix(int idx) { if (!flipped) { if (bst[idx] == '1') cnt --; bst[idx] = '0'; fbst[idx] = '1'; } else { if (bst[idx] == '0') cnt --; bst[idx] = '1'; fbst[idx] = '0'; } } void flip() { flipped = !flipped; cnt = bst.size() - cnt; } bool all() { return cnt == bst.size(); } bool one() { return cnt &gt; 0; } int count() { return cnt; } string toString() { if (!flipped) return bst; else return fbst; }};/** * Your Bitset object will be instantiated and called as such: * Bitset* obj = new Bitset(size); * obj-&gt;fix(idx); * obj-&gt;unfix(idx); * obj-&gt;flip(); * bool param_4 = obj-&gt;all(); * bool param_5 = obj-&gt;one(); * int param_6 = obj-&gt;count(); * string param_7 = obj-&gt;toString(); */ 6003. ç§»é™¤æ‰€æœ‰è½½æœ‰è¿ç¦è´§ç‰©è½¦å¢æ‰€éœ€çš„æœ€å°‘æ—¶é—´å‰åç¼€åˆ†è§£ + DP - ç§»é™¤æ‰€æœ‰è½½æœ‰è¿ç¦è´§ç‰©è½¦å¢æ‰€éœ€çš„æœ€å°‘æ—¶é—´ 1234567891011121314151617181920212223242526class Solution {public: /* è€ƒè™‘å·¦åŠéƒ¨åˆ†çš„æœ€å°‘æ—¶é—´ã€‚ å½“s[i] == '0' pre[i] = pre[i - 1] å½“s[i] == '1' pre[i] = min(pre[i - 1] + 2, i + 1) è€ƒè™‘å³åŠéƒ¨åˆ†çš„æœ€å°‘æ—¶é—´ s[i] == '0' , suf[i] = suf[i + 1] s[i] == '1' , suf[i] = min(suf[i + 1] + 2, n - i) */ int minimumTime(string s) { int n = s.length(); vector&lt;int&gt; suf(n + 1, 0); // ç§»é™¤åiä¸ªè½½æœ‰è¿ç¦è´§ç‰©è½¦æ‰€éœ€çš„æœ€å°‘å•ä½æ—¶é—´æ•° for (int i = n - 1; i &gt;= 0; i --) { suf[i] = s[i] == '0' ? suf[i + 1] : min(suf[i + 1] + 2, n - i); } // æšä¸¾åˆ†å‰²ç‚¹ int pre = 0, ans = suf[0]; // preä½¿ç”¨æ»šåŠ¨æ•°ç»„ä¼˜åŒ– for (int i = 0; i &lt; n; i ++) { if (s[i] == '1') pre = min(pre + 2, i + 1); ans = min(ans, pre + suf[i]); } return ans; }};","link":"/2022/02/06/LC%E5%91%A8%E8%B5%9B/%E7%AC%AC279%E5%9C%BA%E5%91%A8%E8%B5%9B/"},{"title":"ç¬¬71å‘¨åŒå‘¨èµ›","text":"5984. æ‹†åˆ†æ•°ä½åå››ä½æ•°å­—çš„æœ€å°å’Œ123456789101112131415161718192021222324class Solution {public: int minimumSum(int num) { vector&lt;int&gt; vec; int t = num; while (t) { vec.push_back(t % 10); t /= 10; } sort(vec.begin(), vec.end()); int zero = count(vec.begin(), vec.end(), 0); if (zero == 3) { return vec[3]; } else if (zero == 2) { return vec[2] + vec[3]; } else if (zero == 1) { if (vec[2] &gt; vec[3]) return vec[1] * 10 + vec[3] + vec[2]; return vec[1] * 10 + vec[2] + vec[3]; } else { return vec[0] * 10 + vec[2] + vec[1] * 10 + vec[3]; } return 0; }}; 5985. æ ¹æ®ç»™å®šæ•°å­—åˆ’åˆ†æ•°ç»„1234567891011121314151617class Solution {public: vector&lt;int&gt; pivotArray(vector&lt;int&gt;&amp; nums, int pivot) { vector&lt;int&gt; vec1; for (auto num: nums) if (num &lt; pivot) vec1.push_back(num); vector&lt;int&gt; vec2; for (auto num: nums) if (num &gt; pivot) vec2.push_back(num); int tot = count(nums.begin(), nums.end(), pivot); vector&lt;int&gt; res; for (auto i: vec1) res.push_back(i); for (int i = 0; i &lt; tot; i ++) res.push_back(pivot); for (auto i: vec2) res.push_back(i); return res; }}; 5986. è®¾ç½®æ—¶é—´çš„æœ€å°‘ä»£ä»·123456789101112131415161718192021222324252627282930313233class Solution {public: /* åˆ†ç±»è®¨è®º å› ä¸ºç§’æ•°çš„èŒƒå›´[0,99], åˆ†ä¸¤ç§åœºæ™¯è®¨è®º: a. mins = target / 60, secs = target % 60; b. mins = target / 60 - 1, secs = target % 60 + 60; å°†mins*100+secsè½¬ä¸ºå­—ç¬¦ä¸²è¿›è¡Œå¤„ç†, æ±‚å‡ºèŠ±è´¹çš„æ—¶é—´å³å¯; */ int minCostSetTime(int startAt, int moveCost, int pushCost, int targetSeconds) { int mins = targetSeconds / 60, secs = targetSeconds % 60; int ans1 = calTime(startAt, moveCost, pushCost, mins, secs); int ans2 = calTime(startAt, moveCost, pushCost, mins - 1, secs + 60); return min(ans1, ans2); } int calTime(int startAt, int moveCost, int pushCost, int mins, int secs) { if (mins &lt; 0 || mins &gt; 99 || secs &gt; 99) { return INT_MAX; } string s = to_string(mins * 100 + secs); int ans = 0; for (int i = 0; i &lt; s.size(); i ++) { if (s[i] - '0' == startAt) { ans += pushCost; } else { ans += pushCost + moveCost; } startAt = s[i] - '0'; } return ans; }}; 5987. åˆ é™¤å…ƒç´ åå’Œçš„æœ€å°å·®å€¼1234567891011121314151617181920212223242526272829303132333435363738394041class Solution {public: /* æšä¸¾iä¸ºåˆ†ç•Œç‚¹ï¼Œç»´æŠ¤0-iå†…é•¿åº¦ä¸ºn / 3 çš„æœ€å°å€¼ï¼Œi + 1 - n - 1å†…é•¿åº¦ä¸ºn / 3çš„æœ€å¤§å€¼ */ long long minimumDifference(vector&lt;int&gt;&amp; nums) { int n = nums.size(), k = n / 3; vector&lt;long long&gt; s1(n, 0); priority_queue&lt;int&gt; small; // å¤§æ ¹å †ï¼Œç»´æŠ¤0 - iå†…çš„æœ€å°å€¼ for (int i = 0; i &lt; 2 * k; i ++) { s1[i] = (i &gt; 0) ? s1[i - 1] : 0; small.push(nums[i]); s1[i] += nums[i]; if (small.size() &gt; k) { s1[i] -= small.top(); small.pop(); } } vector&lt;long long&gt; s2(n, 0); priority_queue&lt;int, vector&lt;int&gt;, greater&lt;int&gt;&gt; big; // å°æ ¹å †ï¼Œç»´æŠ¤ i + 1 - n - 1å†…çš„æœ€å¤§å€¼ for (int i = n - 2; i &gt;= k - 1; i --) { // æ³¨æ„è¿™é‡Œæ˜¯n - 2çš„åŸå› æ˜¯ï¼Œä¸‹é¢è®¡ç®—ç­”æ¡ˆæ˜¯ä» k - 1 ~ 2 *k - 1ï¼Œå¦‚æœä¸ºn-1ï¼Œä¼šå¤šç®—ä¸€ä¸ªæ•°è¿›æ¥ // ä¾‹å¦‚ 1 2 3 4 5 6 ï¼Œn-2ä¼šä½¿å¾—ä¸‹æ ‡ä¸º1çš„ä½ç½®s[1] è¡¨ç¤º å4ä¸ªæ•°ä¸­æœ€å¤§å€¼ï¼Œn-1åˆ™è¡¨ç¤º5ä¸ªæ•°äº† s2[i] = s2[i + 1]; big.push(nums[i + 1]); s2[i] += nums[i + 1]; if (big.size() &gt; k) { s2[i] -= big.top(); big.pop(); } } long long res = 1e15; for (int i = k - 1; i &lt; 2 * k; i ++) { res = min(res, s1[i] - s2[i]); } return res; }};","link":"/2022/02/06/LC%E5%91%A8%E8%B5%9B/%E7%AC%AC71%E5%91%A8%E5%8F%8C%E5%91%A8%E8%B5%9B/"},{"title":"dubboä»å…¥é—¨åˆ°å®æˆ˜","text":"1 äº’è”ç½‘ç³»ç»Ÿæ¶æ„æ¼”å˜â€‹ éšç€äº’è”ç½‘çš„å‘å±•ï¼Œç½‘ç«™åº”ç”¨è§„æ¨¡ä¸æ–­å£®å¤§ï¼Œç”±æ­¤ç³»ç»Ÿæ¶æ„ä¹Ÿåœ¨ä¸æ–­æ¼”å˜ï¼Œä¸‹å›¾æ˜¯ä¸€å¼ ç»å…¸çš„æ¼”å˜è¿‡ç¨‹å›¾ï¼š å•ä¸€åº”ç”¨æ¶æ„ â€‹ ä¼˜ç‚¹ï¼šå½“ç½‘ç«™æµé‡å¾ˆå°æ—¶ï¼Œåªéœ€ä¸€ä¸ªåº”ç”¨ï¼Œå°†æ‰€æœ‰åŠŸèƒ½å¦‚ä¸‹å•æ”¯ä»˜ç­‰éƒ½éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œä»¥å‡å°‘éƒ¨ç½²èŠ‚ç‚¹å’Œæˆæœ¬ â€‹ ç¼ºç‚¹ï¼šå•ä¸€çš„ç³»ç»Ÿæ¶æ„ï¼Œä½¿å¾—åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå ç”¨çš„èµ„æºè¶Šæ¥è¶Šå¤šï¼Œè€Œä¸”éšç€æµé‡çš„å¢åŠ è¶Šæ¥è¶Šéš¾ä»¥ç»´æŠ¤ â€‹ æ­¤æ—¶ï¼šç”¨äºç®€åŒ–å¢åˆ æ”¹æŸ¥å·¥ä½œé‡çš„æ•°æ®è®¿é—®æ¡†æ¶ï¼ˆORMï¼‰æ˜¯å…³é”® å‚ç›´åº”ç”¨æ¶æ„ â€‹ ä¼˜ç‚¹ï¼šè§£å†³äº†å•ä¸€åº”ç”¨æ¶æ„æ‰€é¢ä¸´çš„æ‰©å®¹é—®é¢˜ï¼Œæµé‡èƒ½å¤Ÿåˆ†æ•£åˆ°å„ä¸ªå­ç³»ç»Ÿå½“ä¸­ï¼Œä¸”ç³»ç»Ÿçš„ä½“ç§¯å¯æ§ï¼Œä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†å¼€å‘äººå‘˜ä¹‹é—´ååŒä»¥åŠç»´æŠ¤çš„æˆæœ¬ï¼Œæå‡äº†å¼€å‘æ•ˆç‡ â€‹ ç¼ºç‚¹ï¼šä½†æ˜¯åœ¨å‚ç›´æ¶æ„ä¸­ç›¸åŒé€»è¾‘ä»£ç éœ€è¦ä¸æ–­çš„å¤åˆ¶ï¼Œä¸èƒ½å¤ç”¨ã€‚ â€‹ æ­¤æ—¶ï¼šç”¨äºåŠ é€Ÿå‰ç«¯é¡µé¢å¼€å‘çš„Webæ¡†æ¶ï¼ˆMVCï¼‰æ˜¯å…³é”® åˆ†å¸ƒå¼åº”ç”¨æ¶æ„ï¼ˆRPCï¼‰ â€‹ å½“å‚ç›´åº”ç”¨è¶Šæ¥è¶Šå¤šï¼Œåº”ç”¨ä¹‹é—´äº¤äº’ä¸å¯é¿å…ï¼Œå°†æ ¸å¿ƒä¸šåŠ¡æŠ½å–å‡ºæ¥ï¼Œä½œä¸ºç‹¬ç«‹çš„æœåŠ¡ï¼Œé€æ¸å½¢æˆç¨³å®šçš„æœåŠ¡ä¸­å¿ƒ â€‹ æ­¤æ—¶ï¼šç”¨äºæé«˜ä¸šåŠ¡å¤ç”¨åŠæ•´åˆçš„åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ï¼ˆRPCï¼‰æ˜¯å…³é”® æµåŠ¨è®¡ç®—æ¶æ„ï¼ˆSOAï¼‰ â€‹ éšç€æœåŠ¡åŒ–çš„è¿›ä¸€æ­¥å‘å±•ï¼ŒæœåŠ¡è¶Šæ¥è¶Šå¤šï¼ŒæœåŠ¡ä¹‹é—´çš„è°ƒç”¨å’Œä¾èµ–å…³ç³»ä¹Ÿè¶Šæ¥è¶Šå¤æ‚ï¼Œè¯ç”Ÿäº†é¢å‘æœåŠ¡çš„æ¶æ„ä½“ç³»(SOA)ï¼Œä¹Ÿå› æ­¤è¡ç”Ÿå‡ºäº†ä¸€ç³»åˆ—ç›¸åº”çš„æŠ€æœ¯ï¼Œå¦‚å¯¹æœåŠ¡æä¾›ã€æœåŠ¡è°ƒç”¨ã€è¿æ¥å¤„ç†ã€é€šä¿¡åè®®ã€åºåˆ—åŒ–æ–¹å¼ã€æœåŠ¡å‘ç°ã€æœåŠ¡è·¯ç”±ã€æ—¥å¿—è¾“å‡ºç­‰è¡Œä¸ºè¿›è¡Œå°è£…çš„æœåŠ¡æ¡†æ¶ â€‹ æ­¤æ—¶ï¼Œç”¨äºæé«˜æœºå™¨åˆ©ç”¨ç‡**èµ„æºè°ƒåº¦å’Œæ²»ç†ä¸­å¿ƒ(SOA)**æ˜¯å…³é”®ã€‚ 2 ä»€ä¹ˆæ˜¯Dubboâ€‹ Dubboæ˜¯ä¸€ä¸ªå¾®æœåŠ¡å¼€å‘æ¡†æ¶ï¼Œæä¾›äº†RPCé€šä¿¡ä¸å¾®æœåŠ¡æ²»ç†ä¸¤å¤§å…³é”®èƒ½åŠ›ã€‚å®ƒæä¾›äº†è¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„èƒ½åŠ›ï¼Œä½¿å¾—è¿œç¨‹è°ƒç”¨åƒæœ¬åœ°è°ƒç”¨ä¸€æ ·æ–¹ä¾¿ â€‹ Dubboæä¾›çš„åŸºç¡€èƒ½åŠ›åŒ…æ‹¬ï¼š æœåŠ¡å‘ç° æµå¼é€šä¿¡ è´Ÿè½½å‡è¡¡ æµé‡æ²»ç† é›†ç¾¤å®¹é”™ æœåŠ¡é™çº§ â€¦ 3 Dubboæ€»ä½“æ¶æ„â€‹ ä»¥ä¸‹æ˜¯å®˜ç½‘çš„ä¸€å¼ å›¾ èŠ‚ç‚¹ è¯´æ˜ Consumer éœ€è¦è°ƒç”¨è¿œç¨‹æœåŠ¡çš„æœåŠ¡æ¶ˆè´¹æ–¹ Registry æ³¨å†Œä¸­å¿ƒ Provider æœåŠ¡æä¾›æ–¹ Container æœåŠ¡è¿è¡Œçš„å®¹å™¨ Monitor ç›‘æ§ä¸­å¿ƒ â€‹ é€šè¿‡ä¸Šå›¾ï¼Œå¯ä»¥çŸ¥é“æœåŠ¡å‘ç°æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š æœåŠ¡æä¾›è€…Providerå¯åŠ¨ç„¶åå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±æ‰€èƒ½æä¾›çš„æœåŠ¡ã€‚ æ¶ˆè´¹è€…Consumerå¯åŠ¨å‘æ³¨å†Œä¸­å¿ƒè®¢é˜…æ‰€éœ€çš„æœåŠ¡ã€‚ ç„¶åæ³¨å†Œä¸­å¿ƒè¿”å›æœåŠ¡æä¾›è€…åœ°å€åˆ—è¡¨ç»™æ¶ˆè´¹è€…Consumerï¼Œå¦‚æœæœ‰å˜æ›´ï¼Œæ³¨å†Œä¸­å¿ƒå°†åŸºäºé•¿è¿æ¥æ¨é€å˜æ›´æ•°æ®ç»™æ¶ˆè´¹è€…Consumerã€‚ æ¶ˆè´¹è€…Consumerå°±å¯ä»¥è´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€ä¸ªProvierç›´æ¥è°ƒç”¨ã€‚ æ³¨å†Œä¸­å¿ƒè¿”å›æœåŠ¡æä¾›è€…åœ°å€åˆ—è¡¨ç»™æ¶ˆè´¹è€…ï¼Œå¦‚æœæœ‰å˜æ›´ï¼Œæ³¨å†Œä¸­å¿ƒå°†åŸºäºé•¿è¿æ¥æ¨é€å˜æ›´æ•°æ®ç»™æ¶ˆè´¹è€…ã€‚ 4 å¿«é€Ÿå…¥é—¨â€‹ æ–°å»ºä¸¤ä¸ªMavené¡¹ç›®ï¼ŒJDKç‰ˆæœ¬1.8ï¼ŒDubboç‰ˆæœ¬2.7ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œä¸€ä¸ªæä¾›è€… å¼•å…¥ä¾èµ– 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;parent&gt; &lt;artifactId&gt;dubbo&lt;/artifactId&gt; &lt;groupId&gt;com.tiza.leo&lt;/groupId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;/parent&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;artifactId&gt;dubbo_001_p&lt;/artifactId&gt; &lt;!--å¼•å…¥ä¾èµ–--&gt; &lt;dependencies&gt; &lt;!-- core context beans springä¸‰ä»¶å¥—--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-core&lt;/artifactId&gt; &lt;version&gt;4.3.4.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;version&gt;4.3.4.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-beans&lt;/artifactId&gt; &lt;version&gt;4.3.4.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;!-- dubbo 2.5.3--&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;dubbo&lt;/artifactId&gt; &lt;version&gt;2.5.3&lt;/version&gt; &lt;/dependency&gt; &lt;!-- zookeeper zkclient--&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt; &lt;artifactId&gt;zookeeper&lt;/artifactId&gt; &lt;version&gt;3.4.12&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.101tec&lt;/groupId&gt; &lt;artifactId&gt;zkclient&lt;/artifactId&gt; &lt;version&gt;0.10&lt;/version&gt; &lt;/dependency&gt; &lt;!-- junit--&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/project&gt; æä¾›ç«¯ä»£ç  UserService 12345678package com.w1nd.dubbo.service;public interface UserService { public String findName(String name); public void addUser(String username);} UserServiceImpl 12345678910111213package com.w1nd.dubbo.service;public class UserServiceImpl implements UserService { public String findName(String name) { System.out.println(&quot;å§“å:&quot; +name); return &quot;hello: &quot;+name; } public void addUser(String username) { System.out.println(&quot;æ·»åŠ ç”¨æˆ·,ç”¨æˆ·åä¸º: &quot;+username); }} spring-dubbo.xmlï¼ˆé‡è¦ï¼‰ 12345678910111213141516171819202122232425&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!--suppress SpringFacetInspection --&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:dubbo=&quot;http://code.alibabatech.com/schema/dubbo&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;&gt; &lt;!--é€šè¿‡dubooå‘å¸ƒæœåŠ¡ --&gt; &lt;dubbo:application name=&quot;dubbo_001_p&quot;&gt;&lt;/dubbo:application&gt; &lt;!--å°†æœåŠ¡æ³¨å†Œåˆ°æŒ‡å®šçš„æ³¨å†Œä¸­å¿ƒ--&gt; &lt;dubbo:registry address=&quot;multicast://224.5.6.7:1234&quot;&gt;&lt;/dubbo:registry&gt; &lt;!--æŒ‡å®šæœåŠ¡çš„åè®® å’Œ ä½¿ç”¨ç«¯å£å· æ³¨æ„æ­¤å¤„æœåŠ¡ç«¯ä½¿ç”¨å®¢æˆ·ç«¯æ— éœ€ä½¿ç”¨ --&gt; &lt;dubbo:protocol name=&quot;dubbo&quot; port=&quot;20880&quot;&gt;&lt;/dubbo:protocol&gt; &lt;dubbo:provider timeout=&quot;5000&quot;&gt;&lt;/dubbo:provider&gt; &lt;!--å®šä¹‰è¶…æ—¶æ—¶é—´æ–¹å¼ä¸€--&gt; &lt;!--æ³¨å†ŒæœåŠ¡åˆ°æ³¨å†Œä¸­å¿ƒ--&gt; &lt;dubbo:service interface=&quot;com.w1nd.dubbo.service.UserService&quot; ref=&quot;userService&quot; timeout=&quot;4000&quot;&gt; &lt;!--å®šä¹‰è¶…æ—¶æ—¶é—´æ–¹äºŒ--&gt; &lt;dubbo:method name=&quot;findName&quot; timeout=&quot;3000&quot;&gt;&lt;/dubbo:method&gt; &lt;!--å®šä¹‰è¶…æ—¶æ—¶é—´æ–¹å¼ä¸‰--&gt; &lt;/dubbo:service&gt; &lt;!--æœåŠ¡æä¾›è€…--&gt; &lt;bean id=&quot;userService&quot; class=&quot;com.w1nd.dubbo.service.UserServiceImpl&quot;&gt;&lt;/bean&gt; &lt;/beans&gt; æµ‹è¯•ä»£ç  1234567891011121314151617package com.w1nd.dubbo.publish;import org.springframework.context.support.ClassPathXmlApplicationContext;import java.io.IOException;import static org.junit.Assert.*;public class PublishServiceTest { public static void main(String[] args) throws IOException { ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(&quot;spring-dubbo.xml&quot;); System.out.println(&quot;æœåŠ¡æä¾›è€…,å¼€å§‹æä¾›æœåŠ¡.....&quot;); System.in.read(); }} æ¶ˆè´¹ç«¯ä»£ç  UserService 1234567package com.w1nd.dubbo.service;public interface UserService { public String findName(String name); public void addUser(String username);} spring-dubbo.xmlï¼ˆé‡è¦ï¼‰ 123456789101112131415161718192021&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!--suppress SpringFacetInspection --&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:dubbo=&quot;http://code.alibabatech.com/schema/dubbo&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;&gt; &lt;!--é€šè¿‡dubboæ¶ˆè´¹æœåŠ¡--&gt; &lt;dubbo:application name=&quot;dubbo_001_c&quot;/&gt; &lt;!--æŒ‡å®šçš„æ³¨å†Œä¸­å¿ƒ--&gt; &lt;dubbo:registry address=&quot;multicast://224.5.6.7:1234&quot;&gt;&lt;/dubbo:registry&gt; &lt;!--å…³é—­æ‰€æœ‰æœåŠ¡çš„å¯åŠ¨æ—¶æ£€æŸ¥ (æ²¡æœ‰æä¾›è€…æ—¶æŠ¥é”™)ï¼š--&gt; &lt;dubbo:consumer timeout=&quot;5000&quot; &gt;&lt;/dubbo:consumer&gt; &lt;!--å®šä¹‰è¶…æ—¶æ—¶é—´æ–¹å¼ä¸€--&gt; &lt;!--è°ƒç”¨æœåŠ¡--&gt; &lt;dubbo:reference id=&quot;userService&quot; interface=&quot;com.w1nd.dubbo.service.UserService&quot; timeout=&quot;4000&quot; &gt; &lt;!--å®šä¹‰è¶…æ—¶æ—¶é—´æ–¹å¼äºŒ--&gt; &lt;dubbo:method name=&quot;findName&quot; timeout=&quot;3000&quot;&gt;&lt;/dubbo:method&gt; &lt;!--å®šä¹‰è¶…æ—¶æ—¶é—´æ–¹å¼ä¸‰--&gt; &lt;/dubbo:reference&gt; &lt;/beans&gt; æµ‹è¯•ä»£ç  12345678910111213141516package com.w1nd.dubbo.invoke;import com.w1nd.dubbo.service.UserService;import org.springframework.context.support.ClassPathXmlApplicationContext;public class InvokeServiceTest { public static void main(String[] args) { ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(&quot;spring-dubbo.xml&quot;); UserService userService = (UserService) context.getBean(&quot;userService&quot;); userService.addUser(&quot;w1nd&quot;); /* String serverReturn = userService.findName(&quot;GouSheng&quot;); System.out.println(&quot;get message from server message is &quot; + serverReturn);*/ }} 5 é›†ç¾¤â€‹ ä¸åŒæ¶ˆè´¹è€…çš„ä½¿ç”¨ç«¯å£å·è®¾ç½®ä¸ä¸€æ ·ï¼Œå³å¯ã€‚ dubbo_cluster_001_p 1&lt;dubbo:protocol name=&quot;dubbo&quot; port=&quot;20881&quot;&gt;&lt;/dubbo:protocol&gt; dubbo_cluster_002_p 1&lt;dubbo:protocol name=&quot;dubbo&quot; port=&quot;20882&quot;&gt;&lt;/dubbo:protocol&gt; dubbo_cluster_003_p 1&lt;dubbo:protocol name=&quot;dubbo&quot; port=&quot;20883&quot;&gt;&lt;/dubbo:protocol&gt; å‚è€ƒ(96æ¡æ¶ˆæ¯) æœ‹å‹å›½ä¼å¹²äº†5å¹´javaï¼Œå±…ç„¶ä¸çŸ¥é“Dubboæ˜¯åšä»€ä¹ˆå‘¢ï¼Ÿæˆ‘çœŸä¿¡äº†ï¼_æ•–ä¸™-CSDNåšå®¢ Dubbo3 ç®€ä»‹ | Apache Dubbo","link":"/2022/02/04/%E6%A1%86%E6%9E%B6/dubbo%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98/"},{"title":"zookeeperåŸºæœ¬ä½¿ç”¨ä¸é›†ç¾¤æ­å»º","text":"1. ZKç®€ä»‹â€‹ ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œå¼€æ”¾æºç çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºåè°ƒæœåŠ¡ã€‚ 2. ZKæ•°æ®æ¨¡å‹2.1 æ¨¡å‹ç»“æ„â€‹ 2.2 æ¨¡å‹çš„ç‰¹ç‚¹ æ¯ä¸ªå­ç›®å½•å¦‚/node1éƒ½è¢«ç§°ä½œä¸€ä¸ªznodeï¼ˆèŠ‚ç‚¹ï¼‰ã€‚è¿™ä¸ªznodeæ˜¯å®ƒæ‰€åœ¨çš„è·¯å¾„å”¯ä¸€æ ‡è¯† znodeå¯ä»¥æœ‰å­èŠ‚ç‚¹ç›®å½•ï¼Œå¹¶ä¸”æ¯ä¸ªznodeå¯ä»¥å­˜å‚¨æ•°æ® znodeæ˜¯æœ‰æœ‰ç‰ˆæœ¬çš„ï¼Œæ¯ä¸ªznodeä¸­å­˜å‚¨çš„æ•°æ®å¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè®¿é—®è·¯å¾„ä¸­å¯ä»¥å­˜å‚¨å¤šä»½æ•°æ® znodeæ˜¯å¯ä»¥è¢«ç›‘æ§ï¼ŒåŒ…æ‹¬è¿™ä¸ªç›®å½•èŠ‚ç‚¹ä¸­å­˜å‚¨çš„æ•°æ®çš„ä¿®æ”¹ï¼Œå­èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–ç­‰ï¼Œä¸€æ—¦å˜åŒ–å¯ä»¥é€šçŸ¥è®¾ç½®ç›‘æ§çš„å®¢æˆ·ç«¯ 3. èŠ‚ç‚¹çš„åˆ†ç±»3.1 æŒä¹…èŠ‚ç‚¹ï¼ˆPERSISTENTï¼‰â€‹ æŒ‡åœ¨èŠ‚ç‚¹åˆ›å»ºåï¼Œå°±ä¸€ç›´å­˜åœ¨ï¼ŒçŸ¥é“æœ‰åˆ é™¤æ“ä½œæ¥ä¸»åŠ¨åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹â€“ä¼šå› ä¸ºåˆ›å»ºè¯¥èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆè€Œæ¶ˆå¤± 3.2 æŒä¹…é¡ºåºèŠ‚ç‚¹ï¼ˆPERSISTENT_SEQUENTIALï¼‰â€‹ è¿™ç±»èŠ‚ç‚¹çš„åŸºæœ¬ç‰¹æ€§å’Œä¸Šé¢çš„èŠ‚ç‚¹ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚é¢å¤–çš„ç‰¹æ€§æ˜¯ï¼Œåœ¨ZKä¸­ï¼Œæ¯ä¸ªçˆ¶èŠ‚ç‚¹ä¼šä¸ºä»–çš„ç¬¬ä¸€çº§å­èŠ‚ç‚¹ç»´æŠ¤ä¸€ä»½æ—¶åºï¼Œä¼šè®°å½•æ¯ä¸ªå­èŠ‚ç‚¹åˆ›å»ºçš„å…ˆåé¡ºåºã€‚åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œåœ¨åˆ›å»ºå­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¯ä»¥è®¾ç½®è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºèŠ‚ç‚¹è¿‡ç¨‹ä¸­ï¼ŒZKä¼šè‡ªåŠ¨ä¸ºç»™å®šèŠ‚ç‚¹ååŠ ä¸Šä¸€ä¸ªæ•°å­—åç¼€ï¼Œä½œä¸ºæ–°çš„èŠ‚ç‚¹åã€‚è¿™ä¸ªæ•°å­—åç¼€çš„èŒƒå›´æ˜¯æ•´å‹çš„æœ€å¤§å€¼ã€‚ 3.3 ä¸´æ—¶èŠ‚ç‚¹ï¼ˆEPHEMERALï¼‰â€‹ å’ŒæŒä¹…èŠ‚ç‚¹ä¸åŒçš„æ˜¯ï¼Œä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸå’Œå®¢æˆ·ç«¯ä¼šè¯ç»‘å®šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè‡ªåŠ¨è¢«æ¸…é™¤æ‰ã€‚æ³¨æ„ï¼Œè¿™é‡Œæåˆ°çš„æ˜¯ä¼šè¯å¤±æ•ˆï¼Œè€Œéè¿æ¥æ–­å¼€ã€‚å¦å¤–ï¼Œåœ¨ä¸´æ—¶èŠ‚ç‚¹ä¸‹é¢ä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ã€‚ 3.4 ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼ˆEPHEMERAL_SEQUENTIALï¼‰â€‹ å…·æœ‰ä¸´æ—¶èŠ‚ç‚¹ç‰¹ç‚¹é¢å¤–çš„ç‰¹æ€§æ˜¯ï¼Œæ¯ä¸ªçˆ¶èŠ‚ç‚¹ä¼šä¸ºä»–çš„ç¬¬ä¸€çº§å­èŠ‚ç‚¹ç»´æŠ¤ä¸€ä»½æ—¶åºã€‚è¿™ç‚¹å’Œåˆšæ‰æåˆ°çš„æŒä¹…é¡ºåºèŠ‚ç‚¹ç±»ä¼¼ 4. å®‰è£…4.1 linuxç³»ç»Ÿå®‰è£… å®‰è£…JDK 12tar -zxvf jdk-8u171-linux-x64.tar.gz mv ./jdk1.8.0_171/ /usr/java/ 12vim /etc/profilesource /etc/profile å®‰è£…ZK 1tar -zxvf apache-zookeeper-3.6.3-bin.tar.gz 1cd conf/ ç”±äºzké»˜è®¤åŠ è½½çš„æ˜¯zoo.cfgï¼Œæ‰€ä»¥éœ€è¦æ”¹å 1mv zoo_sample.cfg zoo.cfg ç”±äºzookeeperåŠ è½½è¦å°†èŠ‚ç‚¹åŠ è½½åˆ°ç£ç›˜ï¼Œæ‰€ä»¥éœ€è¦é¢„å…ˆæ–°å»ºä¸€ä¸ªç£ç›˜ç›®å½• 1mkdir /tmp/zookeeper å¯åŠ¨ZK 1234567[root@localhost bin]# ./zkServer.sh start /root/apache-zookeeper-3.6.3-bin/conf/zoo.cfg ZooKeeper JMX enabled by defaultUsing config: /root/apache-zookeeper-3.6.3-bin/conf/zoo.cfgStarting zookeeper ... STARTED# æŸ¥çœ‹æ˜¯å¦å¯åŠ¨jps â€‹ QuorumPeerMainå°±æ˜¯zk è¿æ¥ZK 1./zkCli.sh -server 192.168.9.3:2181 å¦‚æœæ˜¯æœ¬æœºï¼Œ-serveråå¯ä¸åŠ  5. é…ç½®æ–‡ä»¶è¯´æ˜ tickTimeï¼šé›†ç¾¤èŠ‚ç‚¹å¿ƒè·³æ—¶é—´ï¼Œ initLimitï¼šåˆå§‹åŒ–é›†ç¾¤æ—¶é›†ç¾¤èŠ‚ç‚¹åŒæ­¥è¶…æ—¶æ—¶é—´20s syncLimitï¼šé›†ç¾¤åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒåŒæ­¥æ•°æ®è¶…æ—¶æ—¶é—´ä¸º10sï¼ˆè¿™é‡Œ5æ˜¯æŒ‡5æ¬¡å¿ƒè·³ï¼‰ dataDirï¼šé»˜è®¤æ•°æ®å­˜å‚¨ä½ç½® clientPortï¼šzkæœåŠ¡ç›‘å¬ç«¯å£å· maxClientCnxnsï¼šçº¿ç¨‹æ± çº¿ç¨‹æ•°é‡ 6. å®¢æˆ·ç«¯åŸºæœ¬æŒ‡ä»¤ æŸ¥çœ‹èŠ‚ç‚¹ 1ls / # æ ¹èŠ‚ç‚¹ åˆ›å»ºèŠ‚ç‚¹ 12345create path data # åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ç»™èŠ‚ç‚¹ç»‘å®šæ•°æ®ï¼ˆé»˜è®¤æ˜¯æŒä¹…æ€§èŠ‚ç‚¹ï¼‰- create path data # æŒä¹…èŠ‚ç‚¹- create -s path data # æŒä¹…æ€§é¡ºåºèŠ‚ç‚¹- create -e path data # ä¸´æ—¶æ€§èŠ‚ç‚¹- create -e -s path data # ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ quitï¼šä¼šç›´æ¥å¯¼è‡´ä¼šè¯æ–­å¼€ï¼Œä¼šè¯å¤±æ•ˆï¼Œå…¶ä»–ctrl+cä¼šå¯¼è‡´è§¦å‘å€’è®¡æ—¶ æ³¨ï¼šä¸´æ—¶èŠ‚ç‚¹ä¸Šä¸èƒ½åˆ›å»ºä»»ä½•èŠ‚ç‚¹ æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ 1stat /node1 cZxidï¼šåˆ›å»ºäº‹åŠ¡ID ctimeï¼šåˆ›å»ºæ—¶é—´ mZxidï¼šä¿®æ”¹ID mtimeï¼šä¿®æ”¹æ—¶é—´ pZxidï¼šçˆ¶ç»“ç‚¹ç‰ˆæœ¬å· cversionï¼šåˆ›å»ºç‰ˆæœ¬å· dataVersionï¼šæ•°æ®ç‰ˆæœ¬å· aclVersionï¼š ephemerslOwnerï¼šæ˜¯å¦æ˜¯ä¸´æ—¶èŠ‚ç‚¹ dataLengthï¼šå­˜å‚¨æ•°æ®é•¿åº¦ numChildrenï¼šå­èŠ‚ç‚¹æ•°é‡ è·å¾—èŠ‚ç‚¹ä¸Šç»‘å®šçš„æ•°æ®ä¿¡æ¯ 1get /node1 åˆ é™¤èŠ‚ç‚¹ 1delete /node1 åªèƒ½åˆ é™¤æ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œåˆ™æ— æ³•åˆ é™¤ è‹¥æƒ³åˆ é™¤æœ‰å­èŠ‚ç‚¹çš„ï¼Œåˆ™éœ€è¦deleteall 7. watchèŠ‚ç‚¹ç›‘å¬æœºåˆ¶ç›‘å¬åˆ†ä¸ºèŠ‚ç‚¹ç›®å½•ç›‘å¬å’ŒèŠ‚ç‚¹æ•°æ®ç›‘å¬ ç›®å½•ç›‘å¬æ˜¯ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ– æ•°æ®ç›‘å¬æ˜¯ç›‘å¬å½“å‰èŠ‚ç‚¹æ•°æ®çš„å˜åŒ– ä¸¤ç§ç›‘å¬éƒ½æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä¹Ÿå°±æ˜¯å‘ç°ä¸€ä¸ªä¿®æ”¹ï¼Œä¸‹æ¬¡ä¿®æ”¹åˆ™ä¸ä¼šè§¦å‘ç›‘å¬æœºåˆ¶ ç›®å½•ç›‘å¬ 1ls -w /node å†æ¬¡åˆ›å»ºï¼Œæ— è§¦å‘ æ•°æ®ç›‘å¬ 1get -w /node 8. Javaæ“ä½œZK123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134package com.w1nd.test;import org.I0Itec.zkclient.IZkChildListener;import org.I0Itec.zkclient.IZkDataListener;import org.I0Itec.zkclient.ZkClient;import org.I0Itec.zkclient.serialize.SerializableSerializer;import org.apache.zookeeper.CreateMode;import org.apache.zookeeper.data.Stat;import org.junit.After;import org.junit.Before;import org.junit.Test;import java.io.IOException;import java.util.List;public class TestZKClient { private ZkClient zkClient; // 1. åœ¨zkåˆ›å»ºèŠ‚ç‚¹ @Test public void testCreateNode() { // 1. æŒä¹…èŠ‚ç‚¹ zkClient.create(&quot;/node1&quot;, &quot;xiaochen&quot;, CreateMode.PERSISTENT); // 2. æŒä¹…é¡ºåºèŠ‚ç‚¹ zkClient.create(&quot;/node1/names&quot;, &quot;zhangsan&quot;, CreateMode.PERSISTENT_SEQUENTIAL); // 3. ä¸´æ—¶èŠ‚ç‚¹ zkClient.create(&quot;/node1/lists&quot;, &quot;xiaoxiao&quot;, CreateMode.EPHEMERAL); // 4. ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ zkClient.create(&quot;/node1/lists1&quot;, &quot;xiaoming&quot;, CreateMode.EPHEMERAL_SEQUENTIAL); } // 2. åˆ é™¤èŠ‚ç‚¹ @Test public void testDeleteNode() { // åˆ é™¤æ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼Œè¿”å›å€¼ï¼šæ˜¯å¦æˆåŠŸ boolean delete = zkClient.delete(&quot;/node1&quot;); // é€’å½’åˆ é™¤èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿”å›å€¼ï¼šæ˜¯å¦åˆ é™¤æˆåŠŸ boolean b = zkClient.deleteRecursive(&quot;/node1&quot;); } // 3. æŸ¥è¯¢å½“å‰èŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹ @Test public void testFindNodes() { // è·å–æŒ‡å®šè·¯å¾„çš„èŠ‚ç‚¹ä¿¡æ¯ List&lt;String&gt; children = zkClient.getChildren(&quot;/&quot;); for (String child : children) { System.out.println(child); } } // 4. æŸ¥çœ‹æŸä¸ªèŠ‚ç‚¹æ•°æ®ï¼Œæ³¨æ„ï¼šé€šè¿‡javaå®¢æˆ·ç«¯æ“ä½œéœ€è¦ä¿è¯èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®å’ŒèŠ‚ç‚¹æ—¶åºåˆ—åŒ–æ–¹å¼ä¸€è‡´ // shellä¸­çš„æ•°æ®åºåˆ—åŒ–æ–¹å¼å’Œjavaä¸­çš„ä¸ä¸€è‡´ @Test public void testFindNodeData() { Object readData = zkClient.readData(&quot;/node3&quot;); System.out.println(readData); } // 5. æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯ @Test public void testFindNodeDataAndStat() { Stat stat = new Stat(); Object readData = zkClient.readData(&quot;/node1&quot;, stat); System.out.println(readData); System.out.println(stat); } // 6. ä¿®æ”¹èŠ‚ç‚¹æ•°æ® @Test public void testWriteData() { // User user = new User(); // user.setId(1); // zkClient.writeData(&quot;/node1&quot;, user); } // ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ– @Test public void testOnNodeDataChange() throws IOException { zkClient.subscribeDataChanges(&quot;/node1&quot;, new IZkDataListener() { // å½“èŠ‚ç‚¹æ•°æ®å˜åŒ–æ—¶è§¦å‘å¯¹åº”è¿™ä¸ªæ–¹æ³• @Override public void handleDataChange(String s, Object o) throws Exception { System.out.println(&quot;å½“å‰èŠ‚ç‚¹è·¯å¾„ï¼š&quot; + s); System.out.println(&quot;å½“å‰èŠ‚ç‚¹å˜åŒ–åæ•°æ®ï¼š&quot; + o); } // å½“å‰èŠ‚ç‚¹åˆ é™¤æ—¶è§¦å‘è¿™ä¸ªæ–¹æ³• @Override public void handleDataDeleted(String s) throws Exception { System.out.println(&quot;å½“å‰èŠ‚ç‚¹è·¯å¾„ï¼š&quot; + s); } }); System.in.read(); // é˜»å¡å½“å‰ç›‘å¬ } // ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ– @Test public void testOnNodesChange() throws IOException { zkClient.subscribeChildChanges(&quot;/node1&quot;, new IZkChildListener() { // å½“èŠ‚ç‚¹çš„å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³• // å‚æ•°1ï¼šçˆ¶èŠ‚ç‚¹åç§° // å‚æ•°2ï¼šçˆ¶èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰å­èŠ‚ç‚¹åç§° @Override public void handleChildChange(String s, List&lt;String&gt; list) throws Exception { System.out.println(&quot;çˆ¶èŠ‚ç‚¹åç§°ï¼š&quot; + s); System.out.println(&quot;å‘ç”Ÿå˜æ›´åå­©å­èŠ‚ç‚¹åç§°ï¼š&quot;); for (String name: list) { System.out.println(name); } } }); System.in.read(); // é˜»å¡å½“å‰ç›‘å¬ } @Before public void before() { // å‚æ•°1ï¼šServeræœåŠ¡å™¨ipåœ°å€ // å‚æ•°2ï¼šä¼šè¯è¶…æ—¶æ—¶é—´ // å‚æ•°3ï¼šè¿æ¥è¶…æ—¶æ—¶é—´ // å‚æ•°4ï¼šåºåˆ—åŒ–æ–¹å¼ zkClient = new ZkClient(&quot;192.168.9.3:2181&quot;, 60000 * 30, 60000, new SerializableSerializer()); } @After // é‡Šæ”¾èµ„æº public void after() { zkClient.close(); } // è·å–è¿æ¥ public static void main(String[] args) { }} 9. ZKé›†ç¾¤9.1 é›†ç¾¤ï¼ˆclusterï¼‰â€‹ é›†ç¾¤æ˜¯æŒ‡åŒä¸€ç§è½¯ä»¶æœåŠ¡çš„å¤šä¸ªèŠ‚ç‚¹åŒæ—¶æä¾›æœåŠ¡ â€‹ é›†ç¾¤è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ å•èŠ‚ç‚¹çš„å¹¶å‘è®¿é—®çš„å‹åŠ›é—®é¢˜ å•èŠ‚ç‚¹æ•…éšœé—®é¢˜ 9.2 é›†ç¾¤æ¶æ„ 9.3 é›†ç¾¤æ­å»º åœ¨~ç›®å½•ä¸‹æ–°å»ºä¸‰ä¸ªæ–‡ä»¶å¤¹ 1mkdir zkdata1 zkdata2 zkdata3 å»ºç«‹myidæ–‡ä»¶ 1touch zkdata1/myid zkdata2/myid zkdata3/myid ä¸ºæ¯ä¸ªzkæŒ‡å®šid 123echo &quot;1&quot; &gt;&gt; zkdata1/myid echo &quot;2&quot; &gt;&gt; zkdata2/myid echo &quot;3&quot; &gt;&gt; zkdata3/myid æ·»åŠ é…ç½®æ–‡ä»¶ 12345678910111213vim zkdata1/zoo.cfgvim zkdata2/zoo.cfgvim zkdata3/zoo.cfgtickTime=2000initLimit=10syncLimit=5dataDir=/root/zkdata1clientPort=3001server.1=196.168.9.3:3002:3003server.2=192.158.9.3:4002:4003server.3=192.168.9.3:5002:5003 ç›¸å…³æ“ä½œ 12345678# å¯åŠ¨./bin/zkServer.sh start /root/zkdata1/zoo.cfg./bin/zkServer.sh start /root/zkdata2/zoo.cfg./bin/zkServer.sh start /root/zkdata3/zoo.cfg# æŸ¥çœ‹çŠ¶æ€./bin/zkServer.sh status /root/zkdata1/zoo.cfg# åœæ­¢./bin/zkServer.sh stop /root/zkdata1/zoo.cfg","link":"/2022/02/04/%E6%A1%86%E6%9E%B6/zookeeper%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E4%B8%8E%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"},{"title":"ä½è¿ç®—","text":"å‰‘æŒ‡ Offer II 004. åªå‡ºç°ä¸€æ¬¡çš„æ•°å­—åˆ·ç©¿å‰‘æŒ‡offer-Day02-æ•´æ•°II 004.åªå‡ºç°ä¸€æ¬¡çš„æ•°å­— ä½è¿ç®—è®²è§£ - åªå‡ºç°ä¸€æ¬¡çš„æ•°å­— 12345678910111213141516class Solution {public: int singleNumber(vector&lt;int&gt;&amp; nums) { int ret = 0; for (int i = 0; i &lt; 32; i ++) { int cnt = 0; for (auto num: nums) { cnt += num &gt;&gt; i &amp; 1; } if (cnt % 3 != 0) { ret |= 1 &lt;&lt; i; } } return ret; }}; å‰‘æŒ‡ Offer II 005. å•è¯é•¿åº¦çš„æœ€å¤§ä¹˜ç§¯123456789101112131415161718192021222324class Solution {public: int maxProduct(vector&lt;string&gt;&amp; words) { int n = words.size(); vector&lt;int&gt; dict(n, 0); for (int i = 0; i &lt; words.size(); i ++) { int t = 0; for (auto c: words[i]) { int bit = c - 'a'; t |= (1 &lt;&lt; bit); } dict[i] = t; } int ans = 0; for (int i = 0; i &lt; n; i ++) for (int j = 0; j &lt; i; j ++) if ((dict[i] &amp; dict[j]) == 0) { int temp = words[i].size() * words[j].size(); ans = max(ans, temp); } return ans; } };","link":"/2022/02/04/%E7%AE%97%E6%B3%95/%E4%BD%8D%E8%BF%90%E7%AE%97/"},{"title":"å‰ç¼€å’Œ","text":"525. è¿ç»­æ•°ç»„ 1234567891011121314151617181920class Solution {public: int findMaxLength(vector&lt;int&gt;&amp; nums) { /* ç”±äºä»¥ä¸Šç¢°1åŠ ä¸€ï¼Œç¢°0å‡ä¸€çš„æ“ä½œï¼Œå½“0ä¸1æ•°é‡ä¸€è‡´æ—¶(è¿ç»­æ•°ç»„), å…¶è¿ç»­æ•°ç»„çš„å’Œä¸ºé›¶ã€‚å› æ­¤æˆ‘ä»¬çŸ¥é“æ•°ç»„å‰é¢çš„ cur å€¼æ˜¯ä»€ä¹ˆï¼Œåœ¨åˆ°è¾¾è¯¥è¿ç»­æ•°ç»„å°¾éƒ¨æ—¶å°±ä¸ä¼šå˜ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦æ£€æŸ¥å“ˆå¸Œè¡¨ä¸­æ˜¯å¦å­˜åœ¨å…¶ç›¸åŒçš„ curcur å€¼å³å¯ */ unordered_map&lt;int, int&gt; hash{{0, -1}}; int cur = 0, ans = 0; for (int i = 0; i &lt; nums.size(); i ++) { cur += nums[i] == 0 ? -1 : 1; if (hash.count(cur)) { ans = max(ans, i - hash[cur]); } else { hash[cur] = i; } } return ans; }}; å‰‘æŒ‡ Offer II 010. å’Œä¸º k çš„å­æ•°ç»„ 123456789101112131415161718class Solution {public: int subarraySum(vector&lt;int&gt;&amp; nums, int k) { int n = nums.size(); unordered_map&lt;int, int&gt; hash; vector&lt;int&gt; s(n + 1, 0); for (int i = 1; i &lt;= n; i ++) s[i] = s[i - 1] + nums[i - 1]; hash[0] = 1; int res = 0; // ç±»ä¼¼åŒæŒ‡é’ˆï¼Œå“ˆå¸Œè¡¨å­˜å‚¨çš„æ¯ä¸ªå‰ç¼€å’Œå¯¹åº”çš„ä¸ªæ•°ï¼Œç”±äºhash[0] = 1ï¼Œ // å®ƒä¸€å®šä¼šè½¬ç§»åˆ°å‰å˜´å’Œ-kä¸º0çš„çš„ä½ç½®ï¼Œåé¢åœ¨ç¡®å®šå…¶ä»–å‰å˜´å’Œ-å½“å‰å‰å˜´å’Œæ˜¯å¦èƒ½è¢«é¦–å‰å˜´å’Œè½¬ç§» for (int i = 1; i &lt;= n; i ++) { res += hash[s[i] - k]; hash[s[i]] ++; } return res; }};","link":"/2022/02/04/%E7%AE%97%E6%B3%95/%E5%89%8D%E7%BC%80%E5%92%8C/"},{"title":"åŒºé—´DP","text":"87. æ‰°ä¹±å­—ç¬¦ä¸²1234567891011121314151617181920212223242526272829class Solution {public: bool isScramble(string s1, string s2) { int n = s1.size(); if (s1 == s2) return true; if (s1.size() != s2.size()) return false; vector&lt;vector&lt;vector&lt;int&gt;&gt;&gt; f(n, vector&lt;vector&lt;int&gt;&gt;(n, vector&lt;int&gt;(n + 1, false))); // å¤„ç†é•¿åº¦ä¸º1çš„æƒ…å†µ for (int i = 0; i &lt; n; i ++) for (int j = 0; j &lt; n; j ++) if (s1[i] == s2[j]) f[i][j][1] = true; // f[i][j][len] ä»£è¡¨ s1s1 ä» ii å¼€å§‹ï¼Œs2s2 ä» jj å¼€å§‹ï¼Œåé¢é•¿åº¦ä¸º lenlen çš„å­—ç¬¦æ˜¯å¦èƒ½å½¢æˆã€Œæ‰°ä¹±å­—ç¬¦ä¸²ã€ï¼ˆäº’ä¸ºç¿»è½¬ï¼‰ã€‚ for (int len = 2; len &lt;= n; len ++) for (int i = 0; i &lt;= n - len; i ++) for (int j = 0; j &lt;= n - len; j ++) for (int k = 1; k &lt; len; k ++) { // åˆ†å‰²ç‚¹ // a : 0 - i, b : 0 - j ; a: i - n, j - n bool a = f[i][j][k] &amp;&amp; f[i + k][j + k][len - k]; // a : 0 - i, b : n - i, n ; a: i - n, 0 - j bool b = f[i][j + len - k][k] &amp;&amp; f[i + k][j][len - k]; if (a || b) { f[i][j][len] = true; } } return f[0][0][n]; }}; 375. çŒœæ•°å­—å¤§å° II1234567891011121314151617181920class Solution {public: int getMoneyAmount(int n) { //å®šä¹‰ f[l][r]f[l][r] ä¸ºè€ƒè™‘åœ¨ [l, r][l,r] èŒƒå›´å†…è¿›è¡ŒçŒœæ•°çš„æœ€å°æˆæœ¬ã€‚ vector&lt;vector&lt;int&gt;&gt; f(n + 2, vector&lt;int&gt;(n + 2, 0)); // éœ€è¦æ‰¾åˆ°èƒ½çŒœä¸­æ•°å­—çš„æœ€å°æˆæœ¬ï¼Œä¹Ÿå°±æ˜¯æœ€åæƒ…å†µæœ€å¥½çš„ç»“æœ // å¯¹äºä»»ä¸€åŒºé—´å–minæ˜¯å› ä¸ºæˆ‘ä»¬åœ¨è¯¥åŒºé—´å¯ä»¥å…ˆé€‰æ‹©å°çš„æ•°å»è¯•ï¼Œç”±æ­¤é™ä½æˆæœ¬ for (int len = 2; len &lt;= n; len ++) for (int l = 1; l + len - 1 &lt;= n; l ++) { int r = l + len - 1; f[l][r] = 0x3f3f3f3f; for (int x = l; x &lt;= r; x ++) { int cur = max(f[l][x - 1], f[x + 1][r]) + x; f[l][r] = min(f[l][r], cur); } } return f[1][n]; }}; 516. æœ€é•¿å›æ–‡å­åºåˆ—123456789101112131415161718192021222324252627282930313233class Solution {public: /* bb aa bb bb a bb dp[i][j] è¡¨ç¤º ç¬¬ i ä¸ªå­—ç¬¦åˆ° ç¬¬ j ä¸ªå­—ç¬¦ä¹‹é—´æœ€é•¿çš„å›æ–‡å­åºåˆ—é•¿åº¦ 1ã€å½“ s[i] == s[j] æ—¶ï¼Œè€ƒè™‘ i å’Œ j ä¸­é—´åºåˆ—çš„å¥‡å¶ä¸ªæ•°ï¼Œ dp[i][j] = dp[i+1][j-1] + 2 å¯¹ä¸Šè¿° dp[i][j] = dp[i+1][j-1] + 2 çš„è§£é‡Šï¼š å½“åºåˆ—ä¸º b aa b æ—¶ï¼Œ i = 0, j = 3ï¼Œåˆ™ dp[0][3] = dp[1][2] + 2 = 4 å½“åºåˆ—ä¸º b a b æ—¶ï¼Œi = 0, j = 2ï¼Œåˆ™ dp[0][2] = dp[1][1] + 2 = 3 å½“åºåˆ—ä¸º b b æ—¶ï¼Œ i = 0, j = 1ï¼Œåˆ™ dp[0][1] = dp[1][0] = 0 + 2 = 2 (dp[1][0] é»˜è®¤å€¼ä¸º 0) è¯¥å¼å­åŒæ—¶è€ƒè™‘åˆ°äº†å¥‡å¶ 2ã€å½“ s[i] != s[j] ï¼Œé‚£ä¹ˆ dp[i][j] = Math.max(dp[i+1][j],dp[i][j-1]) å¯¹ä¸Šè¿° dp[i][j] å¼å­çš„è§£é‡Šï¼š å‡å¦‚åºåˆ—ä¸º d c b c cï¼ˆindexï¼š0-4ï¼‰ï¼Œs[0] != s[4] ï¼Œåˆ™ dp[0][4] = Math.max(dp[0][3],dp[1,4]) = Math.max(2,3) = 3 */ int longestPalindromeSubseq(string s) { int n = s.size(); vector&lt;vector&lt;int&gt;&gt; f(n + 1, vector&lt;int&gt;(n + 1, 0)); for (int i = n - 1; i &gt;= 0; i --) { f[i][i] = 1; for (int j = i + 1; j &lt; n; j ++) { if (s[i] == s[j]) { f[i][j] = f[i + 1][j - 1] + 2; } else { f[i][j] = max(f[i + 1][j], f[i][j - 1]); } } } return f[0][n - 1]; }}; 664. å¥‡æ€ªçš„æ‰“å°æœº123456789101112131415161718192021class Solution {public: int strangePrinter(string s) { int n = s.size(); // f[i][j] è¡¨ç¤º åŒºé—´[i,j]çš„æœ€å°æ‰“å°æ¬¡æ•° vector&lt;vector&lt;int&gt;&gt; f(n + 1, vector&lt;int&gt;(n + 1, INT_MAX)); for (int i = n - 1; i &gt;= 0; i --) { f[i][i] = 1; for (int j = i + 1; j &lt; n; j ++) { if (s[i] == s[j]) { f[i][j] = f[i][j - 1]; } else { for (int k = i; k &lt; j; k ++) { f[i][j] = min(f[i][j], f[i][k] + f[k + 1][j]); } } } } return f[0][n - 1]; }}; 877. çŸ³å­æ¸¸æˆ1234567891011121314151617class Solution {public: bool stoneGame(vector&lt;int&gt;&amp; piles) { int n = piles.size(); // å®šä¹‰ f[l][r]f[l][r] ä¸ºè€ƒè™‘åŒºé—´ [l,r][l,r]ï¼Œåœ¨åŒæ–¹éƒ½åšæœ€å¥½é€‰æ‹©çš„æƒ…å†µä¸‹ï¼Œå…ˆæ‰‹ä¸åæ‰‹çš„æœ€å¤§å¾—åˆ†å·®å€¼ä¸ºå¤šå°‘ vector&lt;vector&lt;int&gt;&gt; f(n + 2, vector&lt;int&gt;(n + 2, 0)); for (int len = 1; len &lt;= n; len ++) for (int l = 1; l + len - 1 &lt;= n; l ++) { int r = l + len - 1; int a = piles[l - 1] + f[l + 1][r]; int b = piles[r - 1] + f[l][r - 1]; f[l][r] = max(a, b); } return f[1][n] &gt; 0; }};","link":"/2022/02/02/%E7%AE%97%E6%B3%95/%E5%8C%BA%E9%97%B4DP/"},{"title":"åŒæŒ‡é’ˆ","text":"å‰‘æŒ‡ Offer II 008. å’Œå¤§äºç­‰äº target çš„æœ€çŸ­å­æ•°ç»„123456789101112class Solution {public: int minSubArrayLen(int target, vector&lt;int&gt;&amp; nums) { int n = nums.size(), sum = 0, res = INT_MAX; for (int i = 0, j = 0; i &lt; n; i ++) { sum += nums[i]; while (sum - nums[j] &gt;= target) sum -= nums[j ++]; if (sum &gt;= target) res = min(res, i - j + 1); } return res == INT_MAX ? 0 : res; }}; å‰‘æŒ‡ Offer II 009. ä¹˜ç§¯å°äº K çš„å­æ•°ç»„ 1234567891011121314class Solution {public: int numSubarrayProductLessThanK(vector&lt;int&gt;&amp; nums, int k) { //å·²çŸ¥ABC &lt; target, æ–°å¢ä¸€ä½Xå˜æˆABCX, è‹¥ABCX &lt; target åˆ™æ–°å¢çš„subarrayä¸­å¿…é¡»æ»¡è¶³ 1.è¿ç»­ 2.åŒ…å«X //æ‰€ä»¥ä»Xå‘å·¦æ•°: X, CX, BCX, ABCX int n = nums.size(), product = 1, res = 0; for (int i = 0, j = 0; i &lt; n; i ++ ) { product *= nums[i]; while (i &gt;= j &amp;&amp; product &gt;= k) product /= nums[j ++]; res += i - j + 1; } return res; }}; å‰‘æŒ‡ Offer II 010. å’Œä¸º k çš„å­æ•°ç»„ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰ (leetcode-cn.com) 123456789101112131415161718class Solution {public: int subarraySum(vector&lt;int&gt;&amp; nums, int k) { int n = nums.size(); unordered_map&lt;int, int&gt; hash; vector&lt;int&gt; s(n + 1, 0); for (int i = 1; i &lt;= n; i ++) s[i] = s[i - 1] + nums[i - 1]; hash[0] = 1; int res = 0; // ç±»ä¼¼åŒæŒ‡é’ˆï¼Œå“ˆå¸Œè¡¨å­˜å‚¨çš„æ¯ä¸ªå‰ç¼€å’Œå¯¹åº”çš„ä¸ªæ•°ï¼Œç”±äºhash[0] = 1ï¼Œ // å®ƒä¸€å®šä¼šè½¬ç§»åˆ°å‰å˜´å’Œ-kä¸º0çš„çš„ä½ç½®ï¼Œåé¢åœ¨ç¡®å®šå…¶ä»–å‰å˜´å’Œ-å½“å‰å‰å˜´å’Œæ˜¯å¦èƒ½è¢«é¦–å‰å˜´å’Œè½¬ç§» for (int i = 1; i &lt;= n; i ++) { res += hash[s[i] - k]; hash[s[i]] ++; } return res; }}; å‰‘æŒ‡ Offer II 014. å­—ç¬¦ä¸²ä¸­çš„å˜ä½è¯ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰ (leetcode-cn.com) 1234567891011121314151617class Solution {public: bool checkInclusion(string s1, string s2) { map&lt;char, int&gt; hash; // å­˜å‚¨å­ä¸²å„ä¸ªå­—ç¬¦æ•°é‡ for (auto c: s1) hash[c] ++; int tot = hash.size(), statify = 0; // totæ˜¯å­—ç¬¦æ€»æ•°ï¼Œstatifyæ˜¯s2ä¸­æ»¡è¶³è¦æ±‚çš„æ•°é‡ for (int i = 0, j = 0; i &lt; s2.size(); i ++) { if (--hash[s2[i]] == 0) statify ++; while (i - j + 1 &gt; s1.size()) { // çª—å£å¤§å°å°äºs1.size if (hash[s2[j]] == 0) statify --; hash[s2[j ++]] ++; } if (statify == tot) return true; } return false; }}; å‰‘æŒ‡ Offer II 017. å«æœ‰æ‰€æœ‰å­—ç¬¦çš„æœ€çŸ­å­—ç¬¦ä¸² - åŠ›æ‰£ï¼ˆLeetCodeï¼‰ (leetcode-cn.com) 1234567891011121314151617181920class Solution {public: string minWindow(string s, string t) { map&lt;char, int&gt; hash; for (auto c: t) hash[c] ++; int tot = hash.size(), statify = 0; string res; for (int i = 0, j = 0; i &lt; s.size(); i ++) { if (hash[s[i]] == 1) statify ++; hash[s[i]] --; while (hash[s[j]] &lt; 0) hash[s[j ++]] ++; // æ³¨æ„è¿™é‡Œæ˜¯&lt;ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°åç»­çš„ä¸ç¬¦åˆè¦æ±‚çš„å­—ç¬¦é¡¶å»å‰é¢çš„ï¼Œä¾‹å¦‚BANCï¼ŒNçš„å‡ºç°ä¸ä¼šå°†Båˆ å» if (statify == tot) { if (res.empty() || res.size() &gt; i - j + 1) { res = s.substr(j, i - j + 1); } } } return res; }};","link":"/2022/02/04/%E7%AE%97%E6%B3%95/%E5%8F%8C%E6%8C%87%E9%92%88/"},{"title":"çŠ¶å‹DP","text":"526. ä¼˜ç¾çš„æ’åˆ—123456789101112131415161718class Solution {public: int countArrangement(int n) { int mask = 1 &lt;&lt; n; vector&lt;vector&lt;int&gt;&gt; f(n + 1, vector&lt;int&gt;(mask, 0)); f[0][0] = 1; // è€ƒè™‘å‰iä¸ªæ•°ï¼ŒçŠ¶æ€ä¸º0çš„æ–¹æ¡ˆæ•°ï¼ˆä¼˜ç¾æ’åˆ—æ•°é‡ï¼‰ for (int i = 1; i &lt;= n; i ++) // æšä¸¾å½“å‰ä½ç½® for (int state = 1; state &lt;= mask; state ++) // æšä¸¾å½“å‰çŠ¶æ€ï¼Œ0ä¸ºé€‰è¯¥æ•°ï¼Œ1ä¸ºä¸é€‰ for (int k = 1; k &lt;= n; k ++) { // æšä¸¾å½“å‰ä½ç½®å¡«äº†ä»€ä¹ˆæ•° if (!((state &gt;&gt; (k - 1)) &amp; 1)) continue; // å¦‚æœå½“å‰æ•°åœ¨çŠ¶æ€ä¸­ä¸º0ï¼Œåˆ™è·³è¿‡ if (k % i &amp;&amp; i % k) continue; // ä¸æ»¡è¶³ä»»ä½•æ•´é™¤å…³ç³» // state &amp; (~(1 &lt;&lt; (k - 1))) ä»£è¡¨å°† state ä¸­æ•°å€¼ k çš„ä½ç½®ç½®é›¶ f[i][state] += f[i - 1][state &amp; ~(1 &lt;&lt; (k - 1))]; } return f[n][mask - 1]; }}; 847. è®¿é—®æ‰€æœ‰èŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„1234567891011121314151617181920212223242526class Solution {public: int shortestPathLength(vector&lt;vector&lt;int&gt;&gt;&amp; graph) { int n = graph.size(); int mask = 1 &lt;&lt; n; vector&lt;vector&lt;int&gt;&gt; dist(mask, vector&lt;int&gt;(n + 1, INT_MAX)); // stateå’Œu(è¯¥çŠ¶æ€ä¸‹çš„æœ€åä¸€æ­¥)å¯¹åº”çš„æ­¥æ•° deque&lt;vector&lt;int&gt;&gt; d; // å­˜å‚¨state å’Œ u for (int i = 0; i &lt; n; i ++) { dist[1 &lt;&lt; i][i] = 0; d.push_back({1 &lt;&lt; i, i}); } while (!d.empty()) { auto poll = d.front(); d.pop_front(); int state = poll[0], u = poll[1], step = dist[state][u]; if (state == mask - 1) return step; for (int i: graph[u]) { if (dist[state | (1 &lt;&lt; i)][i] == INT_MAX) { dist[state | (1 &lt;&lt; i)][i] = step + 1; d.push_back({state | (1 &lt;&lt; i), i}); } } } return -1; }};","link":"/2022/02/03/%E7%AE%97%E6%B3%95/%E7%8A%B6%E5%8E%8BDP/"},{"title":"è®°å¿†åŒ–æœç´¢","text":"87. æ‰°ä¹±å­—ç¬¦ä¸²12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455class Solution {public: vector&lt;vector&lt;vector&lt;int&gt;&gt;&gt; cache; int Y = 1, N = -1; string s1, s2; bool isScramble(string _s1, string _s2) { s1 = _s1, s2 = _s2; if (s1 == s2) return true; if (s1.size() != s2.size()) return false; int n = s1.size(); // cacheè¡¨ç¤ºs1ä»iå¼€å§‹ï¼Œs2ä»jå¼€å§‹ len ä½ï¼Œæ˜¯å¦å½¢æˆæ‰°åŠ¨å­—ç¬¦ä¸² cache.resize(n, vector&lt;vector&lt;int&gt;&gt;(n, vector&lt;int&gt;(n + 1, 0))); return dfs(0, 0, n); } bool dfs(int i, int j, int len) { if (cache[i][j][len] != 0) return cache[i][j][len] == Y; string a = s1.substr(i, len), b = s2.substr(j, len); if (a == b){ cache[i][j][len] = Y; return true; } if (!check(a, b)) { cache[i][j][len] = N; return false; } for (int k = 1; k &lt; len; k ++) { if (dfs(i, j, k) &amp;&amp; dfs(i + k, j + k, len - k)) { cache[i][j][len] = Y; return true; } if (dfs(i, len - k + j, k) &amp;&amp; dfs(i + k, j, len - k)) { cache[i][j][len] = Y; return true; } } cache[i][j][len] = N; return false; } bool check(string a, string b) { if (a.size() != b.size()) return false; vector&lt;int&gt; cnt1(26, 0), cnt2(26, 0); for (auto c: s1) { cnt1[c - 'a'] ++; } for (auto c: s2) { cnt2[c - 'a'] ++; } return cnt1 == cnt2; }}; 375. çŒœæ•°å­—å¤§å° II12345678910111213141516171819202122class Solution {public: vector&lt;vector&lt;int&gt;&gt; cache; int getMoneyAmount(int n) { cache.resize(n + 1, vector&lt;int&gt;(n + 1, 0)); return dfs(1, n); } int dfs(int l, int r) { if (l &gt;= r) return 0; if (cache[l][r] != 0) return cache[l][r]; int ans = 0x3f3f3f3f; for (int x = l; x &lt;= r; x ++) { int cnt = max(dfs(l, x - 1), dfs(x + 1, r)) + x; ans = min(ans, cnt); } cache[l][r] = ans; return ans; }}; 403. é’è›™è¿‡æ²³1234567891011121314151617181920212223242526272829303132class Solution {public: unordered_map&lt;string, bool&gt; cache; // å­˜å‚¨uä¸‹æ ‡è·³kæ­¥æœ‰æ²¡æœ‰æ–¹æ¡ˆ unordered_map&lt;int, int&gt; map; // å­˜å‚¨æ¯ä¸ªçŸ³å—å¯¹åº”çš„ä¸‹æ ‡ bool canCross(vector&lt;int&gt;&amp; stones) { int n = stones.size(); for (int i = 0; i &lt; n; i ++) { map.insert({stones[i], i}); } if (!map.count(1)) return false; return dfs(stones, n, 1, 1); } bool dfs(vector&lt;int&gt; &amp;stones, int n, int u, int k) { if (u == n - 1) return true; string key = to_string(u) + '_' + to_string(k); if (cache.count(key)) return cache[key]; for (int i = -1; i &lt;= 1; i ++) { if (k + i == 0) continue; int next = stones[u] + i + k; // ä¸‹ä¸€ä¸ªè·³è·ƒç‚¹ if (map.count(next)) { bool cur = dfs(stones, n, map[next], k + i); cache.insert({key, cur}); if (cur) return true; } } cache.insert({key, false}); return false; }}; 494. ç›®æ ‡å’Œ12345678910111213141516171819202122class Solution {public: unordered_map&lt;string, int&gt; cache; // è¡¨ç¤ºä»uä¸‹æ ‡,å½“å‰è®¡ç®—ç»“æœä¸ºstringï¼Œçš„æ–¹æ¡ˆæ•°int int findTargetSumWays(vector&lt;int&gt;&amp; nums, int target) { return dfs(nums, target, 0, 0); } int dfs(vector&lt;int&gt; &amp;nums, int target, int u, int cur) { string key = to_string(u) + '_' + to_string(cur); if (cache.count(key)) return cache[key]; if (u == nums.size()) { cache.insert({key, cur == target ? 1: 0}); return cache[key]; } int left = dfs(nums, target, u + 1, cur - nums[u]); int right = dfs(nums, target, u + 1, cur + nums[u]); cache.insert({key, left + right}); return cache[key]; }}; 552. å­¦ç”Ÿå‡ºå‹¤è®°å½• II1234567891011121314151617181920212223class Solution {public: // cache æ˜¯æŒ‡ ä¸‹æ ‡ä¸ºuï¼Œè¿ç»­aä¸ªæ•°ä¸ºacntï¼Œlä¸ªæ•°ä¸ºlcntçš„æ–¹æ¡ˆæ•° vector&lt;vector&lt;vector&lt;int&gt;&gt;&gt; cache; int mod = (int)1e9 + 7; int checkRecord(int n) { cache.resize(n + 1, vector&lt;vector&lt;int&gt;&gt;(2, vector&lt;int&gt;(3, -1))); return dfs(n, 0, 0); } int dfs(int u, int acnt, int lcnt) { if (acnt &gt;= 2) return 0; if (lcnt &gt;= 3) return 0; if (u == 0) return 1; if (cache[u][acnt][lcnt] != -1) return cache[u][acnt][lcnt]; int ans = 0; ans = dfs(u - 1, acnt + 1, 0) % mod; // A ans = (ans + dfs(u - 1, acnt, lcnt + 1)) % mod; // L ans = (ans + dfs(u - 1, acnt, 0)) % mod; // P cache[u][acnt][lcnt] = ans; return ans; }}; 576. å‡ºç•Œçš„è·¯å¾„æ•°12345678910111213141516171819202122232425class Solution {public: vector&lt;vector&lt;vector&lt;int&gt;&gt;&gt; cache; int MOD = (int) 1e9 + 7; int findPaths(int m, int n, int maxMove, int startRow, int startColumn) { cache.resize(maxMove + 1, vector&lt;vector&lt;int&gt;&gt;(m, vector&lt;int&gt;(n, -1))); return dfs(m, n, maxMove, startRow, startColumn); } int dfs(int m, int n, int u, int x, int y) { if (x &gt;= m || x &lt; 0) return 1; if (y &gt;= n || y &lt; 0) return 1; if (u == 0) return 0; if (cache[u][x][y] != -1) return cache[u][x][y]; int ans = 0; ans = dfs(m, n, u - 1, x + 1, y) % MOD; ans = (ans + dfs(m, n, u - 1, x, y + 1)) % MOD; ans = (ans + dfs(m, n, u - 1, x, y - 1)) % MOD; ans = (ans + dfs(m, n, u - 1, x - 1, y)) % MOD; cache[u][x][y] = ans; return ans; }}; 1137. ç¬¬ N ä¸ªæ³°æ³¢é‚£å¥‘æ•°12345678910111213class Solution {public: int cache[40]; int tribonacci(int n) { if (n == 0) return 0; if (n == 1 || n == 2) return 1; if (cache[n] != 0) return cache[n]; cache[n] = tribonacci(n - 1) + tribonacci(n - 2) + tribonacci(n - 3); return cache[n]; }}; å‰‘æŒ‡ Offer 10- I. æ–æ³¢é‚£å¥‘æ•°åˆ—1234567891011121314class Solution {public: int mod = (int) 1e9 + 7; int cache[110]; int fib(int n) { if (n &lt;= 1) return n; if (cache[n] != 0) return cache[n]; cache[n] = fib(n - 1) + fib(n - 2); cache[n] %= mod; return cache[n]; }}; 638. å¤§ç¤¼åŒ… 1234567891011121314151617181920212223242526272829303132333435363738class Solution {public: vector&lt;int&gt; price; vector&lt;vector&lt;int&gt;&gt; special; vector&lt;int&gt; needs; map&lt;vector&lt;int&gt;, int&gt; cache; int shoppingOffers(vector&lt;int&gt;&amp; _price, vector&lt;vector&lt;int&gt;&gt;&amp; _special, vector&lt;int&gt;&amp; _needs) { price = _price; special = _special; needs = _needs; return dfs(needs); } int dfs(vector&lt;int&gt; needs) { if (cache.count(needs)) { return cache[needs]; } int n = needs.size(); int minN = 0; for (int i = 0; i &lt; n; i ++) { minN += price[i] * needs[i]; } for (int i = 0; i &lt; special.size(); i ++) { bool flag = true; vector&lt;int&gt; nextNeeds = needs; for (int j = 0; j &lt; n; j ++) { if (special[i][j] &gt; nextNeeds[j]) flag = false; nextNeeds[j] -= special[i][j]; } if (!flag) continue; minN = min(minN, dfs(nextNeeds) + special[i][n]); } return cache[needs] = minN; }};","link":"/2022/01/30/%E7%AE%97%E6%B3%95/%E8%AE%B0%E5%BF%86%E5%8C%96%E6%90%9C%E7%B4%A2/"},{"title":"èƒŒåŒ…DP","text":"279. å®Œå…¨å¹³æ–¹æ•° 12345678910111213class Solution {public: int numSquares(int n) { // dp[i] è¡¨ç¤º èƒ½å‡‘å‡ºiçš„å®Œå…¨å¹³æ–¹æ•°çš„æœ€å°æ•°é‡ vector&lt;int&gt; dp(n + 1); for (int i = 1; i &lt;= n; i ++) { dp[i] = i; for (int j = 1; i - j * j &gt;= 0; j ++) dp[i] = min(dp[i], dp[i - j * j] + 1); } return dp[n]; }}; 322. é›¶é’±å…‘æ¢ 12345678910111213class Solution {public: int coinChange(vector&lt;int&gt;&amp; coins, int amount) { int n = coins.size(); vector&lt;int&gt; dp(amount + 1, 1e9); dp[0] = 0; for (int i = 0; i &lt; n; i ++) for (int j = coins[i]; j &lt;= amount; j ++) dp[j] = min(dp[j], dp[j - coins[i]] + 1); if (dp[amount] == 1e9) return -1; return dp[amount]; }}; 416. åˆ†å‰²ç­‰å’Œå­é›† 12345678910111213141516class Solution {public: bool canPartition(vector&lt;int&gt;&amp; nums) { int sum = 0; for (auto &amp;x: nums) sum += x; int target = sum / 2; if (target * 2 != sum) return false; vector&lt;int&gt; dp(target + 1, 0); // dp[i] è¡¨ç¤º å‡‘å‡º i æ‰€éœ€çš„ä»·å€¼æ•° for (auto &amp;x: nums) for (int j = target; j &gt;= x; j --) { dp[j] = max(dp[j], dp[j - x] + x); } return dp[target] == target; }}; 474. ä¸€å’Œé›¶ 12345678910111213141516171819202122232425class Solution {public: int findMaxForm(vector&lt;string&gt;&amp; strs, int m, int n) { int len = strs.size(); vector&lt;vector&lt;int&gt;&gt; cnt(len, vector&lt;int&gt;(2, 0)); for (int i = 0; i &lt; len; i ++) { int zero = 0, one = 0; for (auto &amp;c: strs[i]) { if (c == '1') one ++; else zero ++; } cnt[i][0] = zero, cnt[i][1] = one; } vector&lt;vector&lt;int&gt;&gt; f(m + 1, vector&lt;int&gt;(n + 1, 0)); for (int k = 0; k &lt; len; k ++) { int zero = cnt[k][0], one = cnt[k][1]; for (int i = m; i &gt;= zero; i --) for (int j = n; j &gt;= one; j --) { f[i][j] = max(f[i][j], f[i - zero][j - one] + 1); } } return f[m][n]; }}; 494. ç›®æ ‡å’Œ 1234567891011121314151617181920class Solution {public: const int Offset = 1000; int findTargetSumWays(vector&lt;int&gt;&amp; a, int t) { int n = a.size(); int s = 0; for (int i: a) s += abs(i); if (abs(t) &gt; s) return 0; vector&lt;vector&lt;int&gt;&gt; dp(n + 1, vector&lt;int&gt;(2 * s + 1, 0)); dp[0][s] = 1; for (int i = 1; i &lt;= n; i ++) for (int j = -s; j &lt;= s; j ++) { if (j - a[i - 1] &gt;= -s) dp[i][j + s] += dp[i - 1][j - a[i - 1] + s]; if (j + a[i - 1] &lt;= s) dp[i][j + s] += dp[i - 1][j + a[i - 1] + s]; } return dp[n][t + s]; }}; 518. é›¶é’±å…‘æ¢ II 1234567891011121314class Solution {public: int change(int amount, vector&lt;int&gt;&amp; coins) { // dp[i][j] è¡¨ç¤º è€ƒè™‘å‰iä¸ªç‰©å“ï¼Œå‡‘å‡º j çš„æ–¹æ¡ˆæ•° int n = coins.size(); vector&lt;int&gt; dp(amount + 1, 0); dp[0] = 1; for (int i = 0; i &lt; n; i ++) for (int j = coins[i]; j &lt;= amount; j ++) { dp[j] += dp[j - coins[i]]; } return dp[amount]; }}; 879. ç›ˆåˆ©è®¡åˆ’ 12345678910111213141516171819class Solution {public: const int MOD = 1e9 + 7; // dp[i][j][k] è¡¨ç¤º å‰iä¸ªä¸ªç‰©å“ï¼Œäººæ•°ä¸è¶…è¿‡jï¼Œåˆ©æ¶¦è‡³å°‘ä¸ºkçš„æ–¹æ¡ˆæ•° int profitableSchemes(int n, int minProfit, vector&lt;int&gt;&amp; group, vector&lt;int&gt;&amp; profit) { int m = group.size(); vector&lt;vector&lt;int&gt;&gt; dp(n + 1, vector&lt;int&gt;(minProfit + 1, 0)); for (int i = 0; i &lt;= n; i ++) dp[i][0] = 1; for (int i = 1; i &lt;= m; i ++) { int a = group[i - 1], b = profit[i - 1]; for (int j = n; j &gt;= a; j --) for (int k = minProfit; k &gt;= 0; k --) { dp[j][k] += dp[j - a][max(k - b, 0)]; dp[j][k] %= MOD; } } return dp[n][minProfit]; }}; 1049. æœ€åä¸€å—çŸ³å¤´çš„é‡é‡ II æœªä¼˜åŒ–ç©ºé—´ é—®é¢˜è½¬åŒ–ä¸ºï¼šæŠŠä¸€å †çŸ³å¤´åˆ†æˆä¸¤å †,æ±‚ä¸¤å †çŸ³å¤´é‡é‡å·®æœ€å°å€¼è¿›ä¸€æ­¥åˆ†æï¼šè¦è®©å·®å€¼å°,ä¸¤å †çŸ³å¤´çš„é‡é‡éƒ½è¦æ¥è¿‘sum/2;æˆ‘ä»¬å‡è®¾ä¸¤å †åˆ†åˆ«ä¸ºA,B,A&lt;sum/2,B&gt;sum/2,è‹¥Aæ›´æ¥è¿‘sum/2,Bä¹Ÿç›¸åº”æ›´æ¥è¿‘sum/2è¿›ä¸€æ­¥è½¬åŒ–ï¼šå°†ä¸€å †stoneæ”¾è¿›æœ€å¤§å®¹é‡ä¸ºsum/2çš„èƒŒåŒ…,æ±‚æ”¾è¿›å»çš„çŸ³å¤´çš„æœ€å¤§é‡é‡MaxWeight,æœ€ç»ˆç­”æ¡ˆå³ä¸ºsum-2*MaxWeight;ã€ 123456789101112131415161718// d[i][j]ä»£è¡¨è€ƒè™‘å‰ i ä¸ªç‰©å“ï¼ˆæ•°å€¼ï¼‰ï¼Œå‡‘æˆæ€»å’Œä¸è¶…è¿‡ j çš„æœ€å¤§ä»·å€¼ã€‚class Solution {public: int lastStoneWeightII(vector&lt;int&gt;&amp; stones) { int sum = 0, n = stones.size(); for (auto x: stones) sum += x; int t = sum / 2; vector&lt;vector&lt;int&gt;&gt; dp(n + 1, vector&lt;int&gt;(t + 1, 0)); for (int i = 1; i &lt;= n; i ++) { int x = stones[i - 1]; for (int j = 0; j &lt;= t; j ++) { dp[i][j] = dp[i - 1][j]; if (j &gt;= x) dp[i][j] = max(dp[i][j], dp[i - 1][j - x] + x); } } return sum - 2 * dp[n][t]; }}; ä¼˜åŒ–ç©ºé—´ 12345678910111213141516class Solution {public: int lastStoneWeightII(vector&lt;int&gt;&amp; stones) { int sum = 0, n = stones.size(); for (auto x: stones) sum += x; int t = sum / 2; vector&lt;int&gt; dp(t + 1, 0); for (int i = 1; i &lt;= n; i ++) { int x = stones[i - 1]; for (int j = t; j &gt;= x; j --) { dp[j] = max(dp[j], dp[j - x] + x); } } return sum - 2 * dp[t]; }}; 1155. æ·éª°å­çš„Nç§æ–¹æ³• æœªä¼˜åŒ–ç©ºé—´ 1234567891011121314class Solution {public: const int MOD = 1e9 + 7; int numRollsToTarget(int n, int m, int t) { vector&lt;vector&lt;int&gt;&gt; f(n + 1, vector&lt;int&gt;(t + 1, 0)); f[0][0] = 1; for (int i = 1; i &lt;= n; i ++) for (int j = 0; j &lt;= t; j ++) for (int k = 1; k &lt;= m; k ++) { if(j &gt;= k) f[i][j] = (f[i][j] + f[i - 1][j - k]) % MOD; } return f[n][t]; }}; ä¼˜åŒ–ç©ºé—´ 12345678910111213141516class Solution {public: const int MOD = 1e9 + 7; int numRollsToTarget(int n, int m, int t) { vector&lt;int&gt; f(t + 1, 0); f[0] = 1; for (int i = 1; i &lt;= n; i ++) for (int j = t; j &gt;= 0; j --) { f[j] = 0; //ç”±äºæˆ‘ä»¬ç›´æ¥æ˜¯åœ¨ f[i][j]f[i][j] æ ¼å­çš„åŸºç¡€ä¸Šè¿›è¡Œæ–¹æ¡ˆæ•°ç´¯åŠ ï¼Œå› æ­¤åœ¨è®¡ç®— f[i][j]f[i][j] è®°å¾—æ‰‹åŠ¨ç½®é›¶ã€‚ for (int k = 1; k &lt;= m; k ++) { if(j &gt;= k) f[j] = (f[j] + f[j - k]) % MOD; } } return f[t]; }}; 1449. æ•°ä½æˆæœ¬å’Œä¸ºç›®æ ‡å€¼çš„æœ€å¤§æ•°å­— 1234567891011121314151617181920212223242526class Solution {public: // dp[i][j] è¡¨ç¤º è€ƒè™‘å‰iä¸ªç‰©å“ï¼Œæ€»æˆæœ¬ä¸ºjçš„æœ€å¤§æ•´æ•°é•¿åº¦ string largestNumber(vector&lt;int&gt;&amp; cost, int t) { int n = cost.size(); vector&lt;int&gt; dp(t + 1, INT_MIN); dp[0] = 0; for (int i = 1; i &lt;= n; i ++) { int x = cost[i - 1]; for (int j = x; j &lt;= t; j ++) { dp[j] = max(dp[j], dp[j - x] + 1); } } if (dp[t] &lt; 0) return &quot;0&quot;; string res = &quot;&quot;; for (int i = 9, j = t; i &gt;= 1; i --) { int x = cost[i - 1]; while (j &gt;= x &amp;&amp; dp[j] == dp[j - x] + 1) { res += to_string(i); j -= x; } } return res; }}; 1995. ç»Ÿè®¡ç‰¹æ®Šå››å…ƒç»„ 123456789101112131415161718192021class Solution {public: int countQuadruplets(vector&lt;int&gt;&amp; nums) { // dp[i][j][k] è€ƒè™‘å‰iä¸ªæ•°ï¼Œæ°å¥½å‡‘å‡ºjï¼Œä½¿ç”¨ä¸ªæ•°ä¸ºkçš„æ–¹æ¡ˆæ•° int n = nums.size(); vector&lt;vector&lt;vector&lt;int&gt;&gt;&gt; f(n + 1, vector&lt;vector&lt;int&gt;&gt;(110, vector&lt;int&gt;(4, 0))); f[0][0][0] = 1; for (int i = 1; i &lt;= n; i ++) { int x = nums[i - 1]; for (int j = 0; j &lt; 110; j ++) for (int k = 0; k &lt; 4; k ++) { f[i][j][k] += f[i - 1][j][k]; if (j &gt;= x &amp;&amp; k &gt;= 1) f[i][j][k] += f[i - 1][j - x][k - 1]; } } int res = 0; for (int i = 3; i &lt; n; i ++) res += f[i][nums[i]][3]; return res; }};","link":"/2022/01/30/%E7%AE%97%E6%B3%95/%E8%83%8C%E5%8C%85DP/"},{"title":"çº¿æ€§DP","text":"10. æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…12345678910111213141516171819202122232425class Solution {public: bool isMatch(string ss, string pp) { int n = ss.size(), m = pp.size(); string s = &quot; &quot; + ss; string p = &quot; &quot; + pp; // dpçŠ¶æ€è¡¨ç¤ºï¼šdp[i][j] sä»¥iç»“å°¾çš„å­ä¸²ä¸pä»¥jç»“å°¾çš„å­ä¸²æ˜¯å¦åŒ¹é… vector&lt;vector&lt;bool&gt;&gt; dp(n + 1, vector&lt;bool&gt;(m + 1)); dp[0][0] = true; for (int i = 0; i &lt;= n; i ++) for (int j = 1; j &lt;= m; j ++) { if (j + 1 &lt;= m &amp;&amp; p[j + 1] == '*') continue; // ä¸‹ä¸€ä¸ªæ˜¯*ï¼Œå½“å‰ å­—ç¬¦ä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œè·³è¿‡ if (i - 1 &gt;= 0 &amp;&amp; p[j] != '*') { dp[i][j] = dp[i - 1][j - 1] &amp;&amp; (s[i] == p[j] || p[j] == '.'); // å¯¹åº”äº†p[j]ä¸ºæ™®é€šå­—ç¬¦å’Œ'.'ä¸¤ç§æƒ…å†µ } else if (p[j] == '*') { // å­—ç¬¦ä¸º'*' dp[i][j] = (j - 2 &gt;= 0 &amp;&amp; dp[i][j - 2]) || (i - 1 &gt;= 0 &amp;&amp; dp[i - 1][j] &amp;&amp; (s[i] == p[j - 1] || p[j - 1] == '.')); } } return dp[n][m]; }}; 44. é€šé…ç¬¦åŒ¹é…1234567891011121314151617181920class Solution {public: bool isMatch(string ss, string pp) { int n = ss.size(); int m = pp.size(); string s = &quot; &quot; + ss; string p = &quot; &quot; + pp; vector&lt;vector&lt;bool&gt;&gt; dp(n + 1, vector&lt;bool&gt;(m + 1)); dp[0][0] = true; for (int i = 0; i &lt;= n; i ++) for (int j = 1; j &lt;= m; j ++) { if (p[j] != '*') { dp[i][j] = i - 1 &gt;= 0 &amp;&amp; dp[i - 1][j - 1] &amp;&amp; (p[j] == s[i] || p[j] == '?'); } else { dp[i][j] = dp[i][j - 1] || (i - 1 &gt;= 0 &amp;&amp; dp[i - 1][j]); } } return dp[n][m]; }}; 45. è·³è·ƒæ¸¸æˆ II123456789101112class Solution {public: int jump(vector&lt;int&gt;&amp; nums) { int n = nums.size(); vector&lt;int&gt; dp(n); for (int i = 1, j = 0; i &lt; n; i ++) { while (j + nums[j] &lt; i) j ++; dp[i] = dp[j] + 1; } return dp[n - 1]; }}; 91. è§£ç æ–¹æ³•123456789101112131415class Solution {public: int numDecodings(string ss) { int n = ss.size(); string s = &quot; &quot; + ss; vector&lt;int&gt; dp(n + 1, 0); dp[0] = 1; for (int i = 1; i &lt;= n; i ++) { int a = s[i] - '0', b = (s[i - 1] - '0') * 10 + (s[i] - '0'); if (a &gt;= 1 &amp;&amp; a &lt;= 9) dp[i] = dp[i - 1]; if (b &gt;= 10 &amp;&amp; b &lt;= 26) dp[i] += dp[i - 2]; } return dp[n]; }}; 115. ä¸åŒçš„å­åºåˆ—1234567891011121314151617181920class Solution {public: int numDistinct(string ss, string tt) { int n = ss.size(), m = tt.size(); string s = &quot; &quot; + ss; string t = &quot; &quot; + tt; vector&lt;vector&lt;int&gt;&gt; dp(n + 1, vector&lt;int&gt;(m + 1)); // f[i][j] è¡¨ç¤º 0~iï¼Œ0~jçš„å­—ç¬¦ä¸²åŒ¹é…ä¸ªæ•° for (int i = 0; i &lt;= n; i ++) dp[i][0] = 1; for (int i = 1; i &lt;= n; i ++) for (int j = 1; j &lt;= m; j ++) { // ä¸åŒ¹é…s[i] dp[i][j] = dp[i - 1][j]; if (s[i] == t[j]) { // åŒ¹é…s[i] dp[i][j] = (0LL + dp[i][j] + dp[i - 1][j - 1]) % INT_MAX; } } return dp[n][m]; }}; 119. æ¨è¾‰ä¸‰è§’ II123456789101112131415class Solution {public: vector&lt;int&gt; getRow(int rowIndex) { vector&lt;int&gt; dp(rowIndex + 1); dp[0] = 1; for (int i = 1; i &lt;= rowIndex; i ++) for (int j = i; j &gt;= 0; j --) { if (j - 1 &gt;= 0) dp[j] += dp[j - 1]; if (dp[j] == 0) dp[j] = 1; } vector&lt;int&gt; res; for (int i = 0; i &lt; rowIndex + 1; i ++) res.push_back(dp[i]); return res; }}; 213. æ‰“å®¶åŠ«èˆ II1234567891011121314151617181920212223class Solution {public: int rob(vector&lt;int&gt;&amp; nums) { int n = nums.size(); if (n == 1) return nums[0]; vector&lt;vector&lt;int&gt;&gt; dp(n, vector&lt;int&gt;(2, 0)); // ä¸é€‰ç¬¬1é—´, 0ä¸é€‰ï¼Œ1é€‰ for (int i = 1; i &lt; n; i ++) { dp[i][1] = dp[i - 1][0] + nums[i]; dp[i][0] = max(dp[i - 1][0], dp[i - 1][1]); } int res1 = max(dp[n - 1][0], dp[n - 1][1]); dp[0][1] = nums[0], dp[0][0] = 0; for (int i = 1; i &lt; n - 1; i ++) { dp[i][1] = dp[i - 1][0] + nums[i]; dp[i][0] = max(dp[i - 1][0], dp[i - 1][1]); } int res2 = max(dp[n - 2][0], dp[n - 2][1]); return max(res1, res2); }}; 403. é’è›™è¿‡æ²³1234567891011121314151617181920class Solution {public: bool canCross(vector&lt;int&gt;&amp; stones) { int n = stones.size(); if (stones[1] != 1) return false; // dp[i][j]è¡¨ç¤ºè·³åˆ°ä½ç½®iæ­¥é•¿ä¸ºjæ˜¯å¦å¯ä»¥ vector&lt;vector&lt;int&gt;&gt; dp(n + 1, vector&lt;int&gt;(n + 1, 0)); dp[1][1] = true; for (int i = 2; i &lt; n; i ++) for (int j = 1; j &lt; i; j ++) { int k = stones[i] - stones[j]; // æ­¥é•¿ if(k &lt;= j + 1) { dp[i][k] = dp[j][k - 1] || dp[j][k] || dp[j][k + 1]; } } for (int i = 1; i &lt; n; i ++) if (dp[n - 1][i]) return true; return false; }}; 576. å‡ºç•Œçš„è·¯å¾„æ•°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253class Solution {public: const int MOD = (int) 1e9 + 7; int n, m, maxn; int dx[4] = {-1, 0, 1, 0}, dy[4] = {0, 1, 0, -1}; int findPaths(int _m, int _n, int _maxMove, int r, int c) { n = _m, m = _n, maxn = _maxMove; vector&lt;vector&lt;int&gt;&gt; dp(n * m, vector&lt;int&gt;(maxn + 1, 0)); // åˆå§‹åŒ–è¾¹ç¼˜ for (int i = 0; i &lt; n; i ++) for (int j = 0; j &lt; m; j ++) { if (i == 0) add(i, j, dp); if (j == 0) add(i, j, dp); if (i == n - 1) add(i, j, dp); if (j == m - 1) add(i, j, dp); } // f[(x,y)][step]=f[(xâˆ’1,y)][stepâˆ’1]+f[(x+1,y)][stepâˆ’1]+f[(x,yâˆ’1)][stepâˆ’1]+f[(x,y+1)][stepâˆ’1] for (int k = 1; k &lt;= maxn; k ++) { for (int idx = 0; idx &lt; m * n; idx ++) { vector&lt;int&gt; info(2, 0); info = parseIdx(idx); int x = info[0], y = info[1]; for (int i = 0; i &lt; 4; i ++) { int nx = x + dx[i], ny = y + dy[i]; if (nx &lt; 0 || nx &gt;= n || ny &lt; 0 || ny &gt;= m) continue; int nidx = getIdx(nx, ny); dp[idx][k] += dp[nidx][k - 1]; dp[idx][k] %= MOD; } } } return dp[getIdx(r, c)][maxn]; } void add(int x, int y, vector&lt;vector&lt;int&gt;&gt; &amp;dp) { for (int k = 1; k &lt;= maxn; k ++) { dp[getIdx(x, y)][k] ++; } } int getIdx(int x, int y) { return x * m + y; } vector&lt;int&gt; parseIdx(int idx) { return vector&lt;int&gt;{idx / m, idx % m}; }}; 639. è§£ç æ–¹æ³• II1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071class Solution {public: const int MOD = (int) 1e9 + 7; // i è¡¨ç¤ºå½“å‰éå†å­—ç¬¦ä¸‹æ ‡ï¼Œjè¡¨ç¤ºå‰ä¸€ä¸ªå­—ç¬¦ä¸‹æ ‡ // f[i] è¡¨ç¤º ä»¥ s[i] ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œå…±æœ‰å¤šå°‘ç§è§£ç æ–¹æ³• /* s[i] == '*'ï¼š s[i]å¯ä»¥å•ç‹¬ç»„æˆä¸€ä¸ªï¼Œf[i] += f[i - 1] * 9 å¯ä»¥å’Œå‰é¢çš„å­—ç¬¦ç»„æˆï¼š è‹¥s[j] == 1ï¼Œé‚£ä¹ˆ f[i] += f[i - 2] * 9 (11 - 19) è‹¥s[j] == 2ï¼Œé‚£ä¹ˆ f[i] += f[i - 2] * 6 (21 - 26) è‹¥s[j] == *ï¼Œé‚£ä¹ˆ f[i] += f[i - 2] * 15 s[i] != '*'ï¼Œs[i]ä¸ºæ•°å­—æ—¶ï¼š s[j] ä¸º '*'ï¼š s[i] == 0ï¼Œf[i] += f[i - 2] * 2; ï¼ˆ10ï¼Œ20ï¼‰ s[i] != 0ï¼š f[i] = f[i - 1] (1 - 9) 1 &lt;= s[i] &lt;= 6 f[i] += f[i - 2] * 2 ï¼ˆ11 - 16ï¼Œ21 - 26ï¼‰ 7 &lt;= s[i] &lt;= 9 f[i] += f[i - 2] * 1 ï¼ˆ17 - 19ï¼‰ s[j] != '*'ï¼š s[i] == 0ï¼Œf[i] = f[i - 2] (10, 20) s[i] != 0ï¼š f[i] = f[i - 1] (1 - 9) s[j] == 1ï¼Œf[i] = f[i - 2]; (11 - 19) s[j] == 2 ä¸” 1 &lt;= s[i] &lt;= 6 ï¼Œf[i] = f[i - 2]; (21 - 26) */ int numDecodings(string s) { int n = s.size(); vector&lt;long&gt; f(n, 0); // æ³¨æ„è¿™é‡Œè¦long f[0] = s[0] == '*' ? 9 : (s[0] != '0' ? 1 : 0); for (int i = 1; i &lt; n; i ++) { char c = s[i], prev = s[i - 1]; if (c == '*') { f[i] += f[i - 1] * 9; if (prev == '*') f[i] += (i - 2 &gt;= 0 ? f[i - 2] : 1) * 15; else { int u = prev - '0'; if (u == 1) f[i] += (i - 2 &gt;= 0 ? f[i - 2] : 1) * 9; else if (u == 2) f[i] += (i - 2 &gt;= 0 ? f[i - 2] : 1) * 6; } } else { int t = c - '0'; if (prev == '*') { if (t == 0) f[i] += (i - 2 &gt;= 0 ? f[i - 2] : 1) * 2; else { f[i] += f[i - 1]; if (t &gt;= 1 &amp;&amp; t &lt;= 6) f[i] += (i - 2 &gt;= 0 ? f[i - 2] : 1) * 2; if (t &gt;= 7 &amp;&amp; t &lt;= 9) f[i] += (i - 2 &gt;= 0 ? f[i - 2] : 1); } } else { int u = prev - '0'; if (t == 0) { if (u == 1 || u == 2) { f[i] += (i - 2 &gt;= 0 ? f[i - 2] : 1); } } else { f[i] = f[i - 1]; if (u == 1) f[i] += (i - 2 &gt;= 0 ? f[i - 2] : 1); if (u == 2 &amp;&amp; t &lt;= 6) f[i] += (i - 2 &gt;= 0 ? f[i - 2] : 1); } } } f[i] %= MOD; } return (int) f[n - 1]; }}; 650. åªæœ‰ä¸¤ä¸ªé”®çš„é”®ç›˜1234567891011121314151617181920// f[i][j]è¡¨ç¤ºç»è¿‡æœ€åä¸€æ¬¡æ“ä½œï¼Œè®°äº‹æœ¬ä¸Šæœ‰iä¸ªå­—ç¬¦ï¼Œç²˜è´´æ¿ä¸Šæœ‰jä¸ªå­—ç¬¦çš„æœ€å°æ“ä½œæ¬¡æ•°class Solution {public: const int MAX_INT = 0x3f3f3f3f; int minSteps(int n) { vector&lt;vector&lt;int&gt;&gt; dp(n + 1, vector&lt;int&gt;(n + 1, MAX_INT)); dp[1][0] = 0, dp[1][1] = 1; for (int i = 2; i &lt;= n; i ++) { int minN = MAX_INT; for (int j = 0; j &lt;= i / 2; j ++) { dp[i][j] = dp[i - j][j] + 1; // paste minN = min(minN, dp[i][j]); } dp[i][i] = minN + 1; // copy all } int res = MAX_INT; for (int i = 0; i &lt;= n; i ++) res = min(res, dp[n][i]); return res; }}; 678. æœ‰æ•ˆçš„æ‹¬å·å­—ç¬¦ä¸²1234567891011121314151617181920212223class Solution {public: bool checkValidString(string s) { int n = s.size(); vector&lt;vector&lt;bool&gt;&gt; dp(n + 1, vector&lt;bool&gt;(n + 1, 0)); dp[0][0] = true; for (int i = 1; i &lt;= n; i ++) { char c = s[i - 1]; for (int j = 0; j &lt;= i; j ++) { if (c == '(') { if (j - 1 &gt;= 0) dp[i][j] = dp[i - 1][j - 1]; } else if (c == ')') { if (j + 1 &lt;= i) dp[i][j] = dp[i - 1][j + 1]; } else { dp[i][j] = dp[i - 1][j]; if (j - 1 &gt;= 0) dp[i][j] = dp[i][j] | dp[i - 1][j - 1]; if (j + 1 &lt;= i) dp[i][j] = dp[i][j] | dp[i - 1][j + 1]; } } } return dp[n][0]; }}; 1220. ç»Ÿè®¡å…ƒéŸ³å­—æ¯åºåˆ—çš„æ•°ç›®12345678910111213141516171819202122232425262728293031class Solution {public: const int MOD = 1e9 + 7; // dp[i][j] è¡¨ç¤º é•¿åº¦ä¸ºiçš„å­—ç¬¦ä¸²ï¼Œç»“å°¾ä¸ºjçš„å­—ç¬¦ä¸² çš„ ä¸ªæ•° int countVowelPermutation(int n) { vector&lt;vector&lt;long&gt;&gt; dp(n, vector&lt;long&gt;(5, 0)); for (int i = 0; i &lt; 5; i ++) dp[0][i] = 1; for (int i = 1; i &lt; n; i ++) { // æ¯ä¸ªå…ƒéŸ³ 'a' åé¢éƒ½åªèƒ½è·Ÿç€ 'e' dp[i][1] += dp[i - 1][0]; // æ¯ä¸ªå…ƒéŸ³ 'e' åé¢åªèƒ½è·Ÿç€ 'a' æˆ–è€…æ˜¯ 'i' dp[i][0] += dp[i - 1][1]; dp[i][2] += dp[i - 1][1]; // æ¯ä¸ªå…ƒéŸ³ 'i' åé¢ ä¸èƒ½ å†è·Ÿç€å¦ä¸€ä¸ª 'i' dp[i][0] += dp[i - 1][2]; dp[i][1] += dp[i - 1][2]; dp[i][3] += dp[i - 1][2]; dp[i][4] += dp[i - 1][2]; // æ¯ä¸ªå…ƒéŸ³ 'o' åé¢åªèƒ½è·Ÿç€ 'i' æˆ–è€…æ˜¯ 'u' dp[i][2] += dp[i - 1][3]; dp[i][4] += dp[i - 1][3]; // æ¯ä¸ªå…ƒéŸ³ 'u' åé¢åªèƒ½è·Ÿç€ 'a' dp[i][0] += dp[i - 1][4]; for (int j = 0; j &lt; 5; j ++) dp[i][j] %= MOD; } long res = 0; for (int i = 0; i &lt; 5; i ++) res += dp[n - 1][i]; return (int) (res % MOD); }}; 1751. æœ€å¤šå¯ä»¥å‚åŠ çš„ä¼šè®®æ•°ç›® II1234567891011121314151617181920212223242526272829303132333435class Solution {public: static bool cmp(vector&lt;int&gt; a, vector&lt;int&gt; b) { // å‡åºæ’åº return a[1] &lt;= b[1]; } int maxValue(vector&lt;vector&lt;int&gt;&gt;&amp; events, int k) { int n = events.size(); vector&lt;vector&lt;int&gt;&gt; dp(n + 1, vector&lt;int&gt;(k + 1, 0)); sort(events.begin(), events.end(), cmp); for (int i = 0; i &lt; n; i ++) printf(&quot;[%d %d %d]&quot;, events[i][0], events[i][1], events[i][2]); for (int i = 1; i &lt;= n; i ++) { auto p = events[i - 1]; int s = p[0], e = p[1], v = p[2]; int last = 0; for (int t = i - 1; t &gt;= 1; t --) { auto l = events[t - 1]; if (s &gt; l[1]) { last = t; // æ›´æ–°ä¸ºä¸å†²çªçš„äº‹ä»¶ä¸‹æ ‡ break; } } for (int j = 1; j &lt;= k; j ++) { dp[i][j] = max(dp[i - 1][j], dp[last][j - 1] + v); // é€‰ä¸ä¸é€‰ } } return dp[n][k]; }}; 1787. ä½¿æ‰€æœ‰åŒºé—´çš„å¼‚æˆ–ç»“æœä¸ºé›¶12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152class Solution {public: /* æ˜“çŸ¥ï¼Œå°†numsæ’åˆ—ä¸ºä¸€ä¸ªäºŒç»´æ•°ç»„ï¼ˆæ¯è¡Œä¸ºkä¸ªï¼‰ï¼Œé—®é¢˜å°†è½¬åŒ–ä¸ºï¼š ä½¿å¾—æ¯åˆ—ç›¸ç­‰ï¼Œä¸”æœ€ç»ˆé¦–è¡Œå¼‚æˆ–å€¼ä¸º0çš„æ›´æ”¹å…ƒç´ æ•° å®šä¹‰ f[i][xor]ä¸ºè€ƒè™‘å‰iåˆ—ï¼Œä¸”é¦–è¡Œå‰iåˆ—å¼‚æˆ–å€¼çš„xorçš„æ›´æ”¹å…ƒç´ æ•° ç”±äºéœ€è¦çŸ¥é“i - 1åˆ—çš„æœ€å°æ›´æ”¹å…ƒç´ æ•°ï¼Œä½¿ä¹‹è½¬æ€è½¬ç§»ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªçŠ¶æ€æ•°ç»„prev å¦å¤–ï¼Œä½¿ç”¨ mapè®°å½•æ¯ä¸€åˆ—æ•°å­—å¯¹åº”çš„ä¸ªæ•° cntè®°å½•æ¯ä¸€åˆ—æ•°å­—æ€»æ•° æ‰€ä»¥ï¼Œåˆ†æçŠ¶æ€è½¬ç§»æ–¹ç¨‹ å½“åœ¨ç¬¬0åˆ—æ—¶ï¼š f[0][xor] = f[0][xor] + cnt - map[xor] å½“åœ¨å…¶ä»–åˆ—æ—¶ï¼Œéœ€è¦è€ƒè™‘ä»å‰ä¸€åˆ—è½¬ç§»çš„çŠ¶æ€ï¼š å¦å¤–ï¼Œè¿˜æœ‰ è€ƒè™‘æ•´åˆ—ä¿®æ”¹ï¼š f[i][xor] = f[i - 1][xor] + cnt; è€ƒè™‘éƒ¨åˆ†ä¿®æ”¹ï¼š f[i][xor] = f[i - 1][xor ^ cur] + cnt - map[cur]; */ const int maxVal = INT_MAX / 2; const int maxHalf = 1 &lt;&lt; 10; int minChanges(vector&lt;int&gt;&amp; nums, int k) { int n = nums.size(); vector&lt;vector&lt;int&gt;&gt; dp(k, vector&lt;int&gt;(maxHalf, maxVal)); vector&lt;int&gt; prev(k, maxVal); for (int i = 0; i &lt; k; i ++) { // éå†æ¯ä¸€åˆ— int cnt = 0; unordered_map&lt;int, int&gt; map; for (int j = i; j &lt; n; j += k) { map[nums[j]] ++; cnt ++; } if (i == 0) { // ç¬¬0åˆ— for (int x = 0; x &lt; maxHalf; x ++) { dp[0][x] = min(dp[0][x], cnt - map[x]); prev[0] = min(prev[0], dp[0][x]); } } else { // å…¶ä»–åˆ— for (int x = 0; x &lt; maxHalf; x ++) { dp[i][x] = prev[i - 1] + cnt; for (auto &amp;it: map) { dp[i][x] = min(dp[i][x], dp[i - 1][x ^ it.first] + cnt - it.second); } prev[i] = min(prev[i], dp[i][x]); } } } return dp[k - 1][0]; }}; å‰‘æŒ‡ Offer 42. è¿ç»­å­æ•°ç»„çš„æœ€å¤§å’Œ1234567891011121314class Solution {public: int maxSubArray(vector&lt;int&gt;&amp; nums) { int n = nums.size(); vector&lt;int&gt; dp(n, 0); dp[0] = nums[0]; int ans = dp[0]; for (int i = 1; i &lt; n; i ++) { dp[i] = max(nums[i], dp[i - 1] + nums[i]); ans = max(ans, dp[i]); } return ans; }}; LCP 07. ä¼ é€’ä¿¡æ¯12345678910111213class Solution {public: int numWays(int n, vector&lt;vector&lt;int&gt;&gt;&amp; relation, int k) { vector&lt;vector&lt;int&gt;&gt; dp(k + 1, vector&lt;int&gt;(15, 0)); dp[0][0] = 1; for (int i = 1; i &lt;= k; i ++) for(auto &amp;r: relation) { int a = r[0], b = r[1]; dp[i][b] += dp[i - 1][a]; } return dp[k][n - 1]; }};","link":"/2022/01/30/%E7%AE%97%E6%B3%95/%E7%BA%BF%E6%80%A7DP/"},{"title":"åºåˆ—DP","text":"334. é€’å¢çš„ä¸‰å…ƒå­åºåˆ— 12345678910111213141516class Solution {public: bool increasingTriplet(vector&lt;int&gt;&amp; nums) { int small = INT_MAX, big = INT_MAX; for (int x: nums) { if (x &lt;= small) { small = x; } else if (x &lt;= big) { big = x; } else { return true; } } return false; }}; 1234567891011121314151617181920class Solution {public: bool increasingTriplet(vector&lt;int&gt;&amp; nums) { int n = nums.size(); vector&lt;int&gt; f(n + 1, INT_MAX); // f[len] = x è¡¨ç¤º ä»¥ é•¿åº¦ä¸º len çš„åºåˆ—çš„æœ€å°å°¾å…ƒç´ ä¸ºx int ans = 1; for (int i = 0; i &lt; n; i ++) { int l = 1, r = i + 1; int x = nums[i]; while (l &lt; r) { // äºŒåˆ†æŸ¥æ‰¾å°äºnums[i]çš„æœ€å°å…ƒç´  int mid = l + r &gt;&gt; 1; if (f[mid] &gt;= x) r = mid; else l = mid + 1; } f[r] = x; ans = max(ans, r); } return ans &gt;= 3; }}; 354. ä¿„ç½—æ–¯å¥—å¨ƒä¿¡å°é—®é¢˜ 123456789101112131415161718class Solution {public: int maxEnvelopes(vector&lt;vector&lt;int&gt;&gt;&amp; envelopes) { int n = envelopes.size(); vector&lt;int&gt; f(n, 0); // ä»¥ i ç»“å°¾çš„æœ€å¤§ä¿¡å° sort(envelopes.begin(), envelopes.end()); int res = 0; for (int i = 0; i &lt; n; i ++) { f[i] = 1; for (int j = 0; j &lt; i; j ++) { if (envelopes[i][0] &gt; envelopes[j][0] &amp;&amp; envelopes[i][1] &gt; envelopes[j][1]) f[i] = max(f[i], f[j] + 1); } res = max(res, f[i]); } return res; }}; 368. æœ€å¤§æ•´é™¤å­é›† 1234567891011121314151617181920212223242526272829class Solution {public: vector&lt;int&gt; largestDivisibleSubset(vector&lt;int&gt;&amp; nums) { int n = nums.size(); vector&lt;int&gt; f(n, 0); // f[i] è¡¨ç¤º å‰iä¸ªæ•°ä¸­ä»¥a[i]ç»“å°¾çš„æ•´é™¤å­é›†çš„æœ€é•¿åºåˆ—çš„å…ƒç´ ä¸ªæ•° sort(nums.begin(), nums.end()); int k = 0; // æ•´é™¤åºåˆ—æœ€åä¸€ä¸ªå…ƒç´ ä¸‹æ ‡ for (int i = 0; i &lt; n; i ++) { f[i] = 1; for (int j = 0; j &lt; i; j ++) if (nums[i] % nums[j] == 0) f[i] = max(f[i], f[j] + 1); if (f[k] &lt; f[i]) k = i; } vector&lt;int&gt; res; // é€†æ¨å¾—å‡ºç­”æ¡ˆ while (true) { res.push_back(nums[k]); if (f[k] == 1) break; // åªå‰©ä¸€ä¸ªå…ƒç´  for (int i = 0; i &lt; k; i ++) { if ((nums[k] % nums[i] == 0) &amp;&amp; f[k] == f[i] + 1) { k = i; break; } } } return res; }}; 390. æ¶ˆé™¤æ¸¸æˆ 1234567class Solution {public: int lastRemaining(int n) { if (n == 1) return 1; return 2 * (n / 2 + 1 - lastRemaining(n / 2)); }}; 446. ç­‰å·®æ•°åˆ—åˆ’åˆ† II - å­åºåˆ— LeetCode 446. ç­‰å·®æ•°åˆ—åˆ’åˆ† II - å­åºåˆ— - AcWing 12345678910111213141516171819202122class Solution {public: int numberOfArithmeticSlices(vector&lt;int&gt;&amp; a) { typedef long long LL; int n = a.size(); // ç”±äºæ¯ä¸ªæ•°å¯èƒ½éƒ½ä¼šåœ¨ä¸åŒç­‰å·®æ•°åˆ—ä¸­ï¼Œéœ€è¦ç”¨å“ˆå¸Œè¡¨æ¥å­˜ vector&lt;unordered_map&lt;LL, int&gt;&gt; f(n); // f[i][j] è¡¨ç¤º è€ƒè™‘ä»¥ç¬¬ i ä¸ªæ•°ç»“å°¾ å…¬å·®ä¸ºjçš„ç­‰å·®æ•°åˆ—çš„ä¸ªæ•° int res = 0; for (int i = 0; i &lt; n; i ++) for (int k = 0; k &lt; i; k ++) { LL j = (LL)a[i] - a[k]; auto it = f[k].find(j); // æŸ¥æ‰¾a[k]ç»“å°¾å…¬å·®ä¸ºjçš„ç­‰å·®æ•°åˆ—çš„ä¸ªæ•° int t = 0; if (it != f[k].end()) { t = it-&gt;second; res += t; } f[i][j] += t + 1; } return res; }}; 472. è¿æ¥è¯ 123456789101112131415161718192021222324252627282930313233343536373839404142class Solution {public: typedef unsigned long long ULL; unordered_set&lt;ULL&gt; hash; const int P = 131; vector&lt;string&gt; findAllConcatenatedWordsInADict(vector&lt;string&gt;&amp; words) { // åˆå§‹åŒ–å­—ç¬¦ä¸²å“ˆå¸Œè¡¨ for (auto &amp;s: words) { ULL t = 0; for (auto &amp;c: s) { t = t * P + c; } hash.insert(t); } vector&lt;string&gt; res; for (auto &amp;s: words) if (check(s)) res.push_back(s); return res; } bool check(string str) { int n = str.size(); vector&lt;int&gt; f(n + 1, -1); // f[i] è¡¨ç¤º åœ¨iå‰é¢çš„è¿æ¥è¯çš„ä¸ªæ•° f[0] = 0; for (int i = 0; i &lt;= n; i ++) { if (f[i]== -1) continue; ULL cur = 0; for (int j = i + 1; j &lt;= n; j ++) { cur = cur * P + str[j - 1]; if (hash.count(cur)) { f[j] = max(f[j], f[i] + 1); } } if (f[n] &gt;= 2) return true; } return false; }}; 583. ä¸¤ä¸ªå­—ç¬¦ä¸²çš„åˆ é™¤æ“ä½œ 123456789101112131415161718class Solution {public: int minDistance(string word1, string word2) { int n = word1.size(), m = word2.size(); vector&lt;vector&lt;int&gt;&gt; f(n + 1, vector&lt;int&gt;(m + 1, 0)); for (int i = 0; i &lt;= n; i ++) f[i][0] = 1; for (int j = 0; j &lt;= m; j ++) f[0][j] = 1; for (int i = 1; i &lt;= n; i ++) for (int j = 1; j &lt;= m; j ++) { f[i][j] = max(f[i][j - 1], f[i - 1][j]); if (word1[i - 1] == word2[j - 1]) { f[i][j] = max(f[i][j], f[i - 1][j - 1] + 1); } } int maxn = f[n][m] - 1; return n + m - 2 * maxn; }}; 629. Kä¸ªé€†åºå¯¹æ•°ç»„ LeetCode 629. Kä¸ªé€†åºå¯¹æ•°ç»„ - AcWing 123456789101112131415161718class Solution {public: const int MOD = 1e9 + 7; int kInversePairs(int n, int k) { // f[i][j] è¡¨ç¤º æ‰€æœ‰ç”±æ•°å­— 1 ~ i ç»„æˆçš„å«æœ‰ j ä¸ª é€†åºå¯¹çš„æ•°ç»„ä¸ªæ•° vector&lt;vector&lt;int&gt;&gt; f(n + 1, vector&lt;int&gt;(k + 1, 0)); f[1][0] = 1; for (int i = 2; i &lt;= n; i ++) { long long s = 0; for (int j = 0; j &lt;= k; j ++) { s += f[i - 1][j]; if (j &gt;= i) s -= f[i - 1][j - i]; f[i][j] = s % MOD; } } return (f[n][k] + MOD) % MOD; } }; 673. æœ€é•¿é€’å¢å­åºåˆ—çš„ä¸ªæ•° 123456789101112131415161718192021class Solution {public: int findNumberOfLIS(vector&lt;int&gt;&amp; nums) { int n = nums.size(); vector&lt;int&gt; f(n), g(n); // f è¡¨ç¤º ä»¥iç»“å°¾çš„æœ€é•¿ä¸Šå‡å­åºåˆ—é•¿åº¦ï¼Œg è¡¨ç¤º ä»¥ i ç»“å°¾çš„æœ€é•¿ä¸Šå‡å­åºåˆ—çš„ä¸ªæ•° int maxl = 0, cnt = 0; // maxlæ˜¯æœ€é•¿å­åºåˆ—é•¿åº¦ï¼Œcntæ˜¯å­åºåˆ—ä¸ªæ•° for (int i = 0; i &lt; n; i ++) { f[i] = g[i] = 1; for (int j = 0; j &lt; i; j ++) { if (nums[j] &lt; nums[i]) { if (f[i] &lt; f[j] + 1) f[i] = f[j] + 1, g[i] = g[j]; else if (f[i] == f[j] + 1) g[i] += g[j]; } } if (maxl &lt; f[i]) maxl = f[i], cnt = g[i]; else if (maxl == f[i]) cnt += g[i]; } return cnt; }}; 689. ä¸‰ä¸ªæ— é‡å å­æ•°ç»„çš„æœ€å¤§å’Œ 1234567891011121314151617181920212223242526272829303132333435363738394041class Solution {public: vector&lt;int&gt; maxSumOfThreeSubarrays(vector&lt;int&gt;&amp; nums, int k) { int n = nums.size(); vector&lt;int&gt; s(n, 0); int sum = 0; for (int i = 0; i &lt; n; i ++) { sum += nums[i]; if (i &gt;= k) sum -= nums[i - k]; if (i &gt;= k - 1) s[i - k + 1] = sum; } vector&lt;int&gt; left(n, 0), right(n, 0); int maxIndex = 0; for (int i = 0; i &lt; n; i ++) { if (s[maxIndex] &lt; s[i]) maxIndex = i; left[i] = maxIndex; } maxIndex = n - 1; for (int i = n - 1; i &gt;= 0; i --) { if (s[maxIndex] &lt;= s[i]) maxIndex = i; right[i] = maxIndex; } vector&lt;int&gt; res(3, -1); for (int i = k; i &lt; n - k; i ++) { if (res[0] == -1 || s[res[0]] + s[res[1]] + s[res[2]] &lt; s[i] + s[left[i - k]] + s[right[i + k]]) { res[0] = left[i - k]; res[1] = i; res[2] = right[i + k]; } } return res; }}; 740. åˆ é™¤å¹¶è·å¾—ç‚¹æ•° 1234567891011121314151617181920class Solution {public: const int N = 1e4 + 10; int deleteAndEarn(vector&lt;int&gt;&amp; nums) { // f[i][j] è¡¨ç¤ºæ˜¯å¦åˆ é™¤ j æ•° çš„ æœ€å¤§ç‚¹æ•° int n = nums.size(); int maxn = 0; vector&lt;int&gt; cnt(N); for(auto x: nums) { cnt[x] ++; maxn = max(maxn, x); } vector&lt;vector&lt;int&gt;&gt; f(maxn + 1, vector&lt;int&gt;(2, 0)); for (int i = 1; i &lt;= maxn; i ++) { f[i][0] = max(f[i - 1][0], f[i - 1][1]); f[i][1] = max(f[i][1], f[i - 1][0] + cnt[i] * i); } return max(f[maxn][0], f[maxn][1]); }}; 978. æœ€é•¿æ¹æµå­æ•°ç»„ 12345678910111213141516171819// ä¼˜åŒ–äº†ç©ºé—´class Solution {public: int maxTurbulenceSize(vector&lt;int&gt;&amp; arr) { int n = arr.size(); // f[i][0/1]è¡¨ç¤º ä»¥iç»“å°¾çš„æ•°ç»„ å…ƒç´ çŠ¶æ€ä¸ºjçš„æœ€å¤§æ¹æµå­æ•°ç»„é•¿åº¦ vector&lt;vector&lt;int&gt;&gt; f(2, vector&lt;int&gt;(2, 0)); int ans = 1; f[0][0] = f[0][1] = 1; for (int i = 1; i &lt; n; i ++) { for (int j = 0; j &lt; 2; j ++) f[i % 2][j] = 1; if (arr[i - 1] &lt; arr[i]) f[i % 2][0] = f[(i - 1) % 2][1] + 1; if (arr[i - 1] &gt; arr[i]) f[i % 2][1] = f[(i - 1) % 2][0] + 1; for (int j = 0; j &lt; 2; j ++) ans = max(ans, f[i % 2][j]); } return ans; }}; 1035. ä¸ç›¸äº¤çš„çº¿ 123456789101112131415161718class Solution {public: int maxUncrossedLines(vector&lt;int&gt;&amp; nums1, vector&lt;int&gt;&amp; nums2) { int n = nums1.size(), m = nums2.size(); // f[i][j] è¡¨ç¤º è€ƒè™‘ å‰ i ä¸ª æ•°å­—ï¼Œå‰ j ä¸ªæ•°å­—ç»„æˆæœ€å¤§å…¬å…±å­åºåˆ—é•¿åº¦ // æœ€é•¿å…¬å…±å­åºåˆ— æ˜¯è€ƒè™‘çš„æƒ…å†µæ˜¯ä¸ä¸€å®šåŒ…å«ç¬¬iä¸ªå­—ç¬¦çš„ // ä¾‹å¦‚ï¼Œæˆ‘ä»¬é€šå¸¸è€ƒè™‘f[i - 1][j]ä¸ºå‰i - 1ï¼Œjä¸ªæ•°å­—çš„æœ€é•¿å­åºåˆ—ï¼Œä½†è¿™é‡Œä¸ä¸€å®šåŒ…å«ç¬¬jä¸ªï¼Œåªæ˜¯å¯èƒ½ï¼Œæ‰€ä»¥ f[i - 1][j] åŒ…å« f[i - 1][j - 1]; vector&lt;vector&lt;int&gt;&gt; f(n + 1, vector&lt;int&gt;(m + 1, 0)); for (int i = 1; i &lt;= n; i ++) for (int j = 1; j &lt;= m; j ++) { f[i][j] = max(f[i - 1][j], f[i][j - 1]); if (nums1[i - 1] == nums2[j - 1]) { f[i][j] = max(f[i][j], f[i - 1][j - 1] + 1); } } return f[n][m]; }}; 1143. æœ€é•¿å…¬å…±å­åºåˆ— 12345678910111213141516class Solution {public: int longestCommonSubsequence(string text1, string text2) { int n = text1.size(), m = text2.size(); vector&lt;vector&lt;int&gt;&gt; f(n + 1, vector&lt;int&gt;(m + 1, 0)); for (int i = 1; i &lt;= n; i ++) for (int j = 1; j &lt;= m; j ++) { f[i][j] = max(f[i - 1][j], f[i][j - 1]); if (text1[i - 1] == text2[j - 1]) { f[i][j] = max(f[i][j], f[i - 1][j - 1] + 1); } } return f[n][m]; }}; 1218. æœ€é•¿å®šå·®å­åºåˆ— 1234567891011121314151617181920212223class Solution {public: // æ³¨æ„è¦†ç›–é—®é¢˜ï¼šhash.inserté‡åˆ°ä¸€æ ·çš„é”®ä¸ä¼šè¦†ç›– // ç”±äº arré•¿åº¦ ä¸º 1e5ï¼Œä¸èƒ½ç”¨ä¸¤å±‚å¾ªç¯ï¼Œä½¿ç”¨å“ˆå¸Œè¡¨è¿›è¡Œä¼˜åŒ– int longestSubsequence(vector&lt;int&gt;&amp; arr, int diff) { int n = arr.size(); // f[i][j] è¡¨ç¤º å‰iä¸ªæ•°ï¼Œç¬¬iä¸ªæ•°é€‰æˆ–ä¸é€‰çš„æœ€é•¿å®šå·®å­åºåˆ—é•¿åº¦ vector&lt;vector&lt;int&gt;&gt; f(n, vector&lt;int&gt;(2, 0)); f[0][1] = 1; unordered_map&lt;int, int&gt; hash; hash[arr[0]] = 0; for (int i = 1; i &lt; n; i ++) { f[i][0] = max(f[i - 1][0], f[i - 1][1]); f[i][1] = 1; int prev = arr[i] - diff; if (hash.count(prev)) { f[i][1] = max(f[i][1], f[hash[prev]][1] + 1); } hash[arr[i]] = i; } return max(f[n - 1][0], f[n - 1][1]); }}; 1473. ç²‰åˆ·æˆ¿å­ III 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051class Solution {public: const int INF = 0x3f3f3f3f; int minCost(vector&lt;int&gt;&amp; houses, vector&lt;vector&lt;int&gt;&gt;&amp; cost, int n, int m, int t) { // f[i][j][k] è¡¨ç¤º è€ƒæ…®å‰iä¸ªæˆ¿å­ï¼Œç¬¬iä¸ªæˆ¿å­ç²‰åˆ·ä¸ºjï¼Œåˆ†åŒºæ•°é‡ä¸ºkçš„æ‰€æœ‰æ–¹æ¡ˆä¸­çš„æœ€å°æ€»èŠ±è´¹ vector&lt;vector&lt;vector&lt;int&gt;&gt;&gt; f(n + 1, vector&lt;vector&lt;int&gt;&gt;(m + 1, vector&lt;int&gt;(t + 1, 0))); for (int i = 0; i &lt;= n; i ++) for (int j = 0; j &lt;= m; j ++) f[i][j][0] = INF; for (int i = 1; i &lt;= n; i ++) { int color = houses[i - 1]; // å½“å‰æˆ¿å­çš„é¢œè‰² for (int j = 1; j &lt;= m; j ++) { for (int k = 1; k &lt;= t; k ++) { if (k &gt; i) { // å¦‚æœåˆ†åŒºæ•°é‡å¤§äºæˆ¿å­æ•°ï¼Œä¸åˆæ³• f[i][j][k] = INF; continue; } if (color != 0) { // å½“å‰æˆ¿å­å·²ç»æŸ“è‰² if (color == j) { // åªæœ‰ä¸å½“å‰é¢œè‰²ç›¸åŒæ‰èƒ½è¢«è½¬ç§» int tmp = INF; for (int p = 1; p &lt;= m; p ++) { // ä¸å‰é¢é¢œè‰²ä¸åŒï¼ˆå¯ç»„æˆåˆ†åŒºçš„æƒ…å†µï¼‰ if (p != j) { tmp = min(tmp, f[i - 1][p][k - 1]); } } f[i][j][k] = min(f[i - 1][j][k], tmp); // ä¸å‰é¢é¢œè‰²ç›¸åŒçš„æƒ…å†µ } else { f[i][j][k] = INF; } } else { // å½“å‰æˆ¿å­æœªè¢«æŸ“è‰² int u = cost[i - 1][j - 1]; int tmp = INF; for (int p = 1; p &lt;= m; p ++) { // ä¸å‰é¢é¢œè‰²ä¸åŒï¼ˆå¯ç»„æˆåˆ†åŒºçš„æƒ…å†µï¼‰ if (p != j) { tmp = min(tmp, f[i - 1][p][k - 1]); } } f[i][j][k] = min(f[i - 1][j][k], tmp) + u; // ä¸å‰é¢é¢œè‰²ç›¸åŒçš„æƒ…å†µ } } } } int ans = INF; for (int i = 1; i &lt;= m; i ++) ans = min(ans, f[n][i][t]); return ans == INF ? -1: ans; }}; 1713. å¾—åˆ°å­åºåˆ—çš„æœ€å°‘æ“ä½œæ¬¡æ•° 123456789101112131415161718192021222324252627282930313233343536373839class Solution {public: /* target 6 4 8 1 3 2 arr 4 7 6 2 3 8 6 1 list 1 0 5 4 2 0 3 */ int minOperations(vector&lt;int&gt;&amp; t, vector&lt;int&gt;&amp; a) { int n = t.size(), m = a.size(); unordered_map&lt;int, int&gt; hash; for (int i = 0; i &lt; n; i ++) hash.insert({t[i], i}); // å»ºç«‹ target å’Œ arr çš„æ˜ å°„å…³ç³» vector&lt;int&gt; list; for (auto x: a) { // ç”±äºtargetå„å…ƒç´ ä¸ç›¸åŒï¼Œlistä¸­ä¿å­˜äº†arrä¸targetç›¸åŒå…ƒç´ çš„ä¸‹æ ‡ï¼Œå¹¶ä¸”é€’å¢ï¼Œæ•…å¯è½¬åŒ–ä¸ºLISé—®é¢˜ if (hash.count(x)) list.push_back(hash[x]); } int cnt = list.size(); // q[i] è¡¨ç¤º é•¿åº¦ä¸ºiçš„ä¸Šå‡å­åºåˆ— ä¸­æœ«å°¾å…ƒç´ æœ€å°çš„æ•° vector&lt;int&gt; q(cnt + 1, 0); // ä½¿ç”¨LISçš„è´ªå¿ƒ+äºŒåˆ†çš„æ–¹æ³•æ±‚è§£ï¼Œå¤æ‚åº¦ä¸ºnlog(n) // ä¸ªäººæ„Ÿè§‰è¿™ç§ä¼˜åŒ–æ–¹å¼ä¸»è¦æ˜¯ç»´æŠ¤ä¸€ä¸ªå•è°ƒé˜Ÿåˆ—ï¼Œæ¯æ¬¡åŠ å…¥æ–°çš„å…ƒç´ ï¼Œè¦å’Œä¹‹å‰åŠ å…¥çš„å¯¹æ¯”ï¼Œ // æ‰¾åˆ°æ¯”è‡ªå·±å°çš„æœ€åä¸€ä¸ªæ•°ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥ä»£æ›¿è¿™ä¹‹å‰çš„é‚£ä¸ªæ•°ï¼Œå› ä¸ºå®ƒæ›´å°ï¼Œæ›´å¥½ç»´æŠ¤é€’å¢åºåˆ—ï¼Œ // ä¾‹å¦‚ 1 3 5 ï¼ŒåŠ å…¥1ä¸ª4ï¼ˆè§„å®šé•¿åº¦3ï¼‰ï¼Œé‚£è‚¯å®š4æ›¿æ¢æ‰5æ›´å¥½ int len = 0; for (int i = 0; i &lt; cnt; i ++) { int l = 0, r = len; while (l &lt; r) { int mid = l + r + 1 &gt;&gt; 1; if (q[mid] &lt; list[i]) l = mid; else r = mid - 1; } q[r + 1] = list[i]; if (r + 1 &gt; len) len ++; } return n - len; }};","link":"/2022/01/30/%E7%AE%97%E6%B3%95/%E5%BA%8F%E5%88%97DP/"},{"title":"Spring Beanç”Ÿå‘½å‘¨æœŸ","text":"1 å‰è¨€â€‹ Beanæ˜¯ç”±Spring IoCå®¹å™¨å®ä¾‹åŒ–ï¼Œç»„è£…å’Œç®¡ç†çš„å¯¹è±¡ï¼Œå¹¶ä¸”Spring Beançš„ç”Ÿå‘½å‘¨æœŸå®Œå…¨ç”±å®¹å™¨æ§åˆ¶ã€‚è¿™é‡Œæ‰€è¯´çš„ç”Ÿå‘½å‘¨æœŸä¸»è¦æ˜¯æŒ‡singleton beanï¼Œå¯¹äºprototypeçš„beanï¼ŒSpringåœ¨åˆ›å»ºå¥½äº¤ç»™ä½¿ç”¨è€…åå°†ä¸ä¼šç®¡ç†åç»­çš„ç”Ÿå‘½å‘¨æœŸã€‚ â€‹ å¯¹äºSpring Beançš„ç”Ÿå‘½å‘¨æœŸï¼Œæœ¬æ–‡å°†ä¼šä»ä»¥ä¸‹ä¸¤éƒ¨åˆ†å°†ï¼š ç”Ÿå‘½å‘¨æœŸçš„æ¦‚è¦æµç¨‹ æ‰©å±•ç‚¹çš„ä½œç”¨ 2 Beanç”Ÿå‘½å‘¨æœŸæ¦‚è¿°â€‹ æˆ‘ä»¬çŸ¥é“å¯¹äºæ™®é€šçš„Javaå¯¹è±¡æ¥è¯´ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ï¼š åˆ›å»ºé˜¶æ®µ(Created) åº”ç”¨é˜¶æ®µ(In Use) ä¸å¯è§é˜¶æ®µ(Invisible) ä¸å¯è¾¾é˜¶æ®µ(Unreachable) æ”¶é›†é˜¶æ®µ(Collected) ç»ˆç»“é˜¶æ®µ(Finalized) å¯¹è±¡ç©ºé—´é‡åˆ†é…é˜¶æ®µ(De-allocated) â€‹ è€Œå¯¹äºSpring Beanæ¥è¯´ï¼Œå¯ä»¥æ¦‚è¿°ä¸º4ä¸ªé˜¶æ®µï¼š å®ä¾‹åŒ–ï¼ˆInstantiationï¼‰ å±æ€§èµ‹å€¼ï¼ˆPopulateï¼‰ åˆå§‹åŒ–ï¼ˆInitializationï¼‰ é”€æ¯ï¼ˆDestructionï¼‰ ä»å›¾ä¸­åˆ†æ å®ä¾‹åŒ–ï¼šç¬¬1æ­¥ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªbeanå¯¹è±¡ å±æ€§èµ‹å€¼ï¼šç¬¬2æ­¥ï¼Œä¸ºbeanå¯¹è±¡è®¾ç½®ç›¸å…³å±æ€§å’Œä¾èµ– åˆå§‹åŒ–ï¼šç¬¬ 3~7 æ­¥ï¼Œæ­¥éª¤è¾ƒå¤šï¼Œå…¶ä¸­ç¬¬ 5ã€6 æ­¥ä¸ºåˆå§‹åŒ–æ“ä½œï¼Œç¬¬ 3ã€4 æ­¥ä¸ºåœ¨åˆå§‹åŒ–å‰æ‰§è¡Œï¼Œç¬¬ 7 æ­¥åœ¨åˆå§‹åŒ–åæ‰§è¡Œï¼Œè¯¥é˜¶æ®µç»“æŸï¼Œæ‰èƒ½è¢«ç”¨æˆ·ä½¿ç”¨ï¼› é”€æ¯ï¼šç¬¬ 8~10æ­¥ï¼Œç¬¬8æ­¥ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„é”€æ¯ï¼ˆè¿˜æ²¡ä½¿ç”¨å‘¢ï¼‰ï¼Œè€Œæ˜¯å…ˆåœ¨ä½¿ç”¨å‰æ³¨å†Œäº†é”€æ¯çš„ç›¸å…³è°ƒç”¨æ¥å£ï¼Œä¸ºäº†åé¢ç¬¬9ã€10æ­¥çœŸæ­£é”€æ¯ bean æ—¶å†æ‰§è¡Œç›¸åº”çš„æ–¹æ³•ã€‚ â€‹ ä¸‹é¢ç»“åˆä»£ç æ¥ç›´è§‚çš„çœ‹ä¸‹ï¼Œ 12345678910111213141516171819202122232425// AbstractAutowireCapableBeanFactory.javaprotected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args) throws BeanCreationException { // 1. å®ä¾‹åŒ– BeanWrapper instanceWrapper = null; if (instanceWrapper == null) { instanceWrapper = createBeanInstance(beanName, mbd, args); } Object exposedObject = bean; try { // 2. å±æ€§èµ‹å€¼ populateBean(beanName, mbd, instanceWrapper); // 3. åˆå§‹åŒ– exposedObject = initializeBean(beanName, exposedObject, mbd); } // 4. é”€æ¯-æ³¨å†Œå›è°ƒæ¥å£ try { registerDisposableBeanIfNecessary(beanName, bean, mbd); } return exposedObject;} â€‹ ç”±äºåˆå§‹åŒ–è¾ƒå¤æ‚ï¼ŒåŒ…å«äº†ç¬¬3~7æ­¥ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿›åˆ° initializeBean() æ–¹æ³•é‡Œå…·ä½“çœ‹ä¸‹å…¶è¿‡ç¨‹ï¼ˆæ³¨é‡Šçš„åºå·å¯¹åº”å›¾ä¸­åºå·ï¼‰ï¼š 123456789101112131415161718192021222324252627282930313233343536// AbstractAutowireCapableBeanFactory.javaprotected Object initializeBean(final String beanName, final Object bean, @Nullable RootBeanDefinition mbd) { // 3. æ£€æŸ¥ Aware ç›¸å…³æ¥å£å¹¶è®¾ç½®ç›¸å…³ä¾èµ– if (System.getSecurityManager() != null) { AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; { invokeAwareMethods(beanName, bean); return null; }, getAccessControlContext()); } else { invokeAwareMethods(beanName, bean); } // 4. BeanPostProcessor å‰ç½®å¤„ç† Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) { wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); } // 5. è‹¥å®ç° InitializingBean æ¥å£ï¼Œè°ƒç”¨ afterPropertiesSet() æ–¹æ³• // 6. è‹¥é…ç½®è‡ªå®šä¹‰çš„ init-methodæ–¹æ³•ï¼Œåˆ™æ‰§è¡Œ try { invokeInitMethods(beanName, wrappedBean, mbd); } catch (Throwable ex) { throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, &quot;Invocation of init method failed&quot;, ex); } // 7. BeanPostProceesor åç½®å¤„ç† if (mbd == null || !mbd.isSynthetic()) { wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); } return wrappedBean;} â€‹ åœ¨ invokInitMethods() æ–¹æ³•ä¸­ä¼šæ£€æŸ¥ InitializingBean æ¥å£å’Œ init-method æ–¹æ³• â€‹ é”€æ¯çš„è¿‡ç¨‹ä¹Ÿä¸å…¶ç±»ä¼¼ï¼š 12345678910111213141516171819202122232425262728// DisposableBeanAdapter.javapublic void destroy() { // 9. è‹¥å®ç° DisposableBean æ¥å£ï¼Œåˆ™æ‰§è¡Œ destory()æ–¹æ³• if (this.invokeDisposableBean) { try { if (System.getSecurityManager() != null) { AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; { ((DisposableBean) this.bean).destroy(); return null; }, this.acc); } else { ((DisposableBean) this.bean).destroy(); } } } // 10. è‹¥é…ç½®è‡ªå®šä¹‰çš„ detory-method æ–¹æ³•ï¼Œåˆ™æ‰§è¡Œ if (this.destroyMethod != null) { invokeCustomDestroyMethod(this.destroyMethod); } else if (this.destroyMethodName != null) { Method methodToInvoke = determineDestroyMethod(this.destroyMethodName); if (methodToInvoke != null) { invokeCustomDestroyMethod(ClassUtils.getInterfaceMethodIfPossible(methodToInvoke)); } }} â€‹ è¿™é‡Œé¢å¤–è¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆJVMç±»åŠ è½½æ˜¯åˆå§‹åŒ–å†å®ä¾‹åŒ–ï¼Œè€ŒSpring Beanæ˜¯å…ˆå®ä¾‹åŒ–å†åˆå§‹åŒ–ï¼Œæœ‰ä»€ä¹ˆä¸åŒï¼Ÿï¼ˆåˆšå¼€å§‹å›°æ‰°äº†ä¸€ä¼šå„¿QAQï¼‰ â€‹ é¦–å…ˆï¼Œè¦æ˜ç¡®ã€‚ç±»åŠ è½½æ˜¯JVMçš„åŸºæœ¬è¿‡ç¨‹ï¼Œè€ŒSpringæ˜¯åœ¨å…¶ä¸Šå±‚çš„å®ç°ï¼Œè¿™ä¸¤ä¸ªä¸åœ¨åŒä¸ªå±‚æ¬¡ â€‹ åœ¨JVMä¸­ï¼Œåˆå§‹åŒ–æ˜¯åœ¨ç±»çº§åˆ«çš„ï¼Œä¸»è¦åŠŸèƒ½æ˜¯ä¸ºé™æ€æˆå‘˜èµ‹å€¼ï¼Œæ‰§è¡Œé™æ€ä»£ç å—ï¼Œæ‰§è¡Œ&lt;clinit&gt;æ–¹æ³•ã€‚å®ä¾‹åŒ–æ˜¯æŒ‡åœ¨å †åŒºåˆ†é…ç©ºé—´ï¼Œæ‰§è¡Œå®ä¾‹å¯¹è±¡åˆå§‹åŒ–ï¼Œè®¾ç½®å¼•ç”¨å˜é‡æŒ‡å‘åˆšåˆ†é…çš„å†…å­˜åœ°å€ï¼ˆæ³¨æ„å®ä¾‹åŒ–ä¹Ÿæœ‰ä¸€ä¸ªåˆå§‹åŒ–ï¼Œè¿™æ¬¡åˆå§‹åŒ–å°±ä¼šè°ƒç”¨æ„é€ å‡½æ•°äº†ï¼Œè¿™æ˜¯å®ä¾‹å¯¹è±¡çº§åˆ«çš„ï¼‰ â€‹ åœ¨Springä¸­ï¼Œå®ä¾‹åŒ–å°±æ˜¯åˆ›é€ å‡ºä¸€ä¸ªbeanå¯¹è±¡äº†ï¼ŒåŒ…å«äº†JVMçš„åˆå§‹åŒ–å’Œå®ä¾‹åŒ–ï¼›åˆå§‹åŒ–å°±æ˜¯ç»™å¯¹è±¡ä¸­çš„å±æ€§èµ‹å€¼ï¼Œç›¸å½“äºäººä¸ºæ“ä½œã€‚ 3 æ‰©å±•ç‚¹çš„ä½œç”¨3.1 Awareæ¥å£â€‹ è‹¥ Spring æ£€æµ‹åˆ° bean å®ç°äº† Aware æ¥å£ï¼Œåˆ™ä¼šä¸ºå…¶æ³¨å…¥ç›¸åº”çš„ä¾èµ–ã€‚æ‰€ä»¥é€šè¿‡è®©bean å®ç° Aware æ¥å£ï¼Œåˆ™èƒ½åœ¨ bean ä¸­è·å¾—ç›¸åº”çš„ Spring å®¹å™¨èµ„æºã€‚ Spring ä¸­æä¾›çš„ Aware æ¥å£æœ‰ï¼š BeanNameAwareï¼šæ³¨å…¥å½“å‰ bean å¯¹åº” beanNameï¼› BeanClassLoaderAwareï¼šæ³¨å…¥åŠ è½½å½“å‰ bean çš„ ClassLoaderï¼› BeanFactoryAwareï¼šæ³¨å…¥ å½“å‰BeanFactoryå®¹å™¨ çš„å¼•ç”¨ã€‚ å…¶ä»£ç å®ç°å¦‚ä¸‹ï¼š 123456789101112131415// AbstractAutowireCapableBeanFactory.javaprivate void invokeAwareMethods(final String beanName, final Object bean) { if (bean instanceof Aware) { if (bean instanceof BeanNameAware) { ((BeanNameAware) bean).setBeanName(beanName); } if (bean instanceof BeanClassLoaderAware) { ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl); } if (bean instanceof BeanFactoryAware) { ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.this); } }} â€‹ ä»¥ä¸Šæ˜¯é’ˆå¯¹ BeanFactory ç±»å‹çš„å®¹å™¨ï¼Œè€Œå¯¹äº ApplicationContext ç±»å‹çš„å®¹å™¨ï¼Œä¹Ÿæä¾›äº† Aware æ¥å£ï¼Œåªä¸è¿‡è¿™äº› Aware æ¥å£çš„æ³¨å…¥å®ç°ï¼Œæ˜¯é€šè¿‡ BeanPostProcessor çš„æ–¹å¼æ³¨å…¥çš„ï¼Œä½†å…¶ä½œç”¨ä»æ˜¯æ³¨å…¥ä¾èµ–ã€‚ EnvironmentAwareï¼šæ³¨å…¥ Enviromentï¼Œä¸€èˆ¬ç”¨äºè·å–é…ç½®å±æ€§ï¼› EmbeddedValueResolverAwareï¼šæ³¨å…¥ EmbeddedValueResolverï¼ˆSpring ELè§£æå™¨ï¼‰ï¼Œä¸€èˆ¬ç”¨äºå‚æ•°è§£æï¼› ApplicationContextAwareï¼ˆResourceLoaderã€ApplicationEventPublisherAwareã€MessageSourceAwareï¼‰ï¼šæ³¨å…¥ ApplicationContext å®¹å™¨æœ¬èº«ã€‚ 123456789101112131415161718192021222324252627// ApplicationContextAwareProcessor.javaprivate void invokeAwareInterfaces(Object bean) { if (bean instanceof EnvironmentAware) { ((EnvironmentAware)bean).setEnvironment(this.applicationContext.getEnvironment()); } if (bean instanceof EmbeddedValueResolverAware) { ((EmbeddedValueResolverAware)bean).setEmbeddedValueResolver(this.embeddedValueResolver); } if (bean instanceof ResourceLoaderAware) { ((ResourceLoaderAware)bean).setResourceLoader(this.applicationContext); } if (bean instanceof ApplicationEventPublisherAware) { ((ApplicationEventPublisherAware)bean).setApplicationEventPublisher(this.applicationContext); } if (bean instanceof MessageSourceAware) { ((MessageSourceAware)bean).setMessageSource(this.applicationContext); } if (bean instanceof ApplicationContextAware) { ((ApplicationContextAware)bean).setApplicationContext(this.applicationContext); }} 3.2 å®¹å™¨çº§çš„æ–¹æ³•ï¼ˆBeanPostProcessor ä¸€ç³»åˆ—æ¥å£ï¼‰ 3.2.1 InstantiationAwareBeanPostProcessor æºç åˆ†æâ€‹ ä»æºç ä¸­å‘ç°InstantiationAwareBeanPostProcessor æ˜¯ç»§æ‰¿äº† BeanPostProcessor 12345678910111213141516171819202122232425262728293031323334package org.springframework.beans.factory.config;import java.beans.PropertyDescriptor;import org.springframework.beans.BeansException;import org.springframework.beans.PropertyValues;import org.springframework.lang.Nullable;public interface InstantiationAwareBeanPostProcessor extends BeanPostProcessor { @Nullable default Object postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) throws BeansException { return null; } default boolean postProcessAfterInstantiation(Object bean, String beanName) throws BeansException { return true; } @Nullable default PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) throws BeansException { return null; } @Deprecated @Nullable default PropertyValues postProcessPropertyValues( PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName) throws BeansException { return pvs; }} 1234567891011121314151617package org.springframework.beans.factory.config;import org.springframework.beans.BeansException;import org.springframework.lang.Nullable;public interface BeanPostProcessor { @Nullable default Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException { return bean; } @Nullable default Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { return bean; }} InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation è°ƒç”¨ç‚¹ Object postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName)è¿”å›å€¼ï¼šå¦‚æœè¿”å›çš„ä¸ä¸ºnullï¼Œé‚£ä¹ˆåç»­çš„Beançš„åˆ›å»ºæµç¨‹ã€å®ä¾‹åŒ–ã€åˆå§‹åŒ–afterPropertiesã€‘éƒ½ä¸ä¼šæ‰§è¡Œï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨è¿”å›çš„å¿«æ·Beanï¼Œæ­¤æ—¶çš„æ­£å¸¸æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼šInstantiationAwareBeanPostProcessoræ¥å£ä¸­çš„postProcessBeforeInstantiationï¼Œåœ¨å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ã€‚BeanPostProcessoræ¥å£ä¸­çš„postProcessAfterInitializationï¼Œåœ¨å®ä¾‹åŒ–ä¹‹åè°ƒç”¨ã€‚ 12345678910111213141516171819202122232425262728293031/* org.spring framework.beans . factory.support.AbstractAutowireCapableBeanFactory#resolveBeforeInstantiation ä½œç”¨ï¼šåœ¨å®ä¾‹åŒ–ä¹‹å‰è§£ææ˜¯å¦æœ‰å¿«æ·åˆ›å»ºçš„Beanï¼Œæ—¢æ˜¯é€šè¿‡postProcessBeforeInstantiationè¿”å›çš„Bean å†…éƒ¨è°ƒç”¨ä¸¤ä¸ªé‡è¦çš„æ–¹æ³•: 1. applyBeanPostProcessorsBeforeInstantiation: å†…éƒ¨éå†è°ƒç”¨postProcessBeforeInstantiationæ–¹æ³•ã€åœ¨å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨J 2. applyBeanPostProcessorsAfterInitialization: å¦‚æœpostProcessBeforeInstantiationæ–¹æ³•è¿”å›äº†å¿«æ·çš„Beanï¼Œå†…éƒ¨éå†è°ƒç”¨postProcessBeforeInstantiationæ–¹æ³•ã€åœ¨åˆå§‹åŒ–ä¹‹åè°ƒç”¨ã€‘*/@Nullableprotected Object resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd) { Object bean = null; if (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) { // Make sure bean class is actually resolved at this point. if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) { Class&lt;?&gt; targetType = determineTargetType(beanName, mbd); if (targetType != null) { // è°ƒç”¨æ–¹æ³•ï¼Œå†…éƒ¨éå†è°ƒç”¨postProcessBeforeInstantiationæ–¹æ³•ã€åœ¨å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ã€‘ bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName); // å¦‚æœè¿”å›äº†å¿«æ·çš„Bean if (bean != null) { //å¦‚æœpostProcessBeforeInstantiationæ–¹æ³•è¿”å›äº†å¿«æ·çš„Beanï¼Œ // å†…éƒ¨éå†è°ƒç”¨ postProcessBeforeInstantiationæ–¹æ³•ã€åœ¨åˆå§‹åŒ–ä¹‹åè°ƒç”¨ã€‘ bean = applyBeanPostProcessorsAfterInitialization(bean, beanName); } } } mbd.beforeInstantiationResolved = (bean != null); } return bean;} applyBeanPostProcessorsBeforeInstantiation 12345678910111213141516/* å°† InstantiationAwareBeanPostProcessors åº”ç”¨äºæŒ‡å®šçš„ bean å®šä¹‰ï¼ˆæŒ‰ç±»å’Œåç§°ï¼‰ï¼Œ è°ƒç”¨å®ƒä»¬çš„ postProcessBeforeInstantiation æ–¹æ³•ã€‚ä»»ä½•è¿”å›çš„å¯¹è±¡éƒ½å°†ç”¨ä½œ beanï¼Œ è€Œä¸æ˜¯å®é™…å®ä¾‹åŒ–ç›®æ ‡ beanã€‚æ¥è‡ªåå¤„ç†å™¨çš„ç©ºè¿”å›å€¼å°†å¯¼è‡´ç›®æ ‡ bean è¢«å®ä¾‹åŒ–ã€‚*/@Nullableprotected Object applyBeanPostProcessorsBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) { // getBeanPostProcessorCacheè¿”å›é¢„è¿‡æ»¤åå¤„ç†å™¨çš„å†…éƒ¨ç¼“å­˜ï¼Œå¦‚æœ‰å¿…è¦ï¼Œé‡æ–°ï¼ˆé‡æ–°ï¼‰æ„å»ºå®ƒã€‚ for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) { Object result = bp.postProcessBeforeInstantiation(beanClass, beanName); if (result != null) { return result; } } return null;} applyBeanPostProcessorsAfterInitialization 1234567891011121314151617/* ä½œç”¨:éå†è°ƒç”¨postProcessAfterInitialization*/@Overridepublic Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException { Object result = existingBean; for (BeanPostProcessor processor : getBeanPostProcessors()) { Object current = processor.postProcessAfterInitialization(result, beanName); if (current == null) { return result; } result = current; } return result;} InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation è°ƒç”¨ç‚¹ boolean postProcessAfterInstantiation(Object bean, String beanName) throws BeansExceptionæ­£å¸¸æƒ…å†µä¸‹åœ¨å®ä¾‹åŒ–ä¹‹ååœ¨æ‰§è¡ŒpopulateBeanä¹‹å‰è°ƒç”¨è¿”å›å€¼ï¼šå¦‚æœæœ‰æŒ‡å®šçš„beançš„æ—¶å€™è¿”å›falseï¼Œé‚£ä¹ˆåç»­çš„å±æ€§å¡«å……å’Œå±æ€§ä¾èµ–æ³¨å…¥ã€populateBeanã€‘å°†ä¸ä¼šæ‰§è¡Œï¼ŒåŒæ—¶åç»­çš„postProcessPropertyValueså°†ä¸ä¼šæ‰§è¡Œ,ä½†æ˜¯åˆå§‹åŒ–å’ŒBeanPostProcessorçš„ä»ç„¶ä¼šæ‰§è¡Œã€‚ 1234567891011121314151617181920212223242526protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) { if (bw == null) { if (mbd.hasPropertyValues()) { throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Cannot apply property values to null instance&quot;); } else { // Skip property population phase for null instance. return; } } // Give any InstantiationAwareBeanPostProcessors the opportunity to modify the // state of the bean before properties are set. This can be used, for example, // to support styles of field injection. if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) { for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) { // æ‰§è¡ŒpostProcessAfterInstantiationæ–¹æ³• if (!bp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) { // è¿”å›ç»“æœä¸ºfalseï¼Œé‚£ä¹ˆèµ‹å€¼continuewithPropertyPopulation=falseï¼Œè¡¨ç¤ºä¸ç»§ç»­æ‰§è¡Œå±æ€§å¡«å…… return; } } } ....} 3.2.2 BeanPostProcessor æºç åˆ†æâ€‹ initializeBeanæ˜¯è¯¥æ¥å£æºç çš„å…¥å£ â€‹ è¿›å…¥åˆå§‹åŒ–æ¥å£ï¼š 1234567891011121314151617181920212223242526272829303132protected Object initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) { if (System.getSecurityManager() != null) { AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; { invokeAwareMethods(beanName, bean); return null; }, getAccessControlContext()); } else { invokeAwareMethods(beanName, bean); } Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) { // åˆå§‹åŒ–å‰æ‰§è¡Œçš„æ–¹æ³• wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); } try { invokeInitMethods(beanName, wrappedBean, mbd); } catch (Throwable ex) { throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, &quot;Invocation of init method failed&quot;, ex); } if (mbd == null || !mbd.isSynthetic()) { // åˆå§‹åŒ–åæ‰§è¡Œçš„æ–¹æ³• wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); } return wrappedBean;} AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsBeforeInitialization 12345678910111213141516@Overridepublic Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName) throws BeansException { Object result = existingBean; // 1. è·å–åˆ°æ‰€æœ‰çš„åç½®å¤„ç†å™¨ getBeanPostProcessors() for (BeanPostProcessor processor : getBeanPostProcessors()) { // 2. è°ƒç”¨åç½®å¤„ç†å™¨çš„æ–¹æ³• Object current = processor.postProcessBeforeInitialization(result, beanName); if (current == null) { return result; } result = current; } return result;} â€‹ è¿›å…¥postProcessBeforeInitializationæ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253// org.springframework.context.support.ApplicationContextAwareProcessor#postProcessBeforeInitialization@Override@Nullablepublic Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException { if (!(bean instanceof EnvironmentAware || bean instanceof EmbeddedValueResolverAware || bean instanceof ResourceLoaderAware || bean instanceof ApplicationEventPublisherAware || bean instanceof MessageSourceAware || bean instanceof ApplicationContextAware || bean instanceof ApplicationStartupAware)) { return bean; } AccessControlContext acc = null; if (System.getSecurityManager() != null) { acc = this.applicationContext.getBeanFactory().getAccessControlContext(); } if (acc != null) { AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; { invokeAwareInterfaces(bean); return null; }, acc); } else { invokeAwareInterfaces(bean); } return bean;}private void invokeAwareInterfaces(Object bean) { if (bean instanceof EnvironmentAware) { ((EnvironmentAware) bean).setEnvironment(this.applicationContext.getEnvironment()); } if (bean instanceof EmbeddedValueResolverAware) { ((EmbeddedValueResolverAware) bean).setEmbeddedValueResolver(this.embeddedValueResolver); } if (bean instanceof ResourceLoaderAware) { ((ResourceLoaderAware) bean).setResourceLoader(this.applicationContext); } if (bean instanceof ApplicationEventPublisherAware) { ((ApplicationEventPublisherAware) bean).setApplicationEventPublisher(this.applicationContext); } if (bean instanceof MessageSourceAware) { ((MessageSourceAware) bean).setMessageSource(this.applicationContext); } if (bean instanceof ApplicationStartupAware) { ((ApplicationStartupAware) bean).setApplicationStartup(this.applicationContext.getApplicationStartup()); } if (bean instanceof ApplicationContextAware) { ((ApplicationContextAware) bean).setApplicationContext(this.applicationContext); }} â€‹ ApplicationContextAwareProcessor#postProcessBeforeInitialization é¦–å…ˆåˆ¤æ–­æ­¤ bean æ˜¯ä¸æ˜¯å„ç§çš„Awareï¼Œå¦‚æœæ˜¯å®ƒåˆ—ä¸¾çš„é‚£å‡ ä¸ª Aware å°±è·å– Bean å·¥å‚çš„æƒé™ï¼Œå¯ä»¥å‘å®¹å™¨ä¸­å¯¼å…¥ç›¸å…³çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œç›®çš„æ˜¯ä¸ºäº† Bean å®ä¾‹èƒ½å¤Ÿè·å–åˆ°ç›¸å…³çš„ä¸Šä¸‹æ–‡ï¼Œå¦‚æœä¸æ˜¯å®ƒåˆ—ä¸¾çš„å‡ ä¸ª Awareï¼Œé‚£å°±è°ƒç”¨ invokeAwareInterfaces(bean)ï¼Œå‘å®¹å™¨ä¸­æ·»åŠ ç›¸å…³æ¥å£çš„ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚ 3.3 InitializingBean å’Œ init-methodInitializingBean å’Œ init-method æ˜¯ Spring ä¸º bean åˆå§‹åŒ–æä¾›çš„æ‰©å±•ç‚¹ã€‚ InitializingBeanæ¥å£ çš„å®šä¹‰å¦‚ä¸‹ï¼š 123public interface InitializingBean { void afterPropertiesSet() throws Exception;} åœ¨ afterPropertiesSet() æ–¹æ³•å†™åˆå§‹åŒ–é€»è¾‘ã€‚ æŒ‡å®š init-method æ–¹æ³•ï¼ŒæŒ‡å®šåˆå§‹åŒ–æ–¹æ³•ï¼š 12345678&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt; &lt;bean id=&quot;demo&quot; class=&quot;com.w1nd.Demo&quot; init-method=&quot;init()&quot;/&gt; &lt;/beans&gt; DisposableBean å’Œ destory-method ä¸ä¸Šè¿°ç±»ä¼¼ï¼Œå°±ä¸æè¿°äº†ã€‚ 4. æ€»ç»“â€‹ æœ€åæ€»ç»“ä¸‹å¦‚ä½•è®°å¿† Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼š é¦–å…ˆæ˜¯å®ä¾‹åŒ–ã€å±æ€§èµ‹å€¼ã€åˆå§‹åŒ–ã€é”€æ¯è¿™ 4 ä¸ªå¤§é˜¶æ®µï¼› å†æ˜¯åˆå§‹åŒ–çš„å…·ä½“æ“ä½œï¼Œæœ‰ Aware æ¥å£çš„ä¾èµ–æ³¨å…¥ã€BeanPostProcessor åœ¨åˆå§‹åŒ–å‰åçš„å¤„ç†ä»¥åŠ InitializingBean å’Œ init-method çš„åˆå§‹åŒ–æ“ä½œï¼› é”€æ¯çš„å…·ä½“æ“ä½œï¼Œæœ‰æ³¨å†Œç›¸å…³é”€æ¯å›è°ƒæ¥å£ï¼Œæœ€åé€šè¿‡DisposableBean å’Œ destory-method è¿›è¡Œé”€æ¯ã€‚ å‚è€ƒå¦‚ä½•è®°å¿† Spring Bean çš„ç”Ÿå‘½å‘¨æœŸ - æ˜é‡‘ (juejin.cn) ä¸€æ–‡è¯»æ‡‚ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸ - SegmentFault æ€å¦ (104æ¡æ¶ˆæ¯) JVMç±» å’Œ spring Bean çš„å®ä¾‹åŒ– å’Œ åˆå§‹åŒ–åŒºåˆ«ä»¥åŠé¡ºåº_ç§‹æ¥“çš„åšå®¢-CSDNåšå®¢_springå®ä¾‹åŒ–å’Œåˆå§‹åŒ–çš„åŒºåˆ« javaç±»çš„åˆå§‹åŒ–å’Œå®ä¾‹åŒ–åŒºåˆ« - pu20065226 - åšå®¢å›­ (cnblogs.com) èŠèŠspringçš„é‚£äº›æ‰©å±•æœºåˆ¶ - æ˜é‡‘ (juejin.cn)","link":"/2022/02/10/%E6%A1%86%E6%9E%B6/Spring/Spring-Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"},{"title":"çº¢é»‘æ ‘","text":"1 æ¦‚å¿µ1. 1 å®šä¹‰ï¼ˆ1ï¼‰ç»“ç‚¹æ˜¯çº¢è‰²æˆ–é»‘è‰² ï¼ˆ2ï¼‰æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰² ï¼ˆ3ï¼‰æ‰€æœ‰å¶å­éƒ½æ˜¯é»‘è‰²ï¼ˆå¶å­æ˜¯NULLç»“ç‚¹ï¼‰ ï¼ˆ4ï¼‰æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹çš„ä¸¤ä¸ªå­èŠ‚ç‚¹ä¸€å®šéƒ½æ˜¯é»‘è‰²ã€‚ä¸èƒ½æœ‰ä¸¤ä¸ªçº¢è‰²èŠ‚ç‚¹ç›¸è¿ã€‚ ï¼ˆ5ï¼‰ä»»æ„ä¸€èŠ‚ç‚¹åˆ°æ¯ä¸ªå¶å­èŠ‚ç‚¹çš„è·¯å¾„éƒ½åŒ…å«æ•°é‡ç›¸åŒçš„é»‘ç»“ç‚¹ã€‚ä¿—ç§°ï¼šé»‘é«˜ï¼ çº¢é»‘æ ‘å®ä¾‹å›¾ â€‹ çº¢é»‘æ ‘å¹¶ä¸æ˜¯ä¸€ä¸ªå®Œç¾å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œä»å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œæ ¹ç»“ç‚¹Pçš„å·¦å­æ ‘æ˜¾ç„¶æ¯”å³å­æ ‘é«˜ï¼Œ â€‹ ä½†å·¦å­æ ‘å’Œå³å­æ ‘çš„é»‘ç»“ç‚¹çš„å±‚æ•°æ˜¯ç›¸ç­‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»»æ„ä¸€ä¸ªç»“ç‚¹åˆ°åˆ°æ¯ä¸ªå¶å­ç»“ç‚¹çš„è·¯å¾„éƒ½åŒ…å«æ•°é‡ç›¸åŒçš„é»‘ç»“ç‚¹(æ€§è´¨5)ã€‚ â€‹ æ‰€ä»¥æˆ‘ä»¬å«çº¢é»‘æ ‘è¿™ç§å¹³è¡¡ä¸ºé»‘è‰²å®Œç¾å¹³è¡¡ã€‚ â€‹ çº¢é»‘æ ‘çš„æ€§è´¨è®²å®Œäº†ï¼Œåªè¦è¿™æ£µæ ‘æ»¡è¶³ä»¥ä¸Šæ€§è´¨ï¼Œè¿™æ£µæ ‘å°±æ˜¯è¶‹è¿‘ä¸å¹³è¡¡çŠ¶æ€çš„ã€‚ 1.2 æ€§è´¨â€‹ ä»æ ¹åˆ°å¶å­çš„æœ€é•¿çš„å¯èƒ½è·¯å¾„ä¸å¤šäºæœ€çŸ­çš„å¯èƒ½è·¯å¾„çš„ä¸¤å€é•¿ 1.3 å…³äºçº¢é»‘æ ‘æ“ä½œâ€‹ åœ¨äº†è§£è¿™äº›æ“ä½œå‰ï¼Œå…ˆæ˜ç¡®ä¸‰ä¸ªå°æ“ä½œ å˜è‰²ï¼šç»“ç‚¹çš„é¢œè‰²ç”±çº¢å˜é»‘æˆ–ç”±é»‘å˜çº¢ã€‚ å·¦æ—‹ï¼šä»¥æŸä¸ªç»“ç‚¹ä½œä¸ºæ”¯ç‚¹(æ—‹è½¬ç»“ç‚¹)ï¼Œå…¶å³å­ç»“ç‚¹å˜ä¸ºæ—‹è½¬ç»“ç‚¹çš„çˆ¶ç»“ç‚¹ï¼Œå³å­ç»“ç‚¹çš„å·¦å­ç»“ç‚¹å˜ä¸ºæ—‹è½¬ç»“ç‚¹çš„å³å­ç»“ç‚¹ï¼Œå·¦å­ç»“ç‚¹ä¿æŒä¸å˜ã€‚ å³æ—‹ï¼šä»¥æŸä¸ªç»“ç‚¹ä½œä¸ºæ”¯ç‚¹(æ—‹è½¬ç»“ç‚¹)ï¼Œå…¶å·¦å­ç»“ç‚¹å˜ä¸ºæ—‹è½¬ç»“ç‚¹çš„çˆ¶ç»“ç‚¹ï¼Œå·¦å­ç»“ç‚¹çš„å³å­ç»“ç‚¹å˜ä¸ºæ—‹è½¬ç»“ç‚¹çš„å·¦å­ç»“ç‚¹ï¼Œå³å­ç»“ç‚¹ä¿æŒä¸å˜ å·¦æ—‹å›¾ç¤º å³æ—‹å›¾ç¤º å¦å¤–ï¼Œçº¦å®šä¸€äº›èŠ‚ç‚¹çš„ç§°å‘¼ 1.3.1 æ’å…¥æ’å…¥æ“ä½œåŒ…æ‹¬ä¸¤éƒ¨åˆ†å·¥ä½œï¼š æŸ¥æ‰¾æ’å…¥çš„ä½ç½® æ’å…¥åè‡ªå¹³è¡¡ â€‹ æ³¨æ„ï¼šæ’å…¥èŠ‚ç‚¹ï¼Œå¿…é¡»ä¸ºçº¢è‰²ï¼Œç†ç”±å¾ˆç®€å•ï¼Œçº¢è‰²åœ¨çˆ¶èŠ‚ç‚¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ä¸ºé»‘è‰²èŠ‚ç‚¹æ—¶ï¼Œçº¢é»‘æ ‘çš„é»‘è‰²å¹³è¡¡æ²¡è¢«ç ´åï¼Œä¸éœ€è¦åšè‡ªå¹³è¡¡æ“ä½œã€‚ â€‹ ä½†å¦‚æœæ’å…¥ç»“ç‚¹æ˜¯é»‘è‰²ï¼Œé‚£ä¹ˆæ’å…¥ä½ç½®æ‰€åœ¨çš„å­æ ‘é»‘è‰²ç»“ç‚¹æ€»æ˜¯å¤š1ï¼Œå¿…é¡»åšè‡ªå¹³è¡¡ã€‚ çº¢é»‘æ ‘æ’å…¥èŠ‚ç‚¹æƒ…æ™¯åˆ†ææƒ…æ™¯1ï¼šçº¢é»‘æ ‘ä¸ºç©ºæ ‘â€‹ æœ€ç®€å•çš„ä¸€ç§æƒ…æ™¯ï¼Œç›´æ¥æŠŠæ’å…¥ç»“ç‚¹ä½œä¸ºæ ¹ç»“ç‚¹å°±è¡Œ â€‹ æ³¨æ„ï¼šæ ¹æ®çº¢é»‘æ ‘æ€§è´¨2ï¼šæ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‚è¿˜éœ€è¦æŠŠæ’å…¥ç»“ç‚¹è®¾ä¸ºé»‘è‰²ã€‚ æƒ…æ™¯2ï¼šæ’å…¥ç»“ç‚¹çš„Keyå·²å­˜åœ¨â€‹ å¤„ç†ï¼šæ›´æ–°å½“å‰èŠ‚ç‚¹çš„å€¼ï¼Œä¸ºæ’å…¥èŠ‚ç‚¹çš„å€¼ æƒ…æ™¯3ï¼šæ’å…¥ç»“ç‚¹çš„çˆ¶ç»“ç‚¹ä¸ºé»‘ç»“ç‚¹â€‹ ç”±äºæ’å…¥çš„ç»“ç‚¹æ˜¯çº¢è‰²çš„ï¼Œå½“æ’å…¥ç»“ç‚¹çš„é»‘è‰²æ—¶ï¼Œå¹¶ä¸ä¼šå½±å“çº¢é»‘æ ‘çš„å¹³è¡¡ï¼Œç›´æ¥æ’å…¥å³å¯ï¼Œæ— éœ€åšè‡ªå¹³è¡¡ã€‚ â€‹ æƒ…æ™¯4ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²â€‹ å†æ¬¡å›æƒ³ä¸‹çº¢é»‘æ ‘çš„æ€§è´¨2ï¼šæ ¹ç»“ç‚¹æ˜¯é»‘è‰²ã€‚å¦‚æœæ’å…¥èŠ‚ç‚¹çš„çˆ¶ç»“ç‚¹ä¸ºçº¢ç»“ç‚¹ï¼Œé‚£ä¹ˆè¯¥çˆ¶ç»“ç‚¹ä¸å¯èƒ½ä¸ºæ ¹ç»“ç‚¹ï¼Œæ‰€ä»¥æ’å…¥ç»“ç‚¹æ€»æ˜¯å­˜åœ¨ç¥–çˆ¶ç»“ç‚¹ã€‚ â€‹ è¿™ä¸€ç‚¹å¾ˆå…³é”®ï¼Œå› ä¸ºåç»­çš„æ—‹è½¬æ“ä½œè‚¯å®šéœ€è¦ç¥–çˆ¶ç»“ç‚¹çš„å‚ä¸ã€‚ â€‹ æ’å…¥æƒ…æ™¯4.1ï¼šå”å”ç»“ç‚¹å­˜åœ¨å¹¶ä¸”ä¸ºçº¢ç»“ç‚¹ ä¾æ®çº¢é»‘æ ‘æ€§è´¨4å¯çŸ¥ï¼Œçº¢è‰²èŠ‚ç‚¹ä¸èƒ½ç›¸è¿ ==&gt; ç¥–çˆ¶ç»“ç‚¹è‚¯å®šä¸ºé»‘ç»“ç‚¹ï¼› å› ä¸ºä¸å¯ä»¥åŒæ—¶å­˜åœ¨ä¸¤ä¸ªç›¸è¿çš„çº¢ç»“ç‚¹ã€‚é‚£ä¹ˆæ­¤æ—¶è¯¥æ’å…¥å­æ ‘çš„çº¢é»‘å±‚æ•°çš„æƒ…å†µæ˜¯ï¼šé»‘çº¢çº¢ã€‚æ˜¾ç„¶æœ€ç®€å•çš„å¤„ç†æ–¹å¼æ˜¯æŠŠå…¶æ”¹ä¸ºï¼šçº¢é»‘çº¢ å¤„ç†ï¼š å°†På’ŒUèŠ‚ç‚¹æ”¹ä¸ºé»‘è‰² å°†PPæ”¹ä¸ºçº¢è‰² å°†PPè®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œè¿›è¡Œåç»­å¤„ç† â€‹ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æŠŠPPç»“ç‚¹è®¾ä¸ºçº¢è‰²äº†ï¼Œå¦‚æœPPçš„çˆ¶ç»“ç‚¹æ˜¯é»‘è‰²ï¼Œé‚£ä¹ˆæ— éœ€å†åšä»»ä½•å¤„ç†ï¼› ä½†å¦‚æœPPçš„çˆ¶ç»“ç‚¹æ˜¯çº¢è‰²ï¼Œåˆ™è¿åçº¢é»‘æ ‘æ€§è´¨äº†ã€‚æ‰€ä»¥éœ€è¦å°†PPè®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œç»§ç»­åšæ’å…¥æ“ä½œè‡ªå¹³è¡¡å¤„ç†ï¼Œç›´åˆ°å¹³è¡¡ä¸ºæ­¢ã€‚ æ’å…¥æƒ…æ™¯4.2ï¼šå”å”ç»“ç‚¹ä¸å­˜åœ¨æˆ–ä¸ºé»‘ç»“ç‚¹ï¼Œå¹¶ä¸”æ’å…¥ç»“ç‚¹çš„çˆ¶äº²ç»“ç‚¹æ˜¯ç¥–çˆ¶ç»“ç‚¹çš„å·¦å­ç»“ç‚¹ æ³¨æ„ï¼šå•çº¯ä»æ’å…¥å‰æ¥çœ‹ï¼Œå”å”èŠ‚ç‚¹éçº¢å³ç©ºï¼ˆNILèŠ‚ç‚¹ï¼‰ï¼Œå¦åˆ™çš„è¯ç ´åäº†çº¢é»‘æ ‘æ€§è´¨5ï¼Œæ­¤è·¯å¾„ä¼šæ¯”å…¶å®ƒè·¯å¾„å¤šä¸€ä¸ªé»‘è‰²èŠ‚ç‚¹ã€‚ â€‹ æ’å…¥æƒ…æ™¯4.2.1ï¼šæ–°æ’å…¥èŠ‚ç‚¹ï¼Œä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼ˆLLçº¢è‰²æƒ…å†µï¼‰ â€‹ å¤„ç†ï¼š å˜é¢œè‰²ï¼šå°†Pè®¾ç½®ä¸ºé»‘è‰²ï¼Œå°†PPè®¾ç½®ä¸ºçº¢è‰² å¯¹PPèŠ‚ç‚¹è¿›è¡Œå³æ—‹ æ’å…¥æƒ…æ™¯4.2.2ï¼šæ–°æ’å…¥èŠ‚ç‚¹ï¼Œä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ˆLRçº¢è‰²æƒ…å†µï¼‰ å¤„ç†ï¼š å¯¹Pè¿›è¡Œå·¦æ—‹ å°†Pè®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œå¾—åˆ°LLçº¢è‰²æƒ…å†µ æŒ‰ç…§LLçº¢è‰²æƒ…å†µå¤„ç†ï¼ˆ1.å˜é¢œè‰² 2.å³æ—‹PPï¼‰ æ’å…¥æƒ…æ™¯4.3ï¼šå”å”ç»“ç‚¹ä¸å­˜åœ¨æˆ–ä¸ºé»‘ç»“ç‚¹ï¼Œå¹¶ä¸”æ’å…¥ç»“ç‚¹çš„çˆ¶äº²ç»“ç‚¹æ˜¯ç¥–çˆ¶ç»“ç‚¹çš„å³å­ç»“ç‚¹ è¯¥æƒ…æ™¯å¯¹åº”æƒ…æ™¯4.2ï¼Œåªæ˜¯æ–¹å‘åè½¬ï¼Œç›´æ¥çœ‹å›¾ã€‚ æ’å…¥æƒ…æ™¯4.3.1ï¼šæ–°æ’å…¥èŠ‚ç‚¹ï¼Œä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ˆRRçº¢è‰²æƒ…å†µï¼‰ å¤„ç†ï¼š å˜é¢œè‰²ï¼šå°†Pè®¾ç½®ä¸ºé»‘è‰²ï¼Œå°†PPè®¾ç½®ä¸ºçº¢è‰² å¯¹PPèŠ‚ç‚¹è¿›è¡Œå·¦æ—‹ æ’å…¥æƒ…æ™¯4.3.2ï¼šæ–°æ’å…¥èŠ‚ç‚¹ï¼Œä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼ˆRLçº¢è‰²æƒ…å†µï¼‰ å¤„ç†ï¼š å¯¹Pè¿›è¡Œå³æ—‹ å°†Pè®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œå¾—åˆ°RRçº¢è‰²æƒ…å†µ æŒ‰ç…§RRçº¢è‰²æƒ…å†µå¤„ç†ï¼ˆ1.å˜é¢œè‰² 2.å·¦æ—‹PPï¼‰ 1.3.2 åˆ é™¤â€‹ åˆ é™¤æ“ä½œæ•´ä½“è¦æ¯”æ’å…¥éš¾ä¸€äº›ã€‚æ’å…¥æ“ä½œä¸»è¦å®¹æ˜“è¿èƒŒçº¢é»‘æ ‘çš„å®šä¹‰4ï¼ˆçº¢é»‘æ ‘ä¸­ä¸å­˜åœ¨ä¸¤ä¸ªç›¸é‚»çš„çº¢è‰²ç»“ç‚¹ï¼‰ã€‚è€Œåˆ é™¤æ“ä½œä¸»è¦å®¹æ˜“è¿èƒŒå®šä¹‰5ï¼ˆåˆ é™¤é»‘è‰²ç»“ç‚¹å¯èƒ½å¯¼è‡´æ ¹ç»“ç‚¹åˆ°å¶ç»“ç‚¹é»‘è‰²ç»“ç‚¹çš„æ•°ç›®å‡å°‘ï¼Œå³é»‘é«˜é™ä½ï¼‰ã€‚ â€‹ åœ¨ä»‹ç»å…·ä½“çš„æ“ä½œä¹‹å‰ï¼Œå…ˆäº†è§£äº›æ¦‚å¿µ å½“åˆ é™¤ç»“ç‚¹ v æ˜¯é»‘è‰²ç»“ç‚¹ï¼Œä¸”å…¶è¢«å…¶é»‘è‰²å­èŠ‚ç‚¹æ›¿æ¢æ—¶ï¼Œå…¶å­ç»“ç‚¹å°±è¢«æ ‡è®°ä¸º åŒé»‘ â€‹ åˆ é™¤æ“ä½œæœ€ä¸»è¦çš„ä»»åŠ¡å°±å¯ä»¥è½¬åŒ–ä¸ºå°†åŒé»‘ç»“ç‚¹è½¬åŒ–ä¸ºæˆ‘ä»¬æ™®é€šé»‘è‰²ç»“ç‚¹ã€‚ çº¢é»‘æ ‘çš„åˆ é™¤åˆ†æâ€‹ é¦–å…ˆæˆ‘ä»¬å‡å®šè¦åˆ é™¤çš„ç»“ç‚¹ä¸º v ï¼Œu æ˜¯ç”¨æ¥æ›¿æ¢ v çš„å­©å­ç»“ç‚¹ï¼ˆæ³¨æ„ï¼Œå½“ v æ˜¯å¶ç»“ç‚¹æ—¶ï¼Œ u æ˜¯ NULLç»“ç‚¹ï¼Œä¸”NULLç»“ç‚¹æˆ‘ä»¬è¿˜æ˜¯å½“åšé»‘è‰²ç»“ç‚¹å¤„ç†ï¼‰ã€‚ â€‹ åˆ é™¤æ“ä½œæ€»çº²ï¼š æ‰§è¡Œæ ‡å‡†çš„ BST çš„åˆ é™¤æ“ä½œ ç®€å•æƒ…å†µï¼šu æˆ–è€… v æ˜¯çº¢è‰² å¤æ‚æƒ…å†µï¼šu å’Œ v éƒ½æ˜¯é»‘è‰²ç»“ç‚¹ã€‚ â€‹ â€‹ ç®€å•æƒ…å†µï¼šuæˆ–væ˜¯çº¢è‰²èŠ‚ç‚¹â€‹ å¦‚æœ u æˆ–è€… v æ˜¯çº¢è‰²ï¼Œæˆ‘ä»¬å°†æ›¿æ¢ç»“ç‚¹ v çš„ç»“ç‚¹ u æ ‡è®°ä¸ºé»‘è‰²ç»“ç‚¹ï¼ˆè¿™æ ·é»‘é«˜å°±ä¸ä¼šå˜åŒ–ï¼‰ã€‚æ³¨æ„è¿™é‡Œæ˜¯ u æˆ–è€… v æ˜¯çº¢è‰²ç»“ç‚¹ï¼Œå› ä¸ºåœ¨ä¸€æ£µçº¢é»‘æ ‘ä¸­ï¼Œæ˜¯ä¸å…è®¸æœ‰ä¸¤ä¸ªç›¸é‚»çš„çº¢è‰²ç»“ç‚¹çš„ï¼Œè€Œç»“ç‚¹ v æ˜¯ç»“ç‚¹ u çš„çˆ¶ç»“ç‚¹ï¼Œå› æ­¤åªèƒ½æ˜¯ u æˆ–è€… v æ˜¯çº¢è‰²ç»“ç‚¹ã€‚ â€‹ åˆ é™¤ç»“ç‚¹ v ä¸ºé»‘è‰²ç»“ç‚¹ 10 ï¼Œæ›¿æ¢ç»“ç‚¹ v çš„ç»“ç‚¹ u ä¸ºçº¢è‰²ç»“ç‚¹ 9 çš„æƒ…å†µï¼š â€‹ â€‹ åˆ é™¤ç»“ç‚¹ v ä¸ºçº¢è‰²ç»“ç‚¹ 20 ï¼Œæ›¿æ¢ç»“ç‚¹ v çš„ç»“ç‚¹ u ä¸ºé»‘è‰²NULLç»“ç‚¹ h çš„æƒ…å†µï¼š å¤æ‚æƒ…å†µï¼šuå’Œvéƒ½æ˜¯é»‘è‰²èŠ‚ç‚¹â€‹ ä¸‹é¢ä¸æƒ³å†™äº†= =ï¼Œå…·ä½“å‚è€ƒè¿™ç¯‡åšæ–‡æŠŠï¼Œæ„Ÿè§‰å†™çš„ä¸é”™ å›¾è§£ï¼šçº¢é»‘æ ‘åˆ é™¤ç¯‡ï¼ˆä¸€æ–‡è¯»æ‡‚ï¼‰ - çŸ¥ä¹ (zhihu.com) 2 ä»£ç å®ç°2.1 RBTree.java123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372package DataStructure.rbtree;import lombok.AllArgsConstructor;import lombok.Data;import lombok.NoArgsConstructor;/** * &lt;p&gt; * â‘¡åˆ›å»ºRBNode * &lt;p&gt; * â‘¢è¾…åŠ©æ–¹æ³•å®šä¹‰ï¼šparentOf(node)ï¼ŒisRed(node)ï¼ŒsetRed(node)ï¼ŒsetBlack(node)ï¼ŒinOrderPrint() * &lt;p&gt; * â‘£å·¦æ—‹æ–¹æ³•å®šä¹‰ï¼šleftRotate(node) * &lt;p&gt; * â‘¤å³æ—‹æ–¹æ³•å®šä¹‰ï¼šrightRotate(node) * &lt;p&gt; * â‘¥å…¬å¼€æ’å…¥æ¥å£æ–¹æ³•å®šä¹‰ï¼šinsert(K key, V value); * &lt;p&gt; * â‘¦å†…éƒ¨æ’å…¥æ¥å£æ–¹æ³•å®šä¹‰ï¼šinsert(RBNode node); * &lt;p&gt; * â‘§ä¿®æ­£æ’å…¥å¯¼è‡´çº¢é»‘æ ‘å¤±è¡¡çš„æ–¹æ³•å®šä¹‰ï¼šinsertFIxUp(RBNode node); * &lt;p&gt; * â‘¨æµ‹è¯•çº¢é»‘æ ‘æ­£ç¡®æ€§ */public class RBTree&lt;K extends Comparable&lt;K&gt;, V&gt; { private static final boolean RED = true; // çº¢ private static final boolean BLACK = false; // é»‘ @Data @AllArgsConstructor @NoArgsConstructor static class RBNode&lt;K extends Comparable&lt;K&gt;, V&gt; { private RBNode parent; //çˆ¶ç»“ç‚¹ private RBNode left; // å·¦å­æ ‘ private RBNode right; // å³å­æ ‘ private boolean color; // é¢œè‰² private K key; //é”® private V value; // å€¼ } /** * æ ‘æ ¹çš„å¼•ç”¨ */ private RBNode root; public RBNode getRoot() { return this.root; } private RBNode parentOf(RBNode node) { if (node != null) { return node.parent; } return null; } /** * å½“å‰ç»“ç‚¹æ˜¯å¦ä¸ºçº¢è‰² * @param node * @return */ private boolean isRed(RBNode node) { return node != null &amp;&amp; node.color == RED; } /** * å½“å‰ç»“ç‚¹æ˜¯å¦ä¸ºé»‘è‰² * @param node * @return */ private boolean isBlack(RBNode node) { return node != null &amp;&amp; node.color == BLACK; } /** * è®¾ç½®èŠ‚ç‚¹ä¸ºçº¢è‰² * * @param node */ private void setRed(RBNode node) { if (node != null) { node.color = RED; } } /** * è®¾ç½®èŠ‚ç‚¹ä¸ºé»‘è‰² * * @param node */ private void setBlack(RBNode node) { if (node != null) { node.color = BLACK; } } /** * ä¸­åºæ‰“å°äºŒå‰æ ‘ */ public void inOrderPrint() { inOrderPrint(root); } private void inOrderPrint(RBNode node) { if (node != null) { inOrderPrint(node.left); System.out.println(&quot;key:&quot; + node.key + &quot;.value:&quot; + node.value); inOrderPrint(node.right); } } /** * å·¦æ—‹æ–¹æ³• * å·¦æ—‹ç¤ºæ„å›¾ï¼šå·¦æ—‹xèŠ‚ç‚¹ * p p * | | * x y * / \\ ----&gt; / \\ * lx y x ry * / \\ / \\ * ly ry lx ly * * å·¦æ—‹åšäº†å‡ ä»¶äº‹ï¼Ÿ * 1.å°†xçš„å³å­èŠ‚ç‚¹æŒ‡å‘yçš„å·¦å­èŠ‚ç‚¹(ly)ï¼Œå¹¶ä¸”æŠŠyçš„å·¦å­èŠ‚ç‚¹æ›´æ–°ä¸ºx * 2.å½“xçš„çˆ¶èŠ‚ç‚¹(ä¸ä¸ºç©ºæ—¶)ï¼Œæ›´æ–°yçš„çˆ¶èŠ‚ç‚¹ä¸ºxçš„çˆ¶èŠ‚ç‚¹ï¼Œå¹¶å°†xçš„çˆ¶èŠ‚ç‚¹ æŒ‡å®š å­æ ‘(å½“å‰xçš„å­æ ‘ä½ç½®) æŒ‡å®šä¸ºy * 3.å°†xçš„çˆ¶èŠ‚ç‚¹æ›´æ–°ä¸ºyï¼Œå°†yçš„å·¦å­èŠ‚ç‚¹æ›´æ–°ä¸ºx */ private void leftRotate(RBNode x) { RBNode y = x.right; x.right = y.left; // 1.å°†xçš„å³å­èŠ‚ç‚¹æŒ‡å‘yçš„å·¦å­èŠ‚ç‚¹(ly)ï¼Œå¹¶ä¸”æŠŠyçš„å·¦å­èŠ‚ç‚¹æ›´æ–°ä¸ºx if (y.left != null) { y.left.parent = x; } // 2.å½“xçš„çˆ¶èŠ‚ç‚¹(ä¸ä¸ºç©ºæ—¶)ï¼Œæ›´æ–°yçš„çˆ¶èŠ‚ç‚¹ä¸ºxçš„çˆ¶èŠ‚ç‚¹ï¼Œå¹¶å°†xçš„çˆ¶èŠ‚ç‚¹ æŒ‡å®š å­æ ‘(å½“å‰xçš„å­æ ‘ä½ç½®) æŒ‡å®šä¸ºy if (x.parent != null) { y.parent = x.parent; if (x == x.parent.left) { // å¦‚æœxæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†yæ”¾åœ¨xçˆ¶èŠ‚ç‚¹çš„å·¦è¾¹ x.parent.left = y; } else { x.parent.right = y; // å¦‚æœxæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†yæ”¾åœ¨xçˆ¶èŠ‚ç‚¹çš„å³è¾¹ } } else { // è¯´æ˜xä¸ºæ ¹èŠ‚ç‚¹ï¼Œæ­¤æ—¶éœ€è¦æ›´æ–°yä¸ºæ ¹èŠ‚ç‚¹ çš„å¼•ç”¨ this.root = y; this.root.parent = null; // æ ¹èŠ‚ç‚¹æ— çˆ¶èŠ‚ç‚¹ } // 3.å°†xçš„çˆ¶èŠ‚ç‚¹æ›´æ–°ä¸ºyï¼Œå°†yçš„å·¦å­èŠ‚ç‚¹æ›´æ–°ä¸ºx x.parent = y; y.left = x; } /** * å³æ—‹æ–¹æ³• * å³æ—‹ç¤ºæ„å›¾ï¼šå³æ—‹yèŠ‚ç‚¹ * * p p * | | * y x * / \\ ----&gt; / \\ * x ry lx y * / \\ / \\ * lx ly ly ry * * å³æ—‹éƒ½åšäº†å‡ ä»¶äº‹ï¼Ÿ * 1.å°†yçš„å·¦å­èŠ‚ç‚¹æŒ‡å‘xçš„å³å­èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ›´æ–°xçš„å³å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºy * 2.å½“yçš„çˆ¶èŠ‚ç‚¹ä¸ä¸ºç©ºæ—¶ï¼Œæ›´æ–°xçš„çˆ¶èŠ‚ç‚¹ä¸ºyçš„çˆ¶èŠ‚ç‚¹ï¼Œæ›´æ–°yçš„çˆ¶èŠ‚ç‚¹çš„æŒ‡å®šå­èŠ‚ç‚¹ï¼ˆyå½“å‰ä½ç½®ï¼‰ ä¸ºx * 3.æ›´æ–°y çš„çˆ¶èŠ‚ç‚¹ä¸ºx ,æ›´æ–°x çš„å³å­èŠ‚ç‚¹ä¸ºy */ public void rightRotate(RBNode y) { RBNode x = y.left; y.left = x.right; // 1.å°†xçš„å³å­èŠ‚ç‚¹ èµ‹å€¼ ç»™äº† y çš„å·¦å­èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ›´æ–°xçš„å³å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸º y if (x.right != null) { x.right.parent = y; } // 2.å°†yçš„çˆ¶èŠ‚ç‚¹pï¼ˆéç©ºæ—¶ï¼‰èµ‹å€¼ç»™xçš„çˆ¶èŠ‚ç‚¹ï¼ŒåŒæ—¶æ›´æ–°pçš„å­èŠ‚ç‚¹ä¸ºxï¼ˆå·¦æˆ–å³ï¼‰ if (y.parent != null) { x.parent = y.parent; if (y == y.parent.left) { // å¦‚æœyæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å°†xæ”¾åœ¨yçˆ¶èŠ‚ç‚¹çš„å·¦è¾¹ y.parent.left = x; } else { // å¦‚æœyæ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™å°†xæ”¾åœ¨yçˆ¶èŠ‚ç‚¹çš„å³è¾¹ y.parent.right = x; } } else { // è¯´æ˜yä¸ºæ ¹èŠ‚ç‚¹ï¼Œæ­¤æ—¶éœ€è¦æ›´æ–°xä¸ºæ ¹èŠ‚ç‚¹ çš„å¼•ç”¨ this.root = x; x.parent = null; } // 3.å°†xçš„å³å­èŠ‚ç‚¹èµ‹å€¼ä¸ºyï¼Œå°†yçš„çˆ¶èŠ‚ç‚¹è®¾ç½®ä¸ºx x.right = y; y.parent = x; } /** * publicæ’å…¥æ–¹æ³• * * @param key * @param value */ public void insert(K key, V value) { RBNode node = new RBNode&lt;&gt;(); node.setKey(key); node.setValue(value); // æ–°ç»“ç‚¹ä¸€å®šæ˜¯çº¢è‰² node.setColor(RED); insert(node); } /** * æ’å…¥èŠ‚ç‚¹ * @param node */ private void insert(RBNode node) { // ç¬¬ä¸€æ­¥ï¼šæŸ¥æ‰¾å½“å‰è¦æ’å…¥èŠ‚ç‚¹nodeçš„çˆ¶èŠ‚ç‚¹ RBNode parent = null; // å£°æ˜è¦æ’å…¥èŠ‚ç‚¹nodeçš„çˆ¶èŠ‚ç‚¹ RBNode x = this.root; while (x != null) { parent = x; /** * cmp &gt; 0 è¯´æ˜node.key å¤§äº x.key éœ€è¦åˆ°x çš„å³å­æ ‘æŸ¥æ‰¾ * cmp == 0 è¯´æ˜node.key ç­‰äº x.key éœ€è¦è¿›è¡Œæ›¿æ¢æ“ä½œ * cmp &lt; 0 è¯´æ˜node.key å°äº x.key éœ€è¦åˆ°x çš„å·¦å­æ ‘æŸ¥æ‰¾ */ int cmp = node.key.compareTo(x.key); if (cmp &gt; 0) { x = x.right; } else if (cmp == 0) { x.setValue(node.getValue()); return ; // ä¿®æ”¹å®Œå å°±ä¸å†ç»§ç»­å¾€ä¸‹é¢çš„ä»£ç æ‰§è¡Œäº† } else { x = x.left; } } /** * é€€å‡ºä¸Šé¢çš„whileå¾ªç¯åï¼Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æ ‘ä¸­æ²¡æœ‰ç›¸åŒkey çš„å…ƒç´  * * éœ€è¦æ·»åŠ æ–°å…ƒç´ nodeåˆ° x(parent) ç›®å‰ä½ç½®çš„å·¦å­æ ‘/å³å­æ ‘ */ node.parent = parent; if (parent != null) { // åˆ¤æ–­nodeä¸parentçš„keyè°å¤§ int cmp = node.key.compareTo(parent.key); if (cmp &gt; 0) { // å½“å‰nodeçš„keyæ¯”parent çš„keyå¤§ï¼Œéœ€è¦æŠŠnodeæ”¾å…¥parent çš„å³å­èŠ‚ç‚¹ parent.right = node; } else { // å½“å‰nodeçš„keyæ¯”parent çš„keyå¤§ï¼Œéœ€è¦æŠŠnodeæ”¾å…¥parent çš„å³å­èŠ‚ç‚¹ parent.left = node; } } else { // parent == null; è¯´æ˜ä¸ºç©ºæ ‘ this.root = node; // ç›´æ¥ç»™æ ‘æ ¹èµ‹å€¼ä¸ºnode } // æ–°å…ƒç´ node åŠ å…¥æ ‘ä¸­ä¹‹åï¼Œè¦è°ƒç”¨ä¿®å¤çº¢é»‘æ ‘å¹³è¡¡çš„æ–¹æ³• insertFixUp(node); } /** * æ’å…¥åä¿®å¤çº¢é»‘æ ‘å¹³è¡¡çš„æ–¹æ³• * |---æƒ…æ™¯1ï¼šå¦‚æœçº¢é»‘æ ‘ä¸ºç©ºæ ‘,éœ€è¦å°†æ ¹èŠ‚ç‚¹æŸ“ä¸ºé»‘è‰² * |---æƒ…æ™¯2ï¼šå¦‚æœæ’å…¥èŠ‚ç‚¹çš„keyå·²ç»å­˜åœ¨,(è¿™ç§æƒ…å†µä¸éœ€è¦å¤„ç†,å› ä¸ºä¿®æ”¹æ ‘ä¸­çš„å€¼ä¸ä¼šè§¦å‘çº¢é»‘æ ‘ä¿®å¤å¹³è¡¡æ–¹æ³•) * |---æƒ…æ™¯3ï¼šå¦‚æœæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²,è¿™ç§æƒ…å†µä¸éœ€è¦å¤„ç†,(å‚è€ƒçº¢é»‘æ ‘çš„æ€§è´¨4å’Œæ€§æŒ‡5å»ç†è§£) * (å› ä¸ºæ‰€æ’å…¥çš„è·¯å¾„ä¸­,é»‘è‰²èŠ‚ç‚¹æ•°æ²¡å‘ç”Ÿå˜åŒ–,æ‰€ä»¥çº¢é»‘æ ‘ä¾ç„¶å¹³è¡¡) * &lt;p&gt; * æƒ…æ™¯4 éœ€è¦å»å¤„ç†çš„æƒ…æ™¯ * |---æƒ…æ™¯4ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²,(è¿åçº¢é»‘æ ‘æ€§è´¨4,ä¸èƒ½æœ‰ä¸¤ä¸ªçº¢è‰²èŠ‚ç‚¹ç›¸è¿) * |---æƒ…æ™¯4.1ï¼šå”å”èŠ‚ç‚¹å­˜åœ¨ï¼Œå¹¶ä¸”ä¸ºçº¢è‰²ï¼ˆçˆ¶-å” åŒçº¢ï¼‰ * å¤„ç†ï¼šå°†çˆ¸çˆ¸å’Œå”å”æŸ“æˆé»‘è‰²ï¼Œå°†çˆ·çˆ·æŸ“æˆçº¢è‰²ï¼Œå¹¶ä¸”å†ä»¥çˆ·çˆ·èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œè¿›è¡Œä¸‹ä¸€è½®å¤„ç† * |---æƒ…æ™¯4.2ï¼šå”å”èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¸ºé»‘è‰²ï¼Œçˆ¶èŠ‚ç‚¹ä¸ºçˆ·çˆ·èŠ‚ç‚¹çš„å·¦å­æ ‘ * å¤„ç†ï¼š * |---æƒ…æ™¯4.2.1ï¼šæ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼ˆLLæƒ…å†µï¼‰ * å¤„ç†ï¼šå°†çˆ¶èŠ‚ç‚¹æŸ“ä¸ºé»‘è‰²ï¼Œå°†çˆ·çˆ·æŸ“ä¸ºçº¢è‰²ï¼Œç„¶åä»¥çˆ·çˆ·èŠ‚ç‚¹å³æ—‹å³å¯ * |---æƒ…æ™¯4.2.2ï¼šæ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ˆLRæƒ…å†µï¼‰ * å¤„ç†ï¼šå°†çˆ¶èŠ‚ç‚¹è¿›è¡Œä¸€æ¬¡å·¦æ—‹ï¼Œå¾—åˆ°LLåŒçº¢æƒ…æ™¯(4.2.1),ç„¶åæŒ‡å®šçˆ¶èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹è¿›è¡Œä¸‹ä¸€è½®å¤„ç† * |---æƒ…æ™¯4.3ï¼šå”å”èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¸ºé»‘è‰²ï¼Œçˆ¶èŠ‚ç‚¹ä¸ºçˆ·çˆ·èŠ‚ç‚¹çš„å³å­æ ‘ * |---æƒ…æ™¯4.3.1ï¼šæ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ˆRRæƒ…å†µï¼‰ * å¤„ç†ï¼šå°†çˆ¶èŠ‚ç‚¹æŸ“ä¸ºé»‘è‰²ï¼Œå°†çˆ·çˆ·èŠ‚ç‚¹æŸ“ä¸ºçº¢è‰²ï¼Œç„¶åä»¥çˆ·çˆ·èŠ‚ç‚¹å·¦æ—‹å³å¯ * |---æƒ…æ™¯4.3.2ï¼šæ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼ˆRLæƒ…å†µï¼‰ * å¤„ç†ï¼šä»¥çˆ¶èŠ‚ç‚¹è¿›è¡Œä¸€æ¬¡å³æ—‹ï¼Œå¾—åˆ°RRåŒçº¢æƒ…æ™¯(4.3.1),ç„¶åæŒ‡å®šçˆ¶èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹è¿›è¡Œä¸‹ä¸€è½®å¤„ç† */ private void insertFixUp(RBNode node) { RBNode parent = parentOf(node); // å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ RBNode gparent = parentOf(parent); // å½“å‰èŠ‚ç‚¹çš„çˆ·çˆ·èŠ‚ç‚¹ // å­˜åœ¨çˆ¶èŠ‚ç‚¹ä¸”çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰² if (parent != null &amp;&amp; isRed(parent)) { // çˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œé‚£ä¹ˆä¸€å®šå­˜åœ¨çˆ·çˆ·èŠ‚ç‚¹(æ€§è´¨2ï¼šæ ¹èŠ‚ç‚¹åªèƒ½æ˜¯é»‘è‰²) // çˆ¶èŠ‚ç‚¹ä¸ºçˆ·çˆ·èŠ‚ç‚¹çš„å·¦å­æ ‘ if (parent == gparent.left) { RBNode uncle = gparent.right; // æƒ…æ™¯4.1ï¼šå”å”èŠ‚ç‚¹å­˜åœ¨ï¼Œå¹¶ä¸”ä¸ºçº¢è‰²ï¼ˆçˆ¶-å” åŒçº¢ï¼‰ // å°†çˆ¶å’Œå”æŸ“è‰²ä¸ºé»‘è‰²ï¼Œå†å°†çˆ·çˆ·æŸ“çº¢ï¼Œå¹¶å°†çˆ·çˆ·è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯åˆ¤æ–­ if (uncle != null &amp;&amp; isRed(uncle)) { setBlack(parent); setBlack(uncle); setRed(gparent); insertFixUp(gparent); return ; } // æƒ…æ™¯4.2ï¼šå”å”èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¸ºé»‘è‰²ï¼Œçˆ¶èŠ‚ç‚¹ä¸ºçˆ·çˆ·èŠ‚ç‚¹çš„å·¦å­æ ‘ if (uncle == null || isBlack(uncle)) { /** * æƒ…æ™¯4.2.1ï¼šæ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼ˆLLæƒ…å†µï¼‰ * å¤„ç†ï¼šå°†çˆ¶èŠ‚ç‚¹æŸ“ä¸ºé»‘è‰²ï¼Œå°†çˆ·çˆ·æŸ“ä¸ºçº¢è‰²ï¼Œç„¶åä»¥çˆ·çˆ·èŠ‚ç‚¹å³æ—‹å³å¯ */ // æ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼ˆLLæƒ…å†µï¼‰=&gt; // å˜è‰²ï¼ˆçˆ¶èŠ‚ç‚¹å˜é»‘ï¼Œçˆ·çˆ·èŠ‚ç‚¹å˜çº¢ï¼‰ï¼Œå³æ—‹çˆ·çˆ·èŠ‚ç‚¹ if (node == parent.left) { setBlack(parent); setRed(gparent); rightRotate(gparent); // ä»¥gparentå³æ—‹ } /** * æƒ…æ™¯4.2.2ï¼šæ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ˆLRæƒ…å†µï¼‰ * å¤„ç†ï¼šå°†çˆ¶èŠ‚ç‚¹è¿›è¡Œä¸€æ¬¡å·¦æ—‹ï¼Œå¾—åˆ°LLåŒçº¢æƒ…æ™¯(4.2.1),ç„¶åæŒ‡å®šçˆ¶èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹è¿›è¡Œä¸‹ä¸€è½®å¤„ç† */ // æ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ˆLRæƒ…å†µï¼‰=&gt; // å·¦æ—‹ï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰ï¼Œå½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºçˆ¶èŠ‚ç‚¹ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ if (node == parent.right) { leftRotate(parent); // parentå·¦æ—‹ insertFixUp(parent); // è¿›è¡Œä¸‹ä¸€è½®å¤„ç† return ; } } } else { // çˆ¶èŠ‚ç‚¹ä¸ºçˆ·çˆ·èŠ‚ç‚¹çš„å³å­æ ‘ RBNode uncle = gparent.left; // æƒ…æ™¯4.1ï¼šå”å”èŠ‚ç‚¹å­˜åœ¨ï¼Œå¹¶ä¸”ä¸ºçº¢è‰²ï¼ˆçˆ¶-å” åŒçº¢ï¼‰ // å°†çˆ¶å’Œå”æŸ“è‰²ä¸ºé»‘è‰²ï¼Œå†å°†çˆ·çˆ·æŸ“çº¢ï¼Œå¹¶å°†çˆ·çˆ·è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯åˆ¤æ–­ if (uncle != null &amp;&amp; isRed(uncle)) { setBlack(parent); setBlack(uncle); setRed(gparent); insertFixUp(gparent); return ; } // æƒ…æ™¯4.3ï¼šå”å”èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¸ºé»‘è‰²ï¼Œçˆ¶èŠ‚ç‚¹ä¸ºçˆ·çˆ·èŠ‚ç‚¹çš„å³å­æ ‘ if (uncle == null || isBlack(uncle)) { /** * æƒ…æ™¯4.3.1ï¼šæ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ˆRRæƒ…å†µï¼‰ * å¤„ç†ï¼šå°†çˆ¶èŠ‚ç‚¹æŸ“ä¸ºé»‘è‰²ï¼Œå°†çˆ·çˆ·èŠ‚ç‚¹æŸ“ä¸ºçº¢è‰²ï¼Œç„¶åä»¥çˆ·çˆ·èŠ‚ç‚¹å·¦æ—‹å³å¯ */ // æ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼ˆRRæƒ…å†µï¼‰=&gt; // å˜è‰²ï¼ˆçˆ¶èŠ‚ç‚¹å˜é»‘ï¼Œçˆ·çˆ·èŠ‚ç‚¹å˜çº¢ï¼‰ï¼Œå³æ—‹çˆ·çˆ·èŠ‚ç‚¹ if (node == parent.right) { setBlack(parent); setRed(gparent); leftRotate(gparent); } /** * æƒ…æ™¯4.3.2ï¼šæ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼ˆRLæƒ…å†µï¼‰ * å¤„ç†ï¼šä»¥çˆ¶èŠ‚ç‚¹è¿›è¡Œä¸€æ¬¡å³æ—‹ï¼Œå¾—åˆ°RRåŒçº¢æƒ…æ™¯(4.3.1),ç„¶åæŒ‡å®šçˆ¶èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹è¿›è¡Œä¸‹ä¸€è½®å¤„ç† */ // æ’å…¥èŠ‚ç‚¹ä¸ºå…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼ˆRLæƒ…å†µï¼‰ // å³æ—‹ï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰å¾—åˆ°RRæƒ…å†µï¼Œå½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºçˆ¶èŠ‚ç‚¹ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ if (node == parent.left) { rightRotate(parent); insertFixUp(parent); return ; } } } } setBlack(this.root); }} 2.2 TreeOperation.java12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394package DataStructure.rbtree;public class TreeOperation { /** æ ‘çš„ç»“æ„ç¤ºä¾‹ï¼š 1 / \\ 2 3 / \\ / \\ 4 5 6 7 */ /** * ç”¨äºè·å¾—æ ‘çš„å±‚æ•° * @param root * @return */ public static int getTreeDepth(RBTree.RBNode root) { return root == null ? 0 : (1 + Math.max(getTreeDepth(root.getLeft()), getTreeDepth(root.getRight()))); } /** * å°†æ ‘çš„å€¼å†™å…¥æ•°ç»„ * @param currNode * @param rowIndex * @param columnIndex * @param res * @param treeDepth */ private static void writeArray(RBTree.RBNode currNode, int rowIndex, int columnIndex, String[][] res, int treeDepth) { // ä¿è¯è¾“å…¥çš„æ ‘ä¸ä¸ºç©º if (currNode == null) return ; // å…ˆå°†å½“å‰èŠ‚ç‚¹ä¿å­˜åˆ°äºŒç»´æ•°ç»„ä¸­ res[rowIndex][columnIndex] = String.valueOf(currNode.getKey() + &quot;-&quot; + (currNode.isColor() ? &quot;R&quot; : &quot;B&quot;) + &quot;&quot;); // è®¡ç®—å½“å‰ä½äºæ ‘çš„ç¬¬å‡ å±‚ int currLevel = ((rowIndex + 1) / 2); // è‹¥åˆ°äº†æœ€åä¸€å±‚ï¼Œåˆ™è¿”å› if (currLevel == treeDepth) return ; // è®¡ç®—å½“å‰è¡Œåˆ°ä¸‹ä¸€è¡Œï¼Œæ¯ä¸ªå…ƒç´ ä¹‹é—´çš„é—´éš”ï¼ˆä¸‹ä¸€è¡Œçš„åˆ—ç´¢å¼•ä¸å½“å‰å…ƒç´ çš„åˆ—ç¼©å½±ä¹‹é—´çš„é—´éš”ï¼‰ int gap = treeDepth - currLevel - 1; // å¯¹å·¦å„¿å­è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥æœ‰å·¦å„¿å­ï¼Œåˆ™è®°å½•ç›¸åº”çš„&quot;/&quot;ä¸å·¦å„¿å­çš„å€¼ if (currNode.getLeft() != null) { res[rowIndex + 1][columnIndex - gap] = &quot;/&quot;; writeArray(currNode.getLeft(), rowIndex + 2, columnIndex - gap * 2, res, treeDepth); } // å¯¹å³å„¿å­è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥æœ‰å³å„¿å­ï¼Œåˆ™è®°å½•ç›¸åº”çš„&quot;\\&quot;ä¸å³å„¿å­çš„å€¼ if (currNode.getRight() != null) { res[rowIndex + 1][columnIndex + gap] = &quot;\\\\&quot;; writeArray(currNode.getRight(), rowIndex + 2, columnIndex + gap * 2, res, treeDepth); } } /** * å±•ç¤º * @param root */ public static void show(RBTree.RBNode root) { if (root == null) System.out.println(&quot;EMPTY!&quot;); // å¾—åˆ°æ ‘çš„æ·±åº¦ int treeDepth = getTreeDepth(root); // æœ€åä¸€è¡Œçš„å®½åº¦ä¸º2çš„ï¼ˆn - 1ï¼‰æ¬¡æ–¹ä¹˜3ï¼Œå†åŠ 1 // ä½œä¸ºæ•´ä¸ªäºŒç»´æ•°ç»„çš„å®½åº¦ int arrayHeight = treeDepth * 2 - 1; int arrayWidth = (2 &lt;&lt; (treeDepth - 2)) * 3 + 1; // ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„æ¥å­˜å‚¨æ¯ä¸ªä½ç½®åº”æ˜¾ç¤ºçš„å…ƒç´  String[][] res = new String[arrayHeight][arrayWidth]; // å¯¹æ•°ç»„è¿›è¡Œåˆå§‹åŒ–ï¼Œé»˜è®¤ä¸ºä¸€ä¸ªç©ºæ ¼ for (int i = 0; i &lt; arrayHeight; i++) { for (int j = 0; j &lt; arrayWidth; j++) { res[i][j] = &quot; &quot;; } } // ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œé€’å½’å¤„ç†æ•´ä¸ªæ ‘ // res[0][(arrayWidth + 1)/ 2] = (char)(root.val + '0'); writeArray(root, 0, arrayWidth / 2, res, treeDepth); // æ­¤æ—¶ï¼Œå·²ç»å°†æ‰€æœ‰éœ€è¦æ˜¾ç¤ºçš„å…ƒç´ å‚¨å­˜åˆ°äº†äºŒç»´æ•°ç»„ä¸­ï¼Œå°†å…¶æ‹¼æ¥å¹¶æ‰“å°å³å¯ for (String[] line : res) { StringBuilder sb = new StringBuilder(); for (int i = 0; i &lt; line.length; i++) { sb.append(line[i]); if (line[i].length() &gt; 1 &amp;&amp; i &lt;= line.length - 1) { i += line[i].length() &gt; 4 ? 2 : line[i].length() - 1; } } System.out.println(sb.toString()); } }} 2.3 RBTreeTest.java123456789101112131415161718package DataStructure.rbtree;import java.util.Scanner;public class RBTreeTest { public static void main(String[] args) { RBTree&lt;String, Object&gt; rbtree = new RBTree(); //æµ‹è¯•è¾“å…¥ï¼šijkgefhdabc while(true) { Scanner sc = new Scanner(System.in); System.out.println(&quot;è¯·è¾“å…¥key:&quot;); String key = sc.next(); rbtree.insert(key, null); TreeOperation.show(rbtree.getRoot()); } }} 3 HashMapåº•å±‚çº¢é»‘æ ‘åˆ†æ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639static final class TreeNode&lt;K,V&gt; extends LinkedHashMap.Entry&lt;K,V&gt; { TreeNode&lt;K,V&gt; parent;// çˆ¶èŠ‚ç‚¹ TreeNode&lt;K,V&gt; left;// å·¦å­æ ‘ TreeNode&lt;K,V&gt; right;// å³å­æ ‘ TreeNode&lt;K,V&gt; prev; // needed to unlink next upon deletion boolean red;// é¢œè‰² /** * æœ‰å‚æ„é€ å‡½æ•° */ TreeNode(int hash, K key, V val, Node&lt;K,V&gt; next) { super(hash, key, val, next); } /** * è·å–çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ */ final TreeNode&lt;K,V&gt; root() { for (TreeNode&lt;K,V&gt; r = this, p;;) { if ((p = r.parent) == null) return r; r = p; } } /** * ç¡®ä¿ç»™å®šçš„æ ¹rootæ˜¯æ ‘çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ */ static &lt;K,V&gt; void moveRootToFront(Node&lt;K,V&gt;[] tab, TreeNode&lt;K,V&gt; root) { ... } /** * è°ƒç”¨findæ–¹æ³•æŸ¥æ‰¾. */ final TreeNode&lt;K, V&gt; getTreeNode(int h, Object k) { // ä»æ ‘çš„æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾ return ((parent != null) ? root() : this).find(h, k, null); } /** * ä»æ ¹èŠ‚ç‚¹å‡ºå‘æŸ¥æ‰¾å…·æœ‰ç»™å®šå“ˆå¸Œå€¼å’Œé”®çš„èŠ‚ç‚¹.ä»æ ¹èŠ‚ç‚¹å‡ºå‘ * æŸ¥æ‰¾å½“å‰è¦æ’å…¥èŠ‚ç‚¹nodeçš„çˆ¶èŠ‚ç‚¹ * * ç»å…¸äºŒå‰æŸ¥æ‰¾æ ‘çš„æŸ¥æ‰¾è¿‡ç¨‹ï¼Œå…ˆæ ¹æ®hashå€¼æ¯”è¾ƒï¼Œå†æ ¹æ®keyå€¼æ¯”è¾ƒå†³å®šæ˜¯æŸ¥å·¦å­æ ‘è¿˜æ˜¯å³å­æ ‘ã€‚ */ final TreeNode&lt;K, V&gt; find(int h, Object k, Class&lt;?&gt; kc) { TreeNode&lt;K, V&gt; p = this; do { int ph, dir; K pk; TreeNode&lt;K, V&gt; pl = p.left, pr = p.right, q; if ((ph = p.hash) &gt; h) // å·¦å­æ ‘ p = pl; else if (ph &lt; h) // å³å­æ ‘ p = pr; else if ((pk = p.key) == k || (k != null &amp;&amp; k.equals(pk))) // æ‰¾åˆ°äº†ç›´æ¥è¿”å› return p; else if (pl == null) // hashç›¸åŒä½†keyä¸åŒï¼Œå·¦å­æ ‘ä¸ºç©ºæŸ¥å³å­æ ‘ p = pr; else if (pr == null) // å³å­æ ‘ä¸ºç©ºæŸ¥å·¦å­æ ‘ p = pl; else if ((kc != null || (kc = comparableClassFor(k)) != null) &amp;&amp; (dir = compareComparables(kc, k, pk)) != 0) // é€šè¿‡compareæ–¹æ³•æ¯”è¾ƒkeyå€¼çš„å¤§å°å†³å®šä½¿ç”¨å·¦å­æ ‘è¿˜æ˜¯å³å­æ ‘ p = (dir &lt; 0) ? pl : pr; else if ((q = pr.find(h, k, kc)) != null) // å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½ä¸é€šè¿‡ï¼Œåˆ™å°è¯•åœ¨å³å­æ ‘æŸ¥æ‰¾ return q; else // éƒ½æ²¡æ‰¾åˆ°å°±åœ¨å·¦å­æ ‘æŸ¥æ‰¾ p = pl; } while (p != null); return null; } /** * ç”¨äºåœ¨a å’Œ b çš„hashå€¼ç›¸ç­‰ä¸”ä¸å¯æ¯”è¾ƒæ—¶å¯¹æ’å…¥è¿›è¡Œæ’åº */ static int tieBreakOrder(Object a, Object b) { ... } /** * å¯¹é“¾è¡¨è¿›è¡Œæ ‘åŒ–çš„æ–¹æ³• *ï¼ˆ1ï¼‰ä»é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹éå†ï¼› *ï¼ˆ2ï¼‰å°†ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºæ ¹èŠ‚ç‚¹ï¼› *ï¼ˆ3ï¼‰å…¶å®ƒå…ƒç´ ä¾æ¬¡æ’å…¥åˆ°çº¢é»‘æ ‘ä¸­ï¼Œå†åšå¹³è¡¡ï¼› *ï¼ˆ4ï¼‰å°†æ ¹èŠ‚ç‚¹ç§»åˆ°é“¾è¡¨ç¬¬ä¸€å…ƒç´ çš„ä½ç½®ï¼ˆå› ä¸ºå¹³è¡¡çš„æ—¶å€™æ ¹èŠ‚ç‚¹ä¼šæ”¹å˜ï¼‰ï¼› */ final void treeify(Node&lt;K, V&gt;[] tab) { TreeNode&lt;K, V&gt; root = null; for (TreeNode&lt;K, V&gt; x = this, next; x != null; x = next) { next = (TreeNode&lt;K, V&gt;) x.next; x.left = x.right = null; // ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºæ ¹èŠ‚ç‚¹ä¸”ä¸ºé»‘èŠ‚ç‚¹ï¼Œå…¶å®ƒå…ƒç´ ä¾æ¬¡æ’å…¥åˆ°æ ‘ä¸­å†åšå¹³è¡¡ if (root == null) { x.parent = null; x.red = false; root = x; } else { K k = x.key; int h = x.hash; Class&lt;?&gt; kc = null; // ä»æ ¹èŠ‚ç‚¹æŸ¥æ‰¾å…ƒç´ æ’å…¥çš„ä½ç½® for (TreeNode&lt;K, V&gt; p = root; ; ) { int dir, ph; K pk = p.key; if ((ph = p.hash) &gt; h) dir = -1; else if (ph &lt; h) dir = 1; else if ((kc == null &amp;&amp; (kc = comparableClassFor(k)) == null) || (dir = compareComparables(kc, k, pk)) == 0) dir = tieBreakOrder(k, pk); // å¦‚æœæœ€åæ²¡æ‰¾åˆ°å…ƒç´ ï¼Œåˆ™æ’å…¥ TreeNode&lt;K, V&gt; xp = p; if ((p = (dir &lt;= 0) ? p.left : p.right) == null) { x.parent = xp; if (dir &lt;= 0) xp.left = x; else xp.right = x; // æ’å…¥åå¹³è¡¡ï¼Œé»˜è®¤æ’å…¥çš„æ˜¯çº¢èŠ‚ç‚¹ï¼Œåœ¨balanceInsertion()æ–¹æ³•é‡Œ root = balanceInsertion(root, x); break; } } } } // æŠŠæ ¹èŠ‚ç‚¹ç§»åŠ¨åˆ°é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œå› ä¸ºç»è¿‡å¹³è¡¡ä¹‹ååŸæ¥çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ä¸€å®šæ˜¯æ ¹èŠ‚ç‚¹äº† moveRootToFront(tab, root); } /** * å¯¹çº¢é»‘æ ‘è¿›è¡Œåæ ‘åŒ–çš„æ–¹æ³• */ final Node&lt;K,V&gt; untreeify(HashMap&lt;K,V&gt; map) { Node&lt;K,V&gt; hd = null, tl = null; for (Node&lt;K,V&gt; q = this; q != null; q = q.next) { Node&lt;K,V&gt; p = map.replacementNode(q, null); if (tl == null) hd = p; else tl.next = p; tl = p; } return hd; } /** * å‘æ ‘ç§æ’å…¥æ•°æ®çš„æ–¹æ³• *ï¼ˆ1ï¼‰å¯»æ‰¾æ ¹èŠ‚ç‚¹ï¼› *ï¼ˆ2ï¼‰ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾ï¼› *ï¼ˆ3ï¼‰æ¯”è¾ƒhashå€¼åŠkeyå€¼ï¼Œå¦‚æœéƒ½ç›¸åŒï¼Œç›´æ¥è¿”å›ï¼Œåœ¨putVal()æ–¹æ³•ä¸­å†³å®šæ˜¯å¦è¦æ›¿æ¢valueå€¼ï¼› *ï¼ˆ4ï¼‰æ ¹æ®hashå€¼åŠkeyå€¼ç¡®å®šåœ¨æ ‘çš„å·¦å­æ ‘è¿˜æ˜¯å³å­æ ‘æŸ¥æ‰¾ï¼Œæ‰¾åˆ°äº†ç›´æ¥è¿”å›ï¼› *ï¼ˆ5ï¼‰å¦‚æœæœ€åæ²¡æœ‰æ‰¾åˆ°åˆ™åœ¨æ ‘çš„ç›¸åº”ä½ç½®æ’å…¥å…ƒç´ ï¼Œå¹¶åšå¹³è¡¡ï¼› */ final TreeNode&lt;K, V&gt; putTreeVal(HashMap&lt;K, V&gt; map, Node&lt;K, V&gt;[] tab, int h, K k, V v) { Class&lt;?&gt; kc = null; // æ ‡è®°æ˜¯å¦æ‰¾åˆ°è¿™ä¸ªkeyçš„èŠ‚ç‚¹ boolean searched = false; // æ‰¾åˆ°æ ‘çš„æ ¹èŠ‚ç‚¹ TreeNode&lt;K, V&gt; root = (parent != null) ? root() : this; // ä»æ ‘çš„æ ¹èŠ‚ç‚¹å¼€å§‹éå† for (TreeNode&lt;K, V&gt; p = root; ; ) { // dir=directionï¼Œæ ‡è®°æ˜¯åœ¨å·¦è¾¹è¿˜æ˜¯å³è¾¹ // ph=p.hashï¼Œå½“å‰èŠ‚ç‚¹çš„hashå€¼ int dir, ph; // pk=p.keyï¼Œå½“å‰èŠ‚ç‚¹çš„keyå€¼ K pk; if ((ph = p.hash) &gt; h) { // å½“å‰hashæ¯”ç›®æ ‡hashå¤§ï¼Œè¯´æ˜åœ¨å·¦è¾¹ dir = -1; } else if (ph &lt; h) // å½“å‰hashæ¯”ç›®æ ‡hashå°ï¼Œè¯´æ˜åœ¨å³è¾¹ dir = 1; else if ((pk = p.key) == k || (k != null &amp;&amp; k.equals(pk))) // ä¸¤è€…hashç›¸åŒä¸”keyç›¸ç­‰ï¼Œè¯´æ˜æ‰¾åˆ°äº†èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›è¯¥èŠ‚ç‚¹ // å›åˆ°putVal()ä¸­åˆ¤æ–­æ˜¯å¦éœ€è¦ä¿®æ”¹å…¶valueå€¼ return p; else if ((kc == null &amp;&amp; // å¦‚æœkæ˜¯Comparableçš„å­ç±»åˆ™è¿”å›å…¶çœŸå®çš„ç±»ï¼Œå¦åˆ™è¿”å›null (kc = comparableClassFor(k)) == null) || // å¦‚æœkå’Œpkä¸æ˜¯åŒæ ·çš„ç±»å‹åˆ™è¿”å›0ï¼Œå¦åˆ™è¿”å›ä¸¤è€…æ¯”è¾ƒçš„ç»“æœ (dir = compareComparables(kc, k, pk)) == 0) { // è¿™ä¸ªæ¡ä»¶è¡¨ç¤ºä¸¤è€…hashç›¸åŒä½†æ˜¯å…¶ä¸­ä¸€ä¸ªä¸æ˜¯Comparableç±»å‹æˆ–è€…ä¸¤è€…ç±»å‹ä¸åŒ // æ¯”å¦‚keyæ˜¯Objectç±»å‹ï¼Œè¿™æ—¶å¯ä»¥ä¼ Stringä¹Ÿå¯ä»¥ä¼ Integerï¼Œä¸¤è€…hashå€¼å¯èƒ½ç›¸åŒ // åœ¨çº¢é»‘æ ‘ä¸­æŠŠåŒæ ·hashå€¼çš„å…ƒç´ å­˜å‚¨åœ¨åŒä¸€é¢—å­æ ‘ï¼Œè¿™é‡Œç›¸å½“äºæ‰¾åˆ°äº†è¿™é¢—å­æ ‘çš„é¡¶ç‚¹ // ä»è¿™ä¸ªé¡¶ç‚¹åˆ†åˆ«éå†å…¶å·¦å³å­æ ‘å»å¯»æ‰¾æœ‰æ²¡æœ‰è·Ÿå¾…æ’å…¥çš„keyç›¸åŒçš„å…ƒç´  if (!searched) { TreeNode&lt;K, V&gt; q, ch; searched = true; // éå†å·¦å³å­æ ‘æ‰¾åˆ°äº†ç›´æ¥è¿”å› if (((ch = p.left) != null &amp;&amp; (q = ch.find(h, k, kc)) != null) || ((ch = p.right) != null &amp;&amp; (q = ch.find(h, k, kc)) != null)) return q; } // å¦‚æœä¸¤è€…ç±»å‹ç›¸åŒï¼Œå†æ ¹æ®å®ƒä»¬çš„å†…å­˜åœ°å€è®¡ç®—hashå€¼è¿›è¡Œæ¯”è¾ƒ dir = tieBreakOrder(k, pk); } TreeNode&lt;K, V&gt; xp = p; if ((p = (dir &lt;= 0) ? p.left : p.right) == null) { // å¦‚æœæœ€åç¡®å®æ²¡æ‰¾åˆ°å¯¹åº”keyçš„å…ƒç´ ï¼Œåˆ™æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ Node&lt;K, V&gt; xpn = xp.next; TreeNode&lt;K, V&gt; x = map.newTreeNode(h, k, v, xpn); if (dir &lt;= 0) xp.left = x; else xp.right = x; xp.next = x; x.parent = x.prev = xp; if (xpn != null) ((TreeNode&lt;K, V&gt;) xpn).prev = x; // æ’å…¥æ ‘èŠ‚ç‚¹åå¹³è¡¡ // æŠŠrootèŠ‚ç‚¹ç§»åŠ¨åˆ°é“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ moveRootToFront(tab, balanceInsertion(root, x)); return null; } } } // remove è°ƒç”¨ removeNode //public V remove(Object key) { // Node&lt;K, V&gt; e; // return (e = removeNode(hash(key), key, null, false, true)) == null ? // null : e.value; //} final Node&lt;K, V&gt; removeNode(int hash, Object key, Object value, boolean matchValue, boolean movable) { Node&lt;K, V&gt;[] tab; Node&lt;K, V&gt; p; int n, index; // å¦‚æœæ¡¶çš„æ•°é‡å¤§äº0ä¸”å¾…åˆ é™¤çš„å…ƒç´ æ‰€åœ¨çš„æ¡¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ä¸ºç©º if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (p = tab[index = (n - 1) &amp; hash]) != null) { Node&lt;K, V&gt; node = null, e; K k; V v; if (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != null &amp;&amp; key.equals(k)))) // å¦‚æœç¬¬ä¸€ä¸ªå…ƒç´ æ­£å¥½å°±æ˜¯è¦æ‰¾çš„å…ƒç´ ï¼Œèµ‹å€¼ç»™nodeå˜é‡åç»­åˆ é™¤ä½¿ç”¨ node = p; else if ((e = p.next) != null) { if (p instanceof TreeNode) // å¦‚æœç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ ‘èŠ‚ç‚¹ï¼Œåˆ™ä»¥æ ‘çš„æ–¹å¼æŸ¥æ‰¾èŠ‚ç‚¹ node = ((TreeNode&lt;K, V&gt;) p).getTreeNode(hash, key); else { // å¦åˆ™éå†æ•´ä¸ªé“¾è¡¨æŸ¥æ‰¾å…ƒç´  do { if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) { node = e; break; } p = e; } while ((e = e.next) != null); } } // å¦‚æœæ‰¾åˆ°äº†å…ƒç´ ï¼Œåˆ™çœ‹å‚æ•°æ˜¯å¦éœ€è¦åŒ¹é…valueå€¼ï¼Œå¦‚æœä¸éœ€è¦åŒ¹é…ç›´æ¥åˆ é™¤ï¼Œ // å¦‚æœéœ€è¦åŒ¹é…åˆ™çœ‹valueå€¼æ˜¯å¦ä¸ä¼ å…¥çš„valueç›¸ç­‰ if (node != null &amp;&amp; (!matchValue || (v = node.value) == value || (value != null &amp;&amp; value.equals(v)))) { if (node instanceof TreeNode) // å¦‚æœæ˜¯æ ‘èŠ‚ç‚¹ï¼Œè°ƒç”¨æ ‘çš„åˆ é™¤æ–¹æ³•ï¼ˆä»¥nodeè°ƒç”¨çš„ï¼Œæ˜¯åˆ é™¤è‡ªå·±ï¼‰ ((TreeNode&lt;K, V&gt;) node).removeTreeNode(this, tab, movable); else if (node == p) // å¦‚æœå¾…åˆ é™¤çš„å…ƒç´ æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™æŠŠç¬¬äºŒä¸ªå…ƒç´ ç§»åˆ°ç¬¬ä¸€çš„ä½ç½® tab[index] = node.next; else // å¦åˆ™åˆ é™¤nodeèŠ‚ç‚¹ p.next = node.next; ++modCount; --size; // åˆ é™¤èŠ‚ç‚¹åç½®å¤„ç† afterNodeRemoval(node); return node; } } return null; } /** *ï¼ˆ1ï¼‰å…ˆæŸ¥æ‰¾å…ƒç´ æ‰€åœ¨çš„èŠ‚ç‚¹ï¼› *ï¼ˆ2ï¼‰å¦‚æœæ‰¾åˆ°çš„èŠ‚ç‚¹æ˜¯æ ‘èŠ‚ç‚¹ï¼Œåˆ™æŒ‰æ ‘çš„ç§»é™¤èŠ‚ç‚¹å¤„ç†ï¼› *ï¼ˆ3ï¼‰å¦‚æœæ‰¾åˆ°çš„èŠ‚ç‚¹æ˜¯æ¡¶ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æŠŠç¬¬äºŒä¸ªèŠ‚ç‚¹ç§»åˆ°ç¬¬ä¸€çš„ä½ç½®ï¼› *ï¼ˆ4ï¼‰å¦åˆ™æŒ‰é“¾è¡¨åˆ é™¤èŠ‚ç‚¹å¤„ç†ï¼› *ï¼ˆ5ï¼‰ä¿®æ”¹sizeï¼Œè°ƒç”¨ç§»é™¤èŠ‚ç‚¹åç½®å¤„ç†ç­‰ï¼› */ final void removeTreeNode(HashMap&lt;K, V&gt; map, Node&lt;K, V&gt;[] tab, boolean movable) { int n; // å¦‚æœæ¡¶çš„æ•°é‡ä¸º0ç›´æ¥è¿”å› if (tab == null || (n = tab.length) == 0) return; // èŠ‚ç‚¹åœ¨æ¡¶ä¸­çš„ç´¢å¼• int index = (n - 1) &amp; hash; // ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ ¹èŠ‚ç‚¹ï¼Œæ ¹å·¦å­èŠ‚ç‚¹ TreeNode&lt;K, V&gt; first = (TreeNode&lt;K, V&gt;) tab[index], root = first, rl; // åç»§èŠ‚ç‚¹ï¼Œå‰ç½®èŠ‚ç‚¹ TreeNode&lt;K, V&gt; succ = (TreeNode&lt;K, V&gt;) next, pred = prev; if (pred == null) // å¦‚æœå‰ç½®èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯æ ¹èŠ‚ç‚¹ï¼Œåˆ™æŠŠåç»§èŠ‚ç‚¹èµ‹å€¼åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ï¼Œç›¸å½“äºåˆ é™¤äº†å½“å‰èŠ‚ç‚¹ tab[index] = first = succ; else // å¦åˆ™æŠŠå‰ç½®èŠ‚ç‚¹çš„ä¸‹ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œç›¸å½“äºåˆ é™¤äº†å½“å‰èŠ‚ç‚¹ pred.next = succ; // å¦‚æœåç»§èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™è®©åç»§èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ï¼Œç›¸å½“äºåˆ é™¤äº†å½“å‰èŠ‚ç‚¹ if (succ != null) succ.prev = pred; // å¦‚æœç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜æ²¡æœ‰åç»§èŠ‚ç‚¹äº†ï¼Œç›´æ¥è¿”å› if (first == null) return; // å¦‚æœæ ¹èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™é‡æ–°æŸ¥æ‰¾çˆ¶èŠ‚ç‚¹ if (root.parent != null) root = root.root(); // å¦‚æœæ ¹èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™éœ€è¦åæ ‘åŒ–ï¼ˆå°†æ ‘è½¬åŒ–ä¸ºé“¾è¡¨ï¼‰ // å¦‚æœéœ€è¦ç§»åŠ¨èŠ‚ç‚¹ä¸”æ ‘çš„é«˜åº¦æ¯”è¾ƒå°ï¼Œåˆ™éœ€è¦åæ ‘åŒ– if (root == null || (movable &amp;&amp; (root.right == null || (rl = root.left) == null || rl.left == null))) { tab[index] = first.untreeify(map); // too small return; } // åˆ†å‰²çº¿ï¼Œä»¥ä¸Šéƒ½æ˜¯åˆ é™¤é“¾è¡¨ä¸­çš„èŠ‚ç‚¹ï¼Œä¸‹é¢æ‰æ˜¯ç›´æ¥åˆ é™¤çº¢é»‘æ ‘çš„èŠ‚ç‚¹ï¼ˆå› ä¸ºTreeNodeæœ¬èº«å³æ˜¯é“¾è¡¨èŠ‚ç‚¹åˆæ˜¯æ ‘èŠ‚ç‚¹ï¼‰ // åˆ é™¤çº¢é»‘æ ‘èŠ‚ç‚¹çš„å¤§è‡´è¿‡ç¨‹æ˜¯å¯»æ‰¾å³å­æ ‘ä¸­æœ€å°çš„èŠ‚ç‚¹æ”¾åˆ°åˆ é™¤èŠ‚ç‚¹çš„ä½ç½®ï¼Œç„¶ååšå¹³è¡¡ï¼Œæ­¤å¤„ä¸è¿‡å¤šæ³¨é‡Š TreeNode&lt;K, V&gt; p = this, pl = left, pr = right, replacement; if (pl != null &amp;&amp; pr != null) { TreeNode&lt;K, V&gt; s = pr, sl; while ((sl = s.left) != null) // find successor s = sl; boolean c = s.red; s.red = p.red; p.red = c; // swap colors TreeNode&lt;K, V&gt; sr = s.right; TreeNode&lt;K, V&gt; pp = p.parent; if (s == pr) { // p was s's direct parent p.parent = s; s.right = p; } else { TreeNode&lt;K, V&gt; sp = s.parent; if ((p.parent = sp) != null) { if (s == sp.left) sp.left = p; else sp.right = p; } if ((s.right = pr) != null) pr.parent = s; } p.left = null; if ((p.right = sr) != null) sr.parent = p; if ((s.left = pl) != null) pl.parent = s; if ((s.parent = pp) == null) root = s; else if (p == pp.left) pp.left = s; else pp.right = s; if (sr != null) replacement = sr; else replacement = p; } else if (pl != null) replacement = pl; else if (pr != null) replacement = pr; else replacement = p; if (replacement != p) { TreeNode&lt;K, V&gt; pp = replacement.parent = p.parent; if (pp == null) root = replacement; else if (p == pp.left) pp.left = replacement; else pp.right = replacement; p.left = p.right = p.parent = null; } TreeNode&lt;K, V&gt; r = p.red ? root : balanceDeletion(root, replacement); if (replacement == p) { // detach TreeNode&lt;K, V&gt; pp = p.parent; p.parent = null; if (pp != null) { if (p == pp.left) pp.left = null; else if (p == pp.right) pp.right = null; } } if (movable) moveRootToFront(tab, r); } final void split(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab, int index, int bit) { ... } // å·¦æ—‹ static &lt;K,V&gt; TreeNode&lt;K,V&gt; rotateLeft(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; p) { TreeNode&lt;K,V&gt; r, pp, rl; if (p != null &amp;&amp; (r = p.right) != null) { if ((rl = p.right = r.left) != null) rl.parent = p; if ((pp = r.parent = p.parent) == null) (root = r).red = false; else if (pp.left == p) pp.left = r; else pp.right = r; r.left = p; p.parent = r; } return root; } // å³æ—‹ static &lt;K,V&gt; TreeNode&lt;K,V&gt; rotateRight(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; p) { TreeNode&lt;K,V&gt; l, pp, lr; if (p != null &amp;&amp; (l = p.left) != null) { if ((lr = p.left = l.right) != null) lr.parent = p; if ((pp = l.parent = p.parent) == null) (root = l).red = false; else if (pp.right == p) pp.right = l; else pp.left = l; l.right = p; p.parent = l; } return root; } // ä¿®å¤çº¢é»‘æ ‘å¹³è¡¡çš„æ–¹æ³• static &lt;K,V&gt; TreeNode&lt;K,V&gt; balanceInsertion(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; x) { x.red = true; for (TreeNode&lt;K,V&gt; xp, xpp, xppl, xppr;;) { if ((xp = x.parent) == null) { x.red = false; return x; } else if (!xp.red || (xpp = xp.parent) == null) return root; if (xp == (xppl = xpp.left)) { if ((xppr = xpp.right) != null &amp;&amp; xppr.red) { xppr.red = false; xp.red = false; xpp.red = true; x = xpp; } else { if (x == xp.right) { root = rotateLeft(root, x = xp); xpp = (xp = x.parent) == null ? null : xp.parent; } if (xp != null) { xp.red = false; if (xpp != null) { xpp.red = true; root = rotateRight(root, xpp); } } } } else { if (xppl != null &amp;&amp; xppl.red) { xppl.red = false; xp.red = false; xpp.red = true; x = xpp; } else { if (x == xp.left) { root = rotateRight(root, x = xp); xpp = (xp = x.parent) == null ? null : xp.parent; } if (xp != null) { xp.red = false; if (xpp != null) { xpp.red = true; root = rotateLeft(root, xpp); } } } } } } static &lt;K,V&gt; TreeNode&lt;K,V&gt; balanceDeletion(TreeNode&lt;K,V&gt; root, TreeNode&lt;K,V&gt; x) { for (TreeNode&lt;K,V&gt; xp, xpl, xpr;;) { if (x == null || x == root) return root; else if ((xp = x.parent) == null) { x.red = false; return x; } else if (x.red) { x.red = false; return root; } else if ((xpl = xp.left) == x) { if ((xpr = xp.right) != null &amp;&amp; xpr.red) { xpr.red = false; xp.red = true; root = rotateLeft(root, xp); xpr = (xp = x.parent) == null ? null : xp.right; } if (xpr == null) x = xp; else { TreeNode&lt;K,V&gt; sl = xpr.left, sr = xpr.right; if ((sr == null || !sr.red) &amp;&amp; (sl == null || !sl.red)) { xpr.red = true; x = xp; } else { if (sr == null || !sr.red) { if (sl != null) sl.red = false; xpr.red = true; root = rotateRight(root, xpr); xpr = (xp = x.parent) == null ? null : xp.right; } if (xpr != null) { xpr.red = (xp == null) ? false : xp.red; if ((sr = xpr.right) != null) sr.red = false; } if (xp != null) { xp.red = false; root = rotateLeft(root, xp); } x = root; } } } else { // symmetric if (xpl != null &amp;&amp; xpl.red) { xpl.red = false; xp.red = true; root = rotateRight(root, xp); xpl = (xp = x.parent) == null ? null : xp.left; } if (xpl == null) x = xp; else { TreeNode&lt;K,V&gt; sl = xpl.left, sr = xpl.right; if ((sl == null || !sl.red) &amp;&amp; (sr == null || !sr.red)) { xpl.red = true; x = xp; } else { if (sl == null || !sl.red) { if (sr != null) sr.red = false; xpl.red = true; root = rotateLeft(root, xpl); xpl = (xp = x.parent) == null ? null : xp.left; } if (xpl != null) { xpl.red = (xp == null) ? false : xp.red; if ((sl = xpl.left) != null) sl.red = false; } if (xp != null) { xp.red = false; root = rotateRight(root, xp); } x = root; } } } } } /** * Recursive invariant check */ static &lt;K,V&gt; boolean checkInvariants(TreeNode&lt;K,V&gt; t) { TreeNode&lt;K,V&gt; tp = t.parent, tl = t.left, tr = t.right, tb = t.prev, tn = (TreeNode&lt;K,V&gt;)t.next; if (tb != null &amp;&amp; tb.next != t) return false; if (tn != null &amp;&amp; tn.prev != t) return false; if (tp != null &amp;&amp; t != tp.left &amp;&amp; t != tp.right) return false; if (tl != null &amp;&amp; (tl.parent != t || tl.hash &gt; t.hash)) return false; if (tr != null &amp;&amp; (tr.parent != t || tr.hash &lt; t.hash)) return false; if (t.red &amp;&amp; tl != null &amp;&amp; tl.red &amp;&amp; tr != null &amp;&amp; tr.red) return false; if (tl != null &amp;&amp; !checkInvariants(tl)) return false; if (tr != null &amp;&amp; !checkInvariants(tr)) return false; return true; } } å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ treeifyBin()123456789101112131415161718192021222324252627282930313233343536373839404142434445464748/* æ›¿æ¢æŒ‡å®šå“ˆå¸Œè¡¨çš„ç´¢å¼•å¤„æ¡¶ä¸­çš„æ‰€æœ‰é“¾æ¥ç»“ç‚¹ï¼Œé™¤éè¡¨å¤ªå°ï¼Œå¦åˆ™å°†ä¿®æ”¹å¤§å°ã€‚ Node&lt;K,V&gt;[] tab = tab æ•°ç»„å int hash = hashè¡¨ç¤ºå“ˆå¸Œå€¼*/final void treeifyBin(Node&lt;K,V&gt;[] tab, int hash) { int n, index; Node&lt;K,V&gt; e; /* å¦‚æœå½“å‰æ•°ç»„ä¸ºç©ºæˆ–è€…æ•°ç»„çš„é•¿åº¦å°äºè¿›è¡Œæ ‘å½¢åŒ–çš„é˜ˆå€¼(MIN_TREEIFY_CAPACITY = 64)ï¼Œ å°±å»æ‰©å®¹ã€‚è€Œä¸æ˜¯å°†ç»“ç‚¹å˜ä¸ºçº¢é»‘æ ‘ã€‚ ç›®çš„ï¼šå¦‚æœæ•°ç»„å¾ˆå°ï¼Œé‚£ä¹ˆè½¬æ¢çº¢é»‘æ ‘ï¼Œç„¶åéå†æ•ˆç‡è¦ä½ä¸€äº›ã€‚è¿™æ—¶è¿›è¡Œæ‰©å®¹ï¼Œ é‚£ä¹ˆé‡æ–°è®¡ç®—å“ˆå¸Œå€¼ï¼Œé“¾è¡¨é•¿åº¦æœ‰å¯èƒ½å°±å˜çŸ­äº†ï¼Œæ•°æ®ä¼šæ”¾åˆ°æ•°ç»„ä¸­ï¼Œè¿™æ ·ç›¸å¯¹æ¥è¯´æ•ˆç‡é«˜ä¸€äº›ã€‚ */ if (tab == null || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY) //æ‰©å®¹æ–¹æ³• resize(); else if ((e = tab[index = (n - 1) &amp; hash]) != null) { /* 1ï¼‰æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜å“ˆå¸Œè¡¨ä¸­çš„æ•°ç»„é•¿åº¦å¤§äºé˜ˆå€¼64ï¼Œå¼€å§‹è¿›è¡Œæ ‘å½¢åŒ– 2ï¼‰e = tab[index = (n - 1) &amp; hash]è¡¨ç¤ºå°†æ•°ç»„ä¸­çš„å…ƒç´ å–å‡ºèµ‹å€¼ç»™eï¼Œ eæ˜¯å“ˆå¸Œè¡¨ä¸­æŒ‡å®šä½ç½®æ¡¶é‡Œçš„é“¾è¡¨ç»“ç‚¹ï¼Œä»ç¬¬ä¸€ä¸ªå¼€å§‹ */ // hdï¼šçº¢é»‘æ ‘çš„å¤´ç»“ç‚¹ tlï¼šçº¢é»‘æ ‘çš„å°¾ç»“ç‚¹ TreeNode&lt;K,V&gt; hd = null, tl = null; do { // æ–°åˆ›å»ºä¸€ä¸ªæ ‘çš„ç»“ç‚¹ï¼Œå†…å®¹å’Œå½“å‰é“¾è¡¨ç»“ç‚¹eä¸€è‡´ TreeNode&lt;K,V&gt; p = replacementTreeNode(e, null); if (tl == null) hd = p; // å°†æ–°åˆ›é”®çš„pç»“ç‚¹èµ‹å€¼ç»™çº¢é»‘æ ‘çš„å¤´ç»“ç‚¹ else { p.prev = tl; // å°†ä¸Šä¸€ä¸ªç»“ç‚¹pèµ‹å€¼ç»™ç°åœ¨çš„pçš„å‰ä¸€ä¸ªç»“ç‚¹ tl.next = p; // å°†ç°åœ¨ç»“ç‚¹pä½œä¸ºæ ‘çš„å°¾ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ } tl = p; /* e = e.next å°†å½“å‰ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹èµ‹å€¼ç»™eï¼Œå¦‚æœä¸‹ä¸€ä¸ªç»“ç‚¹ä¸ç­‰äºnull åˆ™å›åˆ°ä¸Šé¢ç»§ç»­å–å‡ºé“¾è¡¨ä¸­ç»“ç‚¹è½¬æ¢ä¸ºçº¢é»‘æ ‘ */ } while ((e = e.next) != null); /* è®©æ¡¶ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ å³æ•°ç»„ä¸­çš„å…ƒç´ æŒ‡å‘æ–°å»ºçš„çº¢é»‘æ ‘çš„ç»“ç‚¹ï¼Œä»¥åè¿™ä¸ªæ¡¶é‡Œçš„å…ƒç´ å°±æ˜¯çº¢é»‘æ ‘ è€Œä¸æ˜¯é“¾è¡¨æ•°æ®ç»“æ„äº† */ if ((tab[index] = hd) != null) hd.treeify(tab); }} å‚è€ƒ(110æ¡æ¶ˆæ¯) HashMapåº•å±‚çº¢é»‘æ ‘å®ç°(è‡ªå·±å®ç°ä¸€ä¸ªç®€å•çš„çº¢é»‘æ ‘) JDKæºç é˜…è¯»ä¹‹Entry - ç®€ä¹¦ (jianshu.com)","link":"/2022/02/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E7%BA%A2%E9%BB%91%E6%A0%91/"},{"title":"Springæºç é˜…è¯»ï¼ˆä¸€ï¼‰","text":"1 å‰è¨€â€‹ é˜…è¯»æºç å¯ä»¥å¸®åŠ©æé«˜debugèƒ½åŠ›ä»¥åŠæ›´åŠ ç†Ÿæ‚‰è¯¥æ¡†æ¶çš„åŸç†ä¸æ„å»ºæ–¹å¼ï¼Œå­¦ä¹ å¤§å¸ˆçš„æ€ç»´ã€‚æœ¬ç³»åˆ—æ–‡ç« å°†ä¼šé€šè¿‡é˜…è¯»Springæºç ï¼Œå°½åŠ›åˆ†æå„ä¸ªå‡½æ•°ï¼Œç±»ï¼Œæ¥å£ç­‰çš„å®ç°æ–¹å¼ä¸åŸç†ï¼Œæ¥è®©è‡ªå·±æ›´åŠ æ·±åˆ»ç†è§£è¿™ä¸€æ¡†æ¶ã€‚ â€‹ é¦–å…ˆï¼Œæˆ‘ä»¬è¦çŸ¥é“ï¼ŒSpringæ˜¯ä¸€ä¸ªç”Ÿæ€ä½“ç³»ï¼Œå…¶ä¸­åŒ…å«äº†Spring Framework, Spring Boot, Spring Cloudç­‰ï¼Œä¸€èˆ¬è¯´çš„Springæºç æ˜¯æŒ‡Spring Frameworkä¸­çš„ã€‚ â€‹ è€Œåœ¨Spring Frameworkä¸­ï¼Œåˆä¼šæœ‰è®¸å¤šæ¨¡å—æ‰€ç»„æˆ ä¸€å…±æœ‰ä»¥ä¸‹20å¤šä¸ªä¸åŒçš„æ¨¡å— 12345spring-aop spring-context-indexer spring-instrument spring-orm spring-webspring-aspects spring-context-support spring-jcl spring-oxm spring-webfluxspring-beans spring-core spring-jdbc spring-r2dbc spring-webmvcspring-context spring-expression spring-jms spring-test spring-websocketspring-messaging spring-tx â€‹ è€Œæˆ‘ä»¬çŸ¥é“ï¼ŒSpringæœ€æ ¸å¿ƒçš„åŠŸèƒ½å°±æ˜¯IOCå’ŒAOPï¼Œä¹Ÿæ˜¯æœ¬æ¬¡æºç åˆ†æçš„é‡ç‚¹ â€‹ åœ¨å›¾ä¸­ï¼Œä¹Ÿå°±æ˜¯Core Containerä¸­çš„æ¨¡å—å’ŒAOPã€Aspectsã€‚æ¥ä¸‹æ¥ï¼Œè¯´è¯´å¤§è‡´ä½œç”¨ï¼š Beans æ¨¡å—ï¼šæä¾›äº†æ¡†æ¶çš„åŸºç¡€éƒ¨åˆ†ï¼ŒåŒ…æ‹¬æ§åˆ¶åè½¬å’Œä¾èµ–æ³¨å…¥ã€‚ Core æ ¸å¿ƒæ¨¡å—ï¼šå°è£…äº† Spring æ¡†æ¶çš„åº•å±‚éƒ¨åˆ†ï¼ŒåŒ…æ‹¬èµ„æºè®¿é—®ã€ç±»å‹è½¬æ¢åŠä¸€äº›å¸¸ç”¨å·¥å…·ç±»ã€‚ Context ä¸Šä¸‹æ–‡æ¨¡å—ï¼šå»ºç«‹åœ¨ Core å’Œ Beans æ¨¡å—çš„åŸºç¡€ä¹‹ä¸Šï¼Œé›†æˆ Beans æ¨¡å—åŠŸèƒ½å¹¶æ·»åŠ èµ„æºç»‘å®šã€æ•°æ®éªŒè¯ã€å›½é™…åŒ–ã€Java EE æ”¯æŒã€å®¹å™¨ç”Ÿå‘½å‘¨æœŸã€äº‹ä»¶ä¼ æ’­ç­‰ã€‚ApplicationContext æ¥å£æ˜¯ä¸Šä¸‹æ–‡æ¨¡å—çš„ç„¦ç‚¹ã€‚ AOP æ¨¡å—ï¼šæä¾›äº†é¢å‘åˆ‡é¢ç¼–ç¨‹å®ç°ï¼Œæä¾›æ¯”å¦‚æ—¥å¿—è®°å½•ã€æƒé™æ§åˆ¶ã€æ€§èƒ½ç»Ÿè®¡ç­‰é€šç”¨åŠŸèƒ½å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»çš„æŠ€æœ¯ï¼Œå¹¶ä¸”èƒ½åŠ¨æ€çš„æŠŠè¿™äº›åŠŸèƒ½æ·»åŠ åˆ°éœ€è¦çš„ä»£ç ä¸­ï¼Œè¿™æ ·å„å¸å…¶èŒï¼Œé™ä½ä¸šåŠ¡é€»è¾‘å’Œé€šç”¨åŠŸèƒ½çš„è€¦åˆã€‚ Aspects æ¨¡å—ï¼šæä¾›ä¸ AspectJ çš„é›†æˆï¼Œæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä¸”æˆç†Ÿçš„é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰æ¡†æ¶ã€‚ å¤§è‡´äº†è§£äº†ä»¥åï¼Œå°†è¿›å…¥æºç åˆ†æäº† 2 ç¯å¢ƒæ­å»ºæ–°å»ºä¸€ä¸ªmavené¡¹ç›®ä»¥åï¼Œå¯¼å…¥ä»¥ä¸‹pomæ–‡ä»¶ pom.xml 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;org.example&lt;/groupId&gt; &lt;artifactId&gt;spring_core&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;properties&gt; &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.18.20&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-beans --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-beans&lt;/artifactId&gt; &lt;version&gt;5.3.15&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-aop --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-aop&lt;/artifactId&gt; &lt;version&gt;5.3.15&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-core --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-core&lt;/artifactId&gt; &lt;version&gt;5.3.15&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-context --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;version&gt;5.3.15&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-expression --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-expression&lt;/artifactId&gt; &lt;version&gt;5.3.15&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;!--åœ¨buildä¸­é…ç½®resourcesï¼Œæ¥é˜²æ­¢æˆ‘ä»¬èµ„æºå¯¼å‡ºå¤±è´¥çš„é—®é¢˜--&gt; &lt;build&gt; &lt;resources&gt; &lt;resource&gt; &lt;directory&gt;src/main/resources&lt;/directory&gt; &lt;includes&gt; &lt;include&gt;**/*.properties&lt;/include&gt; &lt;include&gt;**/*.xml&lt;/include&gt; &lt;/includes&gt; &lt;filtering&gt;true&lt;/filtering&gt; &lt;/resource&gt; &lt;resource&gt; &lt;directory&gt;src/main/java&lt;/directory&gt; &lt;includes&gt; &lt;include&gt;**/*.properties&lt;/include&gt; &lt;include&gt;**/*.xml&lt;/include&gt; &lt;/includes&gt; &lt;filtering&gt;true&lt;/filtering&gt; &lt;/resource&gt; &lt;/resources&gt; &lt;/build&gt;&lt;/project&gt; applicationContext.xml 1234567891011&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt; &lt;bean id=&quot;person&quot; class=&quot;com.w1nd.spring.dao.Person&quot;&gt; &lt;property name=&quot;age&quot; value=&quot;23&quot;/&gt; &lt;property name=&quot;name&quot; value=&quot;Bruis&quot;/&gt; &lt;/bean&gt;&lt;/beans&gt; Person.java 123456789package com.w1nd.spring.dao;import lombok.Data;@Datapublic class Person { private Integer age; private String name;} 3 IoCè¿‡ç¨‹â€‹ IoCï¼ˆæ§åˆ¶åè½¬ï¼‰ç®€å•æ¥è¯´å°±æ˜¯å°†åˆ›å»ºBeanå’Œæ³¨å…¥Beançš„æƒåˆ©èµ‹äºˆç»™äº†Springå®¹å™¨ï¼Œä¸ç”¨ç¨‹åºå‘˜è‡ªå·±å»ç®¡ç†ï¼Œåœ¨beanç”Ÿæˆæˆ–åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒSpringå®¹å™¨å°±ä¼šå°†æ•°æ®æ³¨å…¥åˆ°beanä¸­ï¼Œåˆæˆ–è€…é€šè¿‡å°†å¯¹è±¡çš„å¼•ç”¨æ³¨å…¥åˆ°å¯¹è±¡æ•°æ®åŸŸä¸­çš„æ–¹å¼æ¥æ³¨å…¥å¯¹æ–¹æ³•è°ƒç”¨çš„ä¾èµ–ã€‚ â€‹ åœ¨Springå®¹å™¨çš„è®¾è®¡ä¸­ï¼Œæœ‰ä¸¤ä¸ªä¸»è¦çš„å®¹å™¨æœºåˆ¶ï¼š å®ç°BeanFactoryæ¥å£çš„ç®€å•å®¹å™¨ç³»åˆ— â€‹ å®ç°äº†å®¹å™¨æœ€åŸºæœ¬çš„åŠŸèƒ½ ApplicationContextåº”ç”¨ä¸Šä¸‹æ–‡ â€‹ é™¤äº†æ‹¥æœ‰BeanFactoryçš„æ‰€æœ‰åŠŸèƒ½å¤–ï¼Œè¿˜æ”¯æŒç‰¹æ®Šç±»å‹beanå¦‚ä¸Šä¸€èŠ‚ä¸­çš„BeanFactoryPostProcessorå’ŒBeanPostProcessorçš„è‡ªåŠ¨è¯†åˆ«ã€èµ„æºåŠ è½½ã€å®¹å™¨äº‹ä»¶å’Œç›‘å¬å™¨ã€å›½é™…åŒ–æ”¯æŒã€å•ä¾‹beanè‡ªåŠ¨åˆå§‹åŒ–ç­‰ã€‚ å¯¹äºè¿™ä¸¤ä¸ªå®¹å™¨ï¼ŒDefaultListableBeanFactoryæ˜¯æ˜¯Springæ³¨å†ŒåŠåŠ è½½beançš„é»˜è®¤å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥ç±»æ¥åŠ è½½ 123456789101112131415161718package com.w1nd.spring;import com.w1nd.spring.dao.Person;import org.springframework.beans.factory.support.DefaultListableBeanFactory;import org.springframework.beans.factory.xml.XmlBeanDefinitionReader;import org.springframework.context.ApplicationContext;import org.springframework.context.support.ClassPathXmlApplicationContext;public class SpringMain { public static void main(String[] args) { DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory(); XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(beanFactory); reader.loadBeanDefinitions(&quot;applicationContext.xml&quot;); Person person1 = (Person) beanFactory.getBean(&quot;person&quot;); System.out.println(person1); }} ä½†åœ¨ä¸‹é¢æ¼”ç¤ºä¸­ï¼Œä¸ºäº†æ›´å¥½çš„äº†è§£springä¸€ç³»åˆ—è¡ç”Ÿæ–¹æ¡ˆï¼Œä½¿ç”¨ClassPathXmlApplicationContextæ¥åŠ è½½xmlæ–‡ä»¶ï¼Œæ¼”ç¤ºç¨‹åºå¦‚ä¸‹ 1234567891011121314package com.w1nd.spring;import com.w1nd.spring.dao.Person;import org.springframework.context.ApplicationContext;import org.springframework.context.support.ClassPathXmlApplicationContext;public class SpringMain { public static void main(String[] args) { //ä½¿ç”¨springå®¹å™¨ ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); Person person = (Person)context.getBean(&quot;person&quot;); System.out.println(person); }} â€‹ å¦å¤–ï¼Œæˆ‘ä»¬æ¥çœ‹DefaultListableBeanFactoryå’ŒClassPathXmlApplicationContextä¸¤ä¸ªç±»çš„ç»§æ‰¿é“¾å›¾ï¼Œè¿™å¯¹äºæ¥ä¸‹æ¥çš„debugä¼šæ›´æœ‰å¸®åŠ© â€‹ å»ºè®®å°†è¯¥å›¾ç”»ä¸‹æ¥ï¼Œdebugæ—¶å¯¹ç€ç”¨ç®­å¤´æ ‡æ˜ï¼Œè¿™æ ·ä¸ä¼šæ··ä¹± â€‹ ä¸‹é¢å¯¹ä¸Šè¿°æ¼”ç¤ºç¨‹åºdebug 3.1 åˆå§‹ åŠ è½½ContextClosedEventï¼Œä»¥å…åç»­å‡ºç°é—®é¢˜ ClassPathXmlApplicationContextæ„é€ å‡½æ•°ï¼ˆClassPathXmlApplicationContext.classï¼‰ 12345678910111213141516171819202122public ClassPathXmlApplicationContext(String configLocation) throws BeansException { this(new String[] {configLocation}, true, null);}/* ä½¿ç”¨ç»™å®šçš„çˆ¶ç±»å®¹å™¨åˆ›å»ºæ–°çš„ClassPathXmlApplicationContextï¼Œç„¶åä»ç»™å®šçš„XMLæ–‡ä»¶åŠ è½½å®šä¹‰ï¼Œ åŠ è½½æ‰€æœ‰beanå®šä¹‰å¹¶ä¸”åˆ›å»ºæ‰€æœ‰çš„å•ä¾‹ï¼Œåœ¨è¿›ä¸€æ­¥é…ç½®ä¸Šä¸‹æ–‡åè°ƒç”¨refreshã€‚æ¢å¥è¯è¯´xmlæ–‡ä»¶çš„è¯»å–ï¼Œ beançš„åˆ›å»ºå’Œå®ä¾‹åŒ–éƒ½æ˜¯åœ¨refresh()æ–¹æ³•ä¸­è¿›è¡Œçš„ï¼Œrefresh()å‡½æ•°ä¸­åŒ…å«äº†å‡ ä¹æ‰€æœ‰çš„ ApplicationContextä¸­æä¾›çš„å…¨éƒ¨åŠŸèƒ½ã€‚*/public ClassPathXmlApplicationContext( String[] configLocations, boolean refresh, @Nullable ApplicationContext parent) throws BeansException { super(parent); //è®¾ç½®é…ç½®è·¯å¾„ setConfigLocations(configLocations); if (refresh) { //refresh Springå®¹å™¨ å¾ˆé‡è¦ï¼Œè¿™ä¸ªæ–¹æ³• refresh(); }} è®¾ç½®é…ç½®è·¯å¾„ï¼ˆAbstractRefreshableConfigApplicationContext.classï¼‰ 12345678910111213//ç»™configLocationså­—ç¬¦ä¸²æ•°ç»„è®¾ç½®å€¼ï¼Œæ”¯æŒå¤šä¸ªé…ç½®æ–‡ä»¶å·²æ•°ç»„æ–¹å¼åŒæ—¶ä¼ å…¥ã€‚public void setConfigLocations(@Nullable String... locations) { if (locations != null) { Assert.noNullElements(locations, &quot;Config locations must not be null&quot;); this.configLocations = new String[locations.length]; for (int i = 0; i &lt; locations.length; i++) { this.configLocations[i] = resolvePath(locations[i]).trim(); } } else { this.configLocations = null; }} 3.2 refresh refreshå‡½æ•°ï¼ˆAbstractApplicationContext.classï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273/* ç®€å•æ¥è¯´ï¼ŒSpringå®¹å™¨çš„åˆå§‹åŒ–æ˜¯åœ¨refresh()æ–¹æ³•æ¥å¯åŠ¨çš„ï¼Œè¿™ä¸ªæ–¹æ³•æ ‡å¿—ç€IOCå®¹å™¨çš„æ­£å¼å¯åŠ¨ã€‚ å…·ä½“æ¥è¯´ï¼Œè¿™é‡Œçš„å¯åŠ¨åŒ…æ‹¬äº†BeanDefinitionå’ŒResourceçš„å®šä½ã€è½½å…¥å’Œæ³¨å†Œä¸‰ä¸ªåŸºæœ¬è¿‡ç¨‹ã€‚*/@Overridepublic void refresh() throws BeansException, IllegalStateException { synchronized (this.startupShutdownMonitor) { StartupStep contextRefresh = this.applicationStartup.start(&quot;spring.context.refresh&quot;); // å‡†å¤‡åˆ·æ–°å®¹å™¨ï¼ˆä¸Šä¸‹æ–‡ç¯å¢ƒï¼‰ prepareRefresh(); // é€šçŸ¥å­ç±»åˆ·æ–°å†…éƒ¨beanå·¥å‚ï¼Œåˆå§‹åŒ–BeanFactoryå¹¶è¿›è¡ŒXMLçš„è§£æè¯»å– ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // å‡†å¤‡ bean å·¥å‚ä»¥åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ã€‚ prepareBeanFactory(beanFactory); try { // å…è®¸åœ¨ä¸Šä¸‹æ–‡å­ç±»ä¸­å¯¹ bean å·¥å‚è¿›è¡Œåå¤„ç†ã€‚ postProcessBeanFactory(beanFactory); StartupStep beanPostProcess = this.applicationStartup.start(&quot;spring.context.beans.post-process&quot;); // è°ƒç”¨åœ¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œä¸º bean çš„å·¥å‚å¤„ç†å™¨ã€‚ invokeBeanFactoryPostProcessors(beanFactory); // æ³¨å†Œæ‹¦æˆª bean åˆ›å»ºçš„ bean å¤„ç†å™¨ã€‚ registerBeanPostProcessors(beanFactory); beanPostProcess.end(); // ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–æ¶ˆæ¯æºã€‚ initMessageSource(); // ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–äº‹ä»¶å¤šæ’­å™¨ã€‚ initApplicationEventMulticaster(); // åˆå§‹åŒ–ç‰¹å®šä¸Šä¸‹æ–‡å­ç±»ä¸­çš„å…¶ä»–ç‰¹æ®Š beanã€‚ onRefresh(); // æ£€æŸ¥ä¾¦å¬å™¨ bean å¹¶æ³¨å†Œå®ƒä»¬ã€‚ registerListeners(); // å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„ï¼ˆéæƒ°æ€§åˆå§‹åŒ–ï¼‰å•ä¾‹ã€‚ finishBeanFactoryInitialization(beanFactory); // æœ€åä¸€æ­¥ï¼šå‘å¸ƒç›¸åº”çš„äº‹ä»¶ã€‚ finishRefresh(); } catch (BeansException ex) { if (logger.isWarnEnabled()) { logger.warn(&quot;Exception encountered during context initialization - &quot; + &quot;cancelling refresh attempt: &quot; + ex); } // Destroy already created singletons to avoid dangling resources. destroyBeans(); // Reset 'active' flag. cancelRefresh(ex); // Propagate exception to caller. throw ex; } finally { // Reset common introspection caches in Spring's core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); contextRefresh.end(); } }} â€‹ é‰´äºè¯¥æ–¹æ³•çš„é‡è¦æ€§ï¼Œä¸‹é¢å¯¹å…¶å‡½æ•°ååˆ†ç›®å½•åˆ†åˆ«è®²è§£ï¼Œæ¯ä¸ªå‡½æ•°ä¼šé€æ¸æ·±å…¥å…¶å­å‡½æ•°å»åˆ†åºå·ï¼Œéƒ¨åˆ†ä¸ä¼šè®²çš„å¯èƒ½ä¸å¤ªé‡è¦æˆ–ä»…çŸ¥é“è¯¥å‡½æ•°ä½œç”¨å³å¯ã€‚å¾€åï¼Œæ¯ä¸ªå‡½æ•°ååé¢ä¼šå†™æ˜æ‰€åœ¨ç±»ï¼Œéƒ¨åˆ†è¾…åŠ©å‡½æ•°å’Œå…¶ä»–å‡½æ•°æ”¾åœ¨åŒä¸ªä»£ç å—è¯´æ˜ï¼Œä»£ç å—çš„å‡½æ•°é€šå¸¸åœ¨åŒä¸ªç±»ï¼Œå¦‚æœä¸åœ¨ï¼Œä¼šåœ¨æ³¨é‡Šæ ‡æ˜ 3.3 prepareRefresh prepareRefreshï¼ˆï¼‰ï¼ˆAbstractApplicationContext.classï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738/* å‡†å¤‡æ­¤ä¸Šä¸‹æ–‡ä»¥è¿›è¡Œåˆ·æ–°ã€è®¾ç½®å…¶å¯åŠ¨æ—¥æœŸå’Œæ´»åŠ¨æ ‡å¿—ä»¥åŠæ‰§è¡Œä»»ä½•å±æ€§æºçš„åˆå§‹åŒ–ã€‚*/protected void prepareRefresh() { // åˆ‡æ¢åˆ°æ´»åŠ¨çŠ¶æ€ this.startupDate = System.currentTimeMillis(); this.closed.set(false); this.active.set(true); if (logger.isDebugEnabled()) { if (logger.isTraceEnabled()) { logger.trace(&quot;Refreshing &quot; + this); } else { logger.debug(&quot;Refreshing &quot; + getDisplayName()); } } // åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­çš„ä»»ä½•å ä½ç¬¦å±æ€§æºã€‚è¿™é‡Œå¯¹äºå­ç±»å•¥éƒ½ä¸ä¼šå¹² initPropertySources(); // éªŒè¯æ‰€æœ‰æ ‡è®°ä¸ºå¿…éœ€çš„å±æ€§éƒ½æ˜¯å¯è§£æçš„ï¼š // è¯·å‚é˜… ConfigurablePropertyResolvesetRequiredProperties getEnvironment().validateRequiredProperties(); // å­˜å‚¨é¢„åˆ·æ–° ApplicationListeners... if (this.earlyApplicationListeners == null) { this.earlyApplicationListeners = new LinkedHashSet&lt;&gt;(this.applicationListeners); } else { // å°†æœ¬åœ°åº”ç”¨ç¨‹åºä¾¦å¬å™¨é‡ç½®ä¸ºé¢„åˆ·æ–°çŠ¶æ€ã€‚ this.applicationListeners.clear(); this.applicationListeners.addAll(this.earlyApplicationListeners); } // å…è®¸æ”¶é›†æ—©æœŸåº”ç”¨ç¨‹åºäº‹ä»¶ï¼Œä¸€æ—¦å¤šæ’­å™¨å¯ç”¨å°±å‘å¸ƒ... this.earlyApplicationEvents = new LinkedHashSet&lt;&gt;();} 3.4 obtainFreshBeanFactoryè¯¥æ–¹æ³•çš„æ—¶åºå›¾ obtainFreshBeanFactory ï¼ˆAbstractApplicationContext.classï¼‰ 1234567/* å‘Šè¯‰å­ç±»åˆ·æ–°å†…éƒ¨ bean å·¥å‚ã€‚ä¼šè¿”å›æ–°çš„BeanFactoryå®ä¾‹*/protected ConfigurableListableBeanFactory obtainFreshBeanFactory() { refreshBeanFactory(); return getBeanFactory();} refreshBeanFactoryï¼ˆAbstractRefreshableApplicationContext.classï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546/* æ­¤å®ç°æ‰§è¡Œæ­¤ä¸Šä¸‹æ–‡çš„åº•å±‚ bean å·¥å‚çš„å®é™…åˆ·æ–°ï¼Œå…³é—­å…ˆå‰çš„ bean å·¥å‚ï¼ˆå¦‚æœæœ‰ï¼‰å¹¶ä¸ºä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸçš„ä¸‹ä¸€é˜¶æ®µåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ bean å·¥å‚ã€‚*/@Overrideprotected final void refreshBeanFactory() throws BeansException { // å¦‚æœæœ‰ Beanå·¥å‚ï¼Œåˆ™å…³é—­è¯¥å·¥å‚ if (hasBeanFactory()) { destroyBeans(); closeBeanFactory(); } try { // åˆ›å»ºä¸€ä¸ªæ–°beanå·¥å‚ï¼Œè¿™é‡Œçš„DefaultListableBeanFactoryå°±æ˜¯å‰é¢çš„Springæ ¸å¿ƒç±»ï¼Œè¿™ä¸ªç±»çœŸçš„å¾ˆé‡è¦ï¼ DefaultListableBeanFactory beanFactory = createBeanFactory(); // åºåˆ—åŒ–æŒ‡å®šIDï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œè®©è¿™ä¸ªBeanFactoryä»IDååºåˆ—åŒ–æ‰BeanFactoryå¯¹è±¡ beanFactory.setSerializationId(getId()); // è‡ªå®šä¹‰æ­¤ä¸Šä¸‹æ–‡ä½¿ç”¨çš„å†…éƒ¨ bean å·¥å‚ã€‚ä¸ºæ¯æ¬¡ refresh() å°è¯•è°ƒç”¨ã€‚é»˜è®¤å®ç°åº”ç”¨æ­¤ä¸Šä¸‹æ–‡ // çš„â€œallowBeanDefinitionOverridingâ€å’Œâ€œallowCircularReferencesâ€è®¾ç½®ï¼ˆå¦‚æœæŒ‡å®šï¼‰ã€‚ // å¯ä»¥åœ¨å­ç±»ä¸­é‡å†™ä»¥è‡ªå®šä¹‰ä»»ä½•DefaultListableBeanFactory çš„è®¾ç½®ã€‚ customizeBeanFactory(beanFactory); // åŠ è½½beanå®šä¹‰ä¿¡æ¯ï¼Œè¿™ä¸€æ­¥å®é™…ä¸Šå°±ä»XMLé…ç½®æ–‡ä»¶é‡Œçš„beanä¿¡æ¯ç»™è¯»å–åˆ°äº†Factoryé‡Œäº†ã€‚ loadBeanDefinitions(beanFactory); this.beanFactory = beanFactory; } catch (IOException ex) { throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex); }}/* ç¡®å®šæ­¤ä¸Šä¸‹æ–‡å½“å‰æ˜¯å¦åŒ…å« bean å·¥å‚ï¼Œå³è‡³å°‘å·²åˆ·æ–°ä¸€æ¬¡ä¸”å°šæœªå…³é—­ã€‚*/ protected final boolean hasBeanFactory() { return (this.beanFactory != null);}/* å…³é—­BeanFactoryå®ä¾‹*/@Overrideprotected final void closeBeanFactory() { DefaultListableBeanFactory beanFactory = this.beanFactory; if (beanFactory != null) { beanFactory.setSerializationId(null); this.beanFactory = null; }} â€‹ ä¸Šé¢å›¾ç‰‡ï¼Œæ˜¯loadBeanDefinitionsï¼ˆï¼‰æ–¹æ³•è¿è¡Œå®Œä¹‹åï¼ŒeanFactoryå˜é‡é‡Œé¢å­˜æ”¾ç€ä¸€ä¸ªConcurrentHashMapå˜é‡ï¼Œç”¨äºå­˜æ”¾ç€personè¿™ä¸ªKVé”®å€¼å¯¹ï¼ŒKeyä¸ºpersonï¼ŒValueä¸ºä¸€ä¸ªArrayListçš„å˜é‡ï¼Œé‡Œé¢å­˜æ”¾ç€personçš„ä¸¤ä¸ªå±æ€§ï¼šageã€nameã€‚ä¸‹é¢æ¥ç€æ·±å…¥è¯¥æ–¹æ³•åˆ†æ loadBeanDefinitionsï¼ˆAbstractXmlApplicationContext.classï¼‰ â€‹ BeanDefinitionï¼Œé¡¾åæ€ä¹‰ï¼Œç”¨äºå®šä¹‰beanä¿¡æ¯çš„ç±»ï¼ŒåŒ…å«beançš„classç±»å‹ã€æ„é€ å‚æ•°ã€å±æ€§å€¼ç­‰ä¿¡æ¯ï¼Œæ¯ä¸ªbeanå¯¹åº”ä¸€ä¸ªBeanDefinitionçš„å®ä¾‹ã€‚ç®€åŒ–BeanDefinitionä»…åŒ…å«beançš„classç±»å‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748/* é€šè¿‡ XmlBeanDefinitionReader åŠ è½½ bean å®šä¹‰ã€‚*/@Overrideprotected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException { // ä¸ºç»™å®šçš„ BeanFactory åˆ›å»ºä¸€ä¸ªæ–°çš„ XmlBeanDefinitionReaderã€‚ XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); // ä½¿ç”¨æ­¤ä¸Šä¸‹æ–‡çš„èµ„æºåŠ è½½ç¯å¢ƒé…ç½® bean å®šä¹‰é˜…è¯»å™¨ã€‚ beanDefinitionReader.setEnvironment(this.getEnvironment()); // è®¾ç½® ResourceLoader ä»¥ç”¨äºèµ„æºå®šä½ã€‚ beanDefinitionReader.setResourceLoader(this); // è®¾ç½®è¦ç”¨äºè§£æçš„ SAX å®ä½“è§£æå™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå°†ä½¿ç”¨ ResourceEntityResolverã€‚ beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); // å…è®¸å­ç±»æä¾›é˜…è¯»å™¨çš„è‡ªå®šä¹‰åˆå§‹åŒ– initBeanDefinitionReader(beanDefinitionReader); // å®é™…åŠ è½½ bean å®šä¹‰ã€‚ loadBeanDefinitions(beanDefinitionReader);}/* AbstractApplicationContext.class ä»¥å¯é…ç½®çš„å½¢å¼è¿”å›æ­¤åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡çš„ç¯å¢ƒï¼Œå…è®¸è¿›ä¸€æ­¥å®šåˆ¶ã€‚ å¦‚æœæœªæŒ‡å®šï¼Œåˆ™å°†é€šè¿‡ createEnvironment() åˆå§‹åŒ–é»˜è®¤ç¯å¢ƒã€‚*/@Overridepublic ConfigurableEnvironment getEnvironment() { if (this.environment == null) { this.environment = createEnvironment(); } return this.environment;}/* XmlBeanDefinitionReader.class*/public void setEntityResolver(@Nullable EntityResolver entityResolver) { this.entityResolver = entityResolver;}/* åˆå§‹åŒ–ç”¨äºåŠ è½½æ­¤ä¸Šä¸‹æ–‡çš„ bean å®šä¹‰çš„ bean å®šä¹‰é˜…è¯»å™¨ã€‚é»˜è®¤å®ç°ä¸ºç©ºã€‚ å¯ä»¥åœ¨å­ç±»ä¸­è¢«è¦†ç›–ï¼Œä¾‹å¦‚ç”¨äºå…³é—­ XML éªŒè¯æˆ–ä½¿ç”¨ä¸åŒçš„ XmlBeanDefinitionParser å®ç°ã€‚*/protected void initBeanDefinitionReader(XmlBeanDefinitionReader reader) { reader.setValidating(this.validating);} loadBeanDefinitionsï¼ˆAbstractXmlApplicationContext.classï¼‰ â€‹ æ³¨æ„è¿™ä¸ªå’Œä¸Šä¸ªä¸ä¸€æ ·ï¼Œæ˜¯é‡è½½ 1234567891011121314/* ä½¿ç”¨ç»™å®šçš„ XmlBeanDefinitionReader åŠ è½½ bean å®šä¹‰ã€‚ bean å·¥å‚çš„ç”Ÿå‘½å‘¨æœŸç”± refreshBeanFactory æ–¹æ³•å¤„ç†ï¼›å› æ­¤è¿™ä¸ªæ–¹æ³•åªæ˜¯åº”è¯¥åŠ è½½å’Œæˆ–æ³¨å†Œ bean å®šä¹‰ã€‚*/protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws BeansException, IOException { Resource[] configResources = getConfigResources(); if (configResources != null) { reader.loadBeanDefinitions(configResources); } String[] configLocations = getConfigLocations(); if (configLocations != null) { reader.loadBeanDefinitions(configLocations); // &lt;-------æ˜¯stringè·¯å¾„ä¼šæ‰§è¡Œè¿™ä¸ª }} loadBeanDefinitionsï¼ˆAbstractBeanDefinationReader.classï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253@Overridepublic int loadBeanDefinitions(String... locations) throws BeanDefinitionStoreException { Assert.notNull(locations, &quot;Location array must not be null&quot;); int count = 0; for (String location : locations) { count += loadBeanDefinitions(location); } return count;}/* ä»æŒ‡å®šçš„èµ„æºä½ç½®åŠ è½½ bean å®šä¹‰ã€‚ä½ç½®ä¹Ÿå¯ä»¥æ˜¯ä½ç½®æ¨¡å¼ï¼Œ å‰ææ˜¯æ­¤ bean å®šä¹‰è¯»å–å™¨çš„ ResourceLoader æ˜¯ ResourcePatternResolverã€‚*/public int loadBeanDefinitions(String location, @Nullable Set&lt;Resource&gt; actualResources) throws BeanDefinitionStoreException { ResourceLoader resourceLoader = getResourceLoader(); if (resourceLoader == null) { throw new BeanDefinitionStoreException( &quot;Cannot load bean definitions from location [&quot; + location + &quot;]: no ResourceLoader available&quot;); } if (resourceLoader instanceof ResourcePatternResolver) { // èµ„æºæ¨¡å¼åŒ¹é…å¯ç”¨ã€‚ try { Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location); // ä»æŒ‡å®šçš„ XML æ–‡ä»¶åŠ è½½ bean å®šä¹‰ã€‚è¿™é‡Œdebugä¼šè¿›å»XmlBeanDefinitionReaderï¼Œ int count = loadBeanDefinitions(resources); if (actualResources != null) { Collections.addAll(actualResources, resources); } if (logger.isTraceEnabled()) { logger.trace(&quot;Loaded &quot; + count + &quot; bean definitions from location pattern [&quot; + location + &quot;]&quot;); } return count; } catch (IOException ex) { throw new BeanDefinitionStoreException( &quot;Could not resolve bean definition resource pattern [&quot; + location + &quot;]&quot;, ex); } } else { // åªèƒ½é€šè¿‡ç»å¯¹ URL åŠ è½½å•ä¸ªèµ„æºã€‚ Resource resource = resourceLoader.getResource(location); int count = loadBeanDefinitions(resource); if (actualResources != null) { actualResources.add(resource); } if (logger.isTraceEnabled()) { logger.trace(&quot;Loaded &quot; + count + &quot; bean definitions from location [&quot; + location + &quot;]&quot;); } return count; }} getResourcesï¼ˆPathMatchingResourcePatternResolver.classï¼‰ 12345678910111213141516171819202122232425262728@Overridepublic Resource[] getResources(String locationPattern) throws IOException { Assert.notNull(locationPattern, &quot;Location pattern must not be null&quot;); if (locationPattern.startsWith(CLASSPATH_ALL_URL_PREFIX)) { // ç±»è·¯å¾„èµ„æºï¼ˆå¯èƒ½æœ‰å¤šä¸ªåŒåèµ„æºï¼‰ if (getPathMatcher().isPattern(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()))) { // ç±»è·¯å¾„èµ„æºæ¨¡å¼ return findPathMatchingResources(locationPattern); } else { // å…·æœ‰ç»™å®šåç§°çš„æ‰€æœ‰ç±»è·¯å¾„èµ„æº return findAllClassPathResources(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length())); } } else { // é€šå¸¸åªåœ¨å‰ç¼€åé¢æŸ¥æ‰¾ä¸€ä¸ªæ¨¡å¼ï¼Œå¹¶ä¸”åœ¨Tomcatä¹‹ååªæœ‰â€œ* /â€åˆ†éš”ç¬¦ä¹‹åçš„â€œwarï¼šâ€åè®®ã€‚ int prefixEnd = (locationPattern.startsWith(&quot;war:&quot;) ? locationPattern.indexOf(&quot;*/&quot;) + 1 : locationPattern.indexOf(':') + 1); if (getPathMatcher().isPattern(locationPattern.substring(prefixEnd))) { // æ–‡ä»¶æ¨¡å¼ return findPathMatchingResources(locationPattern); } else { // å…·æœ‰ç»™å®šåç§°çš„å•ä¸ªèµ„æº return new Resource[] {getResourceLoader().getResource(locationPattern)}; } }} loadBeanDefinitionsï¼ˆXmlBeanDefinitionReader.classï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/* ä»XMLé…ç½®æ–‡ä»¶ä¸­è·å–beanå®šä¹‰ä¿¡æ¯*/public int loadBeanDefinitions(EncodedResource encodedResource) throws BeanDefinitionStoreException { Assert.notNull(encodedResource, &quot;EncodedResource must not be null&quot;); ... Set&lt;EncodedResource&gt; currentResources = this.resourcesCurrentlyBeingLoaded.get(); if (currentResources == null) { currentResources = new HashSet&lt;&gt;(4); this.resourcesCurrentlyBeingLoaded.set(currentResources); } ... try { InputStream inputStream = encodedResource.getResource().getInputStream(); try { InputSource inputSource = new InputSource(inputStream); if (encodedResource.getEncoding() != null) { inputSource.setEncoding(encodedResource.getEncoding()); } //è·å–åˆ°è¯»å–xmlé…ç½®æ–‡ä»¶çš„InputStreamæµåï¼Œè¿›è¡ŒBeanDefinitionsçš„åŠ è½½ return doLoadBeanDefinitions(inputSource, encodedResource.getResource()); } finally { inputStream.close(); } } catch (IOException ex) { ... } finally { currentResources.remove(encodedResource); if (currentResources.isEmpty()) { this.resourcesCurrentlyBeingLoaded.remove(); } }}/* çœŸæ­£ä»xmlé…ç½®æ–‡ä»¶ä¸­åŠ è½½Beanå®šä¹‰ä¿¡æ¯*/protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource) throws BeanDefinitionStoreException { try { //è·å–xmlçš„é…ç½®ä¿¡æ¯å¹¶å°è£…ä¸ºDocumentå¯¹è±¡ Document doc = doLoadDocument(inputSource, resource); return this.registerBeanDefinitions(doc, resource); } catch (BeanDefinitionStoreException ex) { ... }} ä»¥ä¸Šçš„æµç¨‹æ˜¯åœ¨è¯»å–BeanDefinitionä¿¡æ¯ï¼Œä¸‹é¢çœ‹å¦‚ä½•å°†å…¶æ³¨å†Œ registerBeanDefinitionsï¼ˆXmlBeanDefinitionReader.classï¼‰ 123456789101112/* æ³¨å†ŒåŒ…å«åœ¨ç»™å®š DOM æ–‡æ¡£ä¸­çš„ bean å®šä¹‰*/public int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException { // åˆ›å»º BeanDefinitionDocumentReader ä»¥ç”¨äºä» XML æ–‡æ¡£ä¸­å®é™…è¯»å– bean å®šä¹‰ BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader(); // æ³¨å†Œè¡¨ä¸­å®šä¹‰çš„ bean æ•°é‡ int countBefore = getRegistry().getBeanDefinitionCount(); // æ‰“å¼€ä¸€ä¸ª DOM æ–‡æ¡£ï¼›ç„¶ååˆå§‹åŒ–åœ¨ &lt;beans&gt; çº§åˆ«æŒ‡å®šçš„é»˜è®¤è®¾ç½®ï¼›ç„¶åè§£æåŒ…å«çš„ bean å®šä¹‰ã€‚ documentReader.registerBeanDefinitions(doc, createReaderContext(resource)); // &lt;----------- return getRegistry().getBeanDefinitionCount() - countBefore;} registerBeanDefinitionsï¼ˆDefaultBeanDefinitionDocumentReader.classï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102/* æ³¨å†Œå¹¶è§£æåŒ…å«çš„ bean å®šä¹‰ã€‚*/public void registerBeanDefinitions(Document doc, XmlReaderContext readerContext) { this.readerContext = readerContext; doRegisterBeanDefinitions(doc.getDocumentElement());}/* åœ¨ç»™å®šçš„æ ¹ &lt;beans&gt; å…ƒç´ ä¸­æ³¨å†Œæ¯ä¸ª bean å®šä¹‰ã€‚*/protected void doRegisterBeanDefinitions(Element root) { BeanDefinitionParserDelegate parent = this.delegate; this.delegate = createDelegate(getReaderContext(), root, parent); if (this.delegate.isDefaultNamespace(root)) { String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE); if (StringUtils.hasText(profileSpec)) { String[] specifiedProfiles = StringUtils.tokenizeToStringArray( profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS); if (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) { if (logger.isDebugEnabled()) { logger.debug(&quot;Skipped XML bean definition file due to specified profiles [&quot; + profileSpec + &quot;] not matching: &quot; + getReaderContext().getResource()); } return; } } } preProcessXml(root); // è§£æbeanDefinitionsä¿¡æ¯ï¼Œç»è¿‡è¿™ä¸ªæ–¹æ³•ï¼ŒbeanFactoryä¸­å°±ä¼šä¿å­˜ä»xmlé…ç½®æ–‡ä»¶ä¸­è§£æè€Œæ¥çš„ä¿¡æ¯ parseBeanDefinitions(root, this.delegate); postProcessXml(root); this.delegate = parent;}/* è§£ææ–‡æ¡£ä¸­æ ¹çº§åˆ«çš„å…ƒç´ ï¼šâ€œimportâ€ã€â€œaliasâ€ã€â€œbeanâ€*/protected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) { if (delegate.isDefaultNamespace(root)) { NodeList nl = root.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) { Node node = nl.item(i); if (node instanceof Element) { Element ele = (Element) node; if (delegate.isDefaultNamespace(ele)) { // è§£æé»˜è®¤å…ƒç´  parseDefaultElement(ele, delegate); } else { delegate.parseCustomElement(ele); } } } } else { delegate.parseCustomElement(root); }}/* è§£æé»˜è®¤å…ƒç´ */private void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) { if (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) { importBeanDefinitionResource(ele); } else if (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) { processAliasRegistration(ele); } else if (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) { // è¯»å–åˆ°xmlé…ç½®æ–‡ä»¶çš„&lt;bean&gt;èŠ‚ç‚¹ processBeanDefinition(ele, delegate); } else if (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) { // é€’å½’ doRegisterBeanDefinitions(ele); }}/* å¤„ç†ç»™å®šçš„ bean å…ƒç´ ï¼Œè§£æ bean å®šä¹‰å¹¶å°†å…¶æ³¨å†Œåˆ°æ³¨å†Œè¡¨ã€‚*/protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) { BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); // è§£ææä¾›çš„ &lt;bean&gt; å…ƒç´  if (bdHolder != null) { bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); // å¦‚æœé€‚ç”¨ï¼Œé€šè¿‡å‘½åç©ºé—´å¤„ç†ç¨‹åºè£…é¥°ç»™å®šçš„ bean å®šä¹‰ã€‚ try { // æ³¨å†Œæœ€ç»ˆçš„è£…é¥°å®ä¾‹ã€‚ BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry()); } catch (BeanDefinitionStoreException ex) { getReaderContext().error(&quot;Failed to register bean definition with name '&quot; + bdHolder.getBeanName() + &quot;'&quot;, ele, ex); } // å‘é€æ³¨å†Œäº‹ä»¶ã€‚ getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder)); }} parseBeanDefinitionElementï¼ˆBeanDefinitionParserDelegate.classï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162@Nullablepublic BeanDefinitionHolder parseBeanDefinitionElement(Element ele) { return parseBeanDefinitionElement(ele, null);}/* è§£ææä¾›çš„ &lt;bean&gt; å…ƒç´ ã€‚*/@Nullablepublic BeanDefinitionHolder parseBeanDefinitionElement(Element ele, @Nullable BeanDefinition containingBean) { String id = ele.getAttribute(ID_ATTRIBUTE); String nameAttr = ele.getAttribute(NAME_ATTRIBUTE); List&lt;String&gt; aliases = new ArrayList&lt;&gt;(); if (StringUtils.hasLength(nameAttr)) { String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS); aliases.addAll(Arrays.asList(nameArr)); } String beanName = id; if (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) { beanName = aliases.remove(0); if (logger.isTraceEnabled()) { logger.trace(&quot;No XML 'id' specified - using '&quot; + beanName + &quot;' as bean name and &quot; + aliases + &quot; as aliases&quot;); } } if (containingBean == null) { checkNameUniqueness(beanName, aliases, ele); } //ç»ˆäºï¼Œè¿™é‡Œè¦è§£æbeanDefinitionäº† AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean); if (beanDefinition != null) { if (!StringUtils.hasText(beanName)) { try { if (containingBean != null) { beanName = BeanDefinitionReaderUtils.generateBeanName( beanDefinition, this.readerContext.getRegistry(), true); } else { beanName = this.readerContext.generateBeanName(beanDefinition); // Register an alias for the plain bean class name, if still possible, // if the generator returned the class name plus a suffix. // This is expected for Spring 1.2/2.0 backwards compatibility. String beanClassName = beanDefinition.getBeanClassName(); if (beanClassName != null &amp;&amp; beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp; !this.readerContext.getRegistry().isBeanNameInUse(beanClassName)) { aliases.add(beanClassName); } } if (logger.isTraceEnabled()) { logger.trace(&quot;Neither XML 'id' nor 'name' specified - &quot; + &quot;using generated bean name [&quot; + beanName + &quot;]&quot;); } } catch (Exception ex) { error(ex.getMessage(), ele); return null; } } String[] aliasesArray = StringUtils.toStringArray(aliases); return new BeanDefinitionHolder(beanDefinition, beanName, aliasesArray); } return null;}/* è§£æ bean å®šä¹‰æœ¬èº«ï¼Œè€Œä¸è€ƒè™‘åç§°æˆ–åˆ«åã€‚å¦‚æœåœ¨è§£æ bean å®šä¹‰æœŸé—´å‡ºç°é—®é¢˜ï¼Œåˆ™å¯èƒ½è¿”å› nullã€‚*/@Nullablepublic AbstractBeanDefinition parseBeanDefinitionElement( Element ele, String beanName, @Nullable BeanDefinition containingBean) { this.parseState.push(new BeanEntry(beanName)); String className = null; if (ele.hasAttribute(CLASS_ATTRIBUTE)) { className = ele.getAttribute(CLASS_ATTRIBUTE).trim(); } String parent = null; if (ele.hasAttribute(PARENT_ATTRIBUTE)) { parent = ele.getAttribute(PARENT_ATTRIBUTE); } try { // åˆ›å»ºBeanDefinition AbstractBeanDefinition bd = createBeanDefinition(className, parent); parseBeanDefinitionAttributes(ele, beanName, containingBean, bd); bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT)); parseMetaElements(ele, bd); parseLookupOverrideSubElements(ele, bd.getMethodOverrides()); parseReplacedMethodSubElements(ele, bd.getMethodOverrides()); // é€šè¿‡æ„é€ å™¨è§£æå‚æ•°å€¼ parseConstructorArgElements(ele, bd); // é€šè¿‡propertyçš„valueè§£æå€¼å—ï¼Œæœ¬æ–‡çš„ç¨‹åºxmlå°±æ˜¯é€šè¿‡propertyå±æ€§è®¾ç½®beançš„å€¼çš„ï¼Œæœ€ç»ˆè¢«è¿™ä¸€æ–¹æ³•æ‰€è§£æå‡ºæ¥ã€‚ parsePropertyElements(ele, bd); parseQualifierElements(ele, bd); bd.setResource(this.readerContext.getResource()); bd.setSource(extractSource(ele)); return bd; } catch (ClassNotFoundException ex) { error(&quot;Bean class [&quot; + className + &quot;] not found&quot;, ele, ex); } catch (NoClassDefFoundError err) { error(&quot;Class that bean class [&quot; + className + &quot;] depends on not found&quot;, ele, err); } catch (Throwable ex) { error(&quot;Unexpected failure during bean definition parsing&quot;, ele, ex); } finally { this.parseState.pop(); } return null;}// è§£æç»™å®š bean å…ƒç´ çš„å±æ€§å­å…ƒç´ ã€‚public void parsePropertyElements(Element beanEle, BeanDefinition bd) { NodeList nl = beanEle.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) { Node node = nl.item(i); if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, PROPERTY_ELEMENT)) { // è§£æå‡ºå‚æ•°å€¼æ¥ï¼Œè¿™é‡Œå°±çœŸæ­£çš„è®²ageçš„23ï¼Œå’Œnameçš„bruiså€¼è§£æå‡ºæ¥å¹¶é˜²æ­¢åœ¨ä¸€ä¸ªç»„è£…çš„ç±»é‡Œé¢å­˜æ”¾ç€ã€‚ // å› ä¸ºè¿™é‡Œæœ‰ä¸¤ä¸ªbeanï¼Œæ‰€ä»¥è¦å¾ªç¯è°ƒç”¨ä¸¤æ¬¡parsePropertyElement()æ–¹æ³• parsePropertyElement((Element) node, bd); } }}// è§£æå±æ€§å…ƒç´ public void parsePropertyElement(Element ele, BeanDefinition bd) { String propertyName = ele.getAttribute(NAME_ATTRIBUTE); if (!StringUtils.hasLength(propertyName)) { error(&quot;Tag 'property' must have a 'name' attribute&quot;, ele); return; } this.parseState.push(new PropertyEntry(propertyName)); try { if (bd.getPropertyValues().contains(propertyName)) { error(&quot;Multiple 'property' definitions for property '&quot; + propertyName + &quot;'&quot;, ele); return; } Object val = parsePropertyValue(ele, bd, propertyName); PropertyValue pv = new PropertyValue(propertyName, val); parseMetaElements(ele, pv); pv.setSource(extractSource(ele)); // å°±æ˜¯è¿™ä¸€æ­¥ï¼Œå°†Kä¸ºageã€nameï¼Œå€¼åˆ†åˆ«ä¸º23ã€bruisçš„KVå¯¹å­˜æ”¾åœ¨äº†Springå®¹å™¨é‡Œã€‚ bd.getPropertyValues().addPropertyValue(pv); } finally { this.parseState.pop(); }} æ€»ç»“ï¼šè¯¥æ–¹æ³•å®é™…ä¸Šå®ç°äº†å®¹å™¨çš„åˆå§‹åŒ–ä»¥åŠBeanDefinitionçš„æ³¨å†Œä¸åŠ è½½ï¼Œæ–¹ä¾¿åç»­Beançš„åˆ›å»ºå’ŒåŠ è½½ å®¹å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹å¦‚ä¸‹ï¼š ç¬¬ä¸€ä¸ªè¿‡ç¨‹æ˜¯Resourceå®šä½è¿‡ç¨‹ã€‚è¿™ä¸ªResourceå®šä½è¿‡ç¨‹æŒ‡çš„æ˜¯BeanDefinitionçš„èµ„æºå®šä½ï¼Œå®ƒç”±ResourceLoaderé€šè¿‡ç»Ÿä¸€çš„Resourceæ¥å£æ¥å®Œæˆï¼Œè¿™ä¸ªResourceå¯¹å„ç§å½¢å¼çš„BeanDefinitionçš„ä½¿ç”¨éƒ½æä¾›äº†ç»Ÿä¸€æ¥å£ã€‚è¿™ä¸ªå®šä½è¿‡ç¨‹ç±»ä¼¼äºå®¹å™¨å¯»æ‰¾æ•°æ®çš„è¿‡ç¨‹ï¼Œå°±åƒä½¿ç”¨æ°´æ¡¶è£…æ°´å…ˆè¦æŠŠæ°´æ‰¾åˆ°ä¸€æ ·ã€‚ ç¬¬äºŒä¸ªè¿‡ç¨‹æ˜¯BeanDefinitionçš„è½½å…¥ã€‚è¿™ä¸ªè½½å…¥è¿‡ç¨‹æ˜¯æŠŠç”¨æˆ·å®šä¹‰å¥½çš„Beanè¡¨ç¤ºæˆIOCå®¹å™¨å†…éƒ¨çš„æ•°æ®ç»“æ„ï¼Œè€Œè¿™ä¸ªå®¹å™¨å†…éƒ¨çš„æ•°æ®ç»“æ„å°±æ˜¯BeanDefinitionã€‚ä¸‹é¢ä»‹ç»è¿™ä¸ªæ•°æ®ç»“æ„çš„è¯¦ç»†å®šä¹‰ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªBeanDefinitionå®é™…ä¸Šå°±æ˜¯POJOå¯¹è±¡åœ¨IOCå®¹å™¨çš„æŠ½è±¡ï¼Œé€šè¿‡è¿™ä¸ªBeanDefinitionå®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œä½¿IOCèƒ½å¤Ÿæ–¹ä¾¿åœ°å¯¹POJOå¯¹è±¡è¿›è¡Œç®¡ç†ã€‚ ç¬¬ä¸‰ä¸ªè¿‡ç¨‹æ˜¯å‘IOCå®¹å™¨æ³¨å†Œè¿™äº›BeanDefinitionçš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡è°ƒç”¨BeanDefinitionRegistryæ¥å£çš„å®ç°æ¥å®Œæˆçš„ã€‚è¿™ä¸ªæ³¨å†Œè¿‡ç¨‹æŠŠè½½å…¥è¿‡ç¨‹ä¸­è§£æåˆ°çš„BeanDefinitionå‘IOCå®¹å™¨è¿›è¡Œæ³¨å†Œã€‚é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“IOCå†…éƒ¨å°†BeanDefinitionæ³¨å†Œåˆ°äº†ConcurrentHashMapä¸­ã€‚ 3.5 prepareBeanFactory prepareBeanFactoryï¼ˆAbstractApplicationContext.classï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/* é…ç½®å·¥å‚çš„æ ‡å‡†ä¸Šä¸‹æ–‡ç‰¹å¾ï¼Œä¾‹å¦‚ä¸Šä¸‹æ–‡çš„ ClassLoader å’Œåå¤„ç†å™¨*/protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) { // å‘Šè¯‰å†…éƒ¨ bean å·¥å‚ä½¿ç”¨ä¸Šä¸‹æ–‡çš„ç±»åŠ è½½å™¨ç­‰ã€‚ beanFactory.setBeanClassLoader(getClassLoader()); if (!shouldIgnoreSpel) { beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader())); } beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment())); // ä½¿ç”¨ä¸Šä¸‹æ–‡å›è°ƒé…ç½® bean å·¥å‚ã€‚ beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this)); beanFactory.ignoreDependencyInterface(EnvironmentAware.class); beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class); beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class); beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class); beanFactory.ignoreDependencyInterface(MessageSourceAware.class); beanFactory.ignoreDependencyInterface(ApplicationContextAware.class); beanFactory.ignoreDependencyInterface(ApplicationStartupAware.class); // BeanFactory æ¥å£æœªåœ¨æ™®é€šå·¥å‚ä¸­æ³¨å†Œä¸ºå¯è§£æç±»å‹ã€‚ // MessageSource ä½œä¸º bean æ³¨å†Œï¼ˆå¹¶ä¸ºè‡ªåŠ¨è£…é…æ‰¾åˆ°ï¼‰ã€‚ beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory); beanFactory.registerResolvableDependency(ResourceLoader.class, this); beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this); beanFactory.registerResolvableDependency(ApplicationContext.class, this); // å°†ç”¨äºæ£€æµ‹å†…éƒ¨ bean çš„æ—©æœŸåå¤„ç†å™¨æ³¨å†Œä¸º ApplicationListenerã€‚ beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this)); // æ£€æµ‹ LoadTimeWeaver å¹¶å‡†å¤‡ç¼–ç»‡ï¼ˆå¦‚æœæ‰¾åˆ°ï¼‰ã€‚ if (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) { beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory)); // ä¸ºç±»å‹åŒ¹é…è®¾ç½®ä¸€ä¸ªä¸´æ—¶ ClassLoaderã€‚ beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader())); } // æ³¨å†Œé»˜è®¤ç¯å¢ƒ beanã€‚ if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) { beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment()); } if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) { beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties()); } if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) { beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment()); } if (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) { beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup()); }} 3.6 postProcessBeanFactory postProcessBeanFactoryï¼ˆAbstractApplicationContext.classï¼‰ 1234567/* åœ¨æ ‡å‡†åˆå§‹åŒ–ä¹‹åä¿®æ”¹åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡çš„å†…éƒ¨ bean å·¥å‚ã€‚æ‰€æœ‰ bean å®šä¹‰éƒ½å°†è¢«åŠ è½½ï¼Œ ä½†è¿˜æ²¡æœ‰ bean è¢«å®ä¾‹åŒ–ã€‚è¿™å…è®¸åœ¨æŸäº› ApplicationContext å®ç°ä¸­æ³¨å†Œç‰¹æ®Šçš„ BeanPostProcessors ç­‰ã€‚ ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å…è®¸æˆ‘ä»¬åœ¨beanå®ä¾‹åŒ–ä¹‹å‰ä¿®æ”¹beançš„å®šä¹‰ä¿¡æ¯å³BeanDefinitionçš„ä¿¡æ¯*/protected void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {} 3.7 invokeBeanFactoryPostProcessors invokeBeanFactoryPostProcessors ï¼ˆAbstractApplicationContext.classï¼‰ 1234567891011// å®ä¾‹åŒ–å¹¶è°ƒç”¨æ‰€æœ‰å·²æ³¨å†Œçš„ BeanFactoryPostProcessor beanï¼Œå¦‚æœç»™å®šï¼Œåˆ™å°Šé‡æ˜¾å¼é¡ºåºã€‚å¿…é¡»åœ¨å•ä¾‹å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ã€‚protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) { PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors()); // Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime // (e.g. through an @Bean method registered by ConfigurationClassPostProcessor) if (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.getTempClassLoader() == null &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) { beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory)); beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader())); }} 3.8 registerBeanPostProcessors registerBeanPostProcessors ï¼ˆAbstractApplicationContext.classï¼‰ 123456/* å®ä¾‹åŒ–å¹¶æ³¨å†Œæ‰€æœ‰ BeanPostProcessor beanï¼Œå¦‚æœç»™å®šï¼Œåˆ™å°Šé‡æ˜¾å¼é¡ºåºã€‚å¿…é¡»åœ¨åº”ç”¨ç¨‹åº bean çš„ä»»ä½•å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ã€‚*/protected void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) { PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);} 3.9 initMessageSource initMessageSourceï¼ˆAbstractApplicationContext.classï¼‰ 123456789101112131415161718192021222324252627282930/* åˆå§‹åŒ–æ¶ˆæ¯æºã€‚å¦‚æœæ²¡æœ‰åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­å®šä¹‰ï¼Œåˆ™ä½¿ç”¨çˆ¶çº§ã€‚*/protected void initMessageSource() { ConfigurableListableBeanFactory beanFactory = getBeanFactory(); if (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) { this.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class); // ä½¿ MessageSource æ„ŸçŸ¥çˆ¶ MessageSourceã€‚ if (this.parent != null &amp;&amp; this.messageSource instanceof HierarchicalMessageSource) { HierarchicalMessageSource hms = (HierarchicalMessageSource) this.messageSource; if (hms.getParentMessageSource() == null) { // å¦‚æœå°šæœªæ³¨å†Œçˆ¶æ¶ˆæ¯æºï¼Œåˆ™ä»…å°†çˆ¶ä¸Šä¸‹æ–‡è®¾ç½®ä¸ºçˆ¶æ¶ˆæ¯æºã€‚ hms.setParentMessageSource(getInternalParentMessageSource()); } } if (logger.isTraceEnabled()) { logger.trace(&quot;Using MessageSource [&quot; + this.messageSource + &quot;]&quot;); } } else { // ä½¿ç”¨ç©º MessageSource èƒ½å¤Ÿæ¥å— getMessage è°ƒç”¨ã€‚ DelegatingMessageSource dms = new DelegatingMessageSource(); dms.setParentMessageSource(getInternalParentMessageSource()); this.messageSource = dms; beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, this.messageSource); if (logger.isTraceEnabled()) { logger.trace(&quot;No '&quot; + MESSAGE_SOURCE_BEAN_NAME + &quot;' bean, using [&quot; + this.messageSource + &quot;]&quot;); } }} 3.10 initApplicationEventMulticaster initApplicationEventMulticasterï¼ˆAbstractApplicationContext.classï¼‰ 123456789101112131415161718192021/* åˆå§‹åŒ– ApplicationEventMulticasterã€‚å¦‚æœä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰å®šä¹‰ï¼Œåˆ™ä½¿ç”¨ SimpleApplicationEventMulticasterã€‚*/protected void initApplicationEventMulticaster() { ConfigurableListableBeanFactory beanFactory = getBeanFactory(); if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) { this.applicationEventMulticaster = beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class); if (logger.isTraceEnabled()) { logger.trace(&quot;Using ApplicationEventMulticaster [&quot; + this.applicationEventMulticaster + &quot;]&quot;); } } else { this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory); beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, this.applicationEventMulticaster); if (logger.isTraceEnabled()) { logger.trace(&quot;No '&quot; + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + &quot;' bean, using &quot; + &quot;[&quot; + this.applicationEventMulticaster.getClass().getSimpleName() + &quot;]&quot;); } }} 3.11 onRefresh onRefreshï¼ˆAbstractApplicationContext.classï¼‰ 123456/* å¯ä»¥é‡å†™ä»¥æ·»åŠ ç‰¹å®šäºä¸Šä¸‹æ–‡çš„åˆ·æ–°å·¥ä½œçš„æ¨¡æ¿æ–¹æ³•ã€‚åœ¨å•ä¾‹å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ç‰¹æ®Š bean çš„åˆå§‹åŒ–ã€‚è¿™ä¸ªå®ç°æ˜¯ç©ºçš„ã€‚*/protected void onRefresh() throws BeansException { // å¯¹äºå­ç±»ï¼šé»˜è®¤æƒ…å†µä¸‹ä»€ä¹ˆéƒ½ä¸åšã€‚} 3.12 registerListeners registerListenersï¼ˆAbstractApplicationContext.classï¼‰ 123456789101112131415161718192021protected void registerListeners() { // é¦–å…ˆæ³¨å†Œé™æ€æŒ‡å®šçš„ç›‘å¬å™¨ã€‚ for (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) { getApplicationEventMulticaster().addApplicationListener(listener); } // ä¸è¦åœ¨è¿™é‡Œåˆå§‹åŒ– FactoryBeansï¼šæˆ‘ä»¬éœ€è¦è®©æ‰€æœ‰å¸¸è§„ bean ä¿æŒæœªåˆå§‹åŒ–çŠ¶æ€ï¼Œä»¥è®©åå¤„ç†å™¨åº”ç”¨äºå®ƒä»¬ï¼ String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false); for (String listenerBeanName : listenerBeanNames) { getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName); } // å‘å¸ƒæ—©æœŸåº”ç”¨ç¨‹åºäº‹ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬ç»ˆäºæœ‰äº†ä¸€ä¸ªå¤šæ’­å™¨...... Set&lt;ApplicationEvent&gt; earlyEventsToProcess = this.earlyApplicationEvents; this.earlyApplicationEvents = null; if (!CollectionUtils.isEmpty(earlyEventsToProcess)) { for (ApplicationEvent earlyEvent : earlyEventsToProcess) { getApplicationEventMulticaster().multicastEvent(earlyEvent); } }} 3.12 finishBeanFactoryInitialization finishBeanFactoryInitializationï¼ˆAbstractApplicationContext.classï¼‰ 1234567891011121314151617181920212223242526272829303132/* å®Œæˆæ­¤ä¸Šä¸‹æ–‡çš„ bean å·¥å‚çš„åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ‰€æœ‰å‰©ä½™çš„å•ä¾‹ beanã€‚*/protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) { // ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–è½¬æ¢æœåŠ¡ã€‚ if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp; beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) { beanFactory.setConversionService( beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)); } // å¦‚æœä¹‹å‰æ²¡æœ‰æ³¨å†Œè¿‡ä»»ä½• BeanFactoryPostProcessorï¼ˆä¾‹å¦‚ PropertySourcesPlaceholderConfigurer beanï¼‰ï¼Œ // åˆ™æ³¨å†Œä¸€ä¸ªé»˜è®¤çš„åµŒå…¥å€¼è§£æå™¨ï¼šæ­¤æ—¶ï¼Œä¸»è¦ç”¨äºè§£ææ³¨é‡Šå±æ€§å€¼ã€‚ if (!beanFactory.hasEmbeddedValueResolver()) { beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal)); } // å°½æ—©åˆå§‹åŒ– LoadTimeWeaverAware beanï¼Œä»¥ä¾¿å°½æ—©æ³¨å†Œå®ƒä»¬çš„è½¬æ¢å™¨ã€‚ String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false); for (String weaverAwareName : weaverAwareNames) { getBean(weaverAwareName); } // åœæ­¢ä½¿ç”¨ä¸´æ—¶ ClassLoader è¿›è¡Œç±»å‹åŒ¹é…ã€‚ beanFactory.setTempClassLoader(null); // å…è®¸ç¼“å­˜æ‰€æœ‰ bean å®šä¹‰å…ƒæ•°æ®ï¼Œè€Œä¸æ˜¯æœŸæœ›è¿›ä¸€æ­¥çš„æ›´æ”¹ã€‚ beanFactory.freezeConfiguration(); // å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„ï¼ˆéæƒ°æ€§åˆå§‹åŒ–ï¼‰å•ä¾‹ã€‚ beanFactory.preInstantiateSingletons();} â€‹ è¿™é‡Œçš„æ‡’åŠ è½½çš„æ„æ€ï¼ŒæŒ‡çš„æ˜¯beanå•ä¾‹ä¸æ˜¯åœ¨Springå®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™å°±åˆ›å»ºçš„ï¼Œè€Œæ˜¯åœ¨è¦ä½¿ç”¨è¯¥beançš„æ—¶å€™ï¼Œæ‰ä¼šåˆ›å»ºè¯¥beanã€‚ preInstantiateSingletonsï¼ˆDefaultListableBeanFactory.classï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061@Overridepublic void preInstantiateSingletons() throws BeansException { if (logger.isTraceEnabled()) { logger.trace(&quot;Pre-instantiating singletons in &quot; + this); } // è¿­ä»£ä¸€ä¸ªå‰¯æœ¬ä»¥å…è®¸ init æ–¹æ³•ä¾æ¬¡æ³¨å†Œæ–°çš„ bean å®šä¹‰ã€‚ // è™½ç„¶è¿™å¯èƒ½ä¸æ˜¯å¸¸è§„å·¥å‚å¼•å¯¼ç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼Œä½†å®ƒç¡®å®å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ // è·å–æ‰€æœ‰çš„beanå®šä¹‰çš„åå­—ï¼Œå¹¶ä¿å­˜åœ¨é›†åˆListé‡Œé¢ã€‚ List&lt;String&gt; beanNames = new ArrayList&lt;&gt;(this.beanDefinitionNames); // è§¦å‘æ‰€æœ‰éå»¶è¿Ÿå•ä¾‹beançš„åˆå§‹åŒ–... for (String beanName : beanNames) { // è§¦å‘æ‰€æœ‰é€‚ç”¨beançš„ååˆå§‹åŒ–å›è°ƒ RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName); if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) { if (isFactoryBean(beanName)) { Object bean = getBean(FACTORY_BEAN_PREFIX + beanName); if (bean instanceof FactoryBean) { FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean; boolean isEagerInit; if (System.getSecurityManager() != null &amp;&amp; factory instanceof SmartFactoryBean) { isEagerInit = AccessController.doPrivileged( (PrivilegedAction&lt;Boolean&gt;) ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit, getAccessControlContext()); } else { isEagerInit = (factory instanceof SmartFactoryBean &amp;&amp; ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit()); } if (isEagerInit) { getBean(beanName); } } } else { getBean(beanName); } } } // ä¸ºæ‰€æœ‰é€‚ç”¨çš„ bean è§¦å‘åˆå§‹åŒ–åå›è°ƒ... for (String beanName : beanNames) { Object singletonInstance = getSingleton(beanName); if (singletonInstance instanceof SmartInitializingSingleton) { StartupStep smartInitialize = this.getApplicationStartup().start(&quot;spring.beans.smart-initialize&quot;) .tag(&quot;beanName&quot;, beanName); SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance; if (System.getSecurityManager() != null) { AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; { smartSingleton.afterSingletonsInstantiated(); return null; }, getAccessControlContext()); } else { smartSingleton.afterSingletonsInstantiated(); } smartInitialize.end(); } }} getBeanï¼ˆAbstractBeanFactory.classï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159@Overridepublic Object getBean(String name) throws BeansException { return doGetBean(name, null, null, false);}/* è¿”å›æŒ‡å®š bean çš„ä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥æ˜¯å…±äº«çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç‹¬ç«‹çš„ã€‚*/protected &lt;T&gt; T doGetBean( String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException { // å»é™¤nameä¸Šå­˜åœ¨çš„å·¥å‚beançš„å‰ç¼€ String beanName = transformedBeanName(name); Object beanInstance; // å¿«é€Ÿåˆ¤æ–­å•ä¾‹ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨è¯¥beanï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›å•ä¾‹beanï¼›å¦åˆ™è¿”å›null Object sharedInstance = getSingleton(beanName); // &lt;-------------- if (sharedInstance != null &amp;&amp; args == null) { if (logger.isTraceEnabled()) { if (isSingletonCurrentlyInCreation(beanName)) { logger.trace(&quot;Returning eagerly cached instance of singleton bean '&quot; + beanName + &quot;' that is not fully initialized yet - a consequence of a circular reference&quot;); } else { logger.trace(&quot;Returning cached instance of singleton bean '&quot; + beanName + &quot;'&quot;); } } // ä»å•ä¾‹ç¼“å­˜ä¸­è·å–å•ä¾‹bean beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, null); } else { // å¦‚æœæˆ‘ä»¬å·²ç»åœ¨åˆ›å»ºè¿™ä¸ª bean å®ä¾‹ï¼Œåˆ™å¤±è´¥ï¼šæˆ‘ä»¬å¯èƒ½åœ¨å¾ªç¯å¼•ç”¨ä¸­ã€‚ if (isPrototypeCurrentlyInCreation(beanName)) { throw new BeanCurrentlyInCreationException(beanName); } // æ£€æŸ¥æ­¤å·¥å‚ä¸­æ˜¯å¦å­˜åœ¨ bean å®šä¹‰ã€‚ BeanFactory parentBeanFactory = getParentBeanFactory(); if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) { // æœªæ‰¾åˆ° -&gt; æ£€æŸ¥çˆ¶çº§ã€‚ String nameToLookup = originalBeanName(name); if (parentBeanFactory instanceof AbstractBeanFactory) { return ((AbstractBeanFactory) parentBeanFactory).doGetBean( nameToLookup, requiredType, args, typeCheckOnly); } else if (args != null) { // ä½¿ç”¨æ˜¾å¼å‚æ•°å§”æ‰˜ç»™çˆ¶çº§ã€‚ return (T) parentBeanFactory.getBean(nameToLookup, args); } else if (requiredType != null) { // æ²¡æœ‰ args -&gt; å§”æ‰˜ç»™æ ‡å‡† getBean æ–¹æ³•ã€‚ return parentBeanFactory.getBean(nameToLookup, requiredType); } else { return (T) parentBeanFactory.getBean(nameToLookup); } } if (!typeCheckOnly) { markBeanAsCreated(beanName); // å°†æŒ‡å®šçš„ bean æ ‡è®°ä¸ºå·²åˆ›å»ºï¼ˆæˆ–å³å°†åˆ›å»ºï¼‰ã€‚è¿™å…è®¸ bean å·¥å‚ä¼˜åŒ–å…¶ç¼“å­˜ä»¥é‡å¤åˆ›å»ºæŒ‡å®šçš„ bean } StartupStep beanCreation = this.applicationStartup.start(&quot;spring.beans.instantiate&quot;) .tag(&quot;beanName&quot;, name); try { if (requiredType != null) { beanCreation.tag(&quot;beanType&quot;, requiredType::toString); } RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); checkMergedBeanDefinition(mbd, beanName, args); // ä¿è¯å½“å‰ bean æ‰€ä¾èµ–çš„ bean çš„åˆå§‹åŒ–ã€‚ String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) { for (String dep : dependsOn) { if (isDependent(beanName, dep)) { throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Circular depends-on relationship between '&quot; + beanName + &quot;' and '&quot; + dep + &quot;'&quot;); } registerDependentBean(dep, beanName); try { getBean(dep); } catch (NoSuchBeanDefinitionException ex) { throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;'&quot; + beanName + &quot;' depends on missing bean '&quot; + dep + &quot;'&quot;, ex); } } } // åˆ›å»º bean å®ä¾‹ã€‚ if (mbd.isSingleton()) { sharedInstance = getSingleton(beanName, () -&gt; { try { return createBean(beanName, mbd, args); // &lt; ----------------- } catch (BeansException ex) { // ä»å•ä¾‹ç¼“å­˜ä¸­æ˜¾å¼åˆ é™¤å®ä¾‹ï¼šå®ƒå¯èƒ½å·²è¢«åˆ›å»ºè¿‡ç¨‹æ€¥åˆ‡åœ°æ”¾åœ¨é‚£é‡Œï¼Œä»¥å…è®¸å¾ªç¯å¼•ç”¨è§£æã€‚ // è¿˜è¦åˆ é™¤ä»»ä½•æ¥æ”¶åˆ°å¯¹ bean çš„ä¸´æ—¶å¼•ç”¨çš„ beanã€‚ destroySingleton(beanName); throw ex; } }); beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); } else if (mbd.isPrototype()) { // è¿™æ˜¯ä¸€ä¸ªåŸå‹ -&gt; åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹ã€‚ Object prototypeInstance = null; try { beforePrototypeCreation(beanName); prototypeInstance = createBean(beanName, mbd, args); } finally { afterPrototypeCreation(beanName); } beanInstance = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); } else { String scopeName = mbd.getScope(); if (!StringUtils.hasLength(scopeName)) { throw new IllegalStateException(&quot;No scope name defined for bean '&quot; + beanName + &quot;'&quot;); } Scope scope = this.scopes.get(scopeName); if (scope == null) { throw new IllegalStateException(&quot;No Scope registered for scope name '&quot; + scopeName + &quot;'&quot;); } try { Object scopedInstance = scope.get(beanName, () -&gt; { beforePrototypeCreation(beanName); try { return createBean(beanName, mbd, args); } finally { afterPrototypeCreation(beanName); } }); beanInstance = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); } catch (IllegalStateException ex) { throw new ScopeNotActiveException(beanName, scopeName, ex); } } } catch (BeansException ex) { beanCreation.tag(&quot;exception&quot;, ex.getClass().toString()); beanCreation.tag(&quot;message&quot;, String.valueOf(ex.getMessage())); cleanupAfterBeanCreationFailure(beanName); throw ex; } finally { beanCreation.end(); } } return adaptBeanInstance(name, beanInstance, requiredType);} getSingletonï¼ˆDefaultSingletonBeanRegistry.classï¼‰ 123456789101112131415161718192021222324252627282930313233343536@Override@Nullablepublic Object getSingleton(String beanName) { return getSingleton(beanName, true);}/* è¿”å›åœ¨ç»™å®šåç§°ä¸‹æ³¨å†Œçš„ï¼ˆåŸå§‹ï¼‰å•ä¾‹å¯¹è±¡ã€‚ æ£€æŸ¥å·²ç»å®ä¾‹åŒ–çš„å•ä¾‹ï¼Œè¿˜å…è®¸å¯¹å½“å‰åˆ›å»ºçš„å•ä¾‹è¿›è¡Œæ—©æœŸå¼•ç”¨ï¼ˆè§£å†³å¾ªç¯å¼•ç”¨ï¼‰ã€‚*/@Nullableprotected Object getSingleton(String beanName, boolean allowEarlyReference) { // å¿«é€Ÿæ£€æŸ¥æ²¡æœ‰å®Œæ•´å•ä¾‹é”çš„ç°æœ‰å®ä¾‹ Object singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) { singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null &amp;&amp; allowEarlyReference) { synchronized (this.singletonObjects) { // åœ¨å®Œæ•´çš„å•ä¾‹é”ä¸­ä¸€è‡´åœ°åˆ›å»ºæ—©æœŸå¼•ç”¨ singletonObject = this.singletonObjects.get(beanName); if (singletonObject == null) { singletonObject = this.earlySingletonObjects.get(beanName); if (singletonObject == null) { ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); if (singletonFactory != null) { singletonObject = singletonFactory.getObject(); this.earlySingletonObjects.put(beanName, singletonObject); this.singletonFactories.remove(beanName); } } } } } } return singletonObject;} createBeanï¼ˆAbstractAutowireCapableBeanFactory.classï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342/* æ­¤ç±»çš„ä¸­å¿ƒæ–¹æ³•ï¼šåˆ›å»º bean å®ä¾‹ã€å¡«å…… bean å®ä¾‹ã€åº”ç”¨åå¤„ç†å™¨ç­‰ã€‚*/@Overrideprotected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException { if (logger.isTraceEnabled()) { logger.trace(&quot;Creating instance of bean '&quot; + beanName + &quot;'&quot;); } RootBeanDefinition mbdToUse = mbd; // ç¡®ä¿æ­¤æ—¶å®é™…è§£æäº† bean ç±»ï¼Œå¹¶å…‹éš† bean å®šä¹‰ä»¥é˜²åŠ¨æ€è§£æçš„ Class æ— æ³•å­˜å‚¨åœ¨å…±äº«çš„åˆå¹¶ bean å®šä¹‰ä¸­ã€‚ Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName); if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null) { mbdToUse = new RootBeanDefinition(mbd); mbdToUse.setBeanClass(resolvedClass); } // å‡†å¤‡æ–¹æ³•è¦†ç›– try { mbdToUse.prepareMethodOverrides(); } catch (BeanDefinitionValidationException ex) { throw new BeanDefinitionStoreException(mbdToUse.getResourceDescription(), beanName, &quot;Validation of method overrides failed&quot;, ex); } try { // è°ƒç”¨å®ä¾‹åŒ–å‰çš„åç½®å¤„ç†å™¨ï¼Œåœ¨è¿™ä¸ªåç½®å¤„ç†å™¨ä¸­å¯ä»¥å¯¹beanè¿›è¡Œå¤„ç†ï¼Œå¯ä»¥è¿”å›ç”±åç½®å¤„ç†å™¨å¤„ç†çš„beanè€Œä¸æ˜¯è¢«å®ä¾‹åŒ–çš„beanã€‚ // æ¢å¥è¯è¯´å°±æ˜¯è¿™é‡Œå¯ä»¥æ‹¦æˆªä½beançš„å®ä¾‹åŒ– // Springçš„åç½®å¤„ç†å™¨åé¢æœ‰æœºä¼šå†ä¸“é—¨å†™ä¸€ç¯‡åšæ–‡æ¥æ€»ç»“å­¦ä¹ ä¸€ä¸‹ Object bean = resolveBeforeInstantiation(beanName, mbdToUse); if (bean != null) { return bean; } } catch (Throwable ex) { throw new BeanCreationException(mbdToUse.getResourceDescription(), beanName, &quot;BeanPostProcessor before instantiation of bean failed&quot;, ex); } try { Object beanInstance = doCreateBean(beanName, mbdToUse, args); if (logger.isTraceEnabled()) { logger.trace(&quot;Finished creating instance of bean '&quot; + beanName + &quot;'&quot;); } return beanInstance; } catch (BeanCreationException | ImplicitlyAppearedSingletonException ex) { // å…ˆå‰æ£€æµ‹åˆ°çš„å¼‚å¸¸å·²ç»å…·æœ‰æ­£ç¡®çš„ bean åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œæˆ–è€…è¦ä¸ DefaultSingletonBeanRegistry é€šä¿¡çš„éæ³•å•ä¾‹çŠ¶æ€ã€‚ throw ex; } catch (Throwable ex) { throw new BeanCreationException( mbdToUse.getResourceDescription(), beanName, &quot;Unexpected exception during bean creation&quot;, ex); }}/* æ­£åœ¨çš„åˆ›å»ºä¸€ä¸ªbeanï¼Œå¹¶ä¸”æŒ‰ç…§é…ç½®æ–‡ä»¶çš„é…ç½®æ¥å®ä¾‹åŒ–è¯¥beanã€‚å¦‚æœæ²¡æœ‰åˆå§‹åŒ–å‰çš„åç½®å¤„ç†å™¨çš„è°ƒç”¨ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•ã€‚*/protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException { // åˆ›å»ºä¸€ä¸ªåŒ…è£…ç±»ï¼Œç”¨äºåŒ…è£…çœŸæ­£è¦åˆ›å»ºçš„beanã€‚ BeanWrapper instanceWrapper = null; if (mbd.isSingleton()) { instanceWrapper = this.factoryBeanInstanceCache.remove(beanName); } if (instanceWrapper == null) { // ä½¿ç”¨é€‚å½“çš„å®ä¾‹åŒ–ç­–ç•¥ä¾‹å¦‚ï¼šå·¥å‚æ–¹æ³•ã€æ„é€ å‡½æ•°è‡ªåŠ¨è£…é…æˆ–è€…ç®€å•å®ä¾‹åŒ– æ¥ä¸ºæŒ‡å®šbeanåˆ›å»ºæ–°çš„å®ä¾‹ã€‚ // è¿™é‡Œä»…ä»…æ˜¯ç®€å•çš„å®ä¾‹åŒ–ï¼Œä¸ºbeanè®¾ç½®é»˜è®¤åˆå§‹å€¼ // ä¹Ÿå°±æ˜¯nameä¸ºnullï¼Œageä¸º0ã€‚æ­¤æ—¶instanceWrapperä»»ç„¶è¿˜åªæ˜¯ä¸€ä¸ªåŒ…è£…beanï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„personç±»beanã€‚ // 1. å®ä¾‹åŒ– instanceWrapper = createBeanInstance(beanName, mbd, args); } // ç»ˆäºï¼Œæˆ‘ä»¬åƒè¾›ä¸‡è‹¦æ‰“æ–­ç‚¹è°ƒè¯•æ¥åˆ°äº†è¿™ä¸€æ­¥ï¼Œå°±æ˜¯è¿™ä¸€æ­¥ï¼Œ è·å¾—äº†æˆ‘ä»¬æƒ³è¦çš„personç±»beanã€‚ // åªéœ€è¦åœ¨BeanWrapperé‡Œå–å‡ºWrapperInstanceå³å¯ã€‚ // æ¥ä¸‹æ¥å°±æ˜¯è¦æ‹¿è¿™ä¸ªåˆ›å»ºå¥½çš„beanå’ŒBeanDefinitionè¿›è¡Œå®ä¾‹åŒ–äº†ã€‚ Object bean = instanceWrapper.getWrappedInstance(); // è·å–beançš„ç±»å‹ Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass(); if (beanType != NullBean.class) { mbd.resolvedTargetType = beanType; } // è°ƒç”¨åç½®å¤„ç†å™¨å»ä¿®æ”¹beançš„å®šä¹‰ä¿¡æ¯ã€‚ synchronized (mbd.postProcessingLock) { if (!mbd.postProcessed) { try { applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); } catch (Throwable ex) { throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Post-processing of merged bean definition failed&quot;, ex); } mbd.postProcessed = true; } } // å³ä½¿è¢« BeanFactoryAware ç­‰ç”Ÿå‘½å‘¨æœŸæ¥å£è§¦å‘ï¼Œä¹Ÿæ€¥åˆ‡åœ°ç¼“å­˜å•ä¾‹ä»¥è§£æå¾ªç¯å¼•ç”¨ã€‚ boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) { if (logger.isTraceEnabled()) { logger.trace(&quot;Eagerly caching bean '&quot; + beanName + &quot;' to allow for resolving potential circular references&quot;); } addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)); } // å®ä¾‹åŒ–ä¸€ä¸ªçœŸæ­£ä½¿ç”¨çš„beanã€‚ Object exposedObject = bean; try { // 2. å±æ€§èµ‹å€¼ populateBean(beanName, mbd, instanceWrapper); // &lt;-------------------- // 3. åˆå§‹åŒ– exposedObject = initializeBean(beanName, exposedObject, mbd); } catch (Throwable ex) { if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) { throw (BeanCreationException) ex; } else { throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex); } } if (earlySingletonExposure) { Object earlySingletonReference = getSingleton(beanName, false); if (earlySingletonReference != null) { if (exposedObject == bean) { exposedObject = earlySingletonReference; } else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) { String[] dependentBeans = getDependentBeans(beanName); Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;&gt;(dependentBeans.length); for (String dependentBean : dependentBeans) { if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) { actualDependentBeans.add(dependentBean); } } if (!actualDependentBeans.isEmpty()) { throw new BeanCurrentlyInCreationException(beanName, &quot;Bean with name '&quot; + beanName + &quot;' has been injected into other beans [&quot; + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + &quot;] in its raw version as part of a circular reference, but has eventually been &quot; + &quot;wrapped. This means that said other beans do not use the final version of the &quot; + &quot;bean. This is often the result of over-eager type matching - consider using &quot; + &quot;'getBeanNamesForType' with the 'allowEagerInit' flag turned off, for example.&quot;); } } } } // é”€æ¯æ³¨å†Œå›è°ƒæ¥å£ try { registerDisposableBeanIfNecessary(beanName, bean, mbd); } catch (BeanDefinitionValidationException ex) { throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex); } return exposedObject;}/* ä½¿ç”¨ bean å®šä¹‰ä¸­çš„å±æ€§å€¼å¡«å……ç»™å®š BeanWrapper ä¸­çš„ bean å®ä¾‹ã€‚*/protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) { if (bw == null) { if (mbd.hasPropertyValues()) { throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Cannot apply property values to null instance&quot;); } else { // Skip property population phase for null instance. return; } } // è®©ä»»ä½• InstantiationAwareBeanPostProcessors æœ‰æœºä¼šåœ¨è®¾ç½®å±æ€§ä¹‹å‰ä¿®æ”¹ bean çš„çŠ¶æ€ã€‚ // ä¾‹å¦‚ï¼Œè¿™å¯ä»¥ç”¨äºæ”¯æŒå­—æ®µæ³¨å…¥çš„æ ·å¼ã€‚ if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) { for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) { if (!bp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) { return; } } } // å–å‡ºBeanDefinitioné‡Œçš„å±æ€§å€¼ PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null); int resolvedAutowireMode = mbd.getResolvedAutowireMode(); // å¦‚æœè®¾ç½®çš„æ˜¯è‡ªåŠ¨è£…é…æ¨¡å¼ï¼Œåˆ™ç”±è‡ªåŠ¨è£…é…æ¥è¿›è¡Œèµ‹å€¼ if (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) { MutablePropertyValues newPvs = new MutablePropertyValues(pvs); // é€šè¿‡beanåè‡ªåŠ¨è£…é… if (resolvedAutowireMode == AUTOWIRE_BY_NAME) { autowireByName(beanName, mbd, bw, newPvs); } // é€šè¿‡beanç±»å‹è‡ªåŠ¨è£…é… if (resolvedAutowireMode == AUTOWIRE_BY_TYPE) { autowireByType(beanName, mbd, bw, newPvs); } pvs = newPvs; } boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors(); boolean needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE); PropertyDescriptor[] filteredPds = null; if (hasInstAwareBpps) { if (pvs == null) { pvs = mbd.getPropertyValues(); } for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) { PropertyValues pvsToUse = bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName); if (pvsToUse == null) { if (filteredPds == null) { filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching); } pvsToUse = bp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName); if (pvsToUse == null) { return; } } pvs = pvsToUse; } } if (needsDepCheck) { if (filteredPds == null) { filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching); } checkDependencies(beanName, mbd, filteredPds, pvs); } // è¿™é‡Œçš„PropertyValueså·²ç»åŒ…å«äº†beanå­—æ®µå±æ€§çš„è®¾ç½®å€¼äº† if (pvs != null) { applyPropertyValues(beanName, mbd, bw, pvs); }}/* åº”ç”¨ç»™å®šçš„å±æ€§å€¼ï¼Œè§£æå¯¹æ­¤ bean å·¥å‚ä¸­å…¶ä»– bean çš„ä»»ä½•è¿è¡Œæ—¶å¼•ç”¨ã€‚å¿…é¡»ä½¿ç”¨æ·±æ‹·è´ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä¼šæ°¸ä¹…ä¿®æ”¹è¿™ä¸ªå±æ€§ã€‚*/protected void applyPropertyValues(String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs) { if (pvs.isEmpty()) { return; } if (System.getSecurityManager() != null &amp;&amp; bw instanceof BeanWrapperImpl) { ((BeanWrapperImpl) bw).setSecurityContext(getAccessControlContext()); } MutablePropertyValues mpvs = null; // æºå±æ€§å€¼ List&lt;PropertyValue&gt; original; if (pvs instanceof MutablePropertyValues) { mpvs = (MutablePropertyValues) pvs; if (mpvs.isConverted()) { // Shortcut: use the pre-converted values as-is. try { bw.setPropertyValues(mpvs); return; } catch (BeansException ex) { throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Error setting property values&quot;, ex); } } original = mpvs.getPropertyValueList(); } else { original = Arrays.asList(pvs.getPropertyValues()); } TypeConverter converter = getCustomTypeConverter(); if (converter == null) { converter = bw; } BeanDefinitionValueResolver valueResolver = new BeanDefinitionValueResolver(this, beanName, mbd, converter); // æ‹·è´å€¼ï¼›åˆ›å»ºä¸€ä¸ªæ·±æ‹·è´å‰¯æœ¬ï¼Œåº”ç”¨äºä»»ä½•beanå¼•ç”¨æ­¤beançš„æƒ…å†µã€‚ List&lt;PropertyValue&gt; deepCopy = new ArrayList&lt;&gt;(original.size()); boolean resolveNecessary = false; for (PropertyValue pv : original) { if (pv.isConverted()) { deepCopy.add(pv); } else { String propertyName = pv.getName(); Object originalValue = pv.getValue(); if (originalValue == AutowiredPropertyMarker.INSTANCE) { Method writeMethod = bw.getPropertyDescriptor(propertyName).getWriteMethod(); if (writeMethod == null) { throw new IllegalArgumentException(&quot;Autowire marker for property without write method: &quot; + pv); } originalValue = new DependencyDescriptor(new MethodParameter(writeMethod, 0), true); } Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue); Object convertedValue = resolvedValue; boolean convertible = bw.isWritableProperty(propertyName) &amp;&amp; !PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName); if (convertible) { convertedValue = convertForProperty(resolvedValue, propertyName, bw, converter); } // å¯èƒ½åœ¨åˆå¹¶çš„beanå®šä¹‰ä¸­å­˜å‚¨è½¬æ¢åçš„å€¼ï¼Œä»¥é¿å…ä¸ºæ¯ä¸ªåˆ›å»ºçš„beanå®ä¾‹é‡æ–°è½¬æ¢ã€‚ if (resolvedValue == originalValue) { if (convertible) { pv.setConvertedValue(convertedValue); } deepCopy.add(pv); } else if (convertible &amp;&amp; originalValue instanceof TypedStringValue &amp;&amp; !((TypedStringValue) originalValue).isDynamic() &amp;&amp; !(convertedValue instanceof Collection || ObjectUtils.isArray(convertedValue))) { pv.setConvertedValue(convertedValue); deepCopy.add(pv); } else { resolveNecessary = true; deepCopy.add(new PropertyValue(pv, convertedValue)); } } } if (mpvs != null &amp;&amp; !resolveNecessary) { mpvs.setConverted(); } // å°†æ·±æ‹·è´å±æ€§æ•°ç»„å¡«å……åˆ°beanWrapperä¸­ã€‚è¿™é‡Œå°±çœŸæ­£çš„å°†å±æ€§å€¼å¡«å……åˆ°äº†beanä¸Šï¼Œå®ç°äº† try { bw.setPropertyValues(new MutablePropertyValues(deepCopy)); } catch (BeansException ex) { throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Error setting property values&quot;, ex); }} 3.13 finishRefresh finishRefreshï¼ˆAbstractApplicationContext.classï¼‰ 123456789101112131415161718192021/* å®Œæˆæ­¤ä¸Šä¸‹æ–‡çš„åˆ·æ–°ï¼Œè°ƒç”¨ LifecycleProcessor çš„ onRefresh() æ–¹æ³•å¹¶å‘å¸ƒ ContextRefreshedEventã€‚*/protected void finishRefresh() { // æ¸…é™¤ä¸Šä¸‹æ–‡çº§åˆ«çš„èµ„æºç¼“å­˜ï¼ˆä¾‹å¦‚æ‰«æä¸­çš„ ASM å…ƒæ•°æ®ï¼‰ã€‚ clearResourceCaches(); //ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ã€‚ initLifecycleProcessor(); // é¦–å…ˆå°†åˆ·æ–°ä¼ æ’­åˆ°ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ã€‚ getLifecycleProcessor().onRefresh(); // å‘å¸ƒæœ€ç»ˆäº‹ä»¶ã€‚ publishEvent(new ContextRefreshedEvent(this)); // å‚ä¸ LiveBeansView MBeanï¼ˆå¦‚æœå¤„äºæ´»åŠ¨çŠ¶æ€ï¼‰ã€‚ if (!NativeDetector.inNativeImage()) { LiveBeansView.registerApplicationContext(this); }} â€‹ ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œå°±çŸ¥é“çœŸæ­£çš„å¯¹beanèµ‹å€¼å¡«å……æ˜¯åœ¨AbstractAutowireCapableBeanFactory.classç±»é‡Œçš„applyPropertyValuesæ–¹æ³•é‡Œçš„ï¼Œå¹¶ä¸”æ˜¯é€šè¿‡å¯¹åŸå±æ€§å€¼è¿›è¡Œäº†ä¸€æ¬¡æ·±æ‹·è´ï¼Œç„¶åå°†æ·±æ‹·è´åçš„å±æ€§å€¼å¡«å……åˆ°beané‡Œçš„ã€‚ 4. æ€»ç»“â€‹ æœ¬æ¬¡æºç åˆ†æï¼Œä¸»è¦è¿˜æ˜¯å¯¹å®¹å™¨çš„åˆ›å»ºä¸åˆå§‹åŒ–è¿›è¡Œåˆ†æï¼Œä¹Ÿå°±æ˜¯obtainFreshBeanFactory å’ŒfinishBeanFactoryInitializationè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œå…¶ä»–å‡½æ•°æ˜¯å¯¹å…¶çš„åŠ å·¥æˆ–è€…é¢„å¤„ç†ï¼Œç•™åˆ°åé¢å†è¯¦ç»†å±•å¼€ã€‚ å‚è€ƒ(99æ¡æ¶ˆæ¯) Springå’ŒSpring Frameworkçš„ç†è§£_æµ·TAOçš„åšå®¢-CSDNåšå®¢_springframeworkå’Œspring JavaSourceCodeLearning/æ·±å…¥Springæºç ç³»åˆ—ï¼ˆäºŒï¼‰â€”â€”æ·±å…¥Springå®¹å™¨ï¼Œé€šè¿‡æºç é˜…è¯»å’Œæ—¶åºå›¾æ¥å½»åº•å¼„æ‡‚Springå®¹å™¨ï¼ˆä¸Šï¼‰","link":"/2022/02/08/%E6%A1%86%E6%9E%B6/Spring/Spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/"},{"title":"ç¬¬72åœºåŒå‘¨èµ›","text":"5996. ç»Ÿè®¡æ•°ç»„ä¸­ç›¸ç­‰ä¸”å¯ä»¥è¢«æ•´é™¤çš„æ•°å¯¹ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰ (leetcode-cn.com) 1234567891011121314class Solution {public: int countPairs(vector&lt;int&gt;&amp; nums, int k) { int n = nums.size(); int res = 0; for (int i = 0; i &lt; n; i ++) for (int j = i + 1; j &lt; n; j ++) { if (nums[i] == nums[j]) { if (((i * j) % k) == 0) res ++; } } return res; }}; 5997. æ‰¾åˆ°å’Œä¸ºç»™å®šæ•´æ•°çš„ä¸‰ä¸ªè¿ç»­æ•´æ•° - åŠ›æ‰£ï¼ˆLeetCodeï¼‰ (leetcode-cn.com) 1234567891011121314class Solution {public: vector&lt;long long&gt; sumOfThree(long long num) { long long mid = num / 3; long left = mid - 1, right = mid + 1; vector&lt;long long&gt; res; if (mid + left + right == num) { res.push_back(left); res.push_back(mid); res.push_back(right); } return res; }}; 5998. æ‹†åˆ†æˆæœ€å¤šæ•°ç›®çš„å¶æ•´æ•°ä¹‹å’Œ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰ (leetcode-cn.com) 12345678910111213141516class Solution {public: vector&lt;long long&gt; maximumEvenSplit(long long finalSum) { if (finalSum % 2 == 1) return vector&lt;long long&gt;{}; vector&lt;long long&gt; res; long long i = 2; while (finalSum &gt;= i) { res.push_back(i); finalSum -= i; i += 2; } res[res.size() - 1] += finalSum; return res; }};","link":"/2022/02/20/LC%E5%91%A8%E8%B5%9B/%E7%AC%AC72%E5%9C%BA%E5%8F%8C%E5%91%A8%E8%B5%9B/"},{"title":"JDKå’ŒCglibåŠ¨æ€ä»£ç†çš„åŒºåˆ«","text":"1 ä¸ºä»€ä¹ˆéœ€è¦ä»£ç†ï¼Ÿâ€‹ ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸ºäº†ä¿è¯å•ä¸€æ€§åŸåˆ™é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªç±»çš„åŠŸèƒ½å°½å¯èƒ½å•ä¸€ï¼Œè¿™æ ·æ‰èƒ½æ˜¯è¯¥ç±»è¢«æ”¹åŠ¨çš„å¯èƒ½æ€§æœ€å°ã€‚æ¯”å¦‚ï¼Œå¦‚æœå½“æˆ‘ä»¬éœ€è¦ä¸ºç±»é‡ŒåŠ ä¸Šæƒé™ï¼Œæ—¥å¿—ç­‰åŠŸèƒ½æ—¶ï¼Œå¦‚æœæ¯ä¸ªç±»éƒ½éœ€è¦è¿™ç§åŠŸèƒ½ï¼Œé‚£å°±è¦ä¿®æ”¹æ¯ä¸ªç±»ï¼Œè¿™æ ·å·¥ä½œé‡å¾ˆå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä»£ç†ï¼Œè®©æˆ‘ä»¬å¯ä»¥åœ¨ä¸æ”¹åŠ¨åŸæœ‰ä»£ç çš„å‰æä¸‹ï¼Œå®ç°ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼Œå³å¢å¼ºã€‚æˆ‘ä»¬åœ¨è¿›å…¥ç›®æ ‡ç±»ä¹‹å‰ï¼Œå…ˆè¿›å…¥ä»£ç†ç±»ï¼Œåœ¨ä»£ç†ç±»ä¸­å†™æˆ‘ä»¬éœ€è¦çš„é¢å¤–åŠŸèƒ½ï¼Œè¿™æ ·åŸæœ‰ç±»ä¸åŠ¨ï¼Œä¸å½±å“åŸæœ‰åŠŸèƒ½ã€‚ â€‹ ä¸‹é¢å°±æ˜¯ä¸€ä¸ªå…³äºé™æ€ä»£ç†çš„å®ä¾‹ï¼Œèƒ½å¸®åŠ©ç†è§£ä»£ç†çš„æ„ä¹‰ 12345678/*** å…±åŒæ¥å£*/public interface ProgrammerInterface { void goToWork(); void goOffWork();} 1234567891011121314/*** ç¨‹åºå‘˜ç±»*/public class Programmer implements ProgrammerInterface{ @Override public void goToWork() { System.out.print(&quot;å¼€å§‹ä¸Šç­äº†\\n&quot;); } @Override public void goOffWork() { System.out.print(&quot;ç»ˆäºä¸‹ç­äº†\\n&quot;); }} 1234567891011121314151617181920212223242526272829/*** ç¨‹åºå‘˜ä»£ç†ç±»*/public class ProgrammerProxy implements ProgrammerInterface { //ç›®æ ‡ç±»(ç¨‹åºå‘˜ç±») Programmer programmer; //æ„é€ æ–¹æ³•,åˆå§‹åŒ–ç›®æ ‡ç±» public ProgrammerProxy(Programmer programmer) { this.programmer = programmer; } @Override public void goToWork() { System.out.print(&quot;è¿›å…¥äº†ä¸Šç­ä»£ç†\\n&quot;); programmer.goToWork(); System.out.print(&quot;ä¸Šç­æ—¶é—´ä¸º:&quot; + new Date() + &quot;\\n\\n&quot;); } @Override public void goOffWork() { System.out.print(&quot;è¿›å…¥äº†ä¸‹ç­ä»£ç†\\n&quot;); programmer.goOffWork(); System.out.print(&quot;ä¸‹ç­æ—¶é—´ä¸º:&quot; + new Date() + &quot;\\n&quot;); }} 1234567891011121314public class ProxyDemoApplication { public static void main(String[] args) {// Programmer programmer = new Programmer();// programmer.goToWork();// programmer.goOffWork(); Programmer programmer = new Programmer(); ProgrammerProxy programmerProxy = new ProgrammerProxy(programmer); programmerProxy.goToWork(); programmerProxy.goOffWork(); }} è¿è¡Œç»“æœ 1234567è¿›å…¥äº†ä¸Šç­ä»£ç†å¼€å§‹ä¸Šç­äº†ä¸Šç­æ—¶é—´ä¸ºï¼šSun Feb 20 16:51:09 CST 2022è¿›å…¥äº†ä¸‹ç­ä»£ç†ç»ˆäºä¸‹ç­äº†ä¸‹ç­æ—¶é—´ä¸ºï¼šSun Feb 20 16:51:09 CST 2022 â€‹ ä½†é™æ€ä»£ç†æœ‰ä¸¤ä¸ªé—®é¢˜ å¦‚æœå…¶ä»–ç±»éœ€è¦å®ç°åŒæ ·çš„åŠŸèƒ½ï¼Œåˆ™éœ€è¦åœ¨å†™ä¸€ä¸ªä»£ç†ç±»ï¼Œè¿™æ ·ä¼šå¾ˆéº»çƒ¦ã€‚ å½“æˆ‘ä»¬éœ€è¦æ–°å¢åŠŸèƒ½æ—¶ï¼Œéœ€è¦åœ¨æ¥å£ï¼Œç±»ï¼Œä»£ç†ç±»ä¸Šéƒ½è¦æ–°å¢ï¼Œé¡¹ç›®è§„æ¨¡è¾ƒå¤§æ—¶ä¸å¥½ç»´æŠ¤ â€‹ æ‰€ä»¥ï¼Œå°±å‡ºç°äº†åŠ¨æ€ä»£ç†ï¼Œä¸‹é¢æ¥èŠèŠJavaä¸­åŠ¨æ€ä»£ç†çš„å‡ ç§æ–¹å¼å’ŒåŒºåˆ«ã€‚ 2 JDKåŠ¨æ€ä»£ç†â€‹ JDKåŠ¨æ€ä»£ç†ä¸»è¦æ˜¯é€šè¿‡ï¼Œåå°„åŒ…ä¸­çš„Porxyç±»å’ŒInvokationHandleræ¥å£ã€‚å®ƒä»¬ç»“åˆåœ¨ä¸€èµ·åå¯ä»¥åˆ›å»ºåŠ¨æ€ä»£ç†ç±»ã€‚Porxyç±»åŸºäºä¼ é€’çš„å‚æ•°åˆ›å»ºåŠ¨æ€ä»£ç†ç±»ã€‚InvokationHandleråˆ™ç”¨äºæ¿€å‘åŠ¨æ€ä»£ç†ç±»çš„æ–¹æ³•ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€ç”Ÿæˆä¸å¤„ç†çš„ï¼Œæ‰€ä»¥å«åŠ¨æ€ä»£ç†ã€‚ â€‹ ä¸‹é¢æ¥çœ‹çœ‹ä½¿ç”¨ç¤ºä¾‹ å®ç°InvokationHandleræ¥å£â€‹ JDK åŠ¨æ€ä»£ç†ç±»å¿…é¡»å®ç°åå°„åŒ…ä¸­çš„ java.lang.reflect.InvocationHandler æ¥å£ï¼Œåœ¨æ­¤æ¥å£ä¸­åªæœ‰ä¸€ä¸ª invoker æ–¹æ³•ï¼š â€‹ åœ¨InvocationHandler#invokerä¸­å¿…é¡»è°ƒç”¨ç›®æ ‡ç±»è¢«ä»£ç†çš„æ–¹æ³•ï¼Œå¦åˆ™æ— æ³•åšåˆ°ä»£ç†çš„å®ç°ã€‚ä¸‹é¢ä¸ºå®ç° InvocationHandler çš„ä»£ç ã€‚ 12345678910111213141516public class TargetInvoker implements InvocationHandler { // ä»£ç†ä¸­æŒæœ‰çš„ç›®æ ‡ç±» private Object target; public TargetInvoker(Object target) { this.target = target; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { System.out.println(&quot;jdk ä»£ç†æ‰§è¡Œå‰&quot;); Object result = method.invoke(target, args); System.out.println(&quot;jdk ä»£ç†æ‰§è¡Œå&quot;); return result; }} â€‹ åœ¨å®ç°InvocationHandler#invokeræ—¶ï¼Œè¯¥æ–¹æ³•é‡Œæœ‰ä¸‰ä¸ªå‚æ•°ï¼š proxy ä»£ç†ç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œå®ƒæ˜¯çœŸå®çš„ä»£ç†å¯¹è±¡ã€‚ method æ‰§è¡Œç›®æ ‡ç±»çš„æ–¹æ³• args æ‰§è¡Œç›®æ ‡ç±»çš„æ–¹æ³•çš„å‚æ•° åˆ›å»ºJDKåŠ¨æ€ä»£ç†ç±»â€‹ åˆ›å»º JDK åŠ¨æ€ä»£ç†ç±»å®ä¾‹åŒæ ·ä¹Ÿæ˜¯ä½¿ç”¨åå°„åŒ…ä¸­çš„ java.lang.reflect.Proxy ç±»è¿›è¡Œåˆ›å»ºã€‚é€šè¿‡è°ƒç”¨Proxy#newProxyInstanceé™æ€æ–¹æ³•è¿›è¡Œåˆ›å»ºã€‚ 1234567891011public class DynamicProxyAnimal { public static Object getProxy(Object target) throws Exception { Object proxy = Proxy.newProxyInstance( target.getClass().getClassLoader(), // æŒ‡å®šç›®æ ‡ç±»çš„ç±»åŠ è½½ target.getClass().getInterfaces(), // ä»£ç†éœ€è¦å®ç°çš„æ¥å£ï¼Œå¯æŒ‡å®šå¤šä¸ªï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°ç»„ new TargetInvoker(target) // ä»£ç†å¯¹è±¡å¤„ç†å™¨ ); return proxy; }} â€‹ Proxy#newProxyInstanceä¸­çš„ä¸‰ä¸ªå‚æ•°ï¼ˆClassLoader loaderã€Class&lt;?&gt;[] interfacesã€InvocationHandler hï¼‰ï¼š loader åŠ è½½ä»£ç†å¯¹è±¡çš„ç±»åŠ è½½å™¨ interfaces ä»£ç†å¯¹è±¡å®ç°çš„æ¥å£ï¼Œä¸ç›®æ ‡å¯¹è±¡å®ç°åŒæ ·çš„æ¥å£ h å¤„ç†ä»£ç†å¯¹è±¡é€»è¾‘çš„å¤„ç†å™¨ï¼Œå³ä¸Šé¢çš„ InvocationHandler å®ç°ç±»ã€‚ â€‹ æœ€åå®ç°æ‰§è¡Œ DynamicProxyAnimal åŠ¨æ€ä»£ç†ï¼š 3 CglibåŠ¨æ€ä»£ç†â€‹ CGLIB åŠ¨æ€ä»£ç†çš„å®ç°æœºåˆ¶æ˜¯ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»ï¼Œé€šè¿‡è°ƒç”¨çˆ¶ç±»ï¼ˆç›®æ ‡ç±»ï¼‰çš„æ–¹æ³•å®ç°ï¼Œåœ¨è°ƒç”¨çˆ¶ç±»æ–¹æ³•æ—¶å†ä»£ç†ä¸­è¿›è¡Œå¢å¼ºã€‚ å®ç° MethodInterceptor æ¥å£â€‹ ç›¸æ¯”äº JDK åŠ¨æ€ä»£ç†çš„å®ç°ï¼ŒCGLIB åŠ¨æ€ä»£ç†ä¸éœ€è¦å®ç°ä¸ç›®æ ‡ç±»ä¸€æ ·çš„æ¥å£ï¼Œè€Œæ˜¯é€šè¿‡æ–¹æ³•æ‹¦æˆªçš„æ–¹å¼å®ç°ä»£ç†ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼Œé¦–å…ˆæ–¹æ³•æ‹¦æˆªæ¥å£ net.sf.cglib.proxy.MethodInterceptorã€‚ 12345678910public class TargetInterceptor implements MethodInterceptor { @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable { System.out.println(&quot;CGLIB è°ƒç”¨å‰&quot;); Object result = proxy.invokeSuper(obj, args); System.out.println(&quot;CGLIB è°ƒç”¨å&quot;); return result; }} é€šè¿‡æ–¹æ³•æ‹¦æˆªæ¥å£è°ƒç”¨ç›®æ ‡ç±»çš„æ–¹æ³•ï¼Œç„¶ååœ¨è¯¥è¢«æ‹¦æˆªçš„æ–¹æ³•è¿›è¡Œå¢å¼ºå¤„ç†ï¼Œå®ç°æ–¹æ³•æ‹¦æˆªå™¨æ¥å£çš„ intercept æ–¹æ³•é‡Œé¢æœ‰å››ä¸ªå‚æ•°ï¼š obj ä»£ç†ç±»å¯¹è±¡ method å½“å‰è¢«ä»£ç†æ‹¦æˆªçš„æ–¹æ³• args æ‹¦æˆªæ–¹æ³•çš„å‚æ•° proxy ä»£ç†ç±»å¯¹åº”ç›®æ ‡ç±»çš„ä»£ç†æ–¹æ³• åˆ›å»ºCglibåŠ¨æ€ä»£ç†ç±»â€‹ åˆ›å»º CGLIB åŠ¨æ€ä»£ç†ç±»ä½¿ç”¨ net.sf.cglib.proxy.Enhancer ç±»è¿›è¡Œåˆ›å»ºï¼Œå®ƒæ˜¯ CGLIB åŠ¨æ€ä»£ç†ä¸­çš„æ ¸å¿ƒç±»ï¼Œé¦–å…ˆåˆ›å»ºä¸ªç®€å•çš„ä»£ç†ç±»ï¼š 1234567891011121314public class CglibProxy { public static Object getProxy(Class&lt;?&gt; clazz){ Enhancer enhancer = new Enhancer(); // è®¾ç½®ç±»åŠ è½½ enhancer.setClassLoader(clazz.getClassLoader()); // è®¾ç½®è¢«ä»£ç†ç±» enhancer.setSuperclass(clazz); // è®¾ç½®æ–¹æ³•æ‹¦æˆªå™¨ enhancer.setCallback(new TargetInterceptor()); // åˆ›å»ºä»£ç†ç±» return enhancer.create(); }} â€‹ è®¾ç½®è¢«ä»£ç†ç±»çš„ä¿¡æ¯å’Œä»£ç†ç±»æ‹¦æˆªçš„æ–¹æ³•çš„å›è°ƒæ‰§è¡Œé€»è¾‘ï¼Œå°±å¯ä»¥å®ç°ä¸€ä¸ªä»£ç†ç±»ã€‚ å®ç° CGLIB åŠ¨æ€ä»£ç†è°ƒç”¨ï¼š 1234567public class Main { @Test public void dynamicProxy() throws Exception { Animal cat = (Animal) CglibProxy.getProxy(Cat.class); cat.call(); }} â€‹ 4 æ€»ç»“â€‹ ä¸¤ç§æœºåˆ¶çš„ä¸åŒå®ç°ï¼š JDK åŠ¨æ€ä»£ç†æ˜¯é€šè¿‡å®ç°ç›®æ ‡ç±»çš„æ¥å£ï¼Œç„¶åå°†ç›®æ ‡ç±»åœ¨æ„é€ åŠ¨æ€ä»£ç†æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œä½¿ä»£ç†å¯¹è±¡æŒæœ‰ç›®æ ‡å¯¹è±¡ï¼Œå†é€šè¿‡ä»£ç†å¯¹è±¡çš„ InvocationHandler å®ç°åŠ¨æ€ä»£ç†çš„æ“ä½œã€‚ CGLIB åŠ¨æ€ä»£ç†æ˜¯é€šè¿‡é…ç½®ç›®æ ‡ç±»ä¿¡æ¯ï¼Œç„¶ååˆ©ç”¨ ASM å­—èŠ‚ç æ¡†æ¶è¿›è¡Œç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»ã€‚å½“è°ƒç”¨ä»£ç†æ–¹æ³•æ—¶ï¼Œé€šè¿‡æ‹¦æˆªæ–¹æ³•çš„æ–¹å¼å®ç°ä»£ç†çš„æ“ä½œã€‚ â€‹ ä»è€Œï¼Œæˆ‘ä»¬çŸ¥é“ï¼š JDKåŠ¨æ€ä»£ç†åªèƒ½å¯¹å®ç°äº†æ¥å£çš„ç±»ç”Ÿæˆä»£ç†ï¼Œè€Œä¸èƒ½é’ˆå¯¹ç±» CGLIBæ˜¯é’ˆå¯¹ç±»å®ç°ä»£ç†ï¼Œä¸»è¦æ˜¯å¯¹æŒ‡å®šçš„ç±»ç”Ÿæˆä¸€ä¸ªå­ç±»ï¼Œè¦†ç›–å…¶ä¸­çš„æ–¹æ³• â€‹ åç»­å†å‡ºä¸€ç¯‡å…³äºæºç é˜…è¯»çš„æ–‡ç« è¯¦è§£ï¼Œè¿™ä¸¤ç§æ–¹å¼æ˜¯å¦‚ä½•å®ç°ä»£ç†çš„ã€‚ å‚è€ƒJDK åŠ¨æ€ä»£ç†ä¸ CGLIB æœ‰å“ªäº›åŒºåˆ«? - æ˜é‡‘ (juejin.cn) ä½ å¿…é¡»ä¼šçš„ JDK åŠ¨æ€ä»£ç†å’Œ CGLIB åŠ¨æ€ä»£ç† - çŸ¥ä¹ (zhihu.com)","link":"/2022/02/20/%E6%A1%86%E6%9E%B6/Spring/JDK%E5%92%8CCglib%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%9A%84%E5%8C%BA%E5%88%AB/"},{"title":"I&#x2F;Oå¤šè·¯å¤ç”¨è¯¦è§£","text":"1 å‰è¦çŸ¥è¯†1.1 æ–‡ä»¶I/Oâ€‹ æ–‡ä»¶I/Oåˆ†ç±»ï¼Œå¸¸è§çš„æœ‰ ç¼“å†²ä¸â¾®ç¼“å†² I/O ç›´æ¥ä¸â¾®ç›´æ¥ I/O é˜»å¡ä¸â¾®é˜»å¡ I/O VS åŒæ­¥ä¸å¼‚æ­¥ I/O ç¼“å†²ä¸â¾®ç¼“å†² I/O â€‹ â½‚ä»¶æ“ä½œçš„æ ‡å‡†åº“æ˜¯å¯ä»¥å®ç°æ•°æ®çš„ç¼“å­˜ï¼Œé‚£ä¹ˆæ ¹æ®ã€Œæ˜¯å¦åˆ©â½¤æ ‡å‡†åº“ç¼“å†²ã€ï¼Œå¯ä»¥æŠŠâ½‚ä»¶ I/O åˆ†ä¸ºç¼“å†²I/O å’Œâ¾®ç¼“å†² I/Oï¼š ç¼“å†² I/Oï¼Œåˆ©â½¤çš„æ˜¯æ ‡å‡†åº“çš„ç¼“å­˜å®ç°â½‚ä»¶çš„åŠ é€Ÿè®¿é—®ï¼Œâ½½æ ‡å‡†åº“å†é€šè¿‡ç³»ç»Ÿè°ƒâ½¤è®¿é—®â½‚ä»¶ã€‚ â¾®ç¼“å†² I/Oï¼Œç›´æ¥é€šè¿‡ç³»ç»Ÿè°ƒâ½¤è®¿é—®â½‚ä»¶ï¼Œä¸ç»è¿‡æ ‡å‡†åº“ç¼“å­˜ã€‚ ç›´æ¥ä¸â¾®ç›´æ¥ I/O â€‹ æ ¹æ®æ˜¯ã€Œå¦åˆ©â½¤æ“ä½œç³»ç»Ÿçš„ç¼“å­˜ã€ï¼Œå¯ä»¥æŠŠâ½‚ä»¶ I/O åˆ†ä¸ºç›´æ¥ I/O ä¸â¾®ç›´æ¥ I/Oï¼š ç›´æ¥ I/Oï¼Œä¸ä¼šå‘â½£å†…æ ¸ç¼“å­˜å’Œâ½¤æˆ·ç¨‹åºä¹‹é—´æ•°æ®å¤åˆ¶ï¼Œâ½½æ˜¯ç›´æ¥ç»è¿‡â½‚ä»¶ç³»ç»Ÿè®¿é—®ç£ç›˜ã€‚ â¾®ç›´æ¥ I/Oï¼Œè¯»æ“ä½œæ—¶ï¼Œæ•°æ®ä»å†…æ ¸ç¼“å­˜ä¸­æ‹·â»‰ç»™â½¤æˆ·ç¨‹åºï¼Œå†™æ“ä½œæ—¶ï¼Œæ•°æ®ä»â½¤æˆ·ç¨‹åºæ‹·â»‰ç»™å†…æ ¸ç¼“å­˜ï¼Œå†ç”±å†…æ ¸å†³å®šä»€ä¹ˆæ—¶å€™å†™â¼Šæ•°æ®åˆ°ç£ç›˜ã€‚ é˜»å¡ä¸â¾®é˜»å¡ I/O VS åŒæ­¥ä¸å¼‚æ­¥ I/O â€‹ é˜»å¡ç­‰å¾…çš„æ˜¯ã€Œå†…æ ¸æ•°æ®å‡†å¤‡å¥½ã€å’Œã€Œæ•°æ®ä»å†…æ ¸æ€æ‹·â»‰åˆ°â½¤æˆ·æ€ã€è¿™ä¸¤ä¸ªè¿‡ç¨‹ â€‹ â€‹ â¾®é˜»å¡ I/Oï¼Œâ¾®é˜»å¡çš„ read è¯·æ±‚åœ¨æ•°æ®æœªå‡†å¤‡å¥½çš„æƒ…å†µä¸‹â½´å³è¿”å›ï¼Œå¯ä»¥ç»§ç»­å¾€ä¸‹æ‰§â¾ï¼Œæ­¤æ—¶åº”â½¤ç¨‹åºä¸æ–­è½®è¯¢å†…æ ¸ï¼Œç›´åˆ°æ•°æ®å‡†å¤‡å¥½ï¼Œå†…æ ¸å°†æ•°æ®æ‹·â»‰åˆ°åº”â½¤ç¨‹åºç¼“å†²åŒºï¼Œ read è°ƒâ½¤æ‰å¯ä»¥å¾—åˆ°ç»“æœ â€‹ â€‹ åŒæ­¥I/Oå°±æ˜¯æŒ‡ã€Œå†…æ ¸æ•°æ®å‡†å¤‡å¥½ã€å’Œã€Œæ•°æ®ä»å†…æ ¸æ€æ‹·â»‰åˆ°â½¤æˆ·æ€ã€è¿™ä¸¤ä¸ªè¿‡ç¨‹éƒ½éœ€è¦ç­‰å¾…ã€‚ â€‹ å¼‚æ­¥I/O æ˜¯ã€Œå†…æ ¸æ•°æ®å‡†å¤‡å¥½ã€å’Œã€Œæ•°æ®ä»å†…æ ¸æ€æ‹·â»‰åˆ°â½¤æˆ·æ€ã€è¿™ä¸¤ä¸ªè¿‡ç¨‹éƒ½ä¸â½¤ç­‰å¾…ã€‚ 1.2 I/Oæ¨¡å‹â€‹ æ¥çœ‹çœ‹Linuxä¸­æä¾›çš„5ç§I/Oå¤„ç†æ¨¡å‹ é˜»å¡IO â€‹ é˜»å¡IOæ„å‘³ç€å½“æˆ‘ä»¬å‘èµ·ä¸€æ¬¡IOæ“ä½œååº”ç”¨ç¨‹åºä¸€ç›´ç­‰å¾…æˆåŠŸæˆ–å¤±è´¥ä¹‹åæ‰è¿”å›ï¼Œåœ¨è¿™æœŸé—´ç¨‹åºä¸èƒ½åšå…¶å®ƒçš„äº‹æƒ…ã€‚é˜»å¡IOæ“ä½œåªèƒ½å¯¹å•ä¸ªæ–‡ä»¶æè¿°ç¬¦è¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚readå’Œwriteã€‚ éé˜»å¡IO â€‹ éé˜»å¡IOæ˜¯æŒ‡æ¯æ¬¡åº”ç”¨ç¨‹åºè¯¢é—®å†…æ ¸æ˜¯å¦æœ‰æ•°æ®å‡†å¤‡å¥½ã€‚å¦‚æœå°±ç»ªï¼Œå°±è¿›è¡Œæ‹·è´æ“ä½œï¼›å¦‚æœæœªå°±ç»ªï¼Œå°±ä¸é˜»å¡ç¨‹åºï¼Œå†…æ ¸ç›´æ¥è¿”å›æœªå°±ç»ªçš„è¿”å›å€¼ï¼Œç­‰å¾…ç”¨æˆ·ç¨‹åºä¸‹ä¸€ä¸ªè½®è¯¢ã€‚ I/Oå¤šè·¯å¤ç”¨ â€‹ å‘é€æ–¹å‘æ¥æ”¶æ–¹è¯·æ±‚åï¼Œä¸ç­‰å¾…å“åº”ï¼Œå¯ä»¥ç»§ç»­å…¶ä»–å·¥ä½œã€‚ æ¥æ”¶æ–¹å¤„ç†è¯·æ±‚æ—¶è¿›è¡ŒIOæ“ä½œå¦‚æœä¸èƒ½é©¬ä¸Šå¾—åˆ°ç»“æœï¼Œå°±ä¸€ç›´ç­‰åˆ°è¿”å›ç»“æœåï¼Œæ‰å“åº”å‘é€æ–¹ï¼ŒæœŸé—´ä¸èƒ½è¿›è¡Œå…¶ä»–æ“ä½œã€‚ â€‹ è¿™é‡Œå¤ç”¨çš„æ˜¯æŒ‡å¤ç”¨ä¸€ä¸ªæˆ–å‡ ä¸ªçº¿ç¨‹ï¼Œç”¨ä¸€ä¸ªæˆ–ä¸€ç»„çº¿ç¨‹å¤„ç†å¤šä¸ªIOæ“ä½œï¼Œå‡å°‘ç³»ç»Ÿå¼€é”€å°ï¼Œä¸å¿…åˆ›å»ºå’Œç»´æŠ¤è¿‡å¤šçš„è¿›ç¨‹/çº¿ç¨‹ã€‚ ä¿¡å·é©±åŠ¨I/O â€‹ ä¿¡å·é©±åŠ¨I/Oæ˜¯åˆ©ç”¨ä¿¡å·æœºåˆ¶ï¼Œè®©å†…æ ¸å‘ŠçŸ¥åº”ç”¨ç¨‹åºæ–‡ä»¶æè¿°ç¬¦çš„ç›¸å…³äº‹ä»¶ã€‚ å¼‚æ­¥éé˜»å¡I/O â€‹ å‘é€æ–¹å‘æ¥æ”¶æ–¹è¯·æ±‚åï¼Œä¸ç­‰å¾…å“åº”ï¼Œå¯ä»¥ç»§ç»­å…¶ä»–å·¥ä½œã€‚ æ¥æ”¶æ–¹å¤„ç†è¯·æ±‚æ—¶è¿›è¡ŒIOæ“ä½œå¦‚æœä¸èƒ½é©¬ä¸Šå¾—åˆ°ç»“æœï¼Œä¹Ÿä¸ç­‰å¾…ï¼Œè€Œæ˜¯é©¬ä¸Šè¿”å›å»åšå…¶ä»–äº‹æƒ…ã€‚ å½“IOæ“ä½œå®Œæˆä»¥åï¼Œå°†å®ŒæˆçŠ¶æ€å’Œç»“æœé€šçŸ¥æ¥æ”¶æ–¹ï¼Œæ¥æ”¶æ–¹å†å“åº”å‘é€æ–¹ã€‚ â€‹ éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œâ½†è®ºæ˜¯é˜»å¡ I/Oã€â¾®é˜»å¡ I/Oï¼Œè¿˜æ˜¯åŸºäºâ¾®é˜»å¡ I/O çš„å¤šè·¯å¤â½¤éƒ½æ˜¯åŒæ­¥è°ƒâ½¤ã€‚å› ä¸ºå®ƒä»¬åœ¨ readè°ƒâ½¤æ—¶ï¼Œå†…æ ¸å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·â»‰åˆ°åº”â½¤ç¨‹åºç©ºé—´ï¼Œè¿‡ç¨‹éƒ½æ˜¯éœ€è¦ç­‰å¾…çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¿‡ç¨‹æ˜¯åŒæ­¥çš„ï¼Œå¦‚æœå†…æ ¸å®ç°çš„æ‹·â»‰æ•ˆç‡ä¸â¾¼ï¼Œreadè°ƒâ½¤å°±ä¼šåœ¨è¿™ä¸ªåŒæ­¥è¿‡ç¨‹ä¸­ç­‰å¾…â½è¾ƒâ»“çš„æ—¶é—´ã€‚ 2 I/Oå¤šè·¯å¤ç”¨ï¼šselect/poll/epollâ€‹ I/Oå¤šè·¯å¤ç”¨å…¶å®å°±æ˜¯ä½¿ç”¨ä¸€ä¸ªè¿›ç¨‹æ¥ç»´æŠ¤å¤šä¸ªSocketã€‚ â€‹ â¼€ä¸ªè¿›ç¨‹è™½ç„¶ä»»â¼€æ—¶åˆ»åªèƒ½å¤„ç†â¼€ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯å¤„ç†æ¯ä¸ªè¯·æ±‚çš„äº‹ä»¶æ—¶ï¼Œè€—æ—¶æ§åˆ¶åœ¨ 1 æ¯«ç§’ä»¥å†…ï¼Œè¿™æ · 1ç§’å†…å°±å¯ä»¥å¤„ç†ä¸Šåƒä¸ªè¯·æ±‚ï¼ŒæŠŠæ—¶é—´æ‹‰â»“æ¥çœ‹ï¼Œå¤šä¸ªè¯·æ±‚å¤â½¤äº†â¼€ä¸ªè¿›ç¨‹ï¼Œè¿™å°±æ˜¯å¤šè·¯å¤â½¤ï¼Œè¿™ç§æ€æƒ³å¾ˆç±»ä¼¼â¼€ä¸ª CPU å¹¶å‘å¤šä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥ä¹Ÿå«åšæ—¶åˆ†å¤šè·¯å¤â½¤ã€‚ â€‹ select/poll/epoll å†…æ ¸æä¾›ç»™â½¤æˆ·æ€çš„å¤šè·¯å¤â½¤ç³»ç»Ÿè°ƒâ½¤ï¼Œè¿›ç¨‹å¯ä»¥é€šè¿‡â¼€ä¸ªç³»ç»Ÿè°ƒâ½¤å‡½æ•°ä»å†…æ ¸ä¸­è·å–å¤šä¸ªäº‹ä»¶ã€‚ 2.1 selectâ€‹ select å®ç°å¤šè·¯å¤â½¤çš„â½…å¼æ˜¯ï¼Œå°†å·²è¿æ¥çš„ Socket éƒ½æ”¾åˆ°â¼€ä¸ªâ½‚ä»¶æè¿°ç¬¦é›†åˆï¼Œç„¶åè°ƒâ½¤ select å‡½æ•°å°†â½‚ä»¶æè¿°ç¬¦é›†åˆæ‹·â»‰åˆ°å†…æ ¸â¾¥ï¼Œè®©å†…æ ¸æ¥æ£€æŸ¥æ˜¯å¦æœ‰â½¹ç»œäº‹ä»¶äº§â½£ï¼Œæ£€æŸ¥çš„â½…å¼å¾ˆç²—æš´ï¼Œå°±æ˜¯é€šè¿‡éå†â½‚ä»¶æè¿°ç¬¦é›†åˆçš„â½…å¼ï¼Œå½“æ£€æŸ¥åˆ°æœ‰äº‹ä»¶äº§â½£åï¼Œå°†æ­¤ Socket æ ‡è®°ä¸ºå¯è¯»æˆ–å¯å†™ï¼Œ æ¥ç€å†æŠŠæ•´ä¸ªâ½‚ä»¶æè¿°ç¬¦é›†åˆæ‹·â»‰å›â½¤æˆ·æ€â¾¥ï¼Œç„¶åâ½¤æˆ·æ€è¿˜éœ€è¦å†é€šè¿‡éå†çš„â½…æ³•æ‰¾åˆ°å¯è¯»æˆ–å¯å†™çš„ Socketï¼Œç„¶åå†å¯¹å…¶å¤„ç†ã€‚ â€‹ æ‰€ä»¥ï¼Œå¯¹äº select è¿™ç§â½…å¼ï¼Œéœ€è¦è¿›â¾ 2 æ¬¡ã€Œéå†ã€â½‚ä»¶æè¿°ç¬¦é›†åˆï¼Œâ¼€æ¬¡æ˜¯åœ¨å†…æ ¸æ€â¾¥ï¼Œâ¼€ä¸ªæ¬¡æ˜¯åœ¨â½¤æˆ·æ€â¾¥ ï¼Œâ½½ä¸”è¿˜ä¼šå‘â½£ 2 æ¬¡ã€Œæ‹·â»‰ã€â½‚ä»¶æè¿°ç¬¦é›†åˆï¼Œå…ˆä»â½¤æˆ·ç©ºé—´ä¼ â¼Šå†…æ ¸ç©ºé—´ï¼Œç”±å†…æ ¸ä¿®æ”¹åï¼Œå†ä¼ å‡ºåˆ°â½¤æˆ·ç©ºé—´ä¸­ã€‚ â€‹ select ä½¿â½¤å›ºå®šâ»“åº¦çš„ BitsMapï¼Œè¡¨ç¤ºâ½‚ä»¶æè¿°ç¬¦é›†åˆï¼Œâ½½ä¸”æ‰€â½€æŒçš„â½‚ä»¶æè¿°ç¬¦çš„ä¸ªæ•°æ˜¯æœ‰é™åˆ¶çš„ï¼Œåœ¨Linux ç³»ç»Ÿä¸­ï¼Œç”±å†…æ ¸ä¸­çš„ FD_SETSIZE é™åˆ¶ï¼Œ é»˜è®¤æœ€â¼¤å€¼ä¸º 1024 ï¼Œåªèƒ½ç›‘å¬ 0~1023 çš„â½‚ä»¶æè¿°ç¬¦ã€‚ 2.2 pollâ€‹ poll ä¸å†â½¤ BitsMap æ¥å­˜å‚¨æ‰€å…³æ³¨çš„â½‚ä»¶æè¿°ç¬¦ï¼Œå–â½½ä»£ä¹‹â½¤åŠ¨æ€æ•°ç»„ï¼Œä»¥é“¾è¡¨å½¢å¼æ¥ç»„ç»‡ï¼Œçªç ´äº†select çš„â½‚ä»¶æè¿°ç¬¦ä¸ªæ•°é™åˆ¶ï¼Œå½“ç„¶è¿˜ä¼šå—åˆ°ç³»ç»Ÿâ½‚ä»¶æè¿°ç¬¦é™åˆ¶ã€‚ä½†æ˜¯ poll å’Œ select å¹¶æ²¡æœ‰å¤ªâ¼¤çš„æœ¬è´¨åŒºåˆ«ï¼Œéƒ½æ˜¯ä½¿â½¤ã€Œçº¿æ€§ç»“æ„ã€å­˜å‚¨è¿›ç¨‹å…³æ³¨çš„ Socket é›†åˆï¼Œå› æ­¤éƒ½éœ€è¦éå†â½‚ä»¶æè¿°ç¬¦é›†åˆæ¥æ‰¾åˆ°å¯è¯»æˆ–å¯å†™çš„Socketï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œâ½½ä¸”ä¹Ÿéœ€è¦åœ¨â½¤æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´æ‹·â»‰â½‚ä»¶æè¿°ç¬¦é›†åˆï¼Œè¿™ç§â½…å¼éšç€å¹¶å‘æ•°ä¸Šæ¥ï¼Œæ€§èƒ½çš„æŸè€—ä¼šå‘ˆæŒ‡æ•°çº§å¢â»“ã€‚ 2.3 epollâ€‹ epoll é€šè¿‡ä¸¤ä¸ªâ½…â¾¯ï¼Œå¾ˆå¥½è§£å†³äº† select/poll çš„é—®é¢˜ã€‚ â€‹ ç¬¬â¼€ç‚¹ï¼Œepoll åœ¨å†…æ ¸â¾¥ä½¿â½¤çº¢â¿Šæ ‘æ¥è·Ÿè¸ªè¿›ç¨‹æ‰€æœ‰å¾…æ£€æµ‹çš„â½‚ä»¶æè¿°å­—ï¼ŒæŠŠéœ€è¦ç›‘æ§çš„ socket é€šè¿‡epoll_ctl() å‡½æ•°åŠ â¼Šå†…æ ¸ä¸­çš„çº¢â¿Šæ ‘â¾¥ï¼Œçº¢â¿Šæ ‘æ˜¯ä¸ªâ¾¼æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå¢åˆ æŸ¥â¼€èˆ¬æ—¶é—´å¤æ‚åº¦æ˜¯O(logn) ï¼Œé€šè¿‡å¯¹è¿™æ£µâ¿Šçº¢æ ‘è¿›â¾æ“ä½œï¼Œè¿™æ ·å°±ä¸éœ€è¦åƒ select/poll æ¯æ¬¡æ“ä½œæ—¶éƒ½ä¼ â¼Šæ•´ä¸ª socket é›†åˆï¼Œåªéœ€è¦ä¼ â¼Šâ¼€ä¸ªå¾…æ£€æµ‹çš„ socketï¼Œå‡å°‘äº†å†…æ ¸å’Œâ½¤æˆ·ç©ºé—´â¼¤é‡çš„æ•°æ®æ‹·â»‰å’Œå†…å­˜åˆ†é…ã€‚ â€‹ ç¬¬â¼†ç‚¹ï¼Œ epoll ä½¿â½¤äº‹ä»¶é©±åŠ¨çš„æœºåˆ¶ï¼Œå†…æ ¸â¾¥ç»´æŠ¤äº†â¼€ä¸ªé“¾è¡¨æ¥è®°å½•å°±ç»ªäº‹ä»¶ï¼Œå½“æŸä¸ª socket æœ‰äº‹ä»¶å‘â½£æ—¶ï¼Œé€šè¿‡å›è°ƒå‡½æ•°å†…æ ¸ä¼šå°†å…¶åŠ â¼Šåˆ°è¿™ä¸ªå°±ç»ªäº‹ä»¶åˆ—è¡¨ä¸­ï¼Œå½“â½¤æˆ·è°ƒâ½¤epoll_wait()å‡½æ•°æ—¶ï¼Œåªä¼šè¿”å›æœ‰äº‹ä»¶å‘â½£çš„â½‚ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œä¸éœ€è¦åƒ select/poll é‚£æ ·è½®è¯¢æ‰«ææ•´ä¸ª socket é›†åˆï¼Œâ¼¤â¼¤æâ¾¼äº†æ£€æµ‹çš„æ•ˆç‡ã€‚ â€‹ ä»ä¸‹å›¾ä½ å¯ä»¥çœ‹åˆ° epoll ç›¸å…³çš„æ¥â¼ä½œâ½¤ï¼š â€‹ â€‹ epoll çš„â½…å¼å³ä½¿ç›‘å¬çš„ Socket æ•°é‡è¶Šå¤šçš„æ—¶å€™ï¼Œæ•ˆç‡ä¸ä¼šâ¼¤å¹…åº¦é™ä½ï¼Œèƒ½å¤ŸåŒæ—¶ç›‘å¬çš„ Socket çš„æ•°â½¬ä¹Ÿâ¾®å¸¸çš„å¤šäº†ï¼Œä¸Šé™å°±ä¸ºç³»ç»Ÿå®šä¹‰çš„è¿›ç¨‹æ‰“å¼€çš„æœ€â¼¤â½‚ä»¶æè¿°ç¬¦ä¸ªæ•°ã€‚å› â½½ï¼Œepoll è¢«ç§°ä¸ºè§£å†³ C10Ké—®é¢˜ â€‹ è¦æ³¨æ„çš„æ˜¯ï¼Œepollä½¿â½¤çš„å¹¶ä¸æ˜¯å…±äº«å†…å­˜çš„â½…å¼ï¼Œå³â½¤æˆ·æ€å’Œå†…æ ¸æ€éƒ½æŒ‡å‘äº†å°±ç»ªé“¾è¡¨ï¼Œæ‰€ä»¥å°±é¿å…äº†å†…å­˜æ‹·â»‰æ¶ˆè€—ã€‚ â€‹ epoll â½€æŒä¸¤ç§äº‹ä»¶è§¦å‘æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯è¾¹ç¼˜è§¦å‘ï¼ˆedge-triggeredï¼ŒETï¼‰å’Œâ½”å¹³è§¦å‘ï¼ˆlevel-triggeredï¼ŒLTï¼‰ã€‚ ä½¿â½¤è¾¹ç¼˜è§¦å‘æ¨¡å¼æ—¶ï¼Œå½“è¢«ç›‘æ§çš„ Socket æè¿°ç¬¦ä¸Šæœ‰å¯è¯»äº‹ä»¶å‘â½£æ—¶ï¼ŒæœåŠ¡å™¨ç«¯åªä¼šä» epoll_waitä¸­è‹é†’â¼€æ¬¡ï¼Œå³ä½¿è¿›ç¨‹æ²¡æœ‰è°ƒâ½¤ read å‡½æ•°ä»å†…æ ¸è¯»å–æ•°æ®ï¼Œä¹Ÿä¾ç„¶åªè‹é†’â¼€æ¬¡ï¼Œå› æ­¤æˆ‘ä»¬ç¨‹åºè¦ä¿è¯â¼€æ¬¡æ€§å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®è¯»å–å®Œï¼› ä½¿â½¤â½”å¹³è§¦å‘æ¨¡å¼æ—¶ï¼Œå½“è¢«ç›‘æ§çš„ Socket ä¸Šæœ‰å¯è¯»äº‹ä»¶å‘â½£æ—¶ï¼ŒæœåŠ¡å™¨ç«¯ä¸æ–­åœ°ä» epoll_wait ä¸­è‹é†’ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºæ•°æ®è¢«** read å‡½æ•°è¯»å®Œæ‰ç»“æŸï¼Œâ½¬çš„æ˜¯å‘Šè¯‰æˆ‘ä»¬æœ‰æ•°æ®éœ€è¦è¯»å–ï¼› 3 æ€»ç»“â€‹ select å’Œ poll å¹¶æ²¡æœ‰æœ¬è´¨åŒºåˆ«ï¼Œå®ƒä»¬å†…éƒ¨éƒ½æ˜¯ä½¿â½¤ã€Œçº¿æ€§ç»“æ„ã€æ¥å­˜å‚¨è¿›ç¨‹å…³æ³¨çš„ Socket é›†åˆã€‚ â€‹ åœ¨ä½¿â½¤çš„æ—¶å€™ï¼Œâ¾¸å…ˆéœ€è¦æŠŠå…³æ³¨çš„ Socket é›†åˆé€šè¿‡ select/poll ç³»ç»Ÿè°ƒâ½¤ä»â½¤æˆ·æ€æ‹·â»‰åˆ°å†…æ ¸æ€ï¼Œç„¶åç”±å†…æ ¸æ£€æµ‹äº‹ä»¶ï¼Œå½“æœ‰â½¹ç»œäº‹ä»¶äº§â½£æ—¶ï¼Œå†…æ ¸éœ€è¦éå†è¿›ç¨‹å…³æ³¨ Socket é›†åˆï¼Œæ‰¾åˆ°å¯¹åº”çš„ Socketï¼Œå¹¶è®¾ç½®å…¶çŠ¶æ€ä¸ºå¯è¯»/å¯å†™ï¼Œç„¶åæŠŠæ•´ä¸ª Socket é›†åˆä»å†…æ ¸æ€æ‹·â»‰åˆ°â½¤æˆ·æ€ï¼Œâ½¤æˆ·æ€è¿˜è¦ç»§ç»­éå†æ•´ä¸ª Socket é›†åˆæ‰¾åˆ°å¯è¯»/å¯å†™çš„ Socketï¼Œç„¶åå¯¹å…¶å¤„ç†ã€‚ â€‹ å¾ˆæ˜æ˜¾å‘ç°ï¼Œselect å’Œ poll çš„ç¼ºé™·åœ¨äºï¼Œå½“å®¢æˆ·ç«¯è¶Šå¤šï¼Œä¹Ÿå°±æ˜¯ Socket é›†åˆè¶Šâ¼¤ï¼ŒSocket é›†åˆçš„éå†å’Œæ‹·â»‰ä¼šå¸¦æ¥å¾ˆâ¼¤çš„å¼€é”€ï¼Œå› æ­¤ä¹Ÿå¾ˆéš¾åº”å¯¹ C10Kã€‚ â€‹ epoll æ˜¯è§£å†³ C10K é—®é¢˜çš„åˆ©å™¨ï¼Œé€šè¿‡ä¸¤ä¸ªâ½…â¾¯è§£å†³äº† select/poll çš„é—®é¢˜ã€‚ epoll åœ¨å†…æ ¸â¾¥ä½¿â½¤ã€Œçº¢â¿Šæ ‘ã€æ¥å…³æ³¨è¿›ç¨‹æ‰€æœ‰å¾…æ£€æµ‹çš„ Socketï¼Œçº¢â¿Šæ ‘æ˜¯ä¸ªâ¾¼æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå¢åˆ æŸ¥â¼€èˆ¬æ—¶é—´å¤æ‚åº¦æ˜¯ O(logn)ï¼Œé€šè¿‡å¯¹è¿™æ£µâ¿Šçº¢æ ‘çš„ç®¡ç†ï¼Œä¸éœ€è¦åƒ select/poll åœ¨æ¯æ¬¡æ“ä½œæ—¶éƒ½ä¼ â¼Šæ•´ä¸ª Socket é›†åˆï¼Œå‡å°‘äº†å†…æ ¸å’Œâ½¤æˆ·ç©ºé—´â¼¤é‡çš„æ•°æ®æ‹·â»‰å’Œå†…å­˜åˆ†é…ã€‚ epoll ä½¿â½¤äº‹ä»¶é©±åŠ¨çš„æœºåˆ¶ï¼Œå†…æ ¸â¾¥ç»´æŠ¤äº†â¼€ä¸ªã€Œé“¾è¡¨ã€æ¥è®°å½•å°±ç»ªäº‹ä»¶ï¼Œåªå°†æœ‰äº‹ä»¶å‘â½£çš„ Socketé›†åˆä¼ é€’ç»™åº”â½¤ç¨‹åºï¼Œä¸éœ€è¦åƒ select/poll é‚£æ ·è½®è¯¢æ‰«ææ•´ä¸ªé›†åˆï¼ˆåŒ…å«æœ‰å’Œâ½†äº‹ä»¶çš„ Socket ï¼‰ï¼Œâ¼¤â¼¤æâ¾¼äº†æ£€æµ‹çš„æ•ˆç‡ã€‚ â€‹ â½½ä¸”ï¼Œepoll â½€æŒè¾¹ç¼˜è§¦å‘å’Œâ½”å¹³è§¦å‘çš„â½…å¼ï¼Œâ½½ select/poll åªâ½€æŒâ½”å¹³è§¦å‘ï¼Œâ¼€èˆ¬â½½â¾”ï¼Œè¾¹ç¼˜è§¦å‘çš„â½…å¼ä¼šâ½â½”å¹³è§¦å‘çš„æ•ˆç‡â¾¼ã€‚ å‚è€ƒä¸€æ–‡çœ‹æ‡‚IOå¤šè·¯å¤ç”¨ - çŸ¥ä¹ (zhihu.com) å›¾è§£ç³»ç»Ÿ-äº®ç™½é£æ ¼-å°æ—coding-v1.0.pdf","link":"/2022/02/21/Linux/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E8%AF%A6%E8%A7%A3/"},{"title":"ä½¿ç”¨JvisualVMæ’æŸ¥OOM","text":"1 æµ‹è¯•ç¯å¢ƒä½¿ç”¨JDK1.8 12345678910111213141516171819202122package jvm.oom;import java.util.ArrayList;public class TestOOM { static class OOMObject { private String content; public OOMObject(String content) { this.content = content; } } public static void main(String[] args) { ArrayList&lt;OOMObject&gt; list = new ArrayList&lt;&gt;(); int a = 1; while (true) { list.add(new OOMObject(String.valueOf(a ++))); } }} é…ç½®JVMå‚æ•°ï¼š 1234-Xms2m // JVMå¯åŠ¨æ—¶å †å†…å­˜çš„åˆå§‹åŒ–å¤§å°-Xmx4m // è®¾ç½®å †å†…å­˜æœ€å¤§å€¼-XX:+HeapDumpOnOutOfMemoryError // è¡¨ç¤ºå‡ºç°OOMå¼‚å¸¸åï¼Œç”Ÿæˆå †å¿«ç…§hprofæ–‡ä»¶-XX:HeapDumpPath=d:\\jvmtest // è®¾ç½®å †å¿«ç…§hprofæ–‡ä»¶å­˜å‚¨çš„ä½ç½® 2 è¿è¡Œ1234567891011121314java.lang.OutOfMemoryError: Java heap spaceDumping heap to d:\\jvmtest ...Unable to create d:\\jvmtest: File existsException in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space at java.util.Arrays.copyOf(Arrays.java:3210) at java.util.Arrays.copyOf(Arrays.java:3181) at java.util.ArrayList.grow(ArrayList.java:261) at java.util.ArrayList.ensureExplicitCapacity(ArrayList.java:235) at java.util.ArrayList.ensureCapacityInternal(ArrayList.java:227) at java.util.ArrayList.add(ArrayList.java:458) at jvm.oom.TestOOM.main(TestOOM.java:18)Process finished with exit code 1 3 ä½¿ç”¨jvisualVMæ’æŸ¥ ä½¿ç”¨CMDå¯åŠ¨ â€‹ è£…å…¥ç”Ÿæˆçš„hprofæ–‡ä»¶ â€‹ å‘ç°å·²ç»æç¤ºæˆ‘ä»¬å‡ºç°äº†OOMå¼‚å¸¸ â€‹ å‘ç°æ˜¯17è¡Œå‡ºç°OOM â€‹ æŸ¥çœ‹ArrarList â€‹ å‘ç°å…ƒç´ ä¸ªæ•°è¾¾åˆ°ä¸‰ä¸‡å¤šï¼Œå¹¶ä¸”éƒ½æ˜¯OOMObjectå¯¹è±¡ â€‹ æ‰“å¼€ç±»è§†å›¾ï¼Œå‘ç°OOMObjectå¯¹è±¡ç¡®å®å ç”¨äº†å¤§é‡å †å†…å­˜ é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œå°±å¯ä»¥å¤§æ¦‚çŸ¥é“æ˜¯è¿‡å¤šæ— æ³•å›æ”¶çš„OOMObjectå¯¹è±¡ï¼Œå¯¼è‡´äº†OOM 4 æ€»ç»“ ç”Ÿæˆå †è½¬å‚¨å¿«ç…§dumpæ–‡ä»¶ï¼ˆæˆ–è€…ç§°hprofæ–‡ä»¶ï¼‰ï¼› åˆ©ç”¨ç›¸å…³å·¥å…·åˆ†æå †è½¬å‚¨å¿«ç…§ åœ¨çº¿ç¨‹å¿«ç…§ï¼ˆå †è½¬å‚¨ä¸Šçš„çº¿ç¨‹ï¼‰ä¸­å®šä½åˆ°å‘ç”ŸOOMçš„çº¿ç¨‹å’Œä»£ç ä½ç½® ç»¼åˆåˆ†æçº¿ç¨‹å¿«ç…§é‡Œæç¤ºçš„æœ¬åœ°å˜é‡ä¿¡æ¯åŠç±»è§†å›¾ä¸­çš„å®ä¾‹å æ¯”ï¼Œæ‰¾å‡ºå¯¼è‡´OOMçš„å®ä½“ç±»å‹","link":"/2022/02/28/JVM/%E4%BD%BF%E7%94%A8JvisualVM%E6%8E%92%E6%9F%A5OOM/"},{"title":"ç²¾é€‰åšæ–‡ï¼ˆè½¬è½½ï¼‰","text":"JavaJAVAä¸­BIOã€NIOã€AIOçš„åˆ†æç†è§£-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº (aliyun.com) JVM JMMæ¦‚è¿°_ç‰§ç«¹å­-CSDNåšå®¢_jmm JVM_12 JMMå†…å­˜æ¨¡å‹_å…´è¶£ä½¿ç„¶çš„è‰å¸½è·¯é£-CSDNåšå®¢ MYSQLMySQL explain åº”ç”¨è¯¦è§£(åè¡€æ•´ç†ğŸ¤©) - SegmentFault æ€å¦ å®æˆ˜å½»åº•ææ¸…åˆ†åº“åˆ†è¡¨ï¼ˆå‚ç›´åˆ†åº“ï¼Œå‚ç›´åˆ†è¡¨ï¼Œæ°´å¹³åˆ†åº“ï¼Œæ°´å¹³åˆ†è¡¨ï¼‰ - äº‘+ç¤¾åŒº - è…¾è®¯äº‘ (tencent.com) é¢è¯•è¿‘æœŸé¢è¯•æ€»ç»“ï¼šç§’æ€è®¾è®¡ã€AQS ã€synchronizedç›¸å…³é—®é¢˜_å…´è¶£ä½¿ç„¶çš„è‰å¸½è·¯é£-CSDNåšå®¢_aqsé¢è¯•é¢˜","link":"/2022/02/23/%E7%B2%BE%E9%80%89%E5%8D%9A%E6%96%87%EF%BC%88%E8%BD%AC%E8%BD%BD%EF%BC%89/"}],"tags":[{"name":"JVM","slug":"JVM","link":"/tags/JVM/"},{"name":"å‘¨èµ›","slug":"å‘¨èµ›","link":"/tags/%E5%91%A8%E8%B5%9B/"},{"name":"LeetCode","slug":"LeetCode","link":"/tags/LeetCode/"},{"name":"åŒå‘¨èµ›","slug":"åŒå‘¨èµ›","link":"/tags/%E5%8F%8C%E5%91%A8%E8%B5%9B/"},{"name":"Dubbo","slug":"Dubbo","link":"/tags/Dubbo/"},{"name":"zookeeper","slug":"zookeeper","link":"/tags/zookeeper/"},{"name":"ä½è¿ç®—","slug":"ä½è¿ç®—","link":"/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/"},{"name":"å‰ç¼€å’Œ","slug":"å‰ç¼€å’Œ","link":"/tags/%E5%89%8D%E7%BC%80%E5%92%8C/"},{"name":"DP","slug":"DP","link":"/tags/DP/"},{"name":"åŒºé—´DP","slug":"åŒºé—´DP","link":"/tags/%E5%8C%BA%E9%97%B4DP/"},{"name":"åŒæŒ‡é’ˆ","slug":"åŒæŒ‡é’ˆ","link":"/tags/%E5%8F%8C%E6%8C%87%E9%92%88/"},{"name":"çŠ¶æ€DP","slug":"çŠ¶æ€DP","link":"/tags/%E7%8A%B6%E6%80%81DP/"},{"name":"è®°å¿†åŒ–æœç´¢","slug":"è®°å¿†åŒ–æœç´¢","link":"/tags/%E8%AE%B0%E5%BF%86%E5%8C%96%E6%90%9C%E7%B4%A2/"},{"name":"èƒŒåŒ…DP","slug":"èƒŒåŒ…DP","link":"/tags/%E8%83%8C%E5%8C%85DP/"},{"name":"çº¿æ€§DP","slug":"çº¿æ€§DP","link":"/tags/%E7%BA%BF%E6%80%A7DP/"},{"name":"åºåˆ—DP","slug":"åºåˆ—DP","link":"/tags/%E5%BA%8F%E5%88%97DP/"},{"name":"Spring","slug":"Spring","link":"/tags/Spring/"},{"name":"çº¢é»‘æ ‘","slug":"çº¢é»‘æ ‘","link":"/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/"},{"name":"æºç ","slug":"æºç ","link":"/tags/%E6%BA%90%E7%A0%81/"},{"name":"LCåŒå‘¨èµ›","slug":"LCåŒå‘¨èµ›","link":"/tags/LC%E5%8F%8C%E5%91%A8%E8%B5%9B/"},{"name":"ç½‘ç»œæ¨¡å‹","slug":"ç½‘ç»œæ¨¡å‹","link":"/tags/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/"},{"name":"I&#x2F;O","slug":"I-O","link":"/tags/I-O/"},{"name":"BUG","slug":"BUG","link":"/tags/BUG/"},{"name":"è½¬è½½","slug":"è½¬è½½","link":"/tags/%E8%BD%AC%E8%BD%BD/"}],"categories":[{"name":"Java","slug":"Java","link":"/categories/Java/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","link":"/categories/%E7%AE%97%E6%B3%95/"},{"name":"æ¡†æ¶","slug":"æ¡†æ¶","link":"/categories/%E6%A1%86%E6%9E%B6/"},{"name":"Spring","slug":"æ¡†æ¶/Spring","link":"/categories/%E6%A1%86%E6%9E%B6/Spring/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","link":"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"Linux","slug":"Linux","link":"/categories/Linux/"},{"name":"JVM","slug":"Java/JVM","link":"/categories/Java/JVM/"},{"name":"æ‚çƒ©","slug":"æ‚çƒ©","link":"/categories/%E6%9D%82%E7%83%A9/"}]}